version: '3.8'

services:
  app:
    image: python:3.11-slim
    environment:
      DATABASE_URL: postgresql://neondb_owner:npg_WHw0KL1qUsmN@ep-falling-unit-acyw2gc7-pooler.sa-east-1.aws.neon.tech/neondb?sslmode=require
      SECRET_KEY: django-insecure-production-change-me-12345
      DEBUG: "False"
      PYTHONUNBUFFERED: "1"
    working_dir: /workspace/FIBERMEYER
    ports:
      - "8080:8000"
    volumes:
      - app_media:/workspace/FIBERMEYER/media
      - app_static:/workspace/FIBERMEYER/staticfiles
    command: >
      sh -c "
        apt-get update -qq &&
        apt-get install -y -qq git netcat-traditional build-essential pkg-config &&
        cd /workspace/FIBERMEYER &&
        if [ -d .git ]; then
          echo 'Repositorio ja existe, atualizando...' &&
          git reset --hard HEAD &&
          git pull origin main;
        else
          echo 'Inicializando repositorio...' &&
          git init &&
          git remote add origin https://github.com/Fernando-Godinho/FIBERMEYER.git &&
          git fetch origin main &&
          git reset --hard origin/main &&
          git branch -M main;
        fi &&
        echo 'Instalando dependencias...' &&
        pip install -q -r requirements.txt &&
        echo 'Executando migracoes...' &&
        python manage.py migrate --noinput &&
        echo 'Coletando arquivos estaticos...' &&
        python manage.py collectstatic --noinput --clear &&
        echo 'Criando superusuario...' &&
        DJANGO_SETTINGS_MODULE=fibermeyer_project.settings python -c 'from django.contrib.auth import get_user_model; import django; django.setup(); User = get_user_model(); User.objects.filter(username=\"admin\").exists() or User.objects.create_superuser(\"admin\", \"admin@fibermeyer.com\", \"admin123\")' &&
        echo 'Iniciando servidor...' &&
        python manage.py runserver 0.0.0.0:8000
      "
    restart: unless-stopped

volumes:
  app_media:
  app_static:
