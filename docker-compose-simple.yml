version: '3.8'

services:
  app:
    image: python:3.11-slim
    environment:
      - DJANGO_DEBUG=True
      - DJANGO_SECRET_KEY=fibermeyer-secret-key-change-me
      - DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0
    working_dir: /workspace/FIBERMEYER
    ports:
      - "8000:8000"
    volumes:
      - ./data:/workspace/FIBERMEYER/data
      - ./media:/workspace/FIBERMEYER/media
      - ./staticfiles:/workspace/FIBERMEYER/staticfiles
    command: >
      sh -c "
        echo 'ğŸ”§ Instalando dependÃªncias do sistema...' &&
        apt-get update &&
        apt-get install -y git pkg-config default-libmysqlclient-dev build-essential &&
        
        echo 'ğŸ“¥ Clonando/Atualizando repositÃ³rio FIBERMEYER...' &&
        if [ ! -d .git ]; then
          echo 'ğŸ“¥ Clonando repositÃ³rio...' &&
          git clone https://github.com/Fernando-Godinho/FIBERMEYER.git . &&
          echo 'âœ… RepositÃ³rio clonado!';
        else
          echo 'ğŸ“‚ Puxando atualizaÃ§Ãµes...' &&
          git pull &&
          echo 'âœ… RepositÃ³rio atualizado!';
        fi &&
        
        echo 'ğŸ“¦ Instalando dependÃªncias Python...' &&
        pip install --upgrade pip &&
        pip install -r requirements.txt &&
        
        echo 'ğŸ—„ï¸ Configurando banco SQLite...' &&
        python manage.py makemigrations &&
        python manage.py migrate &&
        
        echo 'ğŸ“Š Coletando arquivos estÃ¡ticos...' &&
        python manage.py collectstatic --noinput &&
        
        echo 'ğŸ‘¤ Criando superusuÃ¡rio admin/admin123...' &&
        python manage.py shell -c \"
        from django.contrib.auth import get_user_model;
        User = get_user_model();
        if not User.objects.filter(username='admin').exists():
            User.objects.create_superuser('admin', 'admin@fibermeyer.com', 'admin123');
            print('âœ… SuperusuÃ¡rio criado: admin/admin123');
        else:
            print('â„¹ï¸ SuperusuÃ¡rio jÃ¡ existe');
        \" &&
        
        echo 'ğŸš€ Iniciando servidor FIBERMEYER em http://localhost:8000' &&
        echo 'ğŸ‘¨â€ğŸ’¼ Admin disponÃ­vel em http://localhost:8000/admin/' &&
        echo 'ğŸ”‘ Login: admin / Senha: admin123' &&
        python manage.py runserver 0.0.0.0:8000
      "
    restart: unless-stopped