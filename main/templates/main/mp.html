<style>
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            color: #fff;
        }
        .nav-pills .nav-link:hover {
            background-color: #e2e6ea;
            color: #0d6efd;
        }
        
        /* Estilos para tabela de componentes editáveis */
        .fator-input {
            width: 80px !important;
            text-align: center;
            font-size: 0.875rem;
        }
        
        .fator-input:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        .quantidade-display, .custo-total-display {
            font-weight: 500;
        }
        
        #componentesCalculadosTable th {
            background-color: #f8f9fa;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        #componentesCalculadosTable td {
            vertical-align: middle;
            font-size: 0.875rem;
        }
        
        .btn-sm i {
            font-size: 0.75rem;
        }
        
        /* Destaque para linha de total */
        #componentesCalculadosTable tr:last-child {
            background-color: #e3f2fd;
            font-weight: bold;
        }
</style>
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Produtos / MP - FIBERMEYER</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<div class="d-flex">
  <nav class="flex-shrink-0 p-3 bg-light border-end" style="width: 220px; min-height: 100vh;">
          <h4 class="mb-4">FIBERMEYER</h4>
          <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
              <a class="nav-link d-flex align-items-center" data-bs-toggle="collapse" href="#parametrosSubmenu" role="button" aria-expanded="false" aria-controls="parametrosSubmenu">
                <span>Parâmetros</span>
                <span class="ms-auto caret-indicator" style="transition: transform 0.2s;"></span>
              </a>
              <div class="collapse ms-3" id="parametrosSubmenu">
                <ul class="nav flex-column">
                  <li class="nav-item"><a class="nav-link active" href="/mp/">Produtos / MP</a></li>
                  <li class="nav-item"><a class="nav-link" href="/produtos-compostos/">Produtos Compostos</a></li>
                  <li class="nav-item"><a class="nav-link" href="/impostos/">Impostos</a></li>
                  <li class="nav-item"><a class="nav-link" href="/mao_de_obra/">Mão de Obra</a></li>
                </ul>
              </div>
            </li>
            <li><a href="/" class="nav-link">Dashboard</a></li>
            <li><a href="/orcamento/" class="nav-link">Orçamentos</a></li>
            <li><a href="/about/" class="nav-link">Sobre</a></li>
            <li><a href="/admin/" class="nav-link">Administração</a></li>
          </ul>
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              var parametrosLink = document.querySelector('[href="#parametrosSubmenu"]');
              var parametrosSubmenu = document.getElementById('parametrosSubmenu');
              var caret = parametrosLink.querySelector('.caret-indicator');
              parametrosSubmenu.addEventListener('show.bs.collapse', function () {
                caret.style.transform = 'rotate(180deg)';
              });
              parametrosSubmenu.addEventListener('hide.bs.collapse', function () {
                caret.style.transform = 'rotate(0deg)';
              });
            });
          </script>
  </nav>
  <div class="container-fluid p-4">
    <h1>Produtos / MP</h1>
    <div class="mb-3">
      <button class="btn btn-primary me-2" onclick="openFormProduto()">
        <i class="fas fa-plus"></i> Adicionar Produto Simples
      </button>
      <button class="btn btn-success me-2" onclick="openFormProdutoComposto()">
        <i class="fas fa-layer-group"></i> Criar Produto Composto
      </button>
      <button class="btn btn-warning me-2" onclick="openFormProdutoParametrizado()">
        <i class="fas fa-calculator"></i> Produto Parametrizado
      </button>
      <button class="btn btn-info" onclick="openCreateFromExisting()">
        <i class="fas fa-clone"></i> Criar Baseado em Produto Existente
      </button>
    </div>
    
    <!-- Filtros -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="row">
          <div class="col-md-4">
            <label for="filtroDescricao" class="form-label">Filtrar por Descrição:</label>
            <input type="text" class="form-control" id="filtroDescricao" placeholder="Digite para filtrar..." onkeyup="aplicarFiltros()">
          </div>
          <div class="col-md-3">
            <label for="filtroTipo" class="form-label">Tipo:</label>
            <select class="form-select" id="filtroTipo" onchange="aplicarFiltros()">
              <option value="">Todos</option>
              <option value="Simples">Simples</option>
              <option value="Composto">Composto</option>
              <option value="Parametrizado">Parametrizado</option>
              <option value="Resina">Apenas Resinas</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="filtroReferencia" class="form-label">Referência:</label>
            <select class="form-select" id="filtroReferencia" onchange="aplicarFiltros()">
              <option value="">Todas</option>
              <option value="Votorantim">Votorantim</option>
              <option value="Gerdau">Gerdau</option>
              <option value="ArcelorMittal">ArcelorMittal</option>
              <option value="CSN">CSN</option>
              <option value="Usiminas">Usiminas</option>
              <option value="Belgo">Belgo</option>
              <option value="Aperam">Aperam</option>
              <option value="Nippon">Nippon</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <button type="button" class="btn btn-outline-secondary d-block w-100" onclick="limparFiltros()">
              <i class="fas fa-times"></i> Limpar
            </button>
          </div>
        </div>
      </div>
    </div>
    <table class="table table-bordered" id="produtos-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Descrição</th>
                <th>Tipo</th>
                <th>Custo</th>
                <th>Peso (Kg)</th>
                <th>Unidade</th>
                <th>Referência</th>
                <th>Data Revisão</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
  </div>
</div>

<!-- Modal Produto -->
<div class="modal" tabindex="-1" id="produtoModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitleProduto">Adicionar Produto</h5>
        <button type="button" class="btn-close" onclick="closeFormProduto()"></button>
      </div>
      <div class="modal-body">
        <form id="produtoForm">
          <input type="hidden" id="produtoId">
          <input type="hidden" id="isDuplicate">
          
          <!-- Alert para duplicação -->
          <div id="duplicateAlert" class="alert alert-info d-none" role="alert">
            <i class="fas fa-info-circle"></i> Você está criando uma cópia de um produto existente. Modifique os dados conforme necessário.
          </div>
          
          <div class="mb-3">
            <label for="descricao" class="form-label">Descrição</label>
            <input type="text" class="form-control" id="descricao" required>
          </div>
          <div class="mb-3">
            <label for="custo_centavos" class="form-label">Custo (R$)</label>
            <input type="text" class="form-control" id="custo_centavos" required pattern="^\d+(,\d{2})?$" placeholder="Ex: 12,34">
          </div>
          <div class="mb-3">
            <label for="peso_und" class="form-label">Peso UND</label>
            <input type="number" step="0.000001" class="form-control" id="peso_und" required>
          </div>
          <div class="mb-3">
            <label for="unidade" class="form-label">Unidade</label>
            <select class="form-select" id="unidade" required>
              <option value="">Selecione</option>
              <option value="UN">UN</option>
              <option value="M">M</option>
              <option value="M²">M²</option>
              <option value="CM">CM</option>
              <option value="KG">KG</option>
              <option value="L">L</option>
              <option value="PÇ">PÇ</option>
              <option value="CX">CX</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="referencia" class="form-label">Referência</label>
            <select class="form-select" id="referencia">
              <option value="">Selecione</option>
              <option value="Votorantim">Votorantim</option>
              <option value="Gerdau">Gerdau</option>
              <option value="ArcelorMittal">ArcelorMittal</option>
              <option value="CSN">CSN</option>
              <option value="Usiminas">Usiminas</option>
              <option value="Belgo">Belgo</option>
              <option value="Aperam">Aperam</option>
              <option value="Nippon">Nippon</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeFormProduto()">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="submitFormProduto()">Salvar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Seleção de Produto Base -->
<div class="modal" tabindex="-1" id="selectProductModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Selecionar Produto Base</h5>
        <button type="button" class="btn-close" onclick="closeSelectProductModal()"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">Selecione um produto existente para usar como base para o novo produto:</p>
        
        <!-- Campo de busca -->
        <div class="mb-3">
          <input type="text" class="form-control" id="searchProduct" placeholder="Digite para filtrar produtos..." onkeyup="filterProducts()">
        </div>
        
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
          <table class="table table-hover">
            <thead class="table-light sticky-top">
              <tr>
                <th>ID</th>
                <th>Descrição</th>
                <th>Custo</th>
                <th>Unidade</th>
                <th>Referência</th>
                <th>Ação</th>
              </tr>
            </thead>
            <tbody id="selectProductTableBody">
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeSelectProductModal()">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Produto Parametrizado -->
<div class="modal fade" id="produtoParametrizadoModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Criar Produto Parametrizado</h5>
        <button type="button" class="btn-close" onclick="closeProdutoParametrizadoModal()"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- Seleção de Template -->
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">1. Selecione o Tipo</h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <select class="form-select" id="templateSelect" onchange="carregarTemplate()">
                    <option value="">Escolha um template...</option>
                  </select>
                </div>
                <div id="templateDescription" class="text-muted small"></div>
              </div>
            </div>
          </div>
          
          <!-- Parâmetros -->
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">2. Parâmetros</h6>
              </div>
              <div class="card-body" id="parametrosContainer">
                <p class="text-muted">Selecione um template primeiro</p>
              </div>
            </div>
          </div>
          
          <!-- Resultado -->
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">3. Resultado</h6>
              </div>
              <div class="card-body" id="resultadoContainer">
                <p class="text-muted">Configure os parâmetros para ver o resultado</p>
                <div id="resultadoCalculado" style="display: none;">
                  <div class="mb-3">
                    <strong>Produto Base:</strong> <span id="nomeProdutoCalculado"></span>
                  </div>
                  <div class="mb-2">
                    <strong>Custo Total:</strong> <span id="custoTotalCalculado" class="text-success"></span>
                  </div>
                  <div class="mb-2">
                    <strong>Peso Total:</strong> <span id="pesoTotalCalculado"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Componentes calculados -->
        <div class="row mt-3">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">Componentes Calculados</h6>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Material/Serviço</th>
                        <th>Descrição do Produto</th>
                        <th>Fator %</th>
                        <th>Quantidade</th>
                        <th>Custo Unitário</th>
                        <th>Custo Total</th>
                        <th>Ação</th>
                      </tr>
                    </thead>
                    <tbody id="componentesCalculadosTable">
                      <tr>
                        <td colspan="7" class="text-center text-muted">Nenhum cálculo realizado</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeProdutoParametrizadoModal()">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="salvarProdutoParametrizado()" disabled id="salvarProdutoBtn">
          <i class="fas fa-save"></i> Salvar na Base
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Produto Composto -->
<div class="modal fade" id="produtoCompostoModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitleProdutoComposto">Criar Produto Composto</h5>
        <button type="button" class="btn-close" onclick="closeProdutoCompostoModal()"></button>
      </div>
      <div class="modal-body">
        <form id="produtoCompostoForm">
          <input type="hidden" id="produtoCompostoId">
          
          <!-- Informações básicas do produto -->
          <div class="row mb-3">
            <div class="col-md-8">
              <label for="descricaoComposto" class="form-label">Descrição do Produto Composto *</label>
              <input type="text" class="form-control" id="descricaoComposto" required 
                     placeholder="Ex: Kit de Montagem de Estrutura Completa">
            </div>
            <div class="col-md-4">
              <label for="referenciaComposto" class="form-label">Referência</label>
              <input type="text" class="form-control" id="referenciaComposto" placeholder="Referência personalizada">
            </div>
          </div>
          
          <!-- Seção de componentes -->
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">Componentes do Produto</h6>
            </div>
            <div class="card-body">
              <!-- Adicionar componente -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="componenteProduto" class="form-label">Produto</label>
                  <select class="form-select" id="componenteProduto">
                    <option value="">Selecione um produto...</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="componenteQuantidade" class="form-label">Quantidade</label>
                  <input type="number" step="0.01" class="form-control" id="componenteQuantidade" min="0.01" placeholder="1.00">
                </div>
                <div class="col-md-3">
                  <label class="form-label">&nbsp;</label>
                  <button type="button" class="btn btn-success d-block w-100" onclick="adicionarComponente()">
                    <i class="fas fa-plus"></i> Adicionar
                  </button>
                </div>
              </div>
              
              <!-- Lista de componentes -->
              <div class="table-responsive">
                <table class="table table-striped" id="componentesTable">
                  <thead>
                    <tr>
                      <th>Produto</th>
                      <th>Quantidade</th>
                      <th>Custo Unitário</th>
                      <th>Custo Total</th>
                      <th>Ação</th>
                    </tr>
                  </thead>
                  <tbody id="componentesTableBody">
                    <tr id="noComponentsRow">
                      <td colspan="5" class="text-center text-muted">Nenhum componente adicionado</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <!-- Resumo de custos -->
              <div class="row mt-3">
                <div class="col-md-6 offset-md-6">
                  <div class="card">
                    <div class="card-body">
                      <div class="row">
                        <div class="col-6"><strong>Custo Total:</strong></div>
                        <div class="col-6 text-end"><span id="custoTotalComposto">R$ 0,00</span></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeProdutoCompostoModal()">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="salvarProdutoComposto()">Salvar Produto Composto</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const apiProdutos = '/api/produtos/';
const apiComponentes = '/api/componentes/';
const apiTemplates = '/api/templates/';
const apiCalcular = '/calcular-produto/';
let produtoModal = null;
let selectProductModal = null;
let produtoCompostoModal = null;
let produtoParametrizadoModal = null;
let allProducts = []; // Cache dos produtos para filtragem
let allProductsOriginal = []; // Cache original sem filtro
let componentesTemp = []; // Array temporário para componentes
let templateAtual = null;
let templatesCache = [];
let ultimoCalculo = null;

// Função global para obter CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

if(document.getElementById('produtoModal')) produtoModal = new bootstrap.Modal(document.getElementById('produtoModal'));
if(document.getElementById('selectProductModal')) selectProductModal = new bootstrap.Modal(document.getElementById('selectProductModal'));
if(document.getElementById('produtoCompostoModal')) produtoCompostoModal = new bootstrap.Modal(document.getElementById('produtoCompostoModal'));
if(document.getElementById('produtoParametrizadoModal')) produtoParametrizadoModal = new bootstrap.Modal(document.getElementById('produtoParametrizadoModal'));

// PRODUTOS CRUD
function fetchProdutos() {
    console.log('Fazendo fetch de produtos na URL:', apiProdutos);
    fetch(apiProdutos)
        .then(res => {
            console.log('Resposta da API:', res.status, res.statusText);
            return res.json();
        })
        .then(data => {
            console.log('Dados recebidos:', data);
            console.log('Total de produtos:', data.length);
            allProductsOriginal = data.map(produto => ({
                ...produto,
                tipo: produto.is_composto ? 'Composto' : 'Simples'
            }));
            displayProductsInTable(allProductsOriginal);
        })
        .catch(error => {
            console.error('Erro ao carregar produtos:', error);
            alert('Erro ao carregar produtos: ' + error.message);
        });
}

function displayProductsInTable(produtos) {
    const tbody = document.querySelector('#produtos-table tbody');
    tbody.innerHTML = '';
    
  produtos.forEach(async produto => {
    let tipo = produto.tipo || 'Simples';
    let tipoClass = tipo === 'Composto' ? 'badge bg-success' : (tipo === 'Parametrizado' ? 'badge bg-warning' : 'badge bg-primary');
    let custo_reais = 'R$ 0,00';
    let pesoFormatado = Number(produto.peso_und).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});

    if (tipo === 'Composto') {
      // Para produtos compostos, usar o custo salvo no produto principal
      // (que já foi calculado corretamente baseado nos componentes)
      let centavos = Number(produto.custo_centavos);
      let reais = !isNaN(centavos) ? centavos / 100 : 0;
      custo_reais = 'R$ ' + reais.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    } else if (tipo === 'Parametrizado') {
      // Se possível, calcular custo dos componentes calculados
      if (produto.detalhes_calculo && produto.detalhes_calculo.custo_total) {
        custo_reais = 'R$ ' + Number(produto.detalhes_calculo.custo_total).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      } else {
        let centavos = Number(produto.custo_centavos);
        let reais = !isNaN(centavos) ? centavos / 100 : 0;
        custo_reais = 'R$ ' + reais.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      }
    } else {
      let centavos = Number(produto.custo_centavos);
      let reais = !isNaN(centavos) ? centavos / 100 : 0;
      custo_reais = 'R$ ' + reais.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    let actionButtons = '';
    if (tipo === 'Simples') {
      actionButtons = `
        <button class="btn btn-info btn-sm me-1" onclick="duplicateProduto(${produto.id})" title="Duplicar Produto">
          <i class="fas fa-copy"></i>
        </button>
        <button class="btn btn-warning btn-sm me-1" onclick="editProduto(${produto.id})">Editar</button>
      `;
    } else {
      actionButtons = `
        <button class="btn btn-info btn-sm me-1" onclick="verComponentes(${produto.id})" title="Ver Componentes">
          <i class="fas fa-list"></i>
        </button>
        <button class="btn btn-warning btn-sm me-1" onclick="editProdutoComposto(${produto.id})">Editar</button>
      `;
    }
    actionButtons += `<button class="btn btn-danger btn-sm" onclick="deleteProduto(${produto.id})">Excluir</button>`;

    tbody.innerHTML += `
      <tr>
        <td class="text-center">${produto.id}</td>
        <td>${produto.descricao}</td>
        <td class="text-center"><span class="${tipoClass}">${tipo}</span></td>
        <td class="text-end">${custo_reais}</td>
        <td class="text-end">${pesoFormatado}</td>
        <td class="text-center">${produto.unidade}</td>
        <td>${produto.referencia || ''}</td>
        <td class="text-center">${produto.data_revisao || ''}</td>
        <td class="text-center">
          ${actionButtons}
        </td>
      </tr>
    `;
  });
}
function openFormProduto(id=null, isDuplicate=false) {
    document.getElementById('produtoForm').reset();
    document.getElementById('produtoId').value = '';
    document.getElementById('isDuplicate').value = isDuplicate ? 'true' : 'false';
    document.getElementById('modalTitleProduto').innerText = 'Adicionar Produto';
    
    // Ocultar ou mostrar alert de duplicação
    const duplicateAlert = document.getElementById('duplicateAlert');
    if (isDuplicate) {
        duplicateAlert.classList.remove('d-none');
        document.getElementById('modalTitleProduto').innerText = 'Duplicar Produto';
    } else {
        duplicateAlert.classList.add('d-none');
    }
    
    if (id) {
        fetch(apiProdutos + id + '/')
            .then(res => res.json())
            .then(produto => {
                if (!isDuplicate) {
                    document.getElementById('produtoId').value = produto.id;
                    document.getElementById('modalTitleProduto').innerText = 'Editar Produto';
                } else {
                    // Para duplicação, limpar o ID para criar novo produto
                    document.getElementById('produtoId').value = '';
                    // Adicionar prefixo na descrição para indicar cópia
                    document.getElementById('descricao').value = 'CÓPIA - ' + produto.descricao;
                }
                
                if (isDuplicate) {
                    document.getElementById('descricao').value = 'CÓPIA - ' + produto.descricao;
                } else {
                    document.getElementById('descricao').value = produto.descricao;
                }
                
                document.getElementById('custo_centavos').value = produto.custo_centavos;
                document.getElementById('peso_und').value = produto.peso_und;
                document.getElementById('unidade').value = produto.unidade;
                document.getElementById('referencia').value = produto.referencia || '';
                
                // Para duplicação, não preencher data de revisão (será gerada nova)
                if (!isDuplicate) {
                    document.getElementById('data_revisao').value = produto.data_revisao || '';
                }
            });
    }
    produtoModal.show();
}
function closeFormProduto() {
    produtoModal.hide();
}
function submitFormProduto() {
    const id = document.getElementById('produtoId').value;
    const isDuplicate = document.getElementById('isDuplicate').value === 'true';
    const descricao = document.getElementById('descricao').value;
    
    // Converte valor monetário para centavos
    let custo_valor = document.getElementById('custo_centavos').value.replace('.', '').replace(',', '.');
    let custo_centavos = Math.round(parseFloat(custo_valor) * 100);
    const peso_und = document.getElementById('peso_und').value;
    const unidade = document.getElementById('unidade').value;
    const referencia = document.getElementById('referencia').value;
    
    // Gera data/hora atual no formato ISO para o campo data_revisao
    const now = new Date();
    const data_revisao = now.toISOString();
    
    // Se é duplicação, sempre criar novo (POST), mesmo que tenha ID
    const method = (id && !isDuplicate) ? 'PUT' : 'POST';
    const url = (id && !isDuplicate) ? apiProdutos + id + '/' : apiProdutos;
    
    const csrftoken = getCookie('csrftoken');
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({descricao, custo_centavos, peso_und, unidade, referencia, data_revisao})
    })
    .then(res => {
        if (res.ok) {
            closeFormProduto();
            fetchProdutos();
            if (isDuplicate) {
                // Mostrar mensagem de sucesso para duplicação
                alert('Produto duplicado com sucesso!');
            }
        } else {
            res.json().then(data => alert('Erro: ' + JSON.stringify(data)));
        }
    });
}

function duplicateProduto(id) {
    openFormProduto(id, true);
}

// Funções para modal de seleção de produto base
function openCreateFromExisting() {
    populateSelectProductModal();
    selectProductModal.show();
}

function closeSelectProductModal() {
    selectProductModal.hide();
    document.getElementById('searchProduct').value = '';
}

function populateSelectProductModal() {
    fetch(apiProdutos)
        .then(res => res.json())
        .then(data => {
            allProducts = data; // Armazenar produtos para filtro
            displayProducts(data);
        })
        .catch(error => {
            console.error('Erro ao carregar produtos:', error);
            alert('Erro ao carregar produtos. Tente novamente.');
        });
}

function displayProducts(produtos) {
    const tbody = document.getElementById('selectProductTableBody');
    tbody.innerHTML = '';
    
    if (produtos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum produto encontrado</td></tr>';
        return;
    }
    
    produtos.forEach(produto => {
        let centavos = Number(produto.custo_centavos);
        let reais = !isNaN(centavos) ? centavos / 100 : 0;
        let custo_reais = 'R$ ' + reais.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        tbody.innerHTML += `
            <tr>
                <td>${produto.id}</td>
                <td>${produto.descricao}</td>
                <td>${custo_reais}</td>
                <td>${produto.unidade}</td>
                <td>${produto.referencia || '-'}</td>
                <td>
                    <button class="btn btn-success btn-sm" onclick="selectProductAsBase(${produto.id})" title="Usar como Base">
                        <i class="fas fa-check"></i> Usar como Base
                    </button>
                </td>
            </tr>
        `;
    });
}

function filterProducts() {
    const searchTerm = document.getElementById('searchProduct').value.toLowerCase();
    const filteredProducts = allProducts.filter(produto => 
        produto.descricao.toLowerCase().includes(searchTerm) ||
        (produto.referencia && produto.referencia.toLowerCase().includes(searchTerm)) ||
        produto.id.toString().includes(searchTerm)
    );
    displayProducts(filteredProducts);
}

function selectProductAsBase(id) {
    closeSelectProductModal();
    openFormProduto(id, true);
}

// Funções para filtros
function aplicarFiltros() {
    const filtroDescricao = document.getElementById('filtroDescricao').value.toLowerCase();
    const filtroTipo = document.getElementById('filtroTipo').value;
    const filtroReferencia = document.getElementById('filtroReferencia').value;
    
    let produtosFiltrados = allProductsOriginal.filter(produto => {
        const matchDescricao = !filtroDescricao || produto.descricao.toLowerCase().includes(filtroDescricao);
        
        let matchTipo = true;
        if (filtroTipo) {
            if (filtroTipo === 'Resina') {
                matchTipo = produto.descricao.toLowerCase().includes('resina');
            } else {
                matchTipo = produto.tipo === filtroTipo;
            }
        }
        
        const matchReferencia = !filtroReferencia || produto.referencia === filtroReferencia;
        
        return matchDescricao && matchTipo && matchReferencia;
    });
    
    console.log(`Filtros aplicados: Descrição="${filtroDescricao}", Tipo="${filtroTipo}", Referência="${filtroReferencia}"`);
    console.log(`Produtos filtrados: ${produtosFiltrados.length} de ${allProductsOriginal.length}`);
    
    displayProductsInTable(produtosFiltrados);
}

function limparFiltros() {
    document.getElementById('filtroDescricao').value = '';
    document.getElementById('filtroTipo').value = '';
    document.getElementById('filtroReferencia').value = '';
    displayProductsInTable(allProductsOriginal);
}

// Funções para produto composto
function openFormProdutoComposto() {
    componentesTemp = [];
    document.getElementById('produtoCompostoForm').reset();
    document.getElementById('produtoCompostoId').value = '';
    carregarProdutosParaSelect();
    atualizarTabelaComponentes();
    produtoCompostoModal.show();
}

function closeProdutoCompostoModal() {
  produtoCompostoModal.hide();
  fetchProdutos();
}

function carregarProdutosParaSelect() {
    const select = document.getElementById('componenteProduto');
    select.innerHTML = '<option value="">Selecione um produto...</option>';
    
    allProductsOriginal
        .filter(produto => produto.tipo === 'Simples') // Apenas produtos simples como componentes
        .forEach(produto => {
            const option = document.createElement('option');
            option.value = produto.id;
            option.textContent = `${produto.descricao} - R$ ${(produto.custo_centavos / 100).toFixed(2)}`;
            select.appendChild(option);
        });
}

function adicionarComponente() {
    const produtoId = document.getElementById('componenteProduto').value;
    const quantidade = parseFloat(document.getElementById('componenteQuantidade').value);
    
    if (!produtoId || !quantidade || quantidade <= 0) {
        alert('Selecione um produto e informe uma quantidade válida!');
        return;
    }
    
    // Verificar se o produto já foi adicionado
    if (componentesTemp.find(c => c.produto_id == produtoId)) {
        alert('Este produto já foi adicionado aos componentes!');
        return;
    }
    
    const produto = allProductsOriginal.find(p => p.id == produtoId);
    if (!produto) {
        alert('Produto não encontrado!');
        return;
    }
    
    const componente = {
        produto_id: produtoId,
        produto_descricao: produto.descricao,
        quantidade: quantidade,
        custo_unitario: produto.custo_centavos / 100,
        custo_total: (produto.custo_centavos / 100) * quantidade
    };
    
    componentesTemp.push(componente);
    atualizarTabelaComponentes();
    
    // Limpar campos
    document.getElementById('componenteProduto').value = '';
    document.getElementById('componenteQuantidade').value = '';
}

function removerComponente(index) {
    componentesTemp.splice(index, 1);
    atualizarTabelaComponentes();
}

function atualizarTabelaComponentes() {
    const tbody = document.getElementById('componentesTableBody');
    const noComponentsRow = document.getElementById('noComponentsRow');
    
    if (componentesTemp.length === 0) {
        tbody.innerHTML = '<tr id="noComponentsRow"><td colspan="5" class="text-center text-muted">Nenhum componente adicionado</td></tr>';
        document.getElementById('custoTotalComposto').textContent = 'R$ 0,00';
        return;
    }
    
    let html = '';
    let custoTotal = 0;
    
    componentesTemp.forEach((comp, index) => {
        custoTotal += comp.custo_total;
        html += `
            <tr>
                <td>${comp.produto_descricao}</td>
                <td>${comp.quantidade.toFixed(2)}</td>
                <td>R$ ${comp.custo_unitario.toFixed(2)}</td>
                <td>R$ ${comp.custo_total.toFixed(2)}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="removerComponente(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    document.getElementById('custoTotalComposto').textContent = `R$ ${custoTotal.toFixed(2)}`;
}

function salvarProdutoComposto() {
    const descricao = document.getElementById('descricaoComposto').value;
    const referencia = document.getElementById('referenciaComposto').value;
    
    if (!descricao.trim()) {
        alert('Informe a descrição do produto composto!');
        return;
    }
    
    if (componentesTemp.length === 0) {
        alert('Adicione pelo menos um componente ao produto!');
        return;
    }
    
  // Calcular custo total em centavos
  const custoTotal = componentesTemp.reduce((total, comp) => total + comp.custo_total, 0);
  const custoCentavos = Math.round(custoTotal * 100);

  // Gerar data de revisão no formato ISO
  const now = new Date();
  const data_revisao = now.toISOString();

  const produtoId = document.getElementById('produtoCompostoId').value;
  const produtoData = {
    descricao: descricao,
    custo_centavos: custoCentavos,
    peso_und: 0, // Peso pode ser calculado se necessário
    unidade: 'UN', // Padrão para produtos compostos
    referencia: referencia || '',
    data_revisao: data_revisao,
    tipo_produto: 'composto'
  };

  let method = 'POST';
  let url = apiProdutos;
  if (produtoId) {
    method = 'PUT';
    url = apiProdutos + produtoId + '/';
  }

  fetch(url, {
    method: method,
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(produtoData)
  })
  .then(res => res.json())
  .then(produto => {
    if (produto.id) {
      // Excluir componentes antigos se for edição
      let compDeletePromise = Promise.resolve();
      if (produtoId) {
        compDeletePromise = fetch(apiComponentes + '?produto_principal=' + produtoId)
          .then(res => res.json())
          .then(componentesAntigos => {
            return Promise.all(componentesAntigos.map(comp =>
              fetch(apiComponentes + '/' + comp.id + '/', {method: 'DELETE'})
            ));
          });
      }
      compDeletePromise.then(() => {
        // Salvar componentes novos
        const componentesPromises = componentesTemp.map(comp => {
          return fetch(apiComponentes, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              produto_principal: produto.id,
              produto_componente: comp.produto_id,
              quantidade: comp.quantidade
            })
          });
        });
        Promise.all(componentesPromises)
          .then(() => {
            closeProdutoCompostoModal();
            fetchProdutos();
            alert(produtoId ? 'Produto composto editado com sucesso!' : 'Produto composto criado com sucesso!');
          });
      });
    } else {
      alert('Erro ao criar/editar produto: ' + JSON.stringify(produto));
    }
  })
  .catch(error => {
    console.error('Erro ao salvar produto:', error);
    alert('Erro ao salvar produto!');
  });
}
function editProduto(id) {
    openFormProduto(id);
}
function deleteProduto(id) {
    if (confirm('Tem certeza que deseja excluir este produto?')) {
        fetch(apiProdutos + id + '/', {method: 'DELETE'})
            .then(res => {
                if (res.ok) fetchProdutos();
                else alert('Erro ao excluir!');
            });
    }
}

// Função para ver componentes de um produto composto
function verComponentes(produtoId) {
    fetch(`${apiComponentes}?produto_pai=${produtoId}`)
        .then(res => res.json())
        .then(componentes => {
            if (componentes.length === 0) {
                alert('Este produto não possui componentes cadastrados.');
                return;
            }
            
            let detalhes = 'Componentes do produto:\n\n';
            let custoTotal = 0;
            
            componentes.forEach(comp => {
                const produto = allProductsOriginal.find(p => p.id === comp.produto_componente);
                if (produto) {
                    const custoUnitario = produto.custo_centavos / 100;
                    const custoItem = custoUnitario * comp.quantidade;
                    custoTotal += custoItem;
                    
                    detalhes += `• ${produto.descricao}\n`;
                    detalhes += `  Quantidade: ${comp.quantidade}\n`;
                    detalhes += `  Custo unitário: R$ ${custoUnitario.toFixed(2)}\n`;
                    detalhes += `  Custo total: R$ ${custoItem.toFixed(2)}\n\n`;
                }
            });
            
            detalhes += `Custo total do produto: R$ ${custoTotal.toFixed(2)}`;
            alert(detalhes);
        })
        .catch(error => {
            console.error('Erro ao carregar componentes:', error);
            alert('Erro ao carregar componentes do produto.');
        });
}

// Função para editar produto composto (simplificada)
function editProdutoComposto(id) {
  // Buscar dados do produto composto
  fetch(apiProdutos + id + '/')
    .then(res => res.json())
    .then(produto => {
      // Abrir modal e preencher dados
      document.getElementById('produtoCompostoForm').reset();
      document.getElementById('produtoCompostoId').value = produto.id;
      document.getElementById('descricaoComposto').value = produto.descricao;
      document.getElementById('referenciaComposto').value = produto.referencia || '';
      document.getElementById('modalTitleProdutoComposto').innerText = 'Editar Produto Composto';
      // Buscar componentes
      fetch(apiComponentes + '?produto_principal=' + produto.id)
        .then(res => res.json())
        .then(componentes => {
          componentesTemp = [];
          componentes.forEach(comp => {
            const produtoComp = allProductsOriginal.find(p => p.id == comp.produto_componente);
            if (produtoComp) {
              let custoUnitario = produtoComp.custo_centavos / 100;
              let custoTotal = custoUnitario * parseFloat(comp.quantidade);
              let descricaoComponente = produtoComp.descricao;
              
              // Tentar extrair custos calculados da observação
              if (comp.observacao) {
                try {
                  const custosCalculados = JSON.parse(comp.observacao);
                  if (custosCalculados.custo_unitario && custosCalculados.custo_total) {
                    custoUnitario = custosCalculados.custo_unitario / 100;
                    custoTotal = custosCalculados.custo_total / 100;
                    if (custosCalculados.nome_componente) {
                      descricaoComponente = custosCalculados.nome_componente;
                    }
                    console.log(`✅ Custos recuperados da observação para ${descricaoComponente}: Unit: R$ ${custoUnitario.toFixed(2)}, Total: R$ ${custoTotal.toFixed(2)}`);
                  }
                } catch (e) {
                  console.warn(`⚠️ Erro ao parsear observação do componente ${comp.id}:`, e);
                }
              }
              
              componentesTemp.push({
                produto_id: produtoComp.id,
                produto_descricao: descricaoComponente,
                quantidade: parseFloat(comp.quantidade),
                custo_unitario: custoUnitario,
                custo_total: custoTotal
              });
            }
          });
          carregarProdutosParaSelect();
          atualizarTabelaComponentes();
          produtoCompostoModal.show();
        });
    });
}

function carregarInterfaceNovoPerfil() {
    console.log('=== CARREGANDO INTERFACE NOVO PERFIL ===');
    
    // Limpar estado anterior
    templateAtual = { id: 'perfil_customizado', tipo: 'perfil' };
    ultimoCalculo = null;
    
    // Mostrar descrição
    document.getElementById('templateDescription').innerHTML = `
        <h6 class="text-primary">Novo Perfil</h6>
        <small class="text-muted">Categoria: PRODUTO_FINAL</small>
    `;
    
    // Criar APENAS os 11 campos solicitados
    const parametrosContainer = document.getElementById('parametrosContainer');
    parametrosContainer.innerHTML = `
        <div class="mb-3">
            <label for="perfil_nome" class="form-label">Nome perfil *</label>
            <input type="text" class="form-control param-input" id="perfil_nome" name="nome_perfil" required>
        </div>
        
        <div class="mb-3">
            <label for="perfil_roving" class="form-label">Roving 4400 KG *</label>
            <input type="number" step="0.001" class="form-control param-input" id="perfil_roving" name="roving_4400_kg" required>
        </div>
        
        <div class="mb-3">
            <label for="perfil_manta" class="form-label">Manta 300 KG *</label>
            <input type="number" step="0.001" class="form-control param-input" id="perfil_manta" name="manta_300_kg" required>
        </div>
        
        <div class="mb-3">
            <label for="perfil_veu" class="form-label">Véu KG *</label>
            <input type="number" step="0.001" class="form-control param-input" id="perfil_veu" name="veu_kg" required>
        </div>
        
        <div class="mb-3">
            <label for="perfil_peso_metro" class="form-label">Peso/m kg *</label>
            <input type="number" step="0.001" class="form-control param-input" id="perfil_peso_metro" name="peso_metro_kg" required>
        </div>
        
        <div class="mb-3">
            <label for="perfil_n_matrizes" class="form-label">N matrizes *</label>
            <input type="number" class="form-control param-input" id="perfil_n_matrizes" name="n_matrizes" required min="1">
        </div>
        
        <div class="mb-3">
            <label for="perfil_n_maquinas" class="form-label">N máquinas *</label>
            <input type="number" class="form-control param-input" id="perfil_n_maquinas" name="n_maquinas" required min="1">
        </div>
        
        <div class="mb-3">
            <label for="perfil_metros_h" class="form-label">Metro produzidos/h *</label>
            <input type="number" step="0.1" class="form-control param-input" id="perfil_metros_h" name="metros_produzidos_h" required>
        </div>
        
        <div class="mb-3">
            <label for="perfil_perda" class="form-label">% de perda *</label>
            <input type="number" step="0.1" class="form-control param-input" id="perfil_perda" name="percentual_perda" required min="0" max="100">
        </div>
        
        <div class="mb-3">
            <label for="perfil_tipo_resina" class="form-label">Tipo de Resina *</label>
            <select class="form-select param-input" id="perfil_tipo_resina" name="tipo_resina" required>
                <option value="">Carregando resinas...</option>
            </select>
        </div>
        
        <div class="mb-3">
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="perfil_pintura" name="tem_pintura" onchange="toggleAreaPintura()">
                <label for="perfil_pintura" class="form-check-label">Pintura?</label>
            </div>
        </div>
        
        <div class="mb-3" id="perfil_area_pintura_container" style="display: none;">
            <label for="perfil_area_pintura" class="form-label">Área pintura (m²) *</label>
            <input type="number" step="0.01" class="form-control param-input" id="perfil_area_pintura" name="area_pintura_m2">
        </div>
        
        <div class="mt-3 text-center">
            <button type="button" class="btn btn-primary" onclick="calcularProdutoParametrizado()" id="calcularBtn">
                <i class="fas fa-calculator"></i> Calcular
            </button>
        </div>
    `;
    
    // Carregar tipos de resina disponíveis
    carregarTiposResina();
    
    console.log('Interface Novo Perfil carregada com 12 campos (incluindo tipo de resina)');
}

function carregarTiposResina() {
    console.log('=== CARREGANDO TIPOS DE RESINA ===');
    
    const selectResina = document.getElementById('perfil_tipo_resina');
    if (!selectResina) {
        console.warn('Select de resina não encontrado');
        return;
    }
    
    // Buscar tipos de resina via API
    fetch('/api/tipos-resina/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.resinas) {
                console.log(`✅ ${data.resinas.length} tipos de resina carregados`);
                
                // Limpar opções atuais
                selectResina.innerHTML = '<option value="">Selecione uma resina...</option>';
                
                // Adicionar opções das resinas
                data.resinas.forEach(resina => {
                    const option = document.createElement('option');
                    option.value = resina.id;
                    option.textContent = `${resina.descricao} - R$ ${resina.custo_reais.toFixed(2)}`;
                    selectResina.appendChild(option);
                    
                    console.log(`   • ${resina.descricao}: R$ ${resina.custo_reais.toFixed(2)}`);
                });
                
                // Selecionar Resina Poliéster como padrão (ID 1269)
                selectResina.value = '1269';
                
            } else {
                throw new Error(data.error || 'Erro desconhecido');
            }
        })
        .catch(error => {
            console.error('❌ Erro ao carregar tipos de resina:', error);
            
            // Fallback: adicionar opções básicas
            selectResina.innerHTML = `
                <option value="">Erro ao carregar resinas</option>
                <option value="1269">Resina Poliéster (padrão)</option>
                <option value="1268">Resina Isoftálica</option>
                <option value="1270">Resina Éster Vinílica</option>
            `;
            selectResina.value = '1269';
        });
}

function carregarInterfaceGrades() {
    console.log('=== CARREGANDO INTERFACE GRADES ===');
    
    // Limpar estado anterior
    templateAtual = { id: 'grades_customizado', tipo: 'grades' };
    ultimoCalculo = null;
    
    // Definir valor do select
    document.getElementById('templateSelect').value = 'grades_customizado';
    
    // Mostrar descrição
    document.getElementById('templateDescription').innerHTML = `
        <h6 class="text-primary">Grades</h6>
        <small class="text-muted">Categoria: ESTRUTURAS</small>
        <p class="mt-2 text-info small">
            <strong>Fórmula:</strong> (((comprimento/eixo i)*vão/1000)* peso do perfil)
        </p>
    `;
    
    // Criar campos específicos para grades
    const parametrosContainer = document.getElementById('parametrosContainer');
    parametrosContainer.innerHTML = `
        <div class="mb-3">
            <label for="grade_nome" class="form-label">Nome da Grade *</label>
            <input type="text" class="form-control param-input" id="grade_nome" name="nome_grade" required>
        </div>
        
        <div class="mb-3">
            <label for="grade_vao" class="form-label">Vão (mm) *</label>
            <input type="number" step="0.1" class="form-control param-input" id="grade_vao" name="vao" required min="0">
            <div class="form-text">Distância entre apoios em milímetros</div>
        </div>
        
        <div class="mb-3">
            <label for="grade_comprimento" class="form-label">Comprimento (mm) *</label>
            <input type="number" step="0.1" class="form-control param-input" id="grade_comprimento" name="comprimento" required min="0">
            <div class="form-text">Comprimento total da grade em milímetros</div>
        </div>
        
        <div class="mb-3">
            <label for="grade_eixo_i" class="form-label">Eixo I (mm) *</label>
            <input type="number" step="0.1" class="form-control param-input" id="grade_eixo_i" name="eixo_i" required min="0">
            <div class="form-text">Espaçamento entre perfis em milímetros</div>
        </div>
        
        <div class="mb-3">
            <label for="grade_perfil" class="form-label">Selecione o Perfil *</label>
            <select class="form-select param-input" id="grade_perfil" name="perfil_id" required>
                <option value="">Carregando perfis...</option>
            </select>
            <div class="form-text">Perfil que será utilizado na estrutura</div>
        </div>
        
        <div class="mb-3">
            <label for="grade_perda" class="form-label">Perda (%)</label>
            <input type="number" step="0.1" class="form-control param-input" id="grade_perda" name="perda" value="10" min="0" max="100">
            <div class="form-text">Percentual de perda do material (padrão: 5%)</div>
        </div>
        
        <!-- Seção de Mão de Obra -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-tools"></i> Mão de Obra</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="grade_tempo_proc" class="form-label">Tempo PROC (h)</label>
                        <input type="number" step="0.1" class="form-control param-input" id="grade_tempo_proc" name="tempo_proc" value="0.7" min="0">
                        <div class="form-text">Tempo de processamento em horas</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="grade_tempo_mtg" class="form-label">Tempo MTG (h)</label>
                        <input type="number" step="0.1" class="form-control param-input" id="grade_tempo_mtg" name="tempo_mtg" value="0.3" min="0">
                        <div class="form-text">Tempo de montagem em horas</div>
                    </div>
                </div>
                <div class="alert alert-info">
                    <small><i class="fas fa-info-circle"></i> Mão de Obra: Processamento/Montagem - R$ 65,79/hora</small>
                </div>
            </div>
        </div>
        
        <div class="mt-3 text-center">
            <button type="button" class="btn btn-primary" onclick="calcularGrade()" id="calcularGradeBtn">
                <i class="fas fa-calculator"></i> Calcular Grade
            </button>
        </div>
    `;
    
    // Carregar perfis disponíveis
    carregarPerfisGrade();
    
    console.log('Interface Grades carregada com campos de perda e MO');
}

function carregarPerfisGrade() {
    console.log('=== CARREGANDO PERFIS PARA GRADE ===');
    
    const selectPerfil = document.getElementById('grade_perfil');
    if (!selectPerfil) {
        console.warn('Select de perfil não encontrado');
        return;
    }
    
    // Buscar perfis I25, I32, I38 via API
    fetch('/api/produtos/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(produtos => {
            console.log(`✅ ${produtos.length} produtos carregados, filtrando perfis...`);
            
            // Filtrar perfis I25, I32, I38
            const perfisGrade = produtos.filter(produto => {
                const desc = produto.descricao.toLowerCase();
                return (desc.includes('i25') || desc.includes('i32') || desc.includes('i38')) && 
                       desc.includes('mm');
            });
            
            console.log(`📊 ${perfisGrade.length} perfis de grade encontrados`);
            
            // Limpar opções atuais
            selectPerfil.innerHTML = '<option value="">Selecione um perfil...</option>';
            
            // Ordenar perfis por descrição
            perfisGrade.sort((a, b) => a.descricao.localeCompare(b.descricao));
            
            // Adicionar opções dos perfis
            perfisGrade.forEach(perfil => {
                const option = document.createElement('option');
                option.value = perfil.id;
                option.textContent = `${perfil.descricao} - ${perfil.peso_und}kg - R$ ${(perfil.custo_centavos/100).toFixed(2)}`;
                selectPerfil.appendChild(option);
                
                console.log(`   • ${perfil.descricao}: ${perfil.peso_und}kg - R$ ${(perfil.custo_centavos/100).toFixed(2)}`);
            });
            
            if (perfisGrade.length === 0) {
                selectPerfil.innerHTML = '<option value="">Nenhum perfil encontrado</option>';
                console.warn('⚠️ Nenhum perfil I25/I32/I38 encontrado');
            }
            
        })
        .catch(error => {
            console.error('❌ Erro ao carregar perfis:', error);
            
            // Fallback: adicionar opções básicas com IDs conhecidos
            selectPerfil.innerHTML = `
                <option value="">Erro ao carregar perfis</option>
                <option value="1331">I25mm Leve - 0.298kg (fallback)</option>
                <option value="1328">I25mm - 0.497kg (fallback)</option>
                <option value="1329">I32mm - 0.539kg (fallback)</option>
                <option value="1330">I38mm - 0.590kg (fallback)</option>
            `;
        });
}

function carregarInterfaceTampaInjetada() {
    console.log('=== CARREGANDO INTERFACE TAMPA INJETADA ===');
    
    // Limpar estado anterior
    templateAtual = { id: 'tampa_injetada_customizado', tipo: 'tampa_injetada' };
    ultimoCalculo = null;
    
    // Definir valor do select
    document.getElementById('templateSelect').value = 'tampa_injetada_customizado';
    
    // Mostrar descrição
    document.getElementById('templateDescription').innerHTML = `
        <h6 class="text-primary">Tampa Injetada</h6>
        <small class="text-muted">Categoria: TAMPAS</small>
        <p class="mt-2 text-info small">
            <strong>Fórmula:</strong> Grade injetada com preço por m² fixo
        </p>
    `;
    
    // Criar campos específicos para tampa injetada
    const parametrosContainer = document.getElementById('parametrosContainer');
    parametrosContainer.innerHTML = `
        <div class="mb-3">
            <label for="tampa_inj_nome" class="form-label">Nome da Tampa Injetada *</label>
            <input type="text" class="form-control param-input" id="tampa_inj_nome" name="nome_tampa" required>
        </div>
        
        <div class="mb-3">
            <label for="tampa_inj_vao" class="form-label">Vão (mm) *</label>
            <input type="number" step="0.1" class="form-control param-input" id="tampa_inj_vao" name="vao" required min="0">
            <div class="form-text">Distância entre apoios em milímetros</div>
        </div>
        
        <div class="mb-3">
            <label for="tampa_inj_comprimento" class="form-label">Comprimento (mm) *</label>
            <input type="number" step="0.1" class="form-control param-input" id="tampa_inj_comprimento" name="comprimento" required min="0">
            <div class="form-text">Comprimento total da tampa em milímetros</div>
        </div>
        
        <div class="mb-3">
            <label for="tampa_inj_grade" class="form-label">Selecione a Grade Injetada *</label>
            <select class="form-select param-input" id="tampa_inj_grade" name="grade_id" required>
                <option value="">Carregando grades injetadas...</option>
            </select>
            <div class="form-text">Grade injetada que será utilizada</div>
        </div>
        
        <div class="mb-3">
            <label for="tampa_inj_perda" class="form-label">Perda (%)</label>
            <input type="number" step="0.1" class="form-control param-input" id="tampa_inj_perda" name="perda" value="5" min="0" max="100">
            <div class="form-text">Percentual de perda do material (padrão: 5%)</div>
        </div>
        
        <!-- Opções Adicionais -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-cogs"></i> Opções Adicionais</h6>
            </div>
            <div class="card-body">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="tampa_inj_quadro_u4" name="quadro_u4">
                    <label class="form-check-label" for="tampa_inj_quadro_u4">
                        Quadro U4" (2 unidades)
                    </label>
                </div>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="tampa_inj_alca" name="alca">
                    <label class="form-check-label" for="tampa_inj_alca">
                        Alça Metálica (2 unidades)
                    </label>
                </div>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="tampa_inj_chapa_ev" name="chapa_ev">
                    <label class="form-check-label" for="tampa_inj_chapa_ev">
                        Chapa EV (R$ 277,50 fixo)
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Seção de Mão de Obra -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-tools"></i> Mão de Obra</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="tampa_inj_tempo_proc" class="form-label">Tempo PROC (h)</label>
                        <input type="number" step="0.1" class="form-control param-input" id="tampa_inj_tempo_proc" name="tempo_proc" value="0.7" min="0">
                        <div class="form-text">Tempo de processamento em horas</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="tampa_inj_tempo_mtg" class="form-label">Tempo MTG (h)</label>
                        <input type="number" step="0.1" class="form-control param-input" id="tampa_inj_tempo_mtg" name="tempo_mtg" value="0.3" min="0">
                        <div class="form-text">Tempo de montagem em horas</div>
                    </div>
                </div>
                <div class="alert alert-info">
                    <small><i class="fas fa-info-circle"></i> Mão de Obra: Processamento/Montagem - R$ 65,79/hora</small>
                </div>
            </div>
        </div>
        
        <div class="mt-3 text-center">
            <button type="button" class="btn btn-primary" onclick="calcularTampaInjetada()" id="calcularTampaInjetadaBtn">
                <i class="fas fa-calculator"></i> Calcular Tampa Injetada
            </button>
        </div>
    `;
    
    // Carregar grades injetadas disponíveis
    carregarGradesInjetadas();
    
    console.log('Interface Tampa Injetada carregada');
}

function carregarGradesInjetadas() {
    console.log('=== CARREGANDO GRADES INJETADAS ===');
    
    const selectGrade = document.getElementById('tampa_inj_grade');
    if (!selectGrade) {
        console.warn('Select de grade injetada não encontrado');
        return;
    }
    
    // Buscar grades injetadas via API
    fetch('/api/produtos/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(produtos => {
            console.log(`✅ ${produtos.length} produtos carregados, filtrando grades injetadas...`);
            
            // Filtrar grades injetadas
            const gradesInjetadas = produtos.filter(produto => {
                const desc = produto.descricao.toLowerCase();
                return desc.includes('grade') && desc.includes('injetada');
            });
            
            console.log(`📊 ${gradesInjetadas.length} grades injetadas encontradas`);
            
            // Limpar opções atuais
            selectGrade.innerHTML = '<option value="">Selecione uma grade injetada...</option>';
            
            // Ordenar por descrição
            gradesInjetadas.sort((a, b) => a.descricao.localeCompare(b.descricao));
            
            // Adicionar opções das grades
            gradesInjetadas.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade.id;
                option.textContent = `${grade.descricao} - R$ ${(grade.custo_centavos/100).toFixed(2)}/m²`;
                selectGrade.appendChild(option);
                
                console.log(`   • ${grade.descricao}: R$ ${(grade.custo_centavos/100).toFixed(2)}/m²`);
            });
            
            if (gradesInjetadas.length === 0) {
                selectGrade.innerHTML = '<option value="">Nenhuma grade injetada encontrada</option>';
                console.warn('⚠️ Nenhuma grade injetada encontrada');
            }
            
        })
        .catch(error => {
            console.error('❌ Erro ao carregar grades injetadas:', error);
            selectGrade.innerHTML = '<option value="">Erro ao carregar</option>';
        });
}

function carregarInterfaceDegraus() {
    console.log('=== CARREGANDO INTERFACE DEGRAUS ===');
    
    // Limpar estado anterior
    templateAtual = { id: 'degraus_customizado', tipo: 'degraus' };
    ultimoCalculo = null;
    
    // Definir valor do select
    document.getElementById('templateSelect').value = 'degraus_customizado';
    
    // Mostrar descrição
    document.getElementById('templateDescription').innerHTML = `
        <h6 class="text-primary">Degraus</h6>
        <small class="text-muted">Categoria: ESTRUTURAS</small>
        <p class="mt-2 text-info small">
            <strong>Componentes:</strong> Perfis I25/I38, Travessas, Reforços F4"/E, Tubos, Parafusos, Cola
        </p>
    `;
    
    // Criar campos específicos para degraus
    const parametrosContainer = document.getElementById('parametrosContainer');
    parametrosContainer.innerHTML = `
        <div class="mb-3">
            <label for="degraus_nome" class="form-label">Nome do Degrau *</label>
            <input type="text" class="form-control param-input" id="degraus_nome" name="nome_degrau" required>
        </div>
        
        <div class="mb-3">
            <label for="degraus_perfil" class="form-label">Tipo de Perfil *</label>
            <select class="form-select param-input" id="degraus_perfil" name="tipo_perfil" required>
                <option value="">Selecione o perfil...</option>
                <option value="I25">I25mm - R$ 6,48</option>
                <option value="I38">I38mm - R$ 7,81</option>
            </select>
            <div class="form-text">I25 usa reforço E (R$ 14,73), I38 usa reforço F (R$ 19,70)</div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="degraus_largura" class="form-label">Largura (mm) *</label>
                <input type="number" step="0.1" class="form-control param-input" id="degraus_largura" name="largura" required min="0">
                <div class="form-text">Largura do degrau em milímetros</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="degraus_comprimento" class="form-label">Comprimento (mm) *</label>
                <input type="number" step="0.1" class="form-control param-input" id="degraus_comprimento" name="comprimento" required min="0">
                <div class="form-text">Comprimento do degrau em milímetros</div>
            </div>
        </div>
        
        <!-- Seção de Mão de Obra -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-tools"></i> Mão de Obra</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="degraus_tempo_proc" class="form-label">Tempo PROC (h)</label>
                        <input type="number" step="0.1" class="form-control param-input" id="degraus_tempo_proc" name="tempo_proc" value="1.0" min="0">
                        <div class="form-text">Tempo de processamento em horas</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="degraus_tempo_mtg" class="form-label">Tempo MTG (h)</label>
                        <input type="number" step="0.1" class="form-control param-input" id="degraus_tempo_mtg" name="tempo_mtg" value="1.5" min="0">
                        <div class="form-text">Tempo de montagem em horas</div>
                    </div>
                </div>
                <div class="alert alert-info">
                    <small><i class="fas fa-info-circle"></i> Mão de Obra: Processamento/Montagem - R$ 65,79/hora</small>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <label for="degraus_perda" class="form-label">Percentual de Perda (%)</label>
            <input type="number" step="0.1" class="form-control param-input" id="degraus_perda" name="percentual_perda" value="3.0" min="0" max="100">
            <div class="form-text">Percentual de perda aplicado aos materiais (padrão: 3%)</div>
        </div>
        
        <div class="mt-3 text-center">
            <button type="button" class="btn btn-primary" onclick="calcularDegraus()" id="calcularDegrausBtn">
                <i class="fas fa-calculator"></i> Calcular Degraus
            </button>
        </div>
    `;
    
    console.log('Interface Degraus carregada');
}

function carregarInterfaceDegrauInjetado() {
    console.log('=== CARREGANDO INTERFACE DEGRAU INJETADO ===');
    
    // Limpar estado anterior
    templateAtual = { id: 'degrau_injetado_customizado', tipo: 'degrau_injetado' };
    ultimoCalculo = null;
    
    // Definir valor do select
    document.getElementById('templateSelect').value = 'degrau_injetado_customizado';
    
    // Mostrar descrição
    document.getElementById('templateDescription').innerHTML = `
        <h6 class="text-primary">Degrau Injetado</h6>
        <small class="text-muted">Categoria: ESTRUTURAS</small>
        <p class="mt-2 text-info small">
            Cálculo de degraus usando grade injetada ao invés de perfil I. Fórmulas e componentes iguais aos degraus normais.
        </p>
    `;
    
    // Criar campos específicos para degrau injetado (similar aos degraus normais)
    const parametrosContainer = document.getElementById('parametrosContainer');
    parametrosContainer.innerHTML = `
        <div class="mb-3">
            <label for="degrau_inj_nome" class="form-label">Nome do Degrau *</label>
            <input type="text" class="form-control param-input" id="degrau_inj_nome" name="nome_degrau" required>
        </div>
        
        <div class="mb-3">
            <label for="degrau_inj_grade" class="form-label">Grade Injetada *</label>
            <select class="form-select param-input" id="degrau_inj_grade" name="grade_injetada" required>
                <option value="">Selecione a grade injetada...</option>
            </select>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="degrau_inj_largura" class="form-label">Largura (mm) *</label>
                    <input type="number" class="form-control param-input" id="degrau_inj_largura" name="largura" step="0.01" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="degrau_inj_comprimento" class="form-label">Comprimento (mm) *</label>
                    <input type="number" class="form-control param-input" id="degrau_inj_comprimento" name="comprimento" step="0.01" required>
                </div>
            </div>
        </div>
        
        <!-- Seção de Mão de Obra -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Mão de Obra</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="degrau_inj_tempo_proc" class="form-label">Tempo Processamento (h)</label>
                            <input type="number" class="form-control param-input" id="degrau_inj_tempo_proc" name="tempo_proc" step="0.1" value="1.0">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="degrau_inj_tempo_mtg" class="form-label">Tempo Montagem (h)</label>
                            <input type="number" class="form-control param-input" id="degrau_inj_tempo_mtg" name="tempo_mtg" step="0.1" value="1.5">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <label for="degrau_inj_perda" class="form-label">Perda (%)</label>
            <input type="number" class="form-control param-input" id="degrau_inj_perda" name="percentual_perda" step="0.1" value="3.0" min="0">
        </div>
        
        <div class="mt-3 text-center">
            <button type="button" class="btn btn-success" onclick="calcularDegrauInjetado()">
                <i class="fas fa-calculator"></i> Calcular Degrau Injetado
            </button>
        </div>
    `;
    
    // Carregar grades injetadas disponíveis
    carregarGradesInjetadasDegrau();
    
    console.log('Interface Degrau Injetado carregada');
}

function carregarGradesInjetadasDegrau() {
    console.log('=== CARREGANDO GRADES INJETADAS PARA DEGRAU ===');
    
    const selectGrade = document.getElementById('degrau_inj_grade');
    if (!selectGrade) {
        console.warn('Select de grade injetada para degrau não encontrado');
        return;
    }
    
    // Buscar grades injetadas via API
    fetch('/api/produtos/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(produtos => {
            console.log(`📦 ${produtos.length} produtos carregados da API`);
            
            // Filtrar produtos que são grades injetadas
            const gradesInjetadas = produtos.filter(produto => 
                produto.descricao && 
                produto.descricao.toLowerCase().includes('grade injetada') &&
                produto.descricao.toLowerCase().includes('gi')
            );
            
            console.log(`🔍 ${gradesInjetadas.length} grades injetadas encontradas`);
            
            selectGrade.innerHTML = '<option value="">Selecione a grade injetada...</option>';
            
            gradesInjetadas.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade.id;
                option.textContent = `${grade.descricao} - R$ ${(grade.custo_centavos/100).toFixed(2)}/m²`;
                selectGrade.appendChild(option);
                console.log(`✓ Grade adicionada: ${grade.descricao} - ID ${grade.id}`);
            });
            
        })
        .catch(error => {
            console.error('❌ Erro ao carregar grades injetadas:', error);
            selectGrade.innerHTML = '<option value="">Erro ao carregar</option>';
        });
}

function carregarInterfaceGuardaCorpoHorizontal() {
    console.log('=== CARREGANDO INTERFACE GUARDA CORPO - HORIZONTAL ===');
    
    // Limpar estado anterior
    templateAtual = { id: 'guarda_corpo_horizontal_customizado', tipo: 'guarda_corpo_horizontal' };
    ultimoCalculo = null;
    
    // Definir valor do select
    document.getElementById('templateSelect').value = 'guarda_corpo_horizontal_customizado';
    
    // Mostrar descrição
    document.getElementById('templateDescription').innerHTML = `
        <h6 class="text-primary">Guarda Corpo - Horizontal</h6>
        <small class="text-muted">Categoria: ESTRUTURAS</small>
        <p class="mt-2 text-info small">
            Cálculo de guarda corpo horizontal com colunas, barras intermediárias, tubos quadrados, perfis ômega e sapatas.
        </p>
    `;
    
    // Criar campos específicos para guarda corpo horizontal
    const parametrosContainer = document.getElementById('parametrosContainer');
    parametrosContainer.innerHTML = `
        <div class="mb-3">
            <label for="gc_horiz_nome" class="form-label">Nome do Guarda Corpo *</label>
            <input type="text" class="form-control param-input" id="gc_horiz_nome" name="nome_guarda_corpo" required>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="gc_horiz_larg_modulo" class="form-label">Largura (m) *</label>
                    <input type="number" class="form-control param-input" id="gc_horiz_larg_modulo" name="larg_modulo" step="0.01" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="gc_horiz_altura" class="form-label">Altura (m) *</label>
                    <input type="number" class="form-control param-input" id="gc_horiz_altura" name="altura" step="0.01" required>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="gc_horiz_n_colunas" class="form-label">Nº Colunas *</label>
                    <input type="number" class="form-control param-input" id="gc_horiz_n_colunas" name="n_colunas" min="0.01" step="0.01" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="gc_horiz_n_br_intermediaria" class="form-label">Nº Brr. Intermed.*</label>
                    <input type="number" class="form-control param-input" id="gc_horiz_n_br_intermediaria" name="n_br_intermediaria" min="0" required>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <label for="gc_horiz_tipo_tubo_quad" class="form-label">Tipo de Tubo Quadrado *</label>
            <select class="form-select param-input" id="gc_horiz_tipo_tubo_quad" name="tipo_tubo_quad" required>
                <option value="">Selecione o tipo de tubo quadrado...</option>
                <option value="Tubo Quadrado 50 #6mm">Tubo Quadrado 50 #6mm</option>
                <option value="Tubo Quadrado 50 #4mm">Tubo Quadrado 50 #4mm</option>
                <option value="Tubo Quadrado 50 #3mm">Tubo Quadrado 50 #3mm</option>
            </select>
        </div>
        
        <div class="mb-3">
            <label for="gc_horiz_tipo_omega" class="form-label">Tipo de Ômega *</label>
            <select class="form-select param-input" id="gc_horiz_tipo_omega" name="tipo_omega" required>
                <option value="">Selecione o tipo de ômega...</option>
                <option value="PERFIL OMEGA 45X20MM">PERFIL OMEGA 45X20MM</option>
                <option value="Perfil ômega 50mm">Perfil ômega 50mm</option>
            </select>
        </div>
        
        <div class="mb-3">
            <label for="gc_horiz_tipo_sapata" class="form-label">Tipo de Sapata *</label>
            <select class="form-select param-input" id="gc_horiz_tipo_sapata" name="tipo_sapata" required>
                <option value="">Selecione o tipo de sapata...</option>
                <option value="SAPATA LAMINADA">SAPATA LAMINADA</option>
                <option value="SAPATA INOX 150#3MM">SAPATA INOX 150#3MM</option>
            </select>
        </div>
        
        <!-- Seção de Mão de Obra -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Mão de Obra</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="gc_horiz_tempo_proc" class="form-label">Tempo Processamento (h)</label>
                            <input type="number" class="form-control param-input" id="gc_horiz_tempo_proc" name="tempo_proc" step="0.1" value="2.0">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="gc_horiz_tempo_mtg" class="form-label">Tempo Montagem (h)</label>
                            <input type="number" class="form-control param-input" id="gc_horiz_tempo_mtg" name="tempo_mtg" step="0.1" value="3.0">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <label for="gc_horiz_perda" class="form-label">Perda (%)</label>
            <input type="number" class="form-control param-input" id="gc_horiz_perda" name="percentual_perda" step="0.1" value="3.0" min="0">
        </div>
        
        <div class="mt-3 text-center">
            <button type="button" class="btn btn-success" onclick="calcularGuardaCorpoHorizontal()">
                <i class="fas fa-calculator"></i> Calcular Guarda Corpo
            </button>
        </div>
    `;
    
    console.log('Interface Guarda Corpo - Horizontal carregada');
}

function carregarInterfaceGuardaCorpoVertical() {
    console.log('=== CARREGANDO INTERFACE GUARDA CORPO - VERTICAL ===');
    // Limpar estado anterior
    templateAtual = { id: 'guarda_corpo_vertical_customizado', tipo: 'guarda_corpo_vertical' };
    ultimoCalculo = null;
    document.getElementById('templateSelect').value = 'guarda_corpo_vertical_customizado';
    document.getElementById('templateDescription').innerHTML = `
        <h6 class="text-primary">Guarda Corpo - Vertical</h6>
        <small class="text-muted">Categoria: ESTRUTURAS</small>
        <p class="mt-2 text-info small">
            Cálculo de guarda corpo vertical com colunas, barras intermediárias, tubos quadrados, perfis ômega e sapatas.
        </p>
    `;
    // Copiar campos do horizontal, mas IDs começam com gc_vert_
    const parametrosContainer = document.getElementById('parametrosContainer');
    parametrosContainer.innerHTML = `
        <div class="mb-3">
            <label for="gc_vert_nome" class="form-label">Nome do Guarda Corpo *</label>
            <input type="text" class="form-control param-input" id="gc_vert_nome" name="nome_guarda_corpo" required>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="gc_vert_larg_modulo" class="form-label">Largura (m) *</label>
                    <input type="number" class="form-control param-input" id="gc_vert_larg_modulo" name="larg_modulo" step="0.01" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="gc_vert_altura" class="form-label">Altura (m) *</label>
                    <input type="number" class="form-control param-input" id="gc_vert_altura" name="altura" step="0.01" required>
                </div>
            </div>
        </div>
        
        <!-- Novos campos: VÃO LIVRE e VÃO -->
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="gc_vert_vao_livre" class="form-label">Vão Livre (m)</label>
                    <input type="number" class="form-control param-input" id="gc_vert_vao_livre" name="vao_livre" step="0.01" min="0">
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="gc_vert_vao" class="form-label">Vão (m)</label>
                    <input type="number" class="form-control param-input" id="gc_vert_vao" name="vao" step="0.01" min="0">
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="gc_vert_n_colunas" class="form-label">Nº Colunas *</label>
                    <input type="number" class="form-control param-input" id="gc_vert_n_colunas" name="n_colunas" min="0.01" step="0.01" required>
                </div>
            </div>

        </div>
        <div class="mb-3">
            <label for="gc_vert_tipo_tubo_quad" class="form-label">Tipo de Tubo Quadrado *</label>
            <select class="form-select param-input" id="gc_vert_tipo_tubo_quad" name="tipo_tubo_quad" required>
                <option value="">Selecione o tipo de tubo quadrado...</option>
                <option value="Tubo Quadrado 50 #6mm">Tubo Quadrado 50 #6mm</option>
                <option value="Tubo Quadrado 50 #4mm">Tubo Quadrado 50 #4mm</option>
            </select>
            <small class="form-text text-muted">Tubo Quadrado 50 #3mm será adicionado automaticamente</small>
        </div>

        <div class="mb-3">
            <label for="gc_vert_tipo_tubo_redondo" class="form-label">Tipo de Tubo Redondo</label>
            <select class="form-select param-input" id="gc_vert_tipo_tubo_redondo" name="tipo_tubo_redondo">
                <option value="">Nenhum</option>
                <option value="TUBO REDONDO 26,9mm - (ELETRODUTO 3/4\")">TUBO REDONDO 26,9mm - (ELETRODUTO 3/4")</option>
                <option value="Tubo Redondo 32 #3mm">Tubo Redondo 32 #3mm</option>
            </select>
            <small class="form-text text-muted">Opcional - Será calculado com base no vão e vão livre</small>
        </div>

        <div class="mb-3">
            <label for="gc_vert_tipo_sapata" class="form-label">Tipo de Sapata *</label>
            <select class="form-select param-input" id="gc_vert_tipo_sapata" name="tipo_sapata" required>
                <option value="">Selecione o tipo de sapata...</option>
                <option value="SAPATA LAMINADA">SAPATA LAMINADA</option>
                <option value="SAPATA INOX 150#3MM">SAPATA INOX 150#3MM</option>
            </select>
        </div>
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Mão de Obra</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="gc_vert_tempo_proc" class="form-label">Tempo Processamento (h)</label>
                            <input type="number" class="form-control param-input" id="gc_vert_tempo_proc" name="tempo_proc" step="0.1" value="2.0">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="gc_vert_tempo_mtg" class="form-label">Tempo Montagem (h)</label>
                            <input type="number" class="form-control param-input" id="gc_vert_tempo_mtg" name="tempo_mtg" step="0.1" value="3.0">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="mb-3">
            <label for="gc_vert_perda" class="form-label">Perda (%)</label>
            <input type="number" class="form-control param-input" id="gc_vert_perda" name="percentual_perda" step="0.1" value="3.0" min="0">
        </div>
        <div class="mt-3 text-center">
            <button type="button" class="btn btn-success" onclick="calcularGuardaCorpoVertical()">
                <i class="fas fa-calculator"></i> Calcular Guarda Corpo
            </button>
        </div>
    `;
}
    console.log('=== CARREGANDO INTERFACE GUARDA CORPO - HORIZONTAL ===');
    
    // Limpar estado anterior
    templateAtual = { id: 'guarda_corpo_horizontal_customizado', tipo: 'guarda_corpo_horizontal' };
    ultimoCalculo = null;
    
    // Definir valor do select
    document.getElementById('templateSelect').value = 'guarda_corpo_horizontal_customizado';
    
    // Mostrar descrição
    document.getElementById('templateDescription').innerHTML = `
        <h6 class="text-primary">Guarda Corpo - Horizontal</h6>
        <small class="text-muted">Categoria: ESTRUTURAS</small>
        <p class="mt-2 text-info small">
            Cálculo de guarda corpo horizontal com colunas, barras intermediárias, tubos quadrados, perfis ômega e sapatas.
        </p>
    `;
    
    // Criar campos específicos para guarda corpo horizontal
    const parametrosContainer = document.getElementById('parametrosContainer');
    parametrosContainer.innerHTML = `
        <div class="mb-3">
            <label for="gc_horiz_nome" class="form-label">Nome do Guarda Corpo *</label>
            <input type="text" class="form-control param-input" id="gc_horiz_nome" name="nome_guarda_corpo" required>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="gc_horiz_larg_modulo" class="form-label">Largura (m) *</label>
                    <input type="number" class="form-control param-input" id="gc_horiz_larg_modulo" name="larg_modulo" step="0.01" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="gc_horiz_altura" class="form-label">Altura (m) *</label>
                    <input type="number" class="form-control param-input" id="gc_horiz_altura" name="altura" step="0.01" required>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="gc_horiz_n_colunas" class="form-label">Nº Colunas *</label>
                    <input type="number" class="form-control param-input" id="gc_horiz_n_colunas" name="n_colunas" min="0.01" step="0.01" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="gc_horiz_n_br_intermediaria" class="form-label">Nº Brr. Intermed.*</label>
                    <input type="number" class="form-control param-input" id="gc_horiz_n_br_intermediaria" name="n_br_intermediaria" min="0" required>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <label for="gc_horiz_tipo_tubo_quad" class="form-label">Tipo de Tubo Quadrado *</label>
            <select class="form-select param-input" id="gc_horiz_tipo_tubo_quad" name="tipo_tubo_quad" required>
                <option value="">Selecione o tipo de tubo quadrado...</option>
                <option value="Tubo Quadrado 50 #6mm">Tubo Quadrado 50 #6mm</option>
                <option value="Tubo Quadrado 50 #4mm">Tubo Quadrado 50 #4mm</option>
                <option value="Tubo Quadrado 50 #3mm">Tubo Quadrado 50 #3mm</option>
            </select>
        </div>
        
        <div class="mb-3">
            <label for="gc_horiz_tipo_omega" class="form-label">Tipo de Ômega *</label>
            <select class="form-select param-input" id="gc_horiz_tipo_omega" name="tipo_omega" required>
                <option value="">Selecione o tipo de ômega...</option>
                <option value="PERFIL OMEGA 45X20MM">PERFIL OMEGA 45X20MM</option>
                <option value="Perfil ômega 50mm">Perfil ômega 50mm</option>
            </select>
        </div>
        
        <div class="mb-3">
            <label for="gc_horiz_tipo_sapata" class="form-label">Tipo de Sapata *</label>
            <select class="form-select param-input" id="gc_horiz_tipo_sapata" name="tipo_sapata" required>
                <option value="">Selecione o tipo de sapata...</option>
                <option value="SAPATA LAMINADA">SAPATA LAMINADA</option>
                <option value="SAPATA INOX 150#3MM">SAPATA INOX 150#3MM</option>
            </select>
        </div>
        
        <!-- Seção de Mão de Obra -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">Mão de Obra</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="gc_horiz_tempo_proc" class="form-label">Tempo Processamento (h)</label>
                            <input type="number" class="form-control param-input" id="gc_horiz_tempo_proc" name="tempo_proc" step="0.1" value="2.0">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="gc_horiz_tempo_mtg" class="form-label">Tempo Montagem (h)</label>
                            <input type="number" class="form-control param-input" id="gc_horiz_tempo_mtg" name="tempo_mtg" step="0.1" value="3.0">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <label for="gc_horiz_perda" class="form-label">Perda (%)</label>
            <input type="number" class="form-control param-input" id="gc_horiz_perda" name="percentual_perda" step="0.1" value="3.0" min="0">
        </div>
        
        <div class="mt-3 text-center">
            <button type="button" class="btn btn-success" onclick="calcularGuardaCorpoHorizontal()">
                <i class="fas fa-calculator"></i> Calcular Guarda Corpo
            </button>
        </div>
    `;
    
function carregarInterfaceTampaMontada() {
    console.log('=== CARREGANDO INTERFACE TAMPA MONTADA ===');
    
    // Limpar estado anterior
    templateAtual = { id: 'tampa_montada_customizado', tipo: 'tampa_montada' };
    ultimoCalculo = null;
    
    // Selecionar o template correto
    document.getElementById('templateSelect').value = 'tampa_montada_customizado';
    
    // Mostrar descrição
    document.getElementById('templateDescription').innerHTML = `
        <h6 class="text-primary">Tampa Montada</h6>
        <small class="text-muted">Categoria: PRODUTO_FINAL</small>
    `;
    
    // Criar campos específicos para tampa montada
    const parametrosContainer = document.getElementById('parametrosContainer');
    parametrosContainer.innerHTML = `
        <div class="mb-3">
            <label for="tampa_nome" class="form-label">Nome da Tampa *</label>
            <input type="text" class="form-control param-input" id="tampa_nome" name="nome_tampa" required>
        </div>
        
        <div class="mb-3">
            <label for="tampa_vao" class="form-label">Vão (mm) *</label>
            <input type="number" step="0.1" class="form-control param-input" id="tampa_vao" name="vao" required min="0">
            <div class="form-text">Vão da tampa em milímetros</div>
        </div>
        
        <div class="mb-3">
            <label for="tampa_comprimento" class="form-label">Comprimento (mm) *</label>
            <input type="number" step="0.1" class="form-control param-input" id="tampa_comprimento" name="comprimento" required min="0">
            <div class="form-text">Comprimento total da tampa em milímetros</div>
        </div>
        
        <div class="mb-3">
            <label for="tampa_eixo_i" class="form-label">Eixo I (mm) *</label>
            <input type="number" step="0.1" class="form-control param-input" id="tampa_eixo_i" name="eixo_i" required min="0">
            <div class="form-text">Distância entre perfis em milímetros</div>
        </div>
        
        <div class="mb-3">
            <label for="tampa_perfil" class="form-label">Selecione o Perfil *</label>
            <select class="form-select param-input" id="tampa_perfil" name="perfil_id" required>
                <option value="">Carregando perfis...</option>
            </select>
        </div>
        
        <div class="mb-3">
            <label for="tampa_perda" class="form-label">Perda (%)</label>
            <input type="number" step="0.1" class="form-control param-input" id="tampa_perda" name="perda" value="5" min="0" max="100">
            <div class="form-text">Percentual de perda dos materiais (padrão: 3%)</div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="tampa_tempo_proc" class="form-label">Tempo Processamento (h)</label>
                    <input type="number" step="0.1" class="form-control param-input" id="tampa_tempo_proc" name="tempo_proc" value="0.7" min="0">
                    <div class="form-text">Tempo de processamento em horas</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="tampa_tempo_mtg" class="form-label">Tempo Montagem (h)</label>
                    <input type="number" step="0.1" class="form-control param-input" id="tampa_tempo_mtg" name="tempo_mtg" value="0.3" min="0">
                    <div class="form-text">Tempo de montagem em horas</div>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="tampa_quadro_u4" name="quadro_u4">
                <label class="form-check-label" for="tampa_quadro_u4">
                    Incluir Quadro U4" (2 unidades)
                </label>
            </div>
        </div>
        
        <div class="mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="tampa_alca" name="alca">
                <label class="form-check-label" for="tampa_alca">
                    Incluir Alças (2 unidades)
                </label>
            </div>
        </div>
        
        <div class="mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="tampa_chapa_ev" name="chapa_ev">
                <label class="form-check-label" for="tampa_chapa_ev">
                    Incluir Chapa EV
                </label>
            </div>
        </div>
        
        <div class="d-grid gap-2">
            <button type="button" class="btn btn-primary" onclick="calcularTampaMontada()" id="calcularTampaBtn">
                <i class="fas fa-calculator"></i> Calcular Tampa Montada
            </button>
        </div>
    `;
    
    // Habilitar botão calcular
    const calcularBtn = document.getElementById('calcularBtn');
    if (calcularBtn) {
        calcularBtn.disabled = false;
    }
    
    // Carregar perfis disponíveis
    carregarPerfisTampa();
    
    console.log('Interface Tampa Montada carregada com campos extras');
}

function carregarPerfisTampa() {
    console.log('=== CARREGANDO PERFIS PARA TAMPA MONTADA ===');
    
    const selectPerfil = document.getElementById('tampa_perfil');
    if (!selectPerfil) {
        console.warn('Select de perfil não encontrado');
        return;
    }
    
    // Buscar perfis I25, I32, I38, TRAV via API
    fetch('/api/produtos/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(produtos => {
            console.log(`✅ ${produtos.length} produtos carregados da API`);
            
            // Filtrar perfis I25, I32, I38 e TRAV (excluir porca sextavada e grades injetadas)
            const perfis = produtos.filter(p => {
                const desc = p.descricao ? p.descricao.toLowerCase() : '';
                const incluiPerfil = desc.includes('i25') || desc.includes('i32') || desc.includes('i38') || desc.includes('trav');
                const excluirPorca = desc.includes('por-sxt') || desc.includes('travante') || desc.includes('porca');
                const excluirGradeInjetada = desc.includes('grade') && desc.includes('injetada');
                return incluiPerfil && !excluirPorca && !excluirGradeInjetada;
            });
            
            console.log(`✅ ${perfis.length} perfis encontrados:`, perfis.map(p => `${p.id}: ${p.descricao}`));
            
            // Limpar opções atuais
            selectPerfil.innerHTML = '<option value="">Selecione um perfil...</option>';
            
            // Adicionar opções dos perfis
            perfis.forEach(perfil => {
                const option = document.createElement('option');
                option.value = perfil.id;
                option.textContent = `${perfil.descricao} - ${perfil.peso_und}kg - R$ ${(perfil.custo_centavos/100).toFixed(2)}`;
                selectPerfil.appendChild(option);
            });
            
            if (perfis.length === 0) {
                selectPerfil.innerHTML = '<option value="">Nenhum perfil I25/I32/I38/TRAV encontrado</option>';
            }
        })
        .catch(error => {
            console.error('❌ Erro ao carregar perfis:', error);
            // Fallback com perfis básicos
            selectPerfil.innerHTML = `
                <option value="">Erro ao carregar perfis</option>
                <option value="1331">I25mm Leve - 0.298kg (fallback)</option>
                <option value="1328">I25mm - 0.497kg (fallback)</option>
                <option value="1329">I32mm - 0.539kg (fallback)</option>
                <option value="1330">I38mm - 0.590kg (fallback)</option>
            `;
        });
}

function calcularGrade() {
    console.log('=== CALCULANDO GRADE ===');
    
    // Verificar se todos os campos obrigatórios estão preenchidos
    const camposObrigatorios = [
        'grade_nome', 'grade_vao', 'grade_comprimento', 'grade_eixo_i', 'grade_perfil'
    ];
    
    let todosCamposPreenchidos = true;
    const dados = {};
    
    camposObrigatorios.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (!elemento || !elemento.value.trim()) {
            todosCamposPreenchidos = false;
            console.warn(`Campo ${campo} não preenchido`);
            return;
        }
        
        const valor = elemento.value.trim();
        if (campo === 'grade_nome') {
            dados[elemento.name] = valor;
        } else {
            dados[elemento.name] = parseFloat(valor) || 0;
        }
    });
    
    if (!todosCamposPreenchidos) {
        alert('Por favor, preencha todos os campos obrigatórios.');
        return;
    }
    
    // Coletar dados opcionais de perda e mão de obra
    const perdaElement = document.getElementById('grade_perda');
    dados.perda = perdaElement ? (parseFloat(perdaElement.value) || 5) : 5;
    
    const tempoProc = document.getElementById('tampa_tempo_proc');
    dados.tempo_proc = tempoProc ? (parseFloat(tempoProc.value) || 1.5) : 1.5;
    
    const tempoMtg = document.getElementById('tampa_tempo_mtg');  
    dados.tempo_mtg = tempoMtg ? (parseFloat(tempoMtg.value) || 0.5) : 0.5;
    
    // Usar sempre MÃO DE OBRA Processamento/Montagem (ID 2) 
    dados.mao_obra_id = 2;
    
    console.log('Dados coletados:', dados);
    
    // Buscar dados do perfil selecionado
    console.log('🔍 Buscando dados do perfil selecionado...');
    
    fetch('/api/produtos/')
        .then(response => response.json())
        .then(produtos => {
            console.log('✅ Produtos carregados da base');
            
            // Encontrar o perfil selecionado
            const perfilSelecionado = produtos.find(p => p.id == dados.perfil_id);
            if (!perfilSelecionado) {
                throw new Error(`Perfil ID ${dados.perfil_id} não encontrado`);
            }
            
            // Encontrar a chaveta (ID fixo 1332)
            const chaveta = produtos.find(p => p.id == 1332);
            if (!chaveta) {
                throw new Error('Perfil Chaveta (ID 1332) não encontrado no banco');
            }
            
            // Encontrar a cola (ID fixo 1183)
            const cola = produtos.find(p => p.id == 1183);
            if (!cola) {
                throw new Error('COLA ESTRUTURAL 4500 A/B (ID 1183) não encontrada no banco');
            }
            
            // Encontrar mão de obra processamento/montagem
            const maoObraProcessamento = produtos.find(p => 
                p.descricao && 
                p.descricao.toLowerCase().includes('mão de obra') && 
                p.descricao.toLowerCase().includes('processamento')
            );
            if (!maoObraProcessamento) {
                throw new Error('Produto de mão de obra Processamento/Montagem não encontrado no banco');
            }
            
            console.log(`📐 Perfil selecionado: ${perfilSelecionado.descricao}`);
            console.log(`   • Peso: ${perfilSelecionado.peso_und} kg/m`);
            console.log(`   • Custo: R$ ${(perfilSelecionado.custo_centavos/100).toFixed(2)}/m`);
            
            console.log(`🔧 Chaveta incluída: ${chaveta.descricao}`);
            console.log(`   • Peso: ${chaveta.peso_und} kg/m`);
            console.log(`   • Custo: R$ ${(chaveta.custo_centavos/100).toFixed(2)}/m`);
            
            console.log(`🧴 Cola incluída: ${cola.descricao}`);
            console.log(`   • Peso: ${cola.peso_und} kg/unid`);
            console.log(`   • Custo: R$ ${(cola.custo_centavos/100).toFixed(2)}/unid`);
            
            // APLICAR FÓRMULA: (((comprimento/eixo i)*vão/1000)* peso do perfil)
            const metrosLinearesPorM2 = (dados.comprimento / dados.eixo_i) * (dados.vao / 1000);
            
            // Calcular para o perfil
            const pesoPerfilKg = metrosLinearesPorM2 * perfilSelecionado.peso_und;
            const custoPerfilCentavos = metrosLinearesPorM2 * perfilSelecionado.custo_centavos;
            
            // Calcular para a chaveta - FÓRMULA ESPECÍFICA: vão / 150 * 2 * preço do perfil
            const quantidadeChaveta = (dados.vao / 150) * 2;
            const pesoChaveta = quantidadeChaveta * chaveta.peso_und;
            const custoChaveta = quantidadeChaveta * chaveta.custo_centavos;
            
            // Calcular para a cola - FÓRMULA: quantidade fixa 0.06 unid/m²
            const quantidadeCola = 0.06; // Quantidade fixa
            const pesoCola = quantidadeCola * cola.peso_und;
            const custoCola = quantidadeCola * cola.custo_centavos;
            
            // Aplicar perda APENAS aos custos dos materiais (individualmente)
            const fatorPerda = 1 + (dados.perda / 100);
            const custoPerfilComPerda = custoPerfilCentavos * fatorPerda;
            const custoChaveteComPerda = custoChaveta * fatorPerda;
            const custoColaComPerda = custoCola * fatorPerda;
            
            // Totais dos materiais (já com perda aplicada)
            let pesoTotalMateriaisKg = (pesoPerfilKg + pesoChaveta + pesoCola) * fatorPerda;
            let custoTotalMateriaisCentavos = custoPerfilComPerda + custoChaveteComPerda + custoColaComPerda;
            
            console.log(`📊 Subtotal MATERIAIS (sem perda): R$ ${((custoPerfilCentavos + custoChaveta + custoCola)/100).toFixed(2)}/m²`);
            console.log(`📊 Subtotal MATERIAIS (com ${dados.perda}% perda): R$ ${(custoTotalMateriaisCentavos/100).toFixed(2)}/m²`);
            
            
            // Calcular mão de obra se selecionada
            console.log(`\n🔧 INÍCIO CÁLCULO MÃO DE OBRA:`);
            console.log(`   dados.tempo_proc: ${dados.tempo_proc}h`);
            console.log(`   dados.tempo_mtg: ${dados.tempo_mtg}h`);
            
            let custoMaoObraTotal = 0;
            // Calcular mão de obra diretamente - Processamento/Montagem R$ 65.79/hora
            const valorHoraMO = 65.79; // R$/hora
            const tempoTotal = dados.tempo_proc + dados.tempo_mtg;
            custoMaoObraTotal = tempoTotal * valorHoraMO * 100; // converter para centavos
            const maoObraDescricao = `Processamento/Montagem (${tempoTotal}h)`;
            
            console.log(`💼 Mão de Obra: ${maoObraDescricao} - R$ ${(custoMaoObraTotal/100).toFixed(2)}/m²`);
            
            // CUSTO TOTAL = Materiais com perda + Mão de obra (sem perda)
            let pesoTotalKg = pesoTotalMateriaisKg; // Peso só dos materiais (MO não tem peso)
            let custoTotalCentavos = custoTotalMateriaisCentavos + custoMaoObraTotal;
            
            // Continuar com os cálculos
            
            console.log('\n🧮 CÁLCULO DETALHADO:');
            console.log(`Perfil - Fórmula: (${dados.comprimento}/${dados.eixo_i}) * (${dados.vao}/1000)`);
            console.log(`Perfil - Metros lineares/m²: ${metrosLinearesPorM2.toFixed(4)} m/m²`);
            console.log(`Perfil - Peso: ${pesoPerfilKg.toFixed(3)} kg/m² | Custo: R$ ${(custoPerfilCentavos/100).toFixed(2)}/m²`);
            console.log(`Chaveta - Fórmula: (${dados.vao}/150) * 2`);
            console.log(`Chaveta - Quantidade: ${quantidadeChaveta.toFixed(4)} m/m²`);
            console.log(`Chaveta - Peso: ${pesoChaveta.toFixed(3)} kg/m² | Custo: R$ ${(custoChaveta/100).toFixed(2)}/m²`);
            console.log(`Cola - Fórmula: 0.06 unid/m² (quantidade fixa)`);
            console.log(`Cola - Quantidade: ${quantidadeCola.toFixed(4)} unid/m²`);
            console.log(`Cola - Peso: ${pesoCola.toFixed(3)} kg/m² | Custo: R$ ${(custoCola/100).toFixed(2)}/m²`);
            console.log(`\n💰 RESUMO DE CUSTOS:`);
            console.log(`   Materiais (com ${dados.perda}% perda): R$ ${(custoTotalMateriaisCentavos/100).toFixed(2)}/m²`);
            console.log(`   Mão de Obra (sem perda): R$ ${(custoMaoObraTotal/100).toFixed(2)}/m²`);
            console.log(`   TOTAL FINAL: R$ ${(custoTotalCentavos/100).toFixed(2)}/m² | Peso: ${pesoTotalKg.toFixed(3)} kg/m²`);
            
            console.log('\n🔍 DEBUG CUSTOS INDIVIDUAIS:');
            console.log(`Perfil com perda: ${custoPerfilCentavos * fatorPerda} centavos`);
            console.log(`Chaveta com perda: ${custoChaveta * fatorPerda} centavos`);
            console.log(`Cola com perda: ${custoCola * fatorPerda} centavos`);
            console.log(`Mão de obra (sem perda): ${custoMaoObraTotal} centavos`);
            
            // Criar resultado final
            const resultado = {
                success: true,
                nome_produto: dados.nome_grade,
                custo_total: custoTotalCentavos,
                peso_total: pesoTotalKg,
                metros_lineares_por_m2: metrosLinearesPorM2,
                mao_obra_produto_id: maoObraProcessamento.id, // Adicionar ID do produto de mão de obra
                componentes: [
                    {
                        nome: `${perfilSelecionado.descricao} (com ${dados.perda}% perda no custo)`,
                        produto_nome: perfilSelecionado.descricao,
                        quantidade: metrosLinearesPorM2,
                        custo_unitario: perfilSelecionado.custo_centavos,
                        custo_total: custoPerfilComPerda,
                        unidade: 'm'
                    },
                    {
                        nome: `${chaveta.descricao} (com ${dados.perda}% perda no custo)`,
                        produto_nome: chaveta.descricao,
                        quantidade: quantidadeChaveta,
                        custo_unitario: chaveta.custo_centavos,
                        custo_total: custoChaveteComPerda,
                        unidade: 'm'
                    },
                    {
                        nome: `${cola.descricao} (com ${dados.perda}% perda no custo)`,
                        produto_nome: cola.descricao,
                        quantidade: quantidadeCola,
                        custo_unitario: cola.custo_centavos,
                        custo_total: custoColaComPerda,
                        unidade: 'unid'
                    }
                ]
            };
            
            // Adicionar mão de obra aos componentes se selecionada
            console.log(`🔧 DEBUG MÃO DE OBRA:`);
            console.log(`   custoMaoObraTotal: ${custoMaoObraTotal} centavos = R$ ${(custoMaoObraTotal/100).toFixed(2)}`);
            console.log(`   maoObraDescricao: "${maoObraDescricao}"`);
            console.log(`   tempo_proc: ${dados.tempo_proc}h`);
            console.log(`   tempo_mtg: ${dados.tempo_mtg}h`);
            console.log(`   total_tempo: ${dados.tempo_proc + dados.tempo_mtg}h`);
            
            if (custoMaoObraTotal > 0) {
                console.log(`✅ Adicionando mão de obra aos componentes`);
                resultado.componentes.push({
                    nome: maoObraDescricao,
                    produto_nome: maoObraDescricao,
                    quantidade: dados.tempo_proc + dados.tempo_mtg,
                    custo_unitario: valorHoraMO * 100, // R$ 65.79/hora em centavos
                    custo_total: custoMaoObraTotal,
                    unidade: 'h'
                });
            } else {
                console.log(`❌ Mão de obra NÃO adicionada - custoMaoObraTotal = ${custoMaoObraTotal}`);
            }
            
            // Debug final: verificar soma dos componentes
            const somaComponentes = resultado.componentes.reduce((total, comp) => total + comp.custo_total, 0);
            console.log(`\n🔎 VERIFICAÇÃO FINAL:`);
            console.log(`Custo total calculado: ${custoTotalCentavos} centavos = R$ ${(custoTotalCentavos/100).toFixed(2)}`);
            console.log(`Soma dos componentes: ${somaComponentes} centavos = R$ ${(somaComponentes/100).toFixed(2)}`);
            console.log(`Diferença: ${Math.abs(custoTotalCentavos - somaComponentes)} centavos = R$ ${(Math.abs(custoTotalCentavos - somaComponentes)/100).toFixed(2)}`);
            
            // Atualizar o custo_total do resultado com a soma correta dos componentes
            resultado.custo_total = somaComponentes;
            
            // Salvar resultado globalmente
            ultimoCalculo = resultado;
            
            // Mostrar resultado na interface
            document.getElementById('nomeProdutoCalculado').textContent = dados.nome_grade;
            document.getElementById('custoTotalCalculado').textContent = `R$ ${(custoTotalCentavos / 100).toFixed(2)}/m²`;
            document.getElementById('pesoTotalCalculado').textContent = `${pesoTotalKg.toFixed(3)} kg/m²`;
            document.getElementById('resultadoCalculado').style.display = 'block';
            
            // Preencher tabela de componentes
            preencherTabelaComponentesGrade(resultado);
            
            // Habilitar botão salvar
            document.getElementById('salvarProdutoBtn').disabled = false;
            
            console.log('✅ Cálculo de grade concluído:', resultado);
        })
        .catch(error => {
            console.error('❌ Erro ao calcular grade:', error);
            alert('Erro ao calcular grade: ' + error.message);
        });
}

function preencherTabelaComponentesGrade(resultado) {
    console.log('=== PREENCHENDO TABELA DE COMPONENTES PARA GRADE ===');
    
    const tbody = document.getElementById('componentesCalculadosTable');
    if (!tbody) {
        console.warn('Tabela componentesCalculadosTable não encontrada');
        return;
    }
    
    // Limpar tabela
    tbody.innerHTML = '';
    
    // Adicionar linha para cada componente
    resultado.componentes.forEach((comp, index) => {
        const row = tbody.insertRow();
        
        // Componentes de grade não têm fator editável
        const fatorCol = '<span class="text-muted">-</span>';
        const acaoCol = '<span class="text-muted">-</span>';
        
        row.innerHTML = `
            <td>${comp.nome || 'N/A'}</td>
            <td>${comp.produto_nome || 'N/A'}</td>
            <td>${fatorCol}</td>
            <td><span class="quantidade-display">${comp.quantidade ? comp.quantidade.toFixed(4) : '0.0000'}</span></td>
            <td>R$ ${comp.custo_unitario ? (comp.custo_unitario/100).toFixed(2) : '0.00'}</td>
            <td><span class="custo-total-display">R$ ${comp.custo_total ? (comp.custo_total/100).toFixed(2) : '0.00'}</span></td>
            <td>${acaoCol}</td>`;
        
        console.log(`✓ Componente adicionado: ${comp.nome} - ${comp.quantidade.toFixed(4)} ${comp.unidade || 'm'}`);
    });
    
    // Adicionar linha de total
    const totalRow = tbody.insertRow();
    const custoTotalGeral = resultado.componentes.reduce((total, comp) => total + comp.custo_total, 0);
    totalRow.innerHTML = `
        <td colspan="5"><strong>TOTAL GERAL</strong></td>
        <td><strong>R$ ${(custoTotalGeral/100).toFixed(2)}</strong></td>
        <td></td>`;
    totalRow.style.backgroundColor = '#f8f9fa';
    
    console.log(`✅ Tabela preenchida com ${resultado.componentes.length} componentes. Total: R$ ${(custoTotalGeral/100).toFixed(2)}`);
}

function calcularTampaInjetada() {
    console.log('=== CALCULANDO TAMPA INJETADA ===');
    
    // Verificar se todos os campos obrigatórios estão preenchidos
    const camposObrigatorios = [
        'tampa_inj_nome', 'tampa_inj_vao', 'tampa_inj_comprimento', 'tampa_inj_grade'
    ];
    
    let todosCamposPreenchidos = true;
    const dados = {};
    
    camposObrigatorios.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (!elemento || !elemento.value.trim()) {
            todosCamposPreenchidos = false;
            console.warn(`Campo ${campo} não preenchido`);
            return;
        }
        
        const valor = elemento.value.trim();
        if (campo === 'tampa_inj_nome') {
            dados.nome_tampa = valor;
        } else if (campo === 'tampa_inj_grade') {
            dados.grade_id = parseInt(valor);
        } else {
            const nomeLimpo = campo.replace('tampa_inj_', '');
            dados[nomeLimpo] = parseFloat(valor);
        }
    });
    
    // Campos opcionais
    dados.perda = parseFloat(document.getElementById('tampa_inj_perda').value) || 5;
    dados.tempo_proc = parseFloat(document.getElementById('tampa_inj_tempo_proc').value) || 0.3;
    dados.tempo_mtg = parseFloat(document.getElementById('tampa_inj_tempo_mtg').value) || 0.3;
    dados.quadro_u4 = document.getElementById('tampa_inj_quadro_u4').checked;
    dados.alca = document.getElementById('tampa_inj_alca').checked;
    dados.chapa_ev = document.getElementById('tampa_inj_chapa_ev').checked;
    dados.tipo_calculo = 'tampa_injetada';
    
    if (!todosCamposPreenchidos) {
        alert('Por favor, preencha todos os campos obrigatórios (marcados com *).');
        return;
    }
    
    console.log('Dados da tampa injetada:', dados);
    
    // Buscar produtos necessários
    fetch('/api/produtos/')
        .then(response => response.json())
        .then(produtos => {
            console.log(`✅ ${produtos.length} produtos carregados da API`);
            
            // Encontrar grade injetada selecionada
            const gradeSelecionada = produtos.find(p => p.id === dados.grade_id);
            if (!gradeSelecionada) {
                throw new Error(`Grade injetada com ID ${dados.grade_id} não encontrada`);
            }
            
            // Encontrar cola estrutural (sempre ID 1183)
            const cola = produtos.find(p => p.id === 1183);
            if (!cola) {
                throw new Error('COLA ESTRUTURAL 4500 A/B (ID 1183) não encontrada no banco');
            }
            
            // Encontrar chapa 2,5mm (buscar por descrição)
            const chapa25 = produtos.find(p => 
                p.descricao && 
                p.descricao.toLowerCase().includes('chapa') && 
                p.descricao.toLowerCase().includes('2,5')
            );
            if (!chapa25) {
                throw new Error('Chapa 2,5mm não encontrada no banco');
            }
            
            // Encontrar perfil U4" (se necessário)
            let perfilU4 = null;
            if (dados.quadro_u4) {
                perfilU4 = produtos.find(p => 
                    p.descricao && 
                    p.descricao.toLowerCase().includes('u4')
                );
                if (!perfilU4) {
                    throw new Error('Perfil U4" não encontrado no banco');
                }
            }
            
            // Encontrar alça (se necessário)
            let alca = null;
            if (dados.alca) {
                alca = produtos.find(p => 
                    p.descricao && 
                    p.descricao.toLowerCase().includes('alça')
                );
                if (!alca) {
                    throw new Error('Alça não encontrada no banco');
                }
            }
            
            // Encontrar mão de obra processamento/montagem
            const maoObraProcessamento = produtos.find(p => 
                p.descricao && 
                p.descricao.toLowerCase().includes('mão de obra') && 
                p.descricao.toLowerCase().includes('processamento')
            );
            if (!maoObraProcessamento) {
                throw new Error('Produto de mão de obra Processamento/Montagem não encontrado no banco');
            }
            
            console.log(`📋 Grade selecionada: ${gradeSelecionada.descricao}`);
            console.log(`🧴 Cola incluída: ${cola.descricao}`);
            console.log(`📋 Chapa 2,5mm: ${chapa25.descricao}`);
            if (perfilU4) console.log(`🔲 Perfil U4": ${perfilU4.descricao}`);
            if (alca) console.log(`🎯 Alça: ${alca.descricao}`);
            
            // APLICAR FÓRMULAS DA TAMPA INJETADA
            const fatorPerda = 1 + (dados.perda / 100);
            
            // 1. Grade injetada - área × preço/m²
            const areaTampa = (dados.vao / 1000) * (dados.comprimento / 1000); // em m²
            const pesoGrade = areaTampa * gradeSelecionada.peso_und;
            let custoGradeCentavos = areaTampa * gradeSelecionada.custo_centavos;
            
            // 2. Cola - 0,1 * custo da cola
            const quantidadeCola = 0.1;
            const pesoCola = quantidadeCola * cola.peso_und;
            let custoCola = quantidadeCola * cola.custo_centavos;
            
            // 3. Chapa 2,5mm - área × custo chapa (em m²)
            const areaChapa = (dados.vao / 1000) * (dados.comprimento / 1000); // em m²
            const pesoChapa25 = areaChapa * chapa25.peso_und;
            
            // AJUSTE ESPECIAL: Se Chapa EV marcada, usar valor fixo R$ 277,50
            let custoChapa25;
            let nomeChapa, descricaoChapa;
            if (dados.chapa_ev) {
                custoChapa25 = 27750; // R$ 277,50 em centavos (valor fixo quando EV marcada)
                nomeChapa = "Chapa EV - Res. Poliéster";
                descricaoChapa = "Chapa EV - Res. Poliéster";
                console.log(`🔧 CHAPA EV MARCADA: Custo da chapa alterado para R$ 277,50 (fixo)`);
            } else {
                custoChapa25 = areaChapa * chapa25.custo_centavos; // Cálculo normal
                nomeChapa = chapa25.descricao;
                descricaoChapa = chapa25.descricao;
            }
            
            // 4. Quadro U4" - se 'sim' custo perfil u4 * 2
            let pesoU4 = 0, custoU4 = 0;
            if (dados.quadro_u4 && perfilU4) {
                pesoU4 = 2 * perfilU4.peso_und;
                custoU4 = 2 * perfilU4.custo_centavos;
            }
            
            // 5. Alça - se sim custo da alça * 2
            let pesoAlca = 0, custoAlca = 0;
            if (dados.alca && alca) {
                pesoAlca = 2 * alca.peso_und;
                custoAlca = 2 * alca.custo_centavos;
            }
            
            // Aplicar perda aos materiais individuais (exceto mão de obra)
            custoGradeCentavos = custoGradeCentavos * fatorPerda;
            custoCola = custoCola * fatorPerda;
            custoChapa25 = custoChapa25 * fatorPerda;
            custoU4 = custoU4 * fatorPerda;
            custoAlca = custoAlca * fatorPerda;
            
            // Total dos materiais com perda já aplicada
            const custoTotalMateriaisCentavos = custoGradeCentavos + custoCola + custoChapa25 + custoU4 + custoAlca;
            
            // Calcular mão de obra (sem perda) - LÓGICA ESPECIAL PARA TAMPA INJETADA
            const valorHoraMO = 65.79; // R$/hora
            const custoMaoObraBase = (dados.tempo_proc + dados.tempo_mtg) * valorHoraMO * 100; // custo base em centavos
            
            // Para Tampa Injetada, mão de obra não é multiplicada
            let multiplicadorMO = 1.0; // sempre 1.0 para Tampa Injetada
            let descricaoOpcoes = '';
            
            if (dados.quadro_u4 && dados.alca) {
                descricaoOpcoes = ' (com Quadro U4" + Alça)';
            } else if (!dados.quadro_u4 && dados.alca) {
                descricaoOpcoes = ' (com Alça)';
            } else if (dados.quadro_u4 && !dados.alca) {
                descricaoOpcoes = ' (com Quadro U4")';
            } else {
                descricaoOpcoes = ' (básico)';
            }
            
            const custoMaoObraTotal = Math.round(custoMaoObraBase * multiplicadorMO);
            const maoObraDescricao = `MÃO DE OBRA Processamento/Montagem${descricaoOpcoes}`;
            
            console.log(`\n🔧 CÁLCULO ESPECIAL MÃO DE OBRA TAMPA INJETADA:`);
            console.log(`   • Custo base: R$ ${(custoMaoObraBase/100).toFixed(2)}`);
            console.log(`   • Multiplicador: ${multiplicadorMO}x ${descricaoOpcoes}`);
            console.log(`   • Custo final MO: R$ ${(custoMaoObraTotal/100).toFixed(2)}`);
            
            // Custo total
            const custoTotalCentavos = custoTotalMateriaisCentavos + custoMaoObraTotal;
            
            // Peso total
            const pesoTotalKg = (pesoGrade + pesoCola + pesoChapa25 + pesoU4 + pesoAlca) * fatorPerda;
            
            console.log('\n🧮 CÁLCULO DETALHADO TAMPA INJETADA:');
            console.log(`Área da tampa: ${areaTampa.toFixed(4)} m²`);
            console.log(`Grade - Peso: ${pesoGrade.toFixed(3)} kg | Custo: R$ ${(custoGradeCentavos/100).toFixed(2)}`);
            console.log(`Cola - Quantidade fixa: ${quantidadeCola} unid`);
            console.log(`${nomeChapa} - Área: ${areaChapa.toFixed(4)} m² | Custo: R$ ${(custoChapa25/100).toFixed(2)}`);
            if (dados.quadro_u4) console.log(`Quadro U4" - 2 unidades | Custo: R$ ${(custoU4/100).toFixed(2)}`);
            if (dados.alca) console.log(`Alças - 2 unidades | Custo: R$ ${(custoAlca/100).toFixed(2)}`);
            console.log(`\n💰 RESUMO DE CUSTOS:`);
            console.log(`   Materiais (com ${dados.perda}% perda): R$ ${(custoTotalMateriaisCentavos/100).toFixed(2)}`);
            console.log(`   Mão de Obra (sem perda): R$ ${(custoMaoObraTotal/100).toFixed(2)}`);
            console.log(`   TOTAL FINAL: R$ ${(custoTotalCentavos/100).toFixed(2)} | Peso: ${pesoTotalKg.toFixed(3)} kg`);
            
            // Criar resultado final
            const resultado = {
                success: true,
                nome_produto: dados.nome_tampa,
                custo_total: custoTotalCentavos,
                peso_total: pesoTotalKg,
                area_tampa: areaTampa,
                mao_obra_produto_id: maoObraProcessamento.id,
                componentes: [
                    {
                        nome: `${gradeSelecionada.descricao} (com ${dados.perda}% perda no custo)`,
                        descricao_produto: gradeSelecionada.descricao,
                        quantidade: areaTampa,
                        custo_unitario: Math.round(gradeSelecionada.custo_centavos * fatorPerda),
                        custo_total: custoGradeCentavos,
                        unidade: 'm²'
                    },
                    {
                        nome: `${cola.descricao} - Quantidade fixa 0,1`,
                        descricao_produto: cola.descricao,
                        quantidade: quantidadeCola,
                        custo_unitario: cola.custo_centavos,
                        custo_total: custoCola,
                        unidade: 'unid'
                    },
                    {
                        nome: `${nomeChapa} - Área completa`,
                        descricao_produto: descricaoChapa,
                        quantidade: areaChapa,
                        custo_unitario: dados.chapa_ev ? 27750 : chapa25.custo_centavos,
                        custo_total: custoChapa25,
                        unidade: 'm²'
                    }
                ]
            };
            
            // Adicionar componentes opcionais
            if (dados.quadro_u4 && perfilU4) {
                resultado.componentes.push({
                    nome: `${perfilU4.descricao} - 2 unidades`,
                    descricao_produto: perfilU4.descricao,
                    quantidade: 2,
                    custo_unitario: perfilU4.custo_centavos,
                    custo_total: custoU4,
                    unidade: 'unid'
                });
            }
            
            if (dados.alca && alca) {
                resultado.componentes.push({
                    nome: `${alca.descricao} - 2 unidades`,
                    descricao_produto: alca.descricao,
                    quantidade: 2,
                    custo_unitario: alca.custo_centavos,
                    custo_total: custoAlca,
                    unidade: 'unid'
                });
            }
            
            // Adicionar mão de obra aos componentes se selecionada
            if (custoMaoObraTotal > 0) {
                resultado.componentes.push({
                    nome: maoObraDescricao,
                    descricao_produto: maoObraDescricao,
                    quantidade: dados.tempo_proc + dados.tempo_mtg,
                    custo_unitario: valorHoraMO * 100,
                    custo_total: custoMaoObraTotal,
                    unidade: 'h'
                });
            }
            
            // Verificar soma dos componentes
            const somaComponentes = resultado.componentes.reduce((total, comp) => total + comp.custo_total, 0);
            console.log(`\n🔎 VERIFICAÇÃO FINAL:`);
            console.log(`Custo total calculado: ${custoTotalCentavos} centavos = R$ ${(custoTotalCentavos/100).toFixed(2)}`);
            console.log(`Soma dos componentes: ${somaComponentes} centavos = R$ ${(somaComponentes/100).toFixed(2)}`);
            
            // Atualizar o custo_total com a soma correta
            resultado.custo_total = somaComponentes;
            
            // Salvar resultado globalmente
            ultimoCalculo = resultado;
            
            // Mostrar componentes na tabela
            mostrarComponentesCalculados(resultado.componentes);
            
            // Habilitar botão salvar
            document.getElementById('salvarProdutoBtn').disabled = false;
            
            console.log('✅ Cálculo da Tampa Injetada concluído com sucesso');
            
        })
        .catch(error => {
            console.error('❌ Erro no cálculo:', error);
            alert(`Erro no cálculo: ${error.message}`);
        });
}

function calcularDegraus() {
    console.log('=== CALCULANDO DEGRAUS ===');
    
    // Verificar se todos os campos obrigatórios estão preenchidos
    const camposObrigatorios = [
        'degraus_nome', 'degraus_perfil', 'degraus_largura', 'degraus_comprimento'
    ];
    
    let todosCamposPreenchidos = true;
    const dados = {};
    
    camposObrigatorios.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (!elemento || !elemento.value.trim()) {
            todosCamposPreenchidos = false;
            console.warn(`Campo ${campo} não preenchido`);
            return;
        }
        
        const valor = elemento.value.trim();
        if (campo === 'degraus_nome') {
            dados.nome_degrau = valor;
        } else if (campo === 'degraus_perfil') {
            dados.tipo_perfil = valor;
        } else {
            const nomeLimpo = campo.replace('degraus_', '');
            dados[nomeLimpo] = parseFloat(valor);
        }
    });
    
    // Campos opcionais
    dados.quantidade = 1; // Fixo em 1 unidade
    dados.tempo_proc = parseFloat(document.getElementById('degraus_tempo_proc')?.value || '1.0');
    dados.tempo_mtg = parseFloat(document.getElementById('degraus_tempo_mtg')?.value || '1.5');
    dados.percentual_perda = parseFloat(document.getElementById('degraus_perda')?.value || '3.0');
    
    if (!todosCamposPreenchidos) {
        alert('Por favor, preencha todos os campos obrigatórios.');
        return;
    }
    
    console.log('Dados coletados:', dados);
    
    // Buscar produtos necessários dinamicamente
    Promise.all([
        buscarProdutoPorDescricao(dados.tipo_perfil === 'I25' ? 'I25mm' : 'I38mm'),
        buscarProdutoPorDescricao('Perfil Chaveta'), // Travessa R$ 2,12
        buscarProdutoPorDescricao('COLA ESTRUTURAL'),
        dados.tipo_perfil === 'I25' ? buscarProdutoPorDescricao('E - 4\'x1.3/16\' #3/16\'') : buscarProdutoPorDescricao('PERFIL F 4"'), // Perfil E para I25, Perfil F para I38
        buscarProdutoPorDescricao('Tubo Quadrado 25x38#3mm'),
        buscarProdutoPorDescricao('PARAF-SXT-M6X40-AI304'),
        buscarProdutoPorDescricao('PARAF-SXT-M6X60-AI304'),
        buscarProdutoPorDescricao('POR-SXT-M6-AI304')
    ]).then(([perfilPrincipal, travessa, cola, perfilReforco, tuboQuadrado, paraf40, paraf60, porca]) => {
        
        console.log('=== PRODUTOS ENCONTRADOS ===');
        console.log('Perfil Principal:', perfilPrincipal);
        console.log('Travessa:', travessa);
        console.log('Cola:', cola);
        console.log('Reforço:', perfilReforco);
        console.log('Tubo Quadrado:', tuboQuadrado);
        console.log('Parafusos:', { paraf40, paraf60, porca });
        
        // Calcular dimensões e quantidades
        const areaDegrau = (dados.largura * dados.comprimento) / 1000000; // m²
        const alturaFixa = 150; // Altura fixa de 150mm para degraus
        const volumeDegrau = areaDegrau * (alturaFixa / 1000); // m³
        
        // Calcular quantidades baseadas nas dimensões
        const comprimentoPerfil = (5 * dados.comprimento) / 1000; // 5*comprimento/1000 metros
        const quantidadeTravessas = (((dados.comprimento - 100) / 150) * dados.largura * 2) / 1000; // ((comprimento-100)/150)*largura*2/1000
        
        // Quantidades fixas de parafusos e porcas por degrau conforme especificação
        let quantidadeParafusos40, quantidadeParafusos60, quantidadePorcas;
        
        if (dados.tipo_perfil === 'I38') {
            // Quantidades para perfil I38
            quantidadeParafusos40 = 2; // 2 parafusos M6X40 por degrau
            quantidadeParafusos60 = 4; // 4 parafusos M6X60 por degrau  
            quantidadePorcas = 6; // 6 porcas M6 por degrau
        } else {
            // Quantidades para perfil I25 (padrão)
            quantidadeParafusos40 = 4; // 4 parafusos M6X40 por degrau
            quantidadeParafusos60 = 2; // 2 parafusos M6X60 por degrau  
            quantidadePorcas = 6; // 6 porcas M6 por degrau
        }
        
        // Aplicar fator de perda conforme definido no formulário
        const fatorPerda = 1 + (dados.percentual_perda / 100);
        
        // Calcular custos individuais (com perda para materiais)
        const custoPerfil = (5 * dados.comprimento * perfilPrincipal.custo_centavos / 1000 * dados.quantidade) * fatorPerda;
        const custoTravessa = (quantidadeTravessas * travessa.custo_centavos * dados.quantidade) * fatorPerda;
        const custoCola = (0.05 * (dados.largura * dados.comprimento) * cola.custo_centavos / 1000000 * dados.quantidade) * fatorPerda;
        const custoReforco = (perfilReforco && perfilReforco.id !== cola.id) ? 
                           (2 * dados.largura * perfilReforco.custo_centavos / 1000 * dados.quantidade) * fatorPerda : 0;
        const custoTubo = (dados.comprimento / 1000 * tuboQuadrado.custo_centavos * dados.quantidade) * fatorPerda;
        const custoParaf40 = (quantidadeParafusos40 * paraf40.custo_centavos * dados.quantidade) * fatorPerda;
        const custoParaf60 = (quantidadeParafusos60 * paraf60.custo_centavos * dados.quantidade) * fatorPerda;
        const custoPorcas = (quantidadePorcas * porca.custo_centavos * dados.quantidade) * fatorPerda;
        
        // Total dos materiais
        const custoTotalMateriaisCentavos = custoPerfil + custoTravessa + custoCola + custoReforco + 
                                          custoTubo + custoParaf40 + custoParaf60 + custoPorcas;
        
        // Calcular mão de obra (sem perda)
        const valorHoraMO = 65.79; // R$/hora
        const custoMaoObraTotal = (dados.tempo_proc + dados.tempo_mtg) * valorHoraMO * 100 * dados.quantidade;
        
        // Custo total
        const custoTotalCentavos = custoTotalMateriaisCentavos + custoMaoObraTotal;
        
        // Criar resultado
        const resultado = {
            nome: dados.nome_degrau,
            categoria: 'ESTRUTURAS',
            tipo_calculo: 'degraus',
            custo_total: custoTotalCentavos,
            parametros: dados,
            componentes: []
        };
        
        // Adicionar componentes ao resultado
        resultado.componentes.push({
            nome: `${perfilPrincipal.descricao} - ${comprimentoPerfil.toFixed(2)}m`,
            descricao_produto: perfilPrincipal.descricao,
            quantidade: comprimentoPerfil * dados.quantidade,
            custo_unitario: perfilPrincipal.custo_centavos,
            custo_total: custoPerfil,
            unidade: 'm'
        });
        
        // Travessa (Perfil Chaveta)
        resultado.componentes.push({
            nome: `${travessa.descricao} - ${quantidadeTravessas.toFixed(3)}m`,
            descricao_produto: travessa.descricao,
            quantidade: quantidadeTravessas * dados.quantidade,
            custo_unitario: travessa.custo_centavos,
            custo_total: custoTravessa,
            unidade: 'm'
        });
        
        // Cola Estrutural
        const quantidadeCola = (0.05 * (dados.largura * dados.comprimento) / 1000000) * dados.quantidade; // kg
        resultado.componentes.push({
            nome: `${cola.descricao} - ${quantidadeCola.toFixed(3)}kg`,
            descricao_produto: cola.descricao,
            quantidade: quantidadeCola,
            custo_unitario: cola.custo_centavos,
            custo_total: custoCola,
            unidade: 'kg'
        });
        
        // Perfil de reforço E
        const quantidadeReforco = (2 * dados.largura / 1000) * dados.quantidade; // 2*Largura/1000
        resultado.componentes.push({
            nome: `${perfilReforco.descricao} - ${quantidadeReforco.toFixed(2)}m`,
            descricao_produto: perfilReforco.descricao,
            quantidade: quantidadeReforco,
            custo_unitario: perfilReforco.custo_centavos,
            custo_total: custoReforco,
            unidade: 'm'
        });
        
        // Tubo quadrado (comprimento × 2)
        const quantidadeTubo = ((dados.comprimento * 2) / 1000) * dados.quantidade;
        resultado.componentes.push({
            nome: `${tuboQuadrado.descricao} - ${quantidadeTubo.toFixed(2)}m`,
            descricao_produto: tuboQuadrado.descricao,
            quantidade: quantidadeTubo,
            custo_unitario: tuboQuadrado.custo_centavos,
            custo_total: custoTubo,
            unidade: 'm'
        });
        
        resultado.componentes.push({
            nome: `${paraf40.descricao} - ${quantidadeParafusos40} unid`,
            descricao_produto: paraf40.descricao,
            quantidade: quantidadeParafusos40 * dados.quantidade,
            custo_unitario: paraf40.custo_centavos,
            custo_total: custoParaf40,
            unidade: 'unid'
        });
        
        resultado.componentes.push({
            nome: `${paraf60.descricao} - ${quantidadeParafusos60} unid`,
            descricao_produto: paraf60.descricao,
            quantidade: quantidadeParafusos60 * dados.quantidade,
            custo_unitario: paraf60.custo_centavos,
            custo_total: custoParaf60,
            unidade: 'unid'
        });
        
        resultado.componentes.push({
            nome: `${porca.descricao} - ${quantidadePorcas} unid`,
            descricao_produto: porca.descricao,
            quantidade: quantidadePorcas * dados.quantidade,
            custo_unitario: porca.custo_centavos,
            custo_total: custoPorcas,
            unidade: 'unid'
        });
        
        // Adicionar mão de obra se houver
        if (custoMaoObraTotal > 0) {
            const maoObraDescricao = `Processamento/Montagem - ${dados.tempo_proc + dados.tempo_mtg}h`;
            resultado.componentes.push({
                nome: maoObraDescricao,
                descricao_produto: maoObraDescricao,
                quantidade: (dados.tempo_proc + dados.tempo_mtg) * dados.quantidade,
                custo_unitario: valorHoraMO * 100,
                custo_total: custoMaoObraTotal,
                unidade: 'h'
            });
        }
        
        // Salvar resultado globalmente
        ultimoCalculo = resultado;
        
        // Mostrar componentes na tabela
        mostrarComponentesCalculados(resultado.componentes);
        
        // Habilitar botão de salvar
        document.getElementById('salvarProdutoBtn').disabled = false;
        
        console.log('✅ Cálculo de Degraus concluído com sucesso');
        console.log('Resultado final:', resultado);
        
    }).catch(error => {
        console.error('❌ Erro no cálculo:', error);
        alert(`Erro no cálculo: ${error.message}`);
    });
}

function calcularDegrauInjetado() {
    console.log('=== CALCULANDO DEGRAU INJETADO ===');
    
    // Verificar se todos os campos obrigatórios estão preenchidos
    const camposObrigatorios = [
        'degrau_inj_nome', 'degrau_inj_grade', 'degrau_inj_largura', 'degrau_inj_comprimento'
    ];
    
    let todosCamposPreenchidos = true;
    const dados = {};
    
    camposObrigatorios.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (!elemento || !elemento.value.trim()) {
            todosCamposPreenchidos = false;
            console.warn(`Campo ${campo} não preenchido`);
            return;
        }
        
        const valor = elemento.value.trim();
        if (campo === 'degrau_inj_nome') {
            dados.nome_degrau = valor;
        } else if (campo === 'degrau_inj_grade') {
            dados.grade_id = parseInt(valor);
        } else {
            const nomeLimpo = campo.replace('degrau_inj_', '');
            dados[nomeLimpo] = parseFloat(valor);
        }
    });
    
    // Campos opcionais
    dados.quantidade = 1; // Fixo em 1 unidade
    dados.tempo_proc = parseFloat(document.getElementById('degrau_inj_tempo_proc')?.value || '1.0');
    dados.tempo_mtg = parseFloat(document.getElementById('degrau_inj_tempo_mtg')?.value || '1.5');
    dados.percentual_perda = parseFloat(document.getElementById('degrau_inj_perda')?.value || '3.0');
    
    if (!todosCamposPreenchidos) {
        alert('Por favor, preencha todos os campos obrigatórios.');
        return;
    }
    
    console.log('Dados coletados (Degrau Injetado):', dados);
    
    // Buscar produtos necessários dinamicamente (sem cola e chaveta)
    Promise.all([
        buscarProdutoPorId(dados.grade_id), // Grade injetada selecionada
        buscarProdutoPorDescricao('E - 4\'x1.3/16\' #3/16\''), // Sempre perfil E para degrau injetado
        buscarProdutoPorDescricao('PERFIL F 4"'), // Perfil F para grades 38mm
        buscarProdutoPorDescricao('Tubo Quadrado 25x38#3mm'),
        buscarProdutoPorDescricao('PARAF-SXT-M6X40-AI304'),
        buscarProdutoPorDescricao('PARAF-SXT-M6X60-AI304'),
        buscarProdutoPorDescricao('POR-SXT-M6-AI304')
    ]).then(([gradeInjetada, perfilE, perfilF, tuboQuadrado, paraf40, paraf60, porca]) => {
        
        console.log('=== PRODUTOS ENCONTRADOS (DEGRAU INJETADO) ===');
        console.log('Grade Injetada:', gradeInjetada);
        console.log('Perfil E:', perfilE);
        console.log('Perfil F:', perfilF);
        console.log('Tubo Quadrado:', tuboQuadrado);
        console.log('Parafusos:', { paraf40, paraf60, porca });
        
        // Verificar se é grade de 38mm (e NÃO de 25mm)
        const isGrade38 = gradeInjetada.descricao && 
                         gradeInjetada.descricao.toLowerCase().includes('38') && 
                         !gradeInjetada.descricao.toLowerCase().includes('25');
        
        // Calcular dimensões e quantidades (igual aos degraus normais)
        const areaDegrau = (dados.largura * dados.comprimento) / 1000000; // m²
        const alturaFixa = 150; // Altura fixa de 150mm para degraus
        const volumeDegrau = areaDegrau * (alturaFixa / 1000); // m³
        
        // Quantidades específicas para degrau injetado
        const quantidadeParafusos40 = 4; // 4 parafusos M6X40 por degrau
        const quantidadeParafusos60 = 4; // 4 parafusos M6X60 por degrau  
        const quantidadePorcas = 8; // 8 porcas M6 por degrau
        
        // Aplicar fator de perda conforme definido no formulário
        const fatorPerda = 1 + (dados.percentual_perda / 100);
        
        // Calcular custos individuais (com perda para materiais)
        // Para grade injetada: usar área do degrau × custo/m² da grade
        const custoGrade = (areaDegrau * gradeInjetada.custo_centavos * dados.quantidade) * fatorPerda;
        
        // Perfil E (apenas para grades que NÃO são 38mm)
        const custoPerfilE = !isGrade38 ? (2 * dados.largura * perfilE.custo_centavos / 1000 * dados.quantidade) * fatorPerda : 0;
        
        // Perfil F (apenas para grades 38mm)
        const custoPerfilF = isGrade38 ? (2 * dados.largura * perfilF.custo_centavos / 1000 * dados.quantidade) * fatorPerda : 0;
        
        const custoTubo = ((dados.comprimento * 2) / 1000 * tuboQuadrado.custo_centavos * dados.quantidade) * fatorPerda; // Comprimento × 2
        const custoParaf40 = (quantidadeParafusos40 * paraf40.custo_centavos * dados.quantidade) * fatorPerda;
        const custoParaf60 = (quantidadeParafusos60 * paraf60.custo_centavos * dados.quantidade) * fatorPerda;
        const custoPorcas = (quantidadePorcas * porca.custo_centavos * dados.quantidade) * fatorPerda;
        
        // Total dos materiais (sem cola e travessa)
        const custoTotalMateriaisCentavos = custoGrade + custoPerfilE + custoPerfilF + 
                                          custoTubo + custoParaf40 + custoParaf60 + custoPorcas;
        
        // Calcular mão de obra (sem perda)
        const valorHoraMO = 65.79; // R$/hora
        const custoMaoObraTotal = (dados.tempo_proc + dados.tempo_mtg) * valorHoraMO * 100 * dados.quantidade;
        
        // Custo total
        const custoTotalCentavos = custoTotalMateriaisCentavos + custoMaoObraTotal;
        
        // Criar resultado
        const resultado = {
            nome: dados.nome_degrau,
            categoria: 'ESTRUTURAS',
            tipo_calculo: 'degrau_injetado',
            custo_total: custoTotalCentavos,
            parametros: dados,
            componentes: []
        };
        
        // Adicionar componentes ao resultado
        resultado.componentes.push({
            nome: `${gradeInjetada.descricao} - ${areaDegrau.toFixed(4)}m²`,
            descricao_produto: gradeInjetada.descricao,
            quantidade: areaDegrau * dados.quantidade,
            custo_unitario: gradeInjetada.custo_centavos,
            custo_total: custoGrade,
            unidade: 'm²'
        });
        
        // Perfil E (apenas para grades que NÃO são 38mm)
        if (!isGrade38) {
            const quantidadePerfilE = (2 * dados.largura / 1000) * dados.quantidade; // 2*Largura/1000
            resultado.componentes.push({
                nome: `${perfilE.descricao} - ${quantidadePerfilE.toFixed(2)}m`,
                descricao_produto: perfilE.descricao,
                quantidade: quantidadePerfilE,
                custo_unitario: perfilE.custo_centavos,
                custo_total: custoPerfilE,
                unidade: 'm'
            });
        }
        
        // Perfil F (apenas para grades 38mm)
        if (isGrade38) {
            const quantidadePerfilF = (2 * dados.largura / 1000) * dados.quantidade; // 2*Largura/1000
            resultado.componentes.push({
                nome: `${perfilF.descricao} - ${quantidadePerfilF.toFixed(2)}m`,
                descricao_produto: perfilF.descricao,
                quantidade: quantidadePerfilF,
                custo_unitario: perfilF.custo_centavos,
                custo_total: custoPerfilF,
                unidade: 'm'
            });
        }
        
        // Tubo quadrado (comprimento × 2)
        const quantidadeTubo = ((dados.comprimento * 2) / 1000) * dados.quantidade;
        resultado.componentes.push({
            nome: `${tuboQuadrado.descricao} - ${quantidadeTubo.toFixed(2)}m`,
            descricao_produto: tuboQuadrado.descricao,
            quantidade: quantidadeTubo,
            custo_unitario: tuboQuadrado.custo_centavos,
            custo_total: custoTubo,
            unidade: 'm'
        });
        
        resultado.componentes.push({
            nome: `${paraf40.descricao} - ${quantidadeParafusos40} unid`,
            descricao_produto: paraf40.descricao,
            quantidade: quantidadeParafusos40 * dados.quantidade,
            custo_unitario: paraf40.custo_centavos,
            custo_total: custoParaf40,
            unidade: 'unid'
        });
        
        resultado.componentes.push({
            nome: `${paraf60.descricao} - ${quantidadeParafusos60} unid`,
            descricao_produto: paraf60.descricao,
            quantidade: quantidadeParafusos60 * dados.quantidade,
            custo_unitario: paraf60.custo_centavos,
            custo_total: custoParaf60,
            unidade: 'unid'
        });
        
        resultado.componentes.push({
            nome: `${porca.descricao} - ${quantidadePorcas} unid`,
            descricao_produto: porca.descricao,
            quantidade: quantidadePorcas * dados.quantidade,
            custo_unitario: porca.custo_centavos,
            custo_total: custoPorcas,
            unidade: 'unid'
        });
        
        // Adicionar mão de obra se houver
        if (custoMaoObraTotal > 0) {
            const maoObraDescricao = `Processamento/Montagem - ${dados.tempo_proc + dados.tempo_mtg}h`;
            resultado.componentes.push({
                nome: maoObraDescricao,
                descricao_produto: maoObraDescricao,
                quantidade: (dados.tempo_proc + dados.tempo_mtg) * dados.quantidade,
                custo_unitario: valorHoraMO * 100,
                custo_total: custoMaoObraTotal,
                unidade: 'h'
            });
        }
        
        // Salvar resultado globalmente
        ultimoCalculo = resultado;
        
        // Mostrar componentes na tabela
        mostrarComponentesCalculados(resultado.componentes);
        
        // Habilitar botão de salvar
        document.getElementById('salvarProdutoBtn').disabled = false;
        
        console.log('✅ Cálculo de Degrau Injetado concluído com sucesso');
        console.log('Resultado final:', resultado);
        
    }).catch(error => {
        console.error('❌ Erro no cálculo:', error);
        alert(`Erro no cálculo: ${error.message}`);
    });
}

function calcularTampaMontada() {
    console.log('=== CALCULANDO TAMPA MONTADA ===');
    
    // Verificar se todos os campos obrigatórios estão preenchidos
    const camposObrigatorios = [
        'tampa_nome', 'tampa_vao', 'tampa_comprimento', 'tampa_eixo_i', 'tampa_perfil'
    ];
    
    let todosCamposPreenchidos = true;
    const dados = {};
    
    camposObrigatorios.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (!elemento || !elemento.value.trim()) {
            todosCamposPreenchidos = false;
            console.warn(`Campo ${campo} não preenchido`);
            return;
        }
        
        const valor = elemento.value.trim();
        if (campo === 'tampa_nome') {
            dados.nome_tampa = valor;
        } else if (campo === 'tampa_perfil') {
            dados.perfil_id = parseInt(valor);
        } else {
            const nomeLimpo = campo.replace('tampa_', '');
            dados[nomeLimpo] = parseFloat(valor);
        }
    });
    
    // Campos opcionais
    dados.perda = parseFloat(document.getElementById('tampa_perda').value) || 3;
    dados.tempo_proc = parseFloat(document.getElementById('tampa_tempo_proc').value) || 1.5;
    dados.tempo_mtg = parseFloat(document.getElementById('tampa_tempo_mtg').value) || 0.5;
    dados.quadro_u4 = document.getElementById('tampa_quadro_u4').checked;
    dados.alca = document.getElementById('tampa_alca').checked;
    dados.chapa_ev = document.getElementById('tampa_chapa_ev').checked;
    dados.tipo_calculo = 'tampa_montada';
    
    if (!todosCamposPreenchidos) {
        alert('Por favor, preencha todos os campos obrigatórios (marcados com *).');
        return;
    }
    
    console.log('Dados da tampa montada:', dados);
    
    // Buscar produtos necessários
    fetch('/api/produtos/')
        .then(response => response.json())
        .then(produtos => {
            console.log(`✅ ${produtos.length} produtos carregados da API`);
            
            // Encontrar perfil selecionado
            const perfilSelecionado = produtos.find(p => p.id === dados.perfil_id);
            if (!perfilSelecionado) {
                throw new Error(`Perfil com ID ${dados.perfil_id} não encontrado`);
            }
            
            // Encontrar chaveta (sempre ID 1332)
            const chaveta = produtos.find(p => p.id === 1332);
            if (!chaveta) {
                throw new Error('Chaveta Perfil I (ID 1332) não encontrada no banco');
            }
            
            // Encontrar cola estrutural (sempre ID 1183)
            const cola = produtos.find(p => p.id === 1183);
            if (!cola) {
                throw new Error('COLA ESTRUTURAL 4500 A/B (ID 1183) não encontrada no banco');
            }
            
            // Encontrar chapa 2,5mm (buscar por descrição)
            const chapa25 = produtos.find(p => 
                p.descricao && 
                p.descricao.toLowerCase().includes('chapa') && 
                p.descricao.toLowerCase().includes('2,5')
            );
            if (!chapa25) {
                throw new Error('Chapa 2,5mm não encontrada no banco');
            }
            
            // Encontrar perfil U4" (se necessário)
            let perfilU4 = null;
            if (dados.quadro_u4) {
                perfilU4 = produtos.find(p => 
                    p.descricao && 
                    p.descricao.toLowerCase().includes('u4')
                );
                if (!perfilU4) {
                    throw new Error('Perfil U4" não encontrado no banco');
                }
            }
            
            // Encontrar alça (se necessário)
            let alca = null;
            if (dados.alca) {
                alca = produtos.find(p => 
                    p.descricao && 
                    p.descricao.toLowerCase().includes('alça')
                );
                if (!alca) {
                    throw new Error('Alça não encontrada no banco');
                }
            }
            
            // Encontrar chapa EV (se necessário) - ID fixo 1384
            let chapaEV = null;
            if (dados.chapa_ev) {
                chapaEV = produtos.find(p => p.id === 1384);
                if (!chapaEV) {
                    throw new Error('Chapa EV - Res. Poliéster (ID 1384) não encontrada no banco');
                }
            }
            
            // Encontrar mão de obra processamento/montagem
            const maoObraProcessamento = produtos.find(p => 
                p.descricao && 
                p.descricao.toLowerCase().includes('mão de obra') && 
                p.descricao.toLowerCase().includes('processamento')
            );
            if (!maoObraProcessamento) {
                throw new Error('Produto de mão de obra Processamento/Montagem não encontrado no banco');
            }
            
            console.log(`📐 Perfil selecionado: ${perfilSelecionado.descricao}`);
            console.log(`🔧 Chaveta incluída: ${chaveta.descricao}`);
            console.log(`🧴 Cola incluída: ${cola.descricao}`);
            console.log(`📋 Chapa 2,5mm: ${chapa25.descricao}`);
            if (perfilU4) console.log(`🔲 Perfil U4": ${perfilU4.descricao}`);
            if (alca) console.log(`🎯 Alça: ${alca.descricao}`);
            if (chapaEV) console.log(`📋 Chapa EV: ${chapaEV.descricao}`);
            
            // APLICAR FÓRMULAS DA TAMPA MONTADA
            const fatorPerda = 1 + (dados.perda / 100);
            
            // 1. Perfil (mesma lógica da grade)
            const metrosLinearesPorM2 = (dados.comprimento / dados.eixo_i) * (dados.vao / 1000);
            const pesoPerfilKg = metrosLinearesPorM2 * perfilSelecionado.peso_und;
            let custoPerfilCentavos = metrosLinearesPorM2 * perfilSelecionado.custo_centavos;
            
            // 2. Chaveta (mesma lógica da grade)
            const quantidadeChaveta = (dados.vao / 150) * 2;
            const pesoChaveta = quantidadeChaveta * chaveta.peso_und;
            let custoChaveta = quantidadeChaveta * chaveta.custo_centavos;
            
            // 3. Cola - 0,1 * custo da cola
            const quantidadeCola = 0.1;
            const pesoCola = quantidadeCola * cola.peso_und;
            let custoCola = quantidadeCola * cola.custo_centavos;
            
            // 4. Chapa 2,5mm - vão * comprimento * custo chapa (em m²)
            const areaChapa = (dados.vao / 1000) * (dados.comprimento / 1000); // em m²
            const pesoChapa25 = areaChapa * chapa25.peso_und;
            
            // AJUSTE ESPECIAL: Se Chapa EV marcada, usar fórmula específica
            let custoChapa25;
            let nomeChapa, descricaoChapa;
            if (dados.chapa_ev) {
                // NOVA FÓRMULA: (vão * comprimento * custo chapa EV) / 1000000
                custoChapa25 = (dados.vao * dados.comprimento * chapaEV.custo_centavos) / 1000000;
                nomeChapa = "Chapa EV - Res. Poliéster";
                descricaoChapa = "Chapa EV - Res. Poliéster";
                console.log(`🔧 CHAPA EV MARCADA: Aplicando fórmula (${dados.vao} * ${dados.comprimento} * ${chapaEV.custo_centavos/100}) / 1.000.000 = R$ ${(custoChapa25/100).toFixed(2)}`);
            } else {
                custoChapa25 = areaChapa * chapa25.custo_centavos; // Cálculo normal
                nomeChapa = chapa25.descricao;
                descricaoChapa = chapa25.descricao;
            }
            
            // 5. Quadro U4" - se 'sim' custo perfil u4 * 2
            let pesoU4 = 0, custoU4 = 0;
            if (dados.quadro_u4 && perfilU4) {
                pesoU4 = 2 * perfilU4.peso_und;
                custoU4 = 2 * perfilU4.custo_centavos;
            }
            
            // 6. Alça - se sim custo da alça * 2
            let pesoAlca = 0, custoAlca = 0;
            if (dados.alca && alca) {
                pesoAlca = 2 * alca.peso_und;
                custoAlca = 2 * alca.custo_centavos;
            }
            
            // 7. Chapa EV - REMOVIDO: agora integrado na lógica da chapa principal
            
            // Aplicar perda aos materiais individuais (exceto mão de obra)
            custoPerfilCentavos = custoPerfilCentavos * fatorPerda;
            custoChaveta = custoChaveta * fatorPerda;
            custoCola = custoCola * fatorPerda;
            custoChapa25 = custoChapa25 * fatorPerda;
            custoU4 = custoU4 * fatorPerda;
            custoAlca = custoAlca * fatorPerda;
            
            // Total dos materiais com perda já aplicada
            const custoTotalMateriaisCentavos = custoPerfilCentavos + custoChaveta + custoCola + custoChapa25 + custoU4 + custoAlca;
            
            // Calcular mão de obra (sem perda) - LÓGICA ESPECIAL PARA TAMPA MONTADA
            const valorHoraMO = 65.79; // R$/hora
            const custoMaoObraBase = (dados.tempo_proc + dados.tempo_mtg) * valorHoraMO * 100; // custo base em centavos
            
            // Aplicar multiplicador baseado nas opções selecionadas
            let multiplicadorMO = 1.0; // padrão: nenhuma opção selecionada
            let descricaoOpcoes = '';
            
            if (dados.quadro_u4 && dados.alca) {
                multiplicadorMO = 2.0;
                descricaoOpcoes = ' (com Quadro U4" + Alça)';
            } else if (!dados.quadro_u4 && dados.alca) {
                multiplicadorMO = 1.9;
                descricaoOpcoes = ' (com Alça)';
            } else if (dados.quadro_u4 && !dados.alca) {
                multiplicadorMO = 1.1;
                descricaoOpcoes = ' (com Quadro U4")';
            } else {
                multiplicadorMO = 1.0;
                descricaoOpcoes = ' (básico)';
            }
            
            const custoMaoObraTotal = Math.round(custoMaoObraBase * multiplicadorMO);
            const maoObraDescricao = `MÃO DE OBRA Processamento/Montagem${descricaoOpcoes}`;
            
            console.log(`\n🔧 CÁLCULO ESPECIAL MÃO DE OBRA TAMPA:`);
            console.log(`   • Custo base: R$ ${(custoMaoObraBase/100).toFixed(2)}`);
            console.log(`   • Multiplicador: ${multiplicadorMO}x ${descricaoOpcoes}`);
            console.log(`   • Custo final MO: R$ ${(custoMaoObraTotal/100).toFixed(2)}`);
            
            // Custo total
            const custoTotalCentavos = custoTotalMateriaisCentavos + custoMaoObraTotal;
            
            // Peso total
            const pesoTotalKg = (pesoPerfilKg + pesoChaveta + pesoCola + pesoChapa25 + pesoU4 + pesoAlca) * fatorPerda;
            
            console.log('\n🧮 CÁLCULO DETALHADO TAMPA MONTADA:');
            console.log(`Perfil - Metros lineares/m²: ${metrosLinearesPorM2.toFixed(4)} m/m²`);
            console.log(`Perfil - Peso: ${pesoPerfilKg.toFixed(3)} kg/m² | Custo: R$ ${(custoPerfilCentavos/100).toFixed(2)}/m²`);
            console.log(`Chaveta - Quantidade: ${quantidadeChaveta.toFixed(4)} m/m²`);
            console.log(`Cola - Quantidade fixa: ${quantidadeCola} unid`);
            console.log(`${nomeChapa} - Área: ${areaChapa.toFixed(4)} m² | Custo: R$ ${(custoChapa25/100).toFixed(2)}`);
            if (dados.quadro_u4) console.log(`Quadro U4" - 2 unidades | Custo: R$ ${(custoU4/100).toFixed(2)}`);
            if (dados.alca) console.log(`Alças - 2 unidades | Custo: R$ ${(custoAlca/100).toFixed(2)}`);
            console.log(`\n💰 RESUMO DE CUSTOS:`);
            console.log(`   Materiais (com ${dados.perda}% perda): R$ ${(custoTotalMateriaisCentavos/100).toFixed(2)}/m²`);
            console.log(`   Mão de Obra (sem perda): R$ ${(custoMaoObraTotal/100).toFixed(2)}/m²`);
            console.log(`   TOTAL FINAL: R$ ${(custoTotalCentavos/100).toFixed(2)}/m² | Peso: ${pesoTotalKg.toFixed(3)} kg/m²`);
            
            // Criar resultado final
            const resultado = {
                success: true,
                nome_produto: dados.nome_tampa,
                custo_total: custoTotalCentavos,
                peso_total: pesoTotalKg,
                metros_lineares_por_m2: metrosLinearesPorM2,
                mao_obra_produto_id: maoObraProcessamento.id,
                componentes: [
                    {
                        nome: `${perfilSelecionado.descricao} (com ${dados.perda}% perda no custo)`,
                        produto_nome: perfilSelecionado.descricao,
                        quantidade: metrosLinearesPorM2,
                        custo_unitario: perfilSelecionado.custo_centavos,
                        custo_total: custoPerfilCentavos,
                        unidade: 'm'
                    },
                    {
                        nome: `${chaveta.descricao} (com ${dados.perda}% perda no custo)`,
                        produto_nome: chaveta.descricao,
                        quantidade: quantidadeChaveta,
                        custo_unitario: chaveta.custo_centavos,
                        custo_total: custoChaveta,
                        unidade: 'm'
                    },
                    {
                        nome: `${cola.descricao} - Quantidade fixa 0,1`,
                        produto_nome: cola.descricao,
                        quantidade: quantidadeCola,
                        custo_unitario: cola.custo_centavos,
                        custo_total: custoCola,
                        unidade: 'unid'
                    },
                    {
                        nome: `${nomeChapa} - Área completa`,
                        produto_nome: descricaoChapa,
                        quantidade: areaChapa,
                        custo_unitario: dados.chapa_ev ? 27750 : chapa25.custo_centavos,
                        custo_total: custoChapa25,
                        unidade: 'm²'
                    }
                ]
            };
            
            // Adicionar componentes opcionais
            if (dados.quadro_u4 && perfilU4) {
                resultado.componentes.push({
                    nome: `${perfilU4.descricao} - 2 unidades`,
                    produto_nome: perfilU4.descricao,
                    quantidade: 2,
                    custo_unitario: perfilU4.custo_centavos,
                    custo_total: custoU4,
                    unidade: 'unid'
                });
            }
            
            if (dados.alca && alca) {
                resultado.componentes.push({
                    nome: `${alca.descricao} - 2 unidades`,
                    produto_nome: alca.descricao,
                    quantidade: 2,
                    custo_unitario: alca.custo_centavos,
                    custo_total: custoAlca,
                    unidade: 'unid'
                });
            }
            
            // Chapa EV agora é integrada na chapa principal - não adicionar separadamente
            
            // Adicionar mão de obra aos componentes se selecionada
            if (custoMaoObraTotal > 0) {
                resultado.componentes.push({
                    nome: maoObraDescricao,
                    produto_nome: maoObraDescricao,
                    quantidade: dados.tempo_proc + dados.tempo_mtg,
                    custo_unitario: valorHoraMO * 100,
                    custo_total: custoMaoObraTotal,
                    unidade: 'h'
                });
            }
            
            // Verificar soma dos componentes
            const somaComponentes = resultado.componentes.reduce((total, comp) => total + comp.custo_total, 0);
            console.log(`\n🔎 VERIFICAÇÃO FINAL:`);
            console.log(`Custo total calculado: ${custoTotalCentavos} centavos = R$ ${(custoTotalCentavos/100).toFixed(2)}`);
            console.log(`Soma dos componentes: ${somaComponentes} centavos = R$ ${(somaComponentes/100).toFixed(2)}`);
            
            // Atualizar o custo_total com a soma correta
            resultado.custo_total = somaComponentes;
            
            // Salvar resultado globalmente
            ultimoCalculo = resultado;
            
            // Mostrar resultado na interface
            document.getElementById('nomeProdutoCalculado').textContent = dados.nome_tampa;
            document.getElementById('custoTotalCalculado').textContent = `R$ ${(custoTotalCentavos / 100).toFixed(2)}/m²`;
            document.getElementById('pesoTotalCalculado').textContent = `${pesoTotalKg.toFixed(3)} kg/m²`;
            document.getElementById('resultadoCalculado').style.display = 'block';
            
            // Preencher tabela de componentes
            preencherTabelaComponentesTampa(resultado);
            
            // Habilitar botão salvar
            document.getElementById('salvarProdutoBtn').disabled = false;
            
            console.log('✅ Cálculo de tampa montada concluído:', resultado);
        })
        .catch(error => {
            console.error('❌ Erro ao calcular tampa montada:', error);
            alert('Erro ao calcular tampa montada: ' + error.message);
        });
}

function preencherTabelaComponentesTampa(resultado) {
    console.log('=== PREENCHENDO TABELA DE COMPONENTES PARA TAMPA MONTADA ===');
    
    const tbody = document.getElementById('componentesCalculadosTable');
    if (!tbody) {
        console.warn('Tabela componentesCalculadosTable não encontrada');
        return;
    }
    
    // Limpar tabela
    tbody.innerHTML = '';
    
    // Adicionar linha para cada componente
    resultado.componentes.forEach((comp, index) => {
        const row = tbody.insertRow();
        
        // Componentes de tampa montada não têm fator editável
        const fatorCol = '<span class="text-muted">-</span>';
        const acaoCol = '<span class="text-muted">-</span>';
        
        row.innerHTML = `
            <td>${comp.nome || 'N/A'}</td>
            <td>${comp.produto_nome || 'N/A'}</td>
            <td>${fatorCol}</td>
            <td><span class="quantidade-display">${comp.quantidade ? comp.quantidade.toFixed(4) : '0.0000'}</span></td>
            <td>R$ ${comp.custo_unitario ? (comp.custo_unitario/100).toFixed(2) : '0.00'}</td>
            <td><span class="custo-total-display">R$ ${comp.custo_total ? (comp.custo_total/100).toFixed(2) : '0.00'}</span></td>
            <td>${acaoCol}</td>`;
        
        console.log(`✓ Componente adicionado: ${comp.nome} - ${comp.quantidade.toFixed(4)} ${comp.unidade || 'm'}`);
    });
    
    // Adicionar linha de total
    const totalRow = tbody.insertRow();
    const custoTotalGeral = resultado.componentes.reduce((total, comp) => total + comp.custo_total, 0);
    totalRow.innerHTML = `
        <td colspan="5"><strong>TOTAL GERAL</strong></td>
        <td><strong>R$ ${(custoTotalGeral/100).toFixed(2)}</strong></td>
        <td></td>`;
    totalRow.style.backgroundColor = '#f8f9fa';
    
    console.log(`✅ Tabela preenchida com ${resultado.componentes.length} componentes. Total: R$ ${(custoTotalGeral/100).toFixed(2)}`);
}

function calcularGuardaCorpoHorizontal() {
    console.log('=== CALCULANDO GUARDA CORPO - HORIZONTAL ===');
    alert('Função de cálculo horizontal em desenvolvimento. Use o template vertical por enquanto.');
}

function calcularGuardaCorpoVertical() {
    console.log('=== CALCULANDO GUARDA CORPO - VERTICAL ===');
    
    // Verificar se todos os campos obrigatórios estão preenchidos
    const camposObrigatorios = [
        'gc_vert_nome', 'gc_vert_larg_modulo', 'gc_vert_altura', 
        'gc_vert_n_colunas', 
        'gc_vert_tipo_tubo_quad', 'gc_vert_tipo_sapata'
    ];
    
    let todosCamposPreenchidos = true;
    const dados = {};
    
    camposObrigatorios.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (!elemento || !elemento.value.trim()) {
            todosCamposPreenchidos = false;
            console.warn(`Campo ${campo} não preenchido`);
            return;
        }
        
        const valor = elemento.value.trim();
        if (campo === 'gc_vert_nome') {
            dados.nome_guarda_corpo = valor;
        } else {
            const nomeLimpo = campo.replace('gc_vert_', '');
            if (['larg_modulo', 'altura'].includes(nomeLimpo)) {
                dados[nomeLimpo] = parseFloat(valor);
            } else if (['n_colunas'].includes(nomeLimpo)) {
                dados[nomeLimpo] = parseFloat(valor); // Mudado de parseInt para parseFloat
            } else {
                dados[nomeLimpo] = valor;
            }
        }
    });
    
    // Campos opcionais
    dados.quantidade = 1; // Fixo em 1 unidade
    dados.tempo_proc = parseFloat(document.getElementById('gc_vert_tempo_proc')?.value || '2.0');
    dados.tempo_mtg = parseFloat(document.getElementById('gc_vert_tempo_mtg')?.value || '3.0');
    dados.percentual_perda = parseFloat(document.getElementById('gc_vert_perda')?.value || '3.0');
    
    // Novos campos adicionados
    dados.vao_livre = parseFloat(document.getElementById('gc_vert_vao_livre')?.value || '0');
    dados.vao = parseFloat(document.getElementById('gc_vert_vao')?.value || '0');
    dados.tipo_tubo_redondo = document.getElementById('gc_vert_tipo_tubo_redondo')?.value || '';
    
    // Guarda Corpo Vertical não possui barras intermediárias
    dados.n_br_intermediaria = 0;
    console.log('Guarda Corpo Vertical: sem barras intermediárias (n_br_intermediaria = 0)');
    
    if (!todosCamposPreenchidos) {
        alert('Por favor, preencha todos os campos obrigatórios.');
        return;
    }
    
    console.log('Dados coletados (Guarda Corpo - Vertical):', dados);
    
    // Preparar busca de produtos - tubo redondo é opcional
    const buscasProdutos = [
        buscarProdutoPorDescricao(dados.tipo_tubo_quad), // Tubo quadrado selecionado (4mm ou 6mm)
        buscarProdutoPorDescricao('Tubo Quadrado 50 #3mm'), // Tubo 3mm automático
        buscarProdutoPorDescricao(dados.tipo_sapata), // Sapata selecionada
        buscarProdutoPorDescricao('Perfil Corrimão (s/ pintura) - Res. Poliéster'), // Corrimão fixo
        buscarProdutoPorDescricao('Perfil Rodapé 200mm (s/ pintura) - Res. Poliéster'), // Rodapé fixo
        buscarProdutoPorDescricao('PARAF-SXT-M6X70-AI304'),
        buscarProdutoPorDescricao('POR-SXT-M6-AI304'),
        buscarProdutoPorDescricao('PARAF-AA-PN-PH-4,8X19-AI304')
    ];
    
    // Adicionar tubo redondo se foi selecionado
    if (dados.tipo_tubo_redondo) {
        buscasProdutos.push(buscarProdutoPorDescricao(dados.tipo_tubo_redondo));
    }
    
    // Buscar produtos necessários dinamicamente
    Promise.all(buscasProdutos).then((produtos) => {
        const [tuboQuadrado, tubo3mm, sapata, corrimao, rodape, paraf70, porca, parafAA, tuboRedondo] = produtos;
        
        console.log('=== PRODUTOS ENCONTRADOS (GUARDA CORPO - VERTICAL) ===');
        console.log('Tubo Quadrado Selecionado:', tuboQuadrado);
        console.log('Tubo Quadrado 3mm (automático):', tubo3mm);
        console.log('Sapata:', sapata);
        console.log('Corrimão:', corrimao);
        console.log('Rodapé:', rodape);
        console.log('Parafusos:', { paraf70, porca, parafAA });
        if (tuboRedondo) console.log('Tubo Redondo:', tuboRedondo);
        
        // Aplicar fator de perda conforme definido no formulário
        const fatorPerda = 1 + (dados.percentual_perda / 100);
        
        // Debug: mostrar valores usados no cálculo
        console.log('=== VALORES PARA CÁLCULO DO TUBO QUADRADO ===');
        console.log('Largura módulo:', dados.larg_modulo);
        console.log('N° colunas:', dados.n_colunas);
        console.log('Altura:', dados.altura);
        console.log('Quantidade:', dados.quantidade);
        console.log('Fórmula: (largura/n_colunas) × largura × altura (apenas metros)');
        console.log(`Cálculo: (${dados.larg_modulo}/${dados.n_colunas}) × ${dados.larg_modulo} × ${dados.altura}`);
        
        // Calcular quantidades baseadas nas especificações - VERTICAL PODE TER FÓRMULAS DIFERENTES
        // Tubo Quadrado: (largura/n_colunas) × largura × altura (resultado em metros)
        const quantidadeTuboQuadrado = ( dados.n_colunas/dados.larg_modulo ) * dados.larg_modulo * dados.altura;
        
        console.log('Resultado cálculo tubo quadrado:', quantidadeTuboQuadrado.toFixed(3), 'm');
        
        // Tubo Quadrado 3mm: largura × 2 (resultado em metros) - AUTOMÁTICO
        const quantidadeTubo3mm = dados.larg_modulo * 2;
        
        console.log('=== CÁLCULO TUBO QUADRADO 3MM (AUTOMÁTICO) ===');
        console.log('Largura módulo:', dados.larg_modulo);
        console.log('Fórmula: largura × 2');
        console.log(`Cálculo: ${dados.larg_modulo} × 2`);
        console.log('Resultado tubo 3mm:', quantidadeTubo3mm.toFixed(3), 'm');
        
        // Tubo Redondo: cálculo baseado no tipo selecionado
        let quantidadeTuboRedondo = 0;
        if (tuboRedondo && dados.vao > 0 && dados.vao_livre > 0) {
            console.log('=== CÁLCULO TUBO REDONDO ===');
            console.log('Tipo:', dados.tipo_tubo_redondo);
            console.log('Tipo length:', dados.tipo_tubo_redondo.length);
            console.log('Tipo chars:', dados.tipo_tubo_redondo.split('').map(c => c + ' (' + c.charCodeAt(0) + ')').join(', '));
            console.log('Vão:', dados.vao);
            console.log('Vão Livre:', dados.vao_livre);
            console.log('Altura:', dados.altura);
            
            if (dados.tipo_tubo_redondo.includes('26,9mm')) {
                // Fórmula tubo 26,9: (vão/(vão livre+0,025)*(altura-0,1))
                quantidadeTuboRedondo = (dados.vao / (dados.vao_livre + 0.025)) * (dados.altura - 0.1);
                console.log('Fórmula 26,9mm: (vão/(vão_livre+0,025)*(altura-0,1))');
                console.log(`Cálculo: (${dados.vao}/(${dados.vao_livre}+0,025)*(${dados.altura}-0,1))`);
                console.log(`Resultado detalhado: (${dados.vao}/(${dados.vao_livre + 0.025})*(${dados.altura - 0.1})) = ${quantidadeTuboRedondo}`);
            } else if (dados.tipo_tubo_redondo.includes('32') && dados.tipo_tubo_redondo.includes('3mm')) {
                // Fórmula tubo 32: (vão/(vão livre+0,032)*(altura-0,1))
                quantidadeTuboRedondo = (dados.vao / (dados.vao_livre + 0.032)) * (dados.altura - 0.1);
                console.log('Fórmula 32mm: (vão/(vão_livre+0,032)*(altura-0,1))');
                console.log(`Cálculo: (${dados.vao}/(${dados.vao_livre}+0,032)*(${dados.altura}-0,1))`);
            }
            
            console.log('Resultado tubo redondo:', quantidadeTuboRedondo.toFixed(3), 'm');
        }
        
        // Corrimão: largura (resultado em metros)
        const metrosCorrimao = dados.larg_modulo;
        
        console.log('=== CÁLCULO CORRIMÃO ===');
        console.log('Largura módulo:', dados.larg_modulo);
        console.log('Fórmula: largura');
        console.log(`Resultado corrimão: ${metrosCorrimao.toFixed(3)} m`);
        
        // Rodapé: largura (resultado em metros)
        const metrosRodape = dados.larg_modulo;
        
        console.log('=== CÁLCULO RODAPÉ ===');
        console.log('Largura módulo:', dados.larg_modulo);
        console.log('Fórmula: largura');
        console.log(`Resultado rodapé: ${metrosRodape.toFixed(3)} m`);
        
        // Sapatas: 1 por coluna
        const quantidadeSapatas = dados.n_colunas * dados.quantidade;
        
        // Parafusos estimados baseadas nas especificações (Guarda Corpo Vertical)
        const quantidadeParaf70 = (dados.n_colunas / dados.larg_modulo) * dados.larg_modulo * 2;
        const quantidadePorcas = (dados.n_colunas / dados.larg_modulo) * dados.larg_modulo * 2;
        
        // PARAF-AA-PN-PH-4,8X19-AI304 com fórmula baseada no tubo redondo selecionado:
        // Fórmula: (vão/(vão livre+25))*2+(qtd colunas * largura * 4)
        // Nota: Originalmente usava +25 fixo, agora pode ser dinâmico baseado no tubo redondo
        
        let tamanhoTubo = 25; // valor padrão (original)
        
        // Se há tubo redondo selecionado, usar seu tamanho
        if (dados.tipo_tubo_redondo && dados.tipo_tubo_redondo !== '') {
            console.log('Tubo redondo selecionado:', dados.tipo_tubo_redondo);
            if (dados.tipo_tubo_redondo.includes('26,9') || dados.tipo_tubo_redondo.includes('26.9')) {
                tamanhoTubo = 27; // Arredondando 26,9mm para 27
            } else if (dados.tipo_tubo_redondo.includes('32')) {
                tamanhoTubo = 32;
            }
        } else {
            console.log('Nenhum tubo redondo selecionado, usando padrão:', tamanhoTubo);
        }
        
        console.log('Tamanho do tubo usado no cálculo:', tamanhoTubo);
        
        const quantidadeParafAA = ((dados.vao / (dados.vao_livre + tamanhoTubo)) * 2) + 
                                 (dados.n_colunas * dados.larg_modulo * 4);
        
        console.log('=== CÁLCULO PARAF-SXT-M6X70 ===');
        console.log('N° colunas:', dados.n_colunas);
        console.log('Largura módulo:', dados.larg_modulo);
        console.log('Fórmula: (qtd_colunas / largura) × largura × 2');
        console.log(`Cálculo: (${dados.n_colunas} / ${dados.larg_modulo}) × ${dados.larg_modulo} × 2`);
        console.log('Resultado paraf M6x70:', quantidadeParaf70.toFixed(0), 'unid');
        console.log('Resultado porcas M6:', quantidadePorcas.toFixed(0), 'unid');
        
        console.log('=== CÁLCULO PARAF-AA-PN-PH-4,8X19 (BASEADO EM TUBO REDONDO) ===');
        console.log('Vão:', dados.vao);
        console.log('Vão livre:', dados.vao_livre);
        console.log('N° colunas:', dados.n_colunas);
        console.log('Largura módulo:', dados.larg_modulo);
        console.log('Tubo redondo:', dados.tipo_tubo_redondo || 'Nenhum');
        console.log('Fórmula: (vão/(vão livre+' + tamanhoTubo + '))*2 + (qtd colunas * largura * 4)');
        console.log(`Primeira parte: (${dados.vao}/(${dados.vao_livre}+${tamanhoTubo}))*2 = ${((dados.vao / (dados.vao_livre + tamanhoTubo)) * 2).toFixed(2)}`);
        console.log(`Segunda parte: (${dados.n_colunas} * ${dados.larg_modulo} * 4) = ${(dados.n_colunas * dados.larg_modulo * 4).toFixed(2)}`);
        console.log('Resultado paraf AA:', quantidadeParafAA.toFixed(0), 'unid');
        
        // Calcular custos individuais (com perda para materiais)
        const custoTuboQuadrado = (quantidadeTuboQuadrado * tuboQuadrado.custo_centavos) * fatorPerda;
        const custoTubo3mm = (quantidadeTubo3mm * tubo3mm.custo_centavos) * fatorPerda;
        const custoTuboRedondo = tuboRedondo && quantidadeTuboRedondo > 0 ? 
                                (quantidadeTuboRedondo * tuboRedondo.custo_centavos) * fatorPerda : 0;
        const custoCorrimao = (metrosCorrimao * corrimao.custo_centavos) * fatorPerda;
        const custoRodape = (metrosRodape * rodape.custo_centavos) * fatorPerda;
        const custoSapatas = (quantidadeSapatas * sapata.custo_centavos) * fatorPerda;
        const custoParaf70 = (quantidadeParaf70 * paraf70.custo_centavos) * fatorPerda;
        const custoPorcas = (quantidadePorcas * porca.custo_centavos) * fatorPerda;
        const custoParafAA = (quantidadeParafAA * parafAA.custo_centavos) * fatorPerda;
        
        // Mão de obra
        const custoMaoObraProcessamento = dados.tempo_proc * 6579; // 65,79 centavos por hora
        const custoMaoObraMontagem = dados.tempo_mtg * 6579; // 65,79 centavos por hora
        
        // Custo total (com tubo 3mm automático e tubo redondo se houver)
        const custoTotalCentavos = custoTuboQuadrado + custoTubo3mm + custoTuboRedondo + custoCorrimao + custoRodape + 
                                   custoSapatas + custoParaf70 + custoPorcas + custoParafAA + 
                                   custoMaoObraProcessamento + custoMaoObraMontagem;
        
        // Criar objeto ultimoCalculo para guarda corpo vertical
        ultimoCalculo = {
            nome: dados.nome_guarda_corpo,
            categoria: 'ESTRUTURAS',
            tipo_calculo: 'guarda_corpo_vertical',
            custo_total: custoTotalCentavos,
            parametros: dados,
            componentes: [
                {
                    nome: `${tuboQuadrado.descricao} - ${quantidadeTuboQuadrado.toFixed(2)}m`,
                    descricao_produto: tuboQuadrado.descricao,
                    quantidade: quantidadeTuboQuadrado,
                    custo_unitario: tuboQuadrado.custo_centavos,
                    custo_total: custoTuboQuadrado,
                    unidade: 'm'
                },
                {
                    nome: `${tubo3mm.descricao} - ${quantidadeTubo3mm.toFixed(2)}m (Automático)`,
                    descricao_produto: tubo3mm.descricao,
                    quantidade: quantidadeTubo3mm,
                    custo_unitario: tubo3mm.custo_centavos,
                    custo_total: custoTubo3mm,
                    unidade: 'm'
                },
                ...(tuboRedondo && quantidadeTuboRedondo > 0 ? [{
                    nome: `${tuboRedondo.descricao} - ${quantidadeTuboRedondo.toFixed(2)}m`,
                    descricao_produto: tuboRedondo.descricao,
                    quantidade: quantidadeTuboRedondo,
                    custo_unitario: tuboRedondo.custo_centavos,
                    custo_total: custoTuboRedondo,
                    unidade: 'm'
                }] : []),
                {
                    nome: `${corrimao.descricao} - ${metrosCorrimao.toFixed(2)}m`,
                    descricao_produto: corrimao.descricao,
                    quantidade: metrosCorrimao,
                    custo_unitario: corrimao.custo_centavos,
                    custo_total: custoCorrimao,
                    unidade: 'm'
                },
                {
                    nome: `${rodape.descricao} - ${metrosRodape.toFixed(2)}m`,
                    descricao_produto: rodape.descricao,
                    quantidade: metrosRodape,
                    custo_unitario: rodape.custo_centavos,
                    custo_total: custoRodape,
                    unidade: 'm'
                },
                {
                    nome: `${sapata.descricao} - ${quantidadeSapatas.toFixed(2)} unid`,
                    descricao_produto: sapata.descricao,
                    quantidade: quantidadeSapatas,
                    custo_unitario: sapata.custo_centavos,
                    custo_total: custoSapatas,
                    unidade: 'unid'
                },
                {
                    nome: `${paraf70.descricao} - ${quantidadeParaf70.toFixed(1)} unid`,
                    quantidade: quantidadeParaf70,
                    custo_unitario: paraf70.custo_centavos,
                    custo_total: custoParaf70,
                    unidade: 'unid'
                },
                {
                    nome: `${porca.descricao} - ${quantidadePorcas.toFixed(1)} unid`,
                    quantidade: quantidadePorcas,
                    custo_unitario: porca.custo_centavos,
                    custo_total: custoPorcas,
                    unidade: 'unid'
                },
                {
                    nome: `${parafAA.descricao} - ${quantidadeParafAA.toFixed(1)} unid`,
                    quantidade: quantidadeParafAA,
                    custo_unitario: parafAA.custo_centavos,
                    custo_total: custoParafAA,
                    unidade: 'unid'
                }
            ]
        };
        
        // Adicionar mão de obra se houver tempo
        if (dados.tempo_proc > 0) {
            ultimoCalculo.componentes.push({
                nome: `Processamento - ${dados.tempo_proc}h`,
                quantidade: dados.tempo_proc,
                custo_unitario: 6579,
                custo_total: custoMaoObraProcessamento,
                unidade: 'h'
            });
        }
        
        if (dados.tempo_mtg > 0) {
            ultimoCalculo.componentes.push({
                nome: `Montagem - ${dados.tempo_mtg}h`,
                quantidade: dados.tempo_mtg,
                custo_unitario: 6579,
                custo_total: custoMaoObraMontagem,
                unidade: 'h'
            });
        }
        
        console.log('=== RESULTADO FINAL (GUARDA CORPO - VERTICAL) ===');
        console.log('Nome:', ultimoCalculo.nome);
        console.log('Custo Total: R$', (custoTotalCentavos/100).toFixed(2));
        console.log('Componentes:', ultimoCalculo.componentes.length);
        
        // Exibir resultado
        const resultadoDiv = document.getElementById('resultadoCalculado');
        resultadoDiv.innerHTML = `
            <h5 class="text-success">✅ Guarda Corpo Vertical Calculado</h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Nome:</strong> ${ultimoCalculo.nome}</p>
                    <p><strong>Categoria:</strong> ${ultimoCalculo.categoria}</p>
                    <p><strong>Tipo:</strong> Guarda Corpo Vertical</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Custo Total:</strong> <span class="text-success">R$ ${(custoTotalCentavos/100).toFixed(2)}</span></p>
                    <p><strong>Preço Sugerido:</strong> <span class="text-info">R$ ${(custoTotalCentavos/100 * 1.3).toFixed(2)}</span> (30% margem)</p>
                    <p><strong>Componentes:</strong> ${ultimoCalculo.componentes.length}</p>
                </div>
            </div>
        `;
        resultadoDiv.style.display = 'block';
        
        // Preencher tabela de componentes
        console.log('=== PREENCHENDO TABELA DE COMPONENTES PARA GUARDA CORPO - VERTICAL ===');
        const tbody = document.getElementById('componentesCalculadosTable');
        tbody.innerHTML = '';
        
        ultimoCalculo.componentes.forEach((comp, index) => {
            const row = tbody.insertRow();
            
            // Componentes de guarda corpo não têm fator editável
            const fatorCol = '<span class="text-muted">-</span>';
            const acaoCol = '<span class="text-muted">-</span>';
            
            row.innerHTML = `
                <td>${comp.nome || 'N/A'}</td>
                <td>${comp.descricao_produto || 'N/A'}</td>
                <td>${fatorCol}</td>
                <td><span class="quantidade-display">${comp.quantidade ? comp.quantidade.toFixed(4) : '0.0000'}</span></td>
                <td>R$ ${comp.custo_unitario ? (comp.custo_unitario/100).toFixed(2) : '0.00'}</td>
                <td><span class="custo-total-display">R$ ${comp.custo_total ? (comp.custo_total/100).toFixed(2) : '0.00'}</span></td>
                <td>${acaoCol}</td>`;
            
            console.log(`✓ Componente adicionado: ${comp.nome} - ${comp.quantidade.toFixed(4)} ${comp.unidade}`);
        });
        
        // Adicionar linha de total
        const totalRow = tbody.insertRow();
        const custoTotalGeral = ultimoCalculo.componentes.reduce((total, comp) => total + comp.custo_total, 0);
        totalRow.innerHTML = `
            <td colspan="5"><strong>TOTAL GERAL</strong></td>
            <td><strong>R$ ${(custoTotalGeral/100).toFixed(2)}</strong></td>
            <td></td>`;
        totalRow.style.backgroundColor = '#f8f9fa';
        
        console.log(`✅ Tabela preenchida com ${ultimoCalculo.componentes.length} componentes. Total: R$ ${(custoTotalCentavos/100).toFixed(2)}`);
        
        // Habilitar botão salvar
        document.getElementById('salvarProdutoBtn').disabled = false;
        
    }).catch(error => {
        console.error('❌ Erro ao calcular guarda corpo vertical:', error);
        alert('Erro ao calcular guarda corpo vertical: ' + error.message);
    });
}

function toggleAreaPintura() {
    const checkbox = document.getElementById('perfil_pintura');
    const container = document.getElementById('perfil_area_pintura_container');
    const input = document.getElementById('perfil_area_pintura');
    
    if (checkbox.checked) {
        container.style.display = 'block';
        input.required = true;
    } else {
        container.style.display = 'none';
        input.required = false;
        input.value = '';
    }
    
    // Recalcular se já tiver dados
    calcularPerfilParametrizado();
}

function calcularNovoPerfil() {
    console.log('=== CALCULANDO NOVO PERFIL ===');
    
    // Verificar se todos os campos obrigatórios estão preenchidos
    const camposObrigatorios = [
        'perfil_nome', 'perfil_roving', 'perfil_manta', 'perfil_veu', 
        'perfil_peso_metro', 'perfil_n_matrizes', 'perfil_n_maquinas', 
        'perfil_metros_h', 'perfil_perda', 'perfil_tipo_resina'
    ];
    
    let todosCamposPreenchidos = true;
    const dados = {};
    
    camposObrigatorios.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (!elemento || !elemento.value.trim()) {
            todosCamposPreenchidos = false;
            return;
        }
        
        const valor = elemento.value.trim();
        if (campo === 'perfil_nome') {
            dados[elemento.name] = valor;
        } else {
            dados[elemento.name] = parseFloat(valor) || 0;
        }
    });
    
    // Verificar pintura
    const temPintura = document.getElementById('perfil_pintura').checked;
    dados.tem_pintura = temPintura;
    
    if (temPintura) {
        const areaPintura = document.getElementById('perfil_area_pintura').value;
        if (!areaPintura || parseFloat(areaPintura) <= 0) {
            alert('Área de pintura deve ser preenchida quando pintura está marcada!');
            return;
        }
        dados.area_pintura_m2 = parseFloat(areaPintura);
    } else {
        dados.area_pintura_m2 = 0;
    }
    
    if (!todosCamposPreenchidos) {
        alert('Preencha todos os campos obrigatórios!');
        return;
    }
    
    console.log('Dados coletados:', dados);
    
    // Buscar preços da base de dados MP_Produtos antes de calcular
    console.log('🔍 Buscando preços da base de dados...');
    
    fetch('/api/produtos/')
        .then(response => response.json())
        .then(produtos => {
            console.log('✅ Produtos carregados da base:', produtos.length);
            
            // Criar mapeamento de produtos por nome/descrição
            const precosProdutos = {};
            
            produtos.forEach(produto => {
                const desc = produto.descricao.toLowerCase();
                const precoReais = produto.custo_centavos / 100;
                
                // Mapear produtos específicos
                if (desc.includes('roving') && desc.includes('4400')) {
                    precosProdutos['roving'] = precoReais;
                } else if (desc.includes('manta') && desc.includes('300')) {
                    precosProdutos['manta'] = precoReais;
                } else if (desc.includes('véu') || desc.includes('veu')) {
                    precosProdutos['veu'] = precoReais;
                } else if (desc.includes('resina') && (desc.includes('pet') || desc.includes('poliéster'))) {
                    precosProdutos['resina'] = precoReais;
                } else if (desc.includes('monômero') || desc.includes('estireno')) {
                    precosProdutos['monomero'] = precoReais;
                } else if (desc.includes('anti') && desc.includes('uv')) {
                    precosProdutos['antiUV'] = precoReais;
                } else if (desc.includes('anti') && desc.includes('ox')) {
                    precosProdutos['antiOX'] = precoReais;
                } else if (desc.includes('bpo')) {
                    precosProdutos['bpo'] = precoReais;
                } else if (desc.includes('tbpb')) {
                    precosProdutos['tbpb'] = precoReais;
                } else if (desc.includes('desmoldante')) {
                    precosProdutos['desmoldante'] = precoReais;
                } else if (desc.includes('antichama')) {
                    precosProdutos['antichama'] = precoReais;
                } else if (desc.includes('carga') && desc.includes('mineral')) {
                    precosProdutos['cargaMineral'] = precoReais;
                } else if (desc.includes('pigmento')) {
                    precosProdutos['pigmento'] = precoReais;
                } else if (desc.includes('pintura')) {
                    precosProdutos['pintura'] = precoReais;
                }
            });
            
            console.log('💰 Preços mapeados:', precosProdutos);
            
            // Definir preços padrão caso não encontre na base
            const precosDefault = {
                roving: 8.50,
                manta: 12.00,
                veu: 25.00,
                resina: 12.96,
                monomero: 8.00,
                antiUV: 45.00,
                antiOX: 35.00,
                bpo: 28.00,
                tbpb: 42.00,
                desmoldante: 22.00,
                antichama: 18.50,
                cargaMineral: 3.20,
                pigmento: 15.80,
                pintura: 15.00
            };
            
            // Usar preço da base ou padrão se não encontrar
            const precos = {};
            Object.keys(precosDefault).forEach(key => {
                precos[key] = precosProdutos[key] || precosDefault[key];
                if (!precosProdutos[key]) {
                    console.warn(`⚠️ Preço não encontrado na base para ${key}, usando padrão: R$ ${precosDefault[key]}`);
                }
            });
            
            // BUSCAR PREÇO ESPECÍFICO DA RESINA SELECIONADA
            const tipoResinaId = dados.tipo_resina;
            console.log(`🎯 Tipo de resina selecionado: ID ${tipoResinaId}`);
            
            const resinaSelecionada = produtos.find(p => p.id == tipoResinaId);
            if (resinaSelecionada) {
                precos.resina = resinaSelecionada.custo_centavos / 100;
                console.log(`✅ Preço da resina selecionada (${resinaSelecionada.descricao}): R$ ${precos.resina.toFixed(2)}`);
            } else {
                console.warn(`⚠️ Resina ID ${tipoResinaId} não encontrada, usando preço padrão: R$ ${precos.resina}`);
            }
            
            // CÁLCULO CORRETO DOS COMPONENTES DA RESINA
            // Peso da resina base = peso do metro - (roving + manta + véu)
            const pesoResinaBase = dados.peso_metro_kg - (dados.roving_4400_kg + dados.manta_300_kg + dados.veu_kg);
            
            console.log('Cálculo da resina:');
            console.log(`Peso do metro: ${dados.peso_metro_kg} kg`);
            console.log(`Peso fibras (roving + manta + véu): ${dados.roving_4400_kg + dados.manta_300_kg + dados.veu_kg} kg`);
            console.log(`Peso resina base: ${pesoResinaBase} kg`);
            
            // Fatores de multiplicação conforme especificado
            const fatores = {
                resina: 0.6897,           // 68.97%
                monomero: 0.0213,         // 2.13%
                antiUV: 0.0028,           // 0.28%
                antiOX: 0.0011,           // 0.11%
                bpo: 0.0071,              // 0.71%
                tbpb: 0.0043,             // 0.43%
                desmoldante: 0.0071,      // 0.71%
                antichama: 0.1777,        // 17.77%
                cargaMineral: 0.0711,     // 7.11%
                pigmento: 0.0178          // 1.78%
            };
            
            // Calcular componentes da resina usando preços da base
            const componentes = [
                {
                    nome: 'Roving 4400 KG',
                    produto_nome: 'Roving 4400 tex',
                    quantidade: dados.roving_4400_kg,
                    custo_unitario: precos.roving,
                    custo_total: dados.roving_4400_kg * precos.roving
                },
                {
                    nome: 'Manta 300 KG',
                    produto_nome: 'Manta 300 g/m²',
                    quantidade: dados.manta_300_kg,
                    custo_unitario: precos.manta,
                    custo_total: dados.manta_300_kg * precos.manta
                },
                {
                    nome: 'Véu KG',
                    produto_nome: 'Véu de Superfície',
                    quantidade: dados.veu_kg,
                    custo_unitario: precos.veu,
                    custo_total: dados.veu_kg * precos.veu
                },
                {
                    nome: 'Resina PET',
                    produto_nome: 'Resina Poliéster',
                    quantidade: pesoResinaBase * fatores.resina,
                    custo_unitario: precos.resina,
                    custo_total: (pesoResinaBase * fatores.resina) * precos.resina
                },
                {
                    nome: 'Monômero de estireno',
                    produto_nome: 'Estireno',
                    quantidade: pesoResinaBase * fatores.monomero,
                    custo_unitario: precos.monomero,
                    custo_total: (pesoResinaBase * fatores.monomero) * precos.monomero
                },
                {
                    nome: 'Anti UV',
                    produto_nome: 'Aditivo Anti UV',
                    quantidade: pesoResinaBase * fatores.antiUV,
                    custo_unitario: precos.antiUV,
                    custo_total: (pesoResinaBase * fatores.antiUV) * precos.antiUV
                },
                {
                    nome: 'Anti OX',
                    produto_nome: 'Aditivo Anti Oxidante',
                    quantidade: pesoResinaBase * fatores.antiOX,
                    custo_unitario: precos.antiOX,
                    custo_total: (pesoResinaBase * fatores.antiOX) * precos.antiOX
                },
                {
                    nome: 'BPO',
                    produto_nome: 'Peróxido de Benzoíla',
                    quantidade: pesoResinaBase * fatores.bpo,
                    custo_unitario: precos.bpo,
                    custo_total: (pesoResinaBase * fatores.bpo) * precos.bpo
                },
                {
                    nome: 'TBPB',
                    produto_nome: 'Terc-Butil Perbenzoato',
                    quantidade: pesoResinaBase * fatores.tbpb,
                    custo_unitario: precos.tbpb,
                    custo_total: (pesoResinaBase * fatores.tbpb) * precos.tbpb
                },
                {
                    nome: 'Desmoldante',
                    produto_nome: 'Desmoldante Industrial',
                    quantidade: pesoResinaBase * fatores.desmoldante,
                    custo_unitario: precos.desmoldante,
                    custo_total: (pesoResinaBase * fatores.desmoldante) * precos.desmoldante
                },
                {
                    nome: 'Antichama',
                    produto_nome: 'Aditivo Antichama',
                    quantidade: pesoResinaBase * fatores.antichama,
                    custo_unitario: precos.antichama,
                    custo_total: (pesoResinaBase * fatores.antichama) * precos.antichama
                },
                {
                    nome: 'Carga mineral',
                    produto_nome: 'Carbonato de Cálcio',
                    quantidade: pesoResinaBase * fatores.cargaMineral,
                    custo_unitario: precos.cargaMineral,
                    custo_total: (pesoResinaBase * fatores.cargaMineral) * precos.cargaMineral
                },
                {
                    nome: 'Pigmento',
                    produto_nome: 'Pigmento Colorante',
                    quantidade: pesoResinaBase * fatores.pigmento,
                    custo_unitario: precos.pigmento,
                    custo_total: (pesoResinaBase * fatores.pigmento) * precos.pigmento
                }
            ];
            
            // Adicionar pintura se necessário
            if (temPintura && dados.area_pintura_m2 > 0) {
                componentes.push({
                    nome: 'Área pintura (m²)',
                    produto_nome: 'Pintura Industrial',
                    quantidade: dados.area_pintura_m2,
                    custo_unitario: precos.pintura,
                    custo_total: dados.area_pintura_m2 * precos.pintura
                });
            }
            
            // ADICIONAR MÃO DE OBRA - NOVA FÓRMULA
            // ((mo_pultrusao / 3) * n° de máquinas) / (VELOCIDADE M/H * N° MATRIZES * 24 * 21 * 0,5)
            if (dados.metros_produzidos_h > 0 && dados.n_matrizes > 0) {
                const mo_pultrusao = 9976258; // Valor da tabela main_maoobra ID=1 em centavos
                const velocidade = dados.metros_produzidos_h;
                const matrizes = dados.n_matrizes;
                const maquinas = dados.n_maquinas;
                
                // Aplicar nova fórmula
                const numerador = (mo_pultrusao / 3) * maquinas;
                const denominador = velocidade * matrizes * 24 * 21 * 0.5;
                const custo_raw = numerador / denominador;
                const custo_mao_obra_centavos = Math.max(1, Math.floor(custo_raw));
                const custo_mao_obra_reais = custo_mao_obra_centavos / 100;
                
                console.log('=== CÁLCULO MÃO DE OBRA (NOVA FÓRMULA) ===');
                console.log(`Parâmetros: velocidade=${velocidade}, matrizes=${matrizes}, máquinas=${maquinas}`);
                console.log(`Numerador: (${mo_pultrusao} / 3) * ${maquinas} = ${numerador.toFixed(2)}`);
                console.log(`Denominador: ${velocidade} * ${matrizes} * 24 * 21 * 0.5 = ${denominador}`);
                console.log(`Resultado: ${numerador.toFixed(2)} / ${denominador} = ${custo_raw.toFixed(8)}`);
                console.log(`Custo final: ${custo_mao_obra_centavos} centavos = R$ ${custo_mao_obra_reais.toFixed(2)}`);
                
                componentes.push({
                    nome: 'Mão de Obra - Pultrusão',
                    produto_nome: 'Mão de Obra Industrial',
                    quantidade: 1.0,
                    custo_unitario: custo_mao_obra_reais,
                    custo_total: custo_mao_obra_reais
                });
            }
            
            // Calcular custo total com 3% de perda nas matérias-primas
            // Separar matérias-primas de mão de obra
            const custoMateriasPrimas = componentes
                .filter(comp => comp.nome !== 'Mão de Obra - Pultrusão')
                .reduce((total, comp) => total + comp.custo_total, 0);
            
            const custoMaoObra = componentes
                .filter(comp => comp.nome === 'Mão de Obra - Pultrusão')
                .reduce((total, comp) => total + comp.custo_total, 0);
            
            // Aplicar 3% de perda nas matérias-primas
            const custoMateriasComPerda = custoMateriasPrimas * 1.03; // 3% de perda
            const custoTotal = custoMateriasComPerda + custoMaoObra;
            
            console.log('=== APLICAÇÃO DE 3% DE PERDA ===');
            console.log(`Custo matérias-primas sem perda: R$ ${custoMateriasPrimas.toFixed(2)}`);
            console.log(`Custo matérias-primas com 3% perda: R$ ${custoMateriasComPerda.toFixed(2)}`);
            console.log(`Custo mão de obra: R$ ${custoMaoObra.toFixed(2)}`);
            console.log(`Custo total final: R$ ${custoTotal.toFixed(2)}`);
            
            // Criar resultado
            ultimoCalculo = {
                success: true,
                custo_total: Math.round(custoTotal * 100), // em centavos
                peso_total: dados.peso_metro_kg,
                peso_resina_base: pesoResinaBase,
                peso_fibras: dados.roving_4400_kg + dados.manta_300_kg + dados.veu_kg,
                nome_produto: dados.nome_perfil,
                componentes: componentes,
                dados_originais: dados, // Para poder recalcular
                fatores_originais: { // Para exibir na tabela
                    'Resina PET': fatores.resina * 100,
                    'Monômero de estireno': fatores.monomero * 100,
                    'Anti UV': fatores.antiUV * 100,
                    'Anti OX': fatores.antiOX * 100,
                    'BPO': fatores.bpo * 100,
                    'TBPB': fatores.tbpb * 100,
                    'Desmoldante': fatores.desmoldante * 100,
                    'Antichama': fatores.antichama * 100,
                    'Carga mineral': fatores.cargaMineral * 100,
                    'Pigmento': fatores.pigmento * 100
                }
            };
            
            // Mostrar resultado na interface padrão
            document.getElementById('nomeProdutoCalculado').textContent = dados.nome_perfil;
            document.getElementById('custoTotalCalculado').textContent = `R$ ${(ultimoCalculo.custo_total / 100).toFixed(2)} (preços atualizados + 3% perda)`;
            document.getElementById('pesoTotalCalculado').textContent = `${dados.peso_metro_kg} kg`;
            document.getElementById('resultadoCalculado').style.display = 'block';
            
            // Preencher tabela de componentes (usar função existente)
            preencherTabelaComponentes(ultimoCalculo);
            
            console.log('✅ Cálculo de Novo Perfil concluído com preços da base:', ultimoCalculo);
        })
        .catch(error => {
            console.error('❌ Erro ao buscar preços da base:', error);
            alert('Erro ao carregar preços da base de dados. Usando valores padrão.');
            
            // Em caso de erro, usar valores padrão e continuar cálculo
            calcularNovoPerfilComPrecosDefault(dados, temPintura);
        });
}

// Função auxiliar para calcular com preços padrão em caso de erro no MP
function calcularNovoPerfilComPrecosDefault(dados, temPintura) {
    console.log('⚠️ Usando preços padrão devido a erro na base de dados');
    
    // Preços padrão baseados no tipo de resina selecionado
    let precoResina = 12.96; // Padrão poliéster
    const tipoResinaId = dados.tipo_resina;
    console.log(`🎯 Ajustando preço de resina para ID ${tipoResinaId} (fallback MP)`);
    
    // Preços conhecidos das resinas
    const precosResinas = {
        '1269': 12.96,  // Resina Poliéster (padrão)
        '1268': 18.34,  // Resina Isoftálica  
        '1270': 35.97   // Resina Éster Vinílica
    };
    
    if (precosResinas[tipoResinaId]) {
        precoResina = precosResinas[tipoResinaId];
        console.log(`✅ Preço de resina ajustado para: R$ ${precoResina.toFixed(2)}`);
    }
    
    // CONTINUAR COM LÓGICA PADRÃO (código existente)
    const pesoResinaBase = dados.peso_metro_kg - (dados.roving_4400_kg + dados.manta_300_kg + dados.veu_kg);
    
    const fatores = {
        resina: 0.6897, monomero: 0.0213, antiUV: 0.0028, antiOX: 0.0011,
        bpo: 0.0071, tbpb: 0.0043, desmoldante: 0.0071, antichama: 0.1777,
        cargaMineral: 0.0711, pigmento: 0.0178
    };
    
    const componentes = [
        { nome: 'Roving 4400 KG', produto_nome: 'Roving 4400 tex', quantidade: dados.roving_4400_kg, custo_unitario: 8.50, custo_total: dados.roving_4400_kg * 8.50 },
        { nome: 'Manta 300 KG', produto_nome: 'Manta 300 g/m²', quantidade: dados.manta_300_kg, custo_unitario: 12.00, custo_total: dados.manta_300_kg * 12.00 },
        { nome: 'Véu KG', produto_nome: 'Véu de Superfície', quantidade: dados.veu_kg, custo_unitario: 25.00, custo_total: dados.veu_kg * 25.00 },
        { nome: 'Resina PET', produto_nome: 'Resina Selecionada', quantidade: pesoResinaBase * fatores.resina, custo_unitario: precoResina, custo_total: (pesoResinaBase * fatores.resina) * precoResina },
        { nome: 'Monômero de estireno', produto_nome: 'Estireno', quantidade: pesoResinaBase * fatores.monomero, custo_unitario: 8.00, custo_total: (pesoResinaBase * fatores.monomero) * 8.00 },
        { nome: 'Anti UV', produto_nome: 'Aditivo Anti UV', quantidade: pesoResinaBase * fatores.antiUV, custo_unitario: 45.00, custo_total: (pesoResinaBase * fatores.antiUV) * 45.00 },
        { nome: 'Anti OX', produto_nome: 'Aditivo Anti Oxidante', quantidade: pesoResinaBase * fatores.antiOX, custo_unitario: 35.00, custo_total: (pesoResinaBase * fatores.antiOX) * 35.00 },
        { nome: 'BPO', produto_nome: 'Peróxido de Benzoíla', quantidade: pesoResinaBase * fatores.bpo, custo_unitario: 28.00, custo_total: (pesoResinaBase * fatores.bpo) * 28.00 },
        { nome: 'TBPB', produto_nome: 'Terc-Butil Perbenzoato', quantidade: pesoResinaBase * fatores.tbpb, custo_unitario: 42.00, custo_total: (pesoResinaBase * fatores.tbpb) * 42.00 },
        { nome: 'Desmoldante', produto_nome: 'Desmoldante Industrial', quantidade: pesoResinaBase * fatores.desmoldante, custo_unitario: 22.00, custo_total: (pesoResinaBase * fatores.desmoldante) * 22.00 },
        { nome: 'Antichama', produto_nome: 'Aditivo Antichama', quantidade: pesoResinaBase * fatores.antichama, custo_unitario: 18.50, custo_total: (pesoResinaBase * fatores.antichama) * 18.50 },
        { nome: 'Carga mineral', produto_nome: 'Carbonato de Cálcio', quantidade: pesoResinaBase * fatores.cargaMineral, custo_unitario: 3.20, custo_total: (pesoResinaBase * fatores.cargaMineral) * 3.20 },
        { nome: 'Pigmento', produto_nome: 'Pigmento Colorante', quantidade: pesoResinaBase * fatores.pigmento, custo_unitario: 15.80, custo_total: (pesoResinaBase * fatores.pigmento) * 15.80 }
    ];
    
    if (temPintura && dados.area_pintura_m2 > 0) {
        componentes.push({
            nome: 'Área pintura (m²)', produto_nome: 'Pintura Industrial',
            quantidade: dados.area_pintura_m2, custo_unitario: 15.86,
            custo_total: dados.area_pintura_m2 * 15.86
        });
    }
    
    // Mão de obra
    if (dados.metros_produzidos_h > 0 && dados.n_matrizes > 0) {
        const mo_pultrusao = 9976258, numerador = (mo_pultrusao / 3) * dados.n_maquinas;
        const denominador = dados.metros_produzidos_h * dados.n_matrizes * 24 * 21 * 0.5;
        const custo_mao_obra_reais = Math.max(0.01, numerador / denominador / 100);
        
        componentes.push({
            nome: 'Mão de Obra - Pultrusão', produto_nome: 'Mão de Obra Industrial',
            quantidade: 1.0, custo_unitario: custo_mao_obra_reais, custo_total: custo_mao_obra_reais
        });
    }
    
    // Calcular custo total com 3% de perda nas matérias-primas
    const custoMateriasPrimas = componentes
        .filter(comp => comp.nome !== 'Mão de Obra - Pultrusão')
        .reduce((total, comp) => total + comp.custo_total, 0);
    
    const custoMaoObra = componentes
        .filter(comp => comp.nome === 'Mão de Obra - Pultrusão')
        .reduce((total, comp) => total + comp.custo_total, 0);
    
    // Aplicar 3% de perda nas matérias-primas
    const custoMateriasComPerda = custoMateriasPrimas * 1.03;
    const custoTotal = custoMateriasComPerda + custoMaoObra;
    
    console.log('⚠️ CÁLCULO COM PREÇOS PADRÃO + 3% PERDA');
    console.log(`Matérias-primas: R$ ${custoMateriasPrimas.toFixed(2)} → R$ ${custoMateriasComPerda.toFixed(2)} (+3%)`);
    console.log(`Total final: R$ ${custoTotal.toFixed(2)}`);
    
    ultimoCalculo = {
        success: true, custo_total: Math.round(custoTotal * 100),
        peso_total: dados.peso_metro_kg, nome_produto: dados.nome_perfil,
        componentes: componentes, dados_originais: dados,
        fatores_originais: {
            'Resina PET': fatores.resina * 100, 'Monômero de estireno': fatores.monomero * 100,
            'Anti UV': fatores.antiUV * 100, 'Anti OX': fatores.antiOX * 100,
            'BPO': fatores.bpo * 100, 'TBPB': fatores.tbpb * 100,
            'Desmoldante': fatores.desmoldante * 100, 'Antichama': fatores.antichama * 100,
            'Carga mineral': fatores.cargaMineral * 100, 'Pigmento': fatores.pigmento * 100
        }
    };
    
    document.getElementById('nomeProdutoCalculado').textContent = dados.nome_perfil;
    document.getElementById('custoTotalCalculado').textContent = `R$ ${(ultimoCalculo.custo_total / 100).toFixed(2)} (valores padrão + 3% perda)`;
    document.getElementById('pesoTotalCalculado').textContent = `${dados.peso_metro_kg} kg`;
    document.getElementById('resultadoCalculado').style.display = 'block';
    
    preencherTabelaComponentes(ultimoCalculo);
    console.log('⚠️ Cálculo concluído com preços padrão:', ultimoCalculo);
}

// Função auxiliar para preencher tabela de componentes
function preencherTabelaComponentes(calculo) {
    const tbody = document.getElementById('componentesCalculadosTable');
    tbody.innerHTML = '';
    
    console.log('=== PREENCHENDO TABELA DE COMPONENTES ===');
    
    calculo.componentes.forEach((comp, index) => {
        const row = tbody.insertRow();
        const isComponenteResina = ['Resina PET', 'Monômero de estireno', 'Anti UV', 'Anti OX', 'BPO', 'TBPB', 'Desmoldante', 'Antichama', 'Carga mineral', 'Pigmento'].includes(comp.nome);
        
        let fatorCol = '', acaoCol = '';
        if (isComponenteResina) {
            const fatorAtual = calculo.fatores_originais[comp.nome] || 0;
            fatorCol = `<input type="number" step="0.01" class="form-control form-control-sm fator-input" value="${fatorAtual.toFixed(2)}" data-component-index="${index}" style="width: 80px;" min="0" max="100">`;
            acaoCol = `<button class="btn btn-sm btn-success" onclick="recalcularComponente(${index})" title="Recalcular"><i class="fas fa-calculator"></i></button>`;
        } else {
            fatorCol = '<span class="text-muted">-</span>';
            acaoCol = '<span class="text-muted">-</span>';
        }
        
        row.innerHTML = `
            <td>${comp.nome || 'N/A'}</td>
            <td>${comp.produto_nome || 'N/A'}</td>
            <td>${fatorCol}</td>
            <td><span class="quantidade-display">${comp.quantidade ? comp.quantidade.toFixed(4) : '0.0000'}</span></td>
            <td>R$ ${comp.custo_unitario ? comp.custo_unitario.toFixed(2) : '0.00'}</td>
            <td><span class="custo-total-display">R$ ${comp.custo_total.toFixed(2)}</span></td>
            <td>${acaoCol}</td>`;
    });
    
    const totalRow = tbody.insertRow();
    const custoTotalGeral = calculo.componentes.reduce((total, comp) => total + comp.custo_total, 0);
    totalRow.innerHTML = `
        <td colspan="5"><strong>TOTAL GERAL</strong></td>
        <td><strong><span id="custo-total-geral">R$ ${custoTotalGeral.toFixed(2)}</span></strong></td>
        <td>
            <button class="btn btn-sm btn-warning" onclick="recalcularTodosComponentes()" title="Recalcular Todos">
                <i class="fas fa-sync-alt"></i>
            </button>
        </td>
    `;
    
    console.log('Tabela de componentes preenchida com sucesso!');
    document.getElementById('salvarProdutoBtn').disabled = false;
}

function gerarReferenciaPerfil(nomePerfil) {
    // Gerar referência baseada no nome do perfil
    // Formato: PER-XXXX onde XXXX são 4 dígitos baseados no nome
    
    let referencia = 'PER-';
    
    // Remover caracteres especiais e espaços
    const nomeSimplificado = nomePerfil
        .replace(/[^a-zA-Z0-9]/g, '')  // Remove caracteres especiais
        .toUpperCase()                  // Converte para maiúsculo
        .substring(0, 10);              // Pega apenas os primeiros 10 caracteres
    
    // Se tem números no nome, usar eles
    const numeros = nomePerfil.match(/\d+/g);
    if (numeros && numeros.length > 0) {
        // Usar os números encontrados no nome
        const numerosCombinados = numeros.join('');
        referencia += numerosCombinados.substring(0, 4).padStart(4, '0');
    } else {
        // Gerar código baseado nas letras (hash simples)
        let hash = 0;
        for (let i = 0; i < nomeSimplificado.length; i++) {
            const char = nomeSimplificado.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // Converte para 32-bit
        }
        
        // Usar valor absoluto e pegar 4 dígitos
        const codigo = Math.abs(hash).toString().substring(0, 4).padStart(4, '0');
        referencia += codigo;
    }
    
    // Adicionar timestamp para garantir unicidade
    const agora = new Date();
    const timestamp = (agora.getHours() * 60 + agora.getMinutes()).toString().padStart(4, '0');
    
    return referencia + '-' + timestamp.substring(0, 2);
}

function salvarPerfilParametrizado() {
    console.log('=== SALVANDO PERFIL PARAMETRIZADO ===');
    
    // Verificar se o cálculo foi feito
    if (!ultimoCalculo) {
        alert('Realize o cálculo primeiro!');
        return;
    }
    
    // Coletar dados do formulário
    const dadosPerfil = {};
    const allInputs = document.querySelectorAll('.param-input');
    
    allInputs.forEach(input => {
        if (input.type === 'checkbox') {
            dadosPerfil[input.name] = input.checked;
        } else if (input.name === 'nome_perfil') {
            dadosPerfil[input.name] = input.value.trim();
        } else {
            dadosPerfil[input.name] = parseFloat(input.value) || 0;
        }
    });
    
    // Validação básica
    if (!dadosPerfil.nome_perfil) {
        alert('Nome do perfil é obrigatório!');
        return;
    }
    
    if (dadosPerfil.tem_pintura && dadosPerfil.area_pintura_m2 <= 0) {
        alert('Área de pintura deve ser maior que zero quando pintura está marcada!');
        return;
    }
    
    console.log('Dados do perfil:', dadosPerfil);
    
    // Criar produto na base de dados
    const produtoData = {
        descricao: dadosPerfil.nome_perfil,
        custo_centavos: ultimoCalculo.custo_total,
        peso_und: dadosPerfil.peso_metro_kg.toFixed(3),
        unidade: 'M', // Metro linear
        referencia: gerarReferenciaPerfil(dadosPerfil.nome_perfil),
        tipo: 'Perfil',
        categoria: 'Perfis',
        subcategoria: 'Pultrusão',
        data_revisao: new Date().toISOString(),
        // Dados específicos do perfil
        dados_perfil: JSON.stringify(dadosPerfil)
    };
    
    console.log('Dados do produto:', produtoData);
    
    // Salvar produto
    fetch('/api/produtos/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(produtoData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(produto => {
        console.log('Perfil salvo:', produto);
        alert(`Perfil "${dadosPerfil.nome_perfil}" criado com sucesso!\nID: ${produto.id}\nCusto: R$ ${(produto.custo_centavos / 100).toFixed(2)}`);
        
        // Fechar modal
        closeProdutoParametrizadoModal();
        
        // Atualizar lista de produtos
        fetchProdutos();
    })
    .catch(error => {
        console.error('Erro ao salvar perfil:', error);
        alert('Erro ao salvar perfil: ' + error.message);
    });
}

// Funções para produtos parametrizáveis
function openFormProdutoParametrizado() {
    console.log('=== ABRINDO MODAL PRODUTO PARAMETRIZADO ===');
    
    // Limpar estado global
    templateAtual = null;
    ultimoCalculo = null;
    
    console.log('Estado limpo - templateAtual:', templateAtual, 'ultimoCalculo:', ultimoCalculo);
    
    // Resetar formulário
    document.getElementById('templateSelect').value = '';
    document.getElementById('templateDescription').innerHTML = '';
    document.getElementById('parametrosContainer').innerHTML = '<p class="text-muted">Selecione um template primeiro</p>';
    
    // Reset da seção de resultado
    const resultadoContainer = document.getElementById('resultadoContainer');
    resultadoContainer.querySelector('p').textContent = 'Configure os parâmetros para ver o resultado';
    document.getElementById('resultadoCalculado').style.display = 'none';
    
    // Limpar campo de nome se existir
    const nomeInput = document.getElementById('nomeProdutoInput');
    if (nomeInput) {
        nomeInput.value = '';
    }
    
    // Verificar se botão calcular existe antes de desabilitá-lo
    const calcularBtn = document.getElementById('calcularBtn');
    if (calcularBtn) {
        calcularBtn.disabled = true;
    }
    
    // Limpar tabela de componentes
    const tbody = document.getElementById('componentesCalculadosTable');
    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum cálculo realizado</td></tr>';
    
    // Desabilitar botão salvar
    document.getElementById('salvarProdutoBtn').disabled = true;
    
    console.log('Interface resetada - carregando templates...');
    
    carregarTemplates();
    produtoParametrizadoModal.show();
    
    console.log('Modal aberto com sucesso');
}

function closeProdutoParametrizadoModal() {
    produtoParametrizadoModal.hide();
}

function carregarTemplates() {
    fetch(apiTemplates)
        .then(res => res.json())
        .then(templates => {
            // Popular o cache
            templatesCache = templates;
            
            const select = document.getElementById('templateSelect');
            select.innerHTML = '<option value="">Escolha um template...</option>';
            
            // Adicionar opção "Novo Perfil" primeiro
            const novoPerfilOption = document.createElement('option');
            novoPerfilOption.value = 'perfil_customizado';
            novoPerfilOption.textContent = 'Novo Perfil';
            select.appendChild(novoPerfilOption);
            
            // Adicionar opção "Grades" 
            const gradesOption = document.createElement('option');
            gradesOption.value = 'grades_customizado';
            gradesOption.textContent = 'Grades';
            select.appendChild(gradesOption);
            
            // Adicionar opção "Tampa Montada"
            const tampaOption = document.createElement('option');
            tampaOption.value = 'tampa_montada_customizado';
            tampaOption.textContent = 'Tampa Montada';
            select.appendChild(tampaOption);
            
            // Adicionar opção "Tampa Injetada"
            const tampaInjetadaOption = document.createElement('option');
            tampaInjetadaOption.value = 'tampa_injetada_customizado';
            tampaInjetadaOption.textContent = 'Tampa Injetada';
            select.appendChild(tampaInjetadaOption);
            
            // Adicionar opção "Degraus"
            const degrausOption = document.createElement('option');
            degrausOption.value = 'degraus_customizado';
            degrausOption.textContent = 'Degraus';
            select.appendChild(degrausOption);
            
            // Adicionar opção "Degrau Injetado"
            const degrauInjetadoOption = document.createElement('option');
            degrauInjetadoOption.value = 'degrau_injetado_customizado';
            degrauInjetadoOption.textContent = 'Degrau Injetado';
            select.appendChild(degrauInjetadoOption);
            
            // Adicionar opção "Guarda Corpo - Horizontal"
            const guardaCorpoHorizontalOption = document.createElement('option');
            guardaCorpoHorizontalOption.value = 'guarda_corpo_horizontal_customizado';
            guardaCorpoHorizontalOption.textContent = 'Guarda Corpo - Horizontal';
            select.appendChild(guardaCorpoHorizontalOption);

            // Adicionar opção "Guarda Corpo - Vertical"
            const guardaCorpoVerticalOption = document.createElement('option');
            guardaCorpoVerticalOption.value = 'guarda_corpo_vertical_customizado';
            guardaCorpoVerticalOption.textContent = 'Guarda Corpo - Vertical';
            select.appendChild(guardaCorpoVerticalOption);
            
            templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                
                // Correção: usar produto_base.descricao em vez de template.nome
                if (template.produto_base && template.produto_base.descricao) {
                    option.textContent = `${template.produto_base.descricao} (${template.produto_base.categoria || 'Geral'})`;
                } else {
                    option.textContent = `Template ID: ${template.id} (Sem produto base)`;
                }
                
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Erro ao carregar templates:', error);
            alert('Erro ao carregar templates de produtos.');
        });
}

function carregarTemplate() {
    const templateId = document.getElementById('templateSelect').value;
    
    console.log('=== CARREGANDO TEMPLATE ===');
    console.log('Template ID:', templateId);
    
    if (!templateId) {
        console.log('Nenhum template selecionado - limpando interface');
        
        // Limpar completamente a interface
        document.getElementById('templateDescription').innerHTML = '';
        document.getElementById('parametrosContainer').innerHTML = '<p class="text-muted">Selecione um template primeiro</p>';
        document.getElementById('resultadoContainer').querySelector('p').textContent = 'Configure os parâmetros para ver o resultado';
        document.getElementById('resultadoCalculado').style.display = 'none';
        
        // Verificar se botões existem antes de desabilitá-los
        const calcularBtn = document.getElementById('calcularBtn');
        if (calcularBtn) {
            calcularBtn.disabled = true;
        }
        document.getElementById('salvarProdutoBtn').disabled = true;
        
        // Limpar tabela de componentes
        const tbody = document.getElementById('componentesCalculadosTable');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum cálculo realizado</td></tr>';
        
        // Resetar variável global
        templateAtual = null;
        ultimoCalculo = null;
        
        return;
    }
    
    // Verificar se é "Novo Perfil"
    if (templateId === 'perfil_customizado') {
        console.log('Carregando interface de Novo Perfil');
        carregarInterfaceNovoPerfil();
        return;
    }
    
    // Verificar se é "Grades"
    if (templateId === 'grades_customizado') {
        console.log('Carregando interface de Grades');
        carregarInterfaceGrades();
        return;
    }
    
    // Verificar se é "Tampa Montada"
    if (templateId === 'tampa_montada_customizado') {
        console.log('Carregando interface de Tampa Montada');
        carregarInterfaceTampaMontada();
        return;
    }
    
    // Verificar se é "Tampa Injetada"
    if (templateId === 'tampa_injetada_customizado') {
        console.log('Carregando interface de Tampa Injetada');
        carregarInterfaceTampaInjetada();
        return;
    }
    
    // Verificar se é "Degraus"
    if (templateId === 'degraus_customizado') {
        console.log('Carregando interface de Degraus');
        carregarInterfaceDegraus();
        return;
    }
    
    // Verificar se é "Degrau Injetado"
    if (templateId === 'degrau_injetado_customizado') {
        console.log('Carregando interface de Degrau Injetado');
        carregarInterfaceDegrauInjetado();
        return;
    }
    
    // Verificar se é "Guarda Corpo - Horizontal"
    if (templateId === 'guarda_corpo_horizontal_customizado') {
        console.log('Carregando interface de Guarda Corpo - Horizontal');
        carregarInterfaceGuardaCorpoHorizontal();
        return;
    }
    // Verificar se é "Guarda Corpo - Vertical"
    if (templateId === 'guarda_corpo_vertical_customizado') {
        console.log('Carregando interface de Guarda Corpo - Vertical');
        carregarInterfaceGuardaCorpoVertical();
        return;
    }
    
    // Usar o template já carregado no cache
    const template = templatesCache.find(t => t.id == templateId);
    if (!template) {
        console.error('Template não encontrado no cache:', templateId);
        alert('Erro: Template não encontrado. Tente recarregar a página.');
        return;
    }
    
    console.log('Template encontrado:', template);
    templateAtual = template;
    
    // Limpar estado anterior
    ultimoCalculo = null;
    document.getElementById('resultadoCalculado').style.display = 'none';
    
    // Verificar se botões existem antes de desabilitá-los
    const calcularBtn = document.getElementById('calcularBtn');
    if (calcularBtn) {
        calcularBtn.disabled = true;
    }
    document.getElementById('salvarProdutoBtn').disabled = true;
    
    // Limpar tabela de componentes
    const tbody = document.getElementById('componentesCalculadosTable');
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Configure os parâmetros e clique em Calcular</td></tr>';
    
    // Mostrar descrição
    const descricao = template.produto_base ? template.produto_base.descricao : 'Sem descrição';
    const categoria = template.produto_base ? template.produto_base.categoria : 'Sem categoria';
    
    document.getElementById('templateDescription').innerHTML = `
        <strong>${descricao}</strong><br>
        <small class="text-muted">Categoria: ${categoria}</small>
    `;
    
    // Reset da seção de resultado
    document.getElementById('resultadoContainer').querySelector('p').textContent = 'Configure os parâmetros para ver o resultado';
    
    // Limpar campo de nome se existir
    const nomeInput = document.getElementById('nomeProdutoInput');
    if (nomeInput) {
        nomeInput.value = '';
    }
    
    console.log('Criando campos de parâmetros...');
    
    // Criar campos de parâmetros usando a nova estrutura
    criarCamposParametrosNovo(template);
}

function criarCamposParametrosNovo(template) {
    const container = document.getElementById('parametrosContainer');
    container.innerHTML = '';
    
    // Verificar se tem parâmetros obrigatórios ou opcionais
    const temObrigatorios = template.parametros_obrigatorios && template.parametros_obrigatorios.length > 0;
    const temOpcionais = template.parametros_opcionais && Object.keys(template.parametros_opcionais).length > 0;
    
    if (!temObrigatorios && !temOpcionais) {
        container.innerHTML = '<p class="text-muted">Este template não possui parâmetros configurados</p>';
        // Não precisa desabilitar calcularBtn aqui pois ele ainda não foi criado
        return;
    }
    
    // Parâmetros obrigatórios
    if (temObrigatorios) {
        const obrigatoriosDiv = document.createElement('div');
        obrigatoriosDiv.innerHTML = '<h6 class="text-danger">Parâmetros Obrigatórios:</h6>';
        
        template.parametros_obrigatorios.forEach(param => {
            const div = document.createElement('div');
            div.className = 'mb-3';
            div.innerHTML = `
                <label for="param_${param}" class="form-label">${param.charAt(0).toUpperCase() + param.slice(1)}:</label>
                <input type="number" class="form-control param-input" id="param_${param}" name="${param}" 
                       value="0" step="0.001" required oninput="verificarParametros()">
            `;
            obrigatoriosDiv.appendChild(div);
        });
        
        container.appendChild(obrigatoriosDiv);
    }
    
    // Parâmetros opcionais
    if (temOpcionais) {
        const opcionaisDiv = document.createElement('div');
        opcionaisDiv.innerHTML = '<h6 class="text-info mt-3">Parâmetros Opcionais:</h6>';
        
        Object.entries(template.parametros_opcionais).forEach(([param, defaultValue]) => {
            const div = document.createElement('div');
            div.className = 'mb-3';
            
            let inputHTML = '';
            if (param === 'tipo_resina') {
                // Criar dropdown para seleção de resina
                inputHTML = `
                    <label for="param_${param}" class="form-label">Tipo de Resina:</label>
                    <select class="form-control param-input" id="param_${param}" name="${param}" oninput="verificarParametros()">
                        <option value="1269" ${defaultValue === '1269' ? 'selected' : ''}>Resina Poliéster - R$ 12,96</option>
                        <option value="1268" ${defaultValue === '1268' ? 'selected' : ''}>Resina Isoftálica - R$ 18,34</option>
                        <option value="1270" ${defaultValue === '1270' ? 'selected' : ''}>Resina Éster Vinílica - R$ 35,97</option>
                    </select>
                `;
            } else if (param === 'velocidade_m_h') {
                // Campo específico para velocidade
                inputHTML = `
                    <label for="param_${param}" class="form-label">Velocidade (m/h):</label>
                    <input type="number" class="form-control param-input" id="param_${param}" name="${param}" 
                           value="${defaultValue}" step="0.1" min="0.1" oninput="verificarParametros()">
                    <div class="form-text">Velocidade de produção em metros por hora</div>
                `;
            } else if (param === 'num_matrizes') {
                // Campo específico para número de matrizes
                inputHTML = `
                    <label for="param_${param}" class="form-label">N° de Matrizes:</label>
                    <input type="number" class="form-control param-input" id="param_${param}" name="${param}" 
                           value="${defaultValue}" step="1" min="1" oninput="verificarParametros()">
                    <div class="form-text">Quantidade de matrizes utilizadas</div>
                `;
            } else if (param === 'num_maquinas_utilizadas') {
                // Campo específico para número de máquinas utilizadas
                inputHTML = `
                    <label for="param_${param}" class="form-label">N° de Máquinas Utilizadas:</label>
                    <input type="number" class="form-control param-input" id="param_${param}" name="${param}" 
                           value="${defaultValue}" step="1" min="1" max="3" oninput="verificarParametros()">
                    <div class="form-text">Máquinas utilizadas (máx. 3)</div>
                `;
            } else {
                // Campo normal para outros parâmetros
                inputHTML = `
                    <label for="param_${param}" class="form-label">${param.charAt(0).toUpperCase() + param.slice(1)}:</label>
                    <input type="text" class="form-control param-input" id="param_${param}" name="${param}" value="${defaultValue}" oninput="verificarParametros()">
                `;
            }
            
            div.innerHTML = inputHTML;
            opcionaisDiv.appendChild(div);
        });
        
        container.appendChild(opcionaisDiv);
    }
    
    // Adicionar botão de calcular na seção de parâmetros
    const calcularDiv = document.createElement('div');
    calcularDiv.className = 'mt-3 text-center';
    calcularDiv.innerHTML = `
        <button type="button" class="btn btn-primary" onclick="calcularProdutoParametrizado()" id="calcularBtn" disabled>
            <i class="fas fa-calculator"></i> Calcular Produto
        </button>
    `;
    container.appendChild(calcularDiv);
    
    // Verificar se pode habilitar o botão
    verificarParametros();
}

function verificarParametros() {
    const calcularBtn = document.getElementById('calcularBtn');
    if (!calcularBtn) {
        console.log('Botão calcular não encontrado');
        return;
    }
    
    console.log('=== VERIFICANDO PARÂMETROS ===');
    
    // Verificar se tem template selecionado
    const templateId = document.getElementById('templateSelect').value;
    if (!templateId) {
        console.log('Nenhum template selecionado');
        calcularBtn.disabled = true;
        return;
    }
    
    const templateAtual = templatesCache.find(t => t.id == templateId);
    if (!templateAtual) {
        console.log('Template não encontrado no cache:', templateId);
        calcularBtn.disabled = true;
        return;
    }
    
    console.log('Template:', templateAtual);
    
    let todosPreenchidos = true;
    
    // Verificar parâmetros obrigatórios
    if (templateAtual.parametros_obrigatorios && templateAtual.parametros_obrigatorios.length > 0) {
        console.log('Verificando parâmetros obrigatórios:', templateAtual.parametros_obrigatorios);
        
        templateAtual.parametros_obrigatorios.forEach(param => {
            const input = document.getElementById(`param_${param}`);
            if (!input) {
                console.log(`Input não encontrado para parâmetro: ${param}`);
                todosPreenchidos = false;
            } else if (!input.value || input.value.trim() === '') {
                console.log(`Parâmetro obrigatório vazio: ${param}`);
                todosPreenchidos = false;
            } else {
                console.log(`Parâmetro OK: ${param} = ${input.value}`);
            }
        });
    }
    
    console.log('Todos preenchidos:', todosPreenchidos);
    calcularBtn.disabled = !todosPreenchidos;
    
    if (todosPreenchidos) {
        console.log('✅ Botão calcular habilitado');
    } else {
        console.log('❌ Botão calcular desabilitado');
    }
}

function calcularProdutoParametrizado() {
    const templateId = document.getElementById('templateSelect').value;
    
    // Verificar se é "Novo Perfil"
    if (templateId === 'perfil_customizado') {
        console.log('=== CALCULANDO NOVO PERFIL ===');
        calcularNovoPerfil();
        return;
    }
    
    const template = templatesCache.find(t => t.id == templateId);
    
    if (!template) {
        alert('Template não encontrado!');
        return;
    }
    
    // Limpar resultado anterior
    document.getElementById('resultadoCalculado').style.display = 'none';
    document.getElementById('salvarProdutoBtn').disabled = true;
    
    // Limpar tabela de componentes
    const tbody = document.getElementById('componentesCalculadosTable');
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Calculando...</td></tr>';
    
    // Coletar parâmetros
    const parametros = {};
    const allInputs = document.querySelectorAll('.param-input');
    
    console.log('=== CÁLCULO PRODUTO PARAMETRIZADO ===');
    console.log('Template ID:', templateId);
    console.log('Template:', template);
    console.log('Inputs encontrados:', allInputs.length);
    
    allInputs.forEach((input, index) => {
        console.log(`Input ${index + 1}: name="${input.name}", value="${input.value}"`);
        parametros[input.name] = input.value;
    });
    
    console.log('Parâmetros coletados:', parametros);
    
    // Mostrar o nome do produto
    document.getElementById('nomeProdutoCalculado').textContent = template.produto_base.descricao;
    
    const csrftoken = getCookie('csrftoken');
    
    const requestBody = {
        template_id: templateId,
        parametros: parametros
    };
    
    console.log('Request body:', JSON.stringify(requestBody, null, 2));
    
    // Fazer chamada para API de cálculo
    fetch('/api/calcular-produto-parametrizado/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(requestBody)
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('=== RESPOSTA DA API ===');
        console.log('Data completa:', data);
        console.log('Success:', data.success);
        console.log('Componentes:', data.componentes);
        console.log('Número de componentes:', data.componentes ? data.componentes.length : 'undefined');
        
        if (data.success) {
            // Armazenar resultado para usar no salvamento
            ultimoCalculo = data;
            
            // Mostrar resultado
            document.getElementById('custoTotalCalculado').textContent = `R$ ${(data.custo_total / 100).toFixed(2)}`;
            document.getElementById('pesoTotalCalculado').textContent = `${data.peso_total} kg`;
            document.getElementById('resultadoCalculado').style.display = 'block';
            
            // Preencher nome automaticamente baseado no template
            const nomeInput = document.getElementById('nomeProdutoInput');
            if (nomeInput && !nomeInput.value) {
                nomeInput.value = template.produto_base.descricao;
            }
            
            // Mostrar componentes calculados
            mostrarComponentesCalculados(data.componentes);
            
            // Habilitar botão salvar
            document.getElementById('salvarProdutoBtn').disabled = false;
        } else {
            console.error('Erro no cálculo:', data.error);
            alert('Erro no cálculo: ' + (data.error || 'Erro desconhecido'));
            
            // Limpar tabela em caso de erro
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erro no cálculo</td></tr>';
        }
    })
    .catch(error => {
        console.error('Erro ao calcular:', error);
        alert('Erro ao calcular produto. Verifique o console para mais detalhes.');
        
        // Limpar tabela em caso de erro
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erro na comunicação</td></tr>';
    });
}

function mostrarComponentesCalculados(componentes) {
    console.log('=== MOSTRAR COMPONENTES ===');
    console.log('Componentes recebidos:', componentes);
    console.log('Tipo:', typeof componentes);
    console.log('É array?', Array.isArray(componentes));
    console.log('Quantidade:', componentes ? componentes.length : 'undefined');
    
    const tbody = document.getElementById('componentesCalculadosTable');
    tbody.innerHTML = '';
    
    if (!componentes || componentes.length === 0) {
        console.log('Nenhum componente - mostrando mensagem vazia');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum componente calculado</td></tr>';
        return;
    }
    
    console.log('Adicionando', componentes.length, 'componentes à tabela');
    componentes.forEach((comp, index) => {
        console.log(`Componente ${index + 1}:`, comp);
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${comp.nome}</td>
            <td>${comp.descricao_produto || comp.produto || 'N/A'}</td>
            <td></td>
            <td>${parseFloat(comp.quantidade).toFixed(3)}</td>
            <td>R$ ${(comp.custo_unitario / 100).toFixed(2)}</td>
            <td>R$ ${(comp.custo_total / 100).toFixed(2)}</td>
            <td></td>
        `;
        tbody.appendChild(row);
    });
    
    // Adicionar linha de total
    const custoTotalGeral = componentes.reduce((total, comp) => total + comp.custo_total, 0);
    const totalRow = document.createElement('tr');
    totalRow.innerHTML = `
        <td colspan="5"><strong>TOTAL GERAL</strong></td>
        <td><strong>R$ ${(custoTotalGeral/100).toFixed(2)}</strong></td>
        <td></td>
    `;
    totalRow.style.backgroundColor = '#f8f9fa'; // Mesmo estilo da Tampa Montada
    tbody.appendChild(totalRow);
    
    console.log('Tabela atualizada com', tbody.children.length, 'linhas');
}

function criarCamposParametros(parametros) {
    const container = document.getElementById('parametrosContainer');
    container.innerHTML = '';
    
    if (!parametros || parametros.length === 0) {
        container.innerHTML = '<p class="text-muted">Este template não possui parâmetros configurados</p>';
        return;
    }
    
    parametros.forEach(param => {
        const div = document.createElement('div');
        div.className = 'mb-3';
        
        let inputHTML = '';
        
        if (param.tipo === 'decimal' || param.tipo === 'inteiro') {
            const step = param.tipo === 'decimal' ? '0.01' : '1';
            inputHTML = `
                <input type="number" class="form-control" 
                       id="param_${param.nome}" 
                       step="${step}" 
                       value="${param.valor_padrao || ''}" 
                       placeholder="Digite o valor"
                       onchange="calcularProduto()"
                       ${param.obrigatorio ? 'required' : ''}>
            `;
        } else if (param.tipo === 'selecao') {
            // Campo de seleção com opções pré-definidas
            let opcoes = '';
            try {
                const opcoesData = typeof param.opcoes_selecao === 'string' 
                    ? JSON.parse(param.opcoes_selecao) 
                    : param.opcoes_selecao || [];
                
                opcoesData.forEach(opcao => {
                    const selected = opcao.id.toString() === param.valor_padrao ? 'selected' : '';
                    opcoes += `<option value="${opcao.id}" ${selected}>${opcao.descricao} - R$ ${opcao.preco.toFixed(2)}</option>`;
                });
            } catch (e) {
                console.error('Erro ao processar opções de seleção:', e);
                opcoes = '<option value="">Erro ao carregar opções</option>';
            }
            
            inputHTML = `
                <select class="form-select" 
                        id="param_${param.nome}" 
                        onchange="calcularProduto()"
                        ${param.obrigatorio ? 'required' : ''}>
                    <option value="">Selecione...</option>
                    ${opcoes}
                </select>
            `;
        } else if (param.tipo === 'produto') {
            // Carregar produtos do banco para seleção
            inputHTML = `
                <select class="form-select" 
                        id="param_${param.nome}" 
                        onchange="calcularProduto()"
                        ${param.obrigatorio ? 'required' : ''}>
                    <option value="">Carregando produtos...</option>
                </select>
            `;
            
            // Carregar produtos após criar o elemento
            setTimeout(() => carregarProdutosParaParametro(param.nome), 100);
        }
        
        div.innerHTML = `
            <label for="param_${param.nome}" class="form-label">
                ${param.label} ${param.obrigatorio ? '*' : ''}
            </label>
            ${inputHTML}
            ${param.ajuda ? `<div class="form-text">${param.ajuda}</div>` : ''}
        `;
        
        container.appendChild(div);
    });
    
    // Botão para calcular
    const btnDiv = document.createElement('div');
    btnDiv.innerHTML = `
        <button type="button" class="btn btn-primary w-100" onclick="calcularProduto()">
            <i class="fas fa-calculator"></i> Calcular
        </button>
    `;
    container.appendChild(btnDiv);
}

function carregarProdutosParaParametro(nomeParametro) {
    const select = document.getElementById(`param_${nomeParametro}`);
    if (!select) return;
    
    // Filtrar apenas produtos que podem ser usados como perfis/materiais
    const produtosFiltrados = allProductsOriginal.filter(produto => 
        produto.tipo === 'Simples' && 
        (produto.unidade === 'M' || produto.unidade === 'KG' || produto.unidade === 'UN')
    );
    
    select.innerHTML = '<option value="">Selecione um produto...</option>';
    
    produtosFiltrados.forEach(produto => {
        const option = document.createElement('option');
        option.value = produto.id;
        option.textContent = `${produto.descricao} - R$ ${(produto.custo_centavos / 100).toFixed(2)}/${produto.unidade}`;
        select.appendChild(option);
    });
}

function calcularProduto() {
    if (!templateAtual) return;
    
    // Coletar valores dos parâmetros
    const parametros = {};
    let todosPreenchidos = true;
    
    templateAtual.parametros.forEach(param => {
        const input = document.getElementById(`param_${param.nome}`);
        if (input) {
            const valor = input.value;
            if (param.obrigatorio && !valor) {
                todosPreenchidos = false;
            }
            parametros[param.nome] = valor;
        }
    });
    
    if (!todosPreenchidos) {
        document.getElementById('resultadoContainer').innerHTML = '<p class="text-warning">Preencha todos os parâmetros obrigatórios</p>';
        return;
    }
    
    // Fazer chamada para calcular
    fetch(apiCalcular, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            template_id: templateAtual.id,
            parametros: parametros
        })
    })
    .then(res => res.json())
    .then(resultado => {
        if (resultado.erro) {
            document.getElementById('resultadoContainer').innerHTML = `<p class="text-danger">Erro: ${resultado.erro}</p>`;
            return;
        }
        
        ultimoCalculo = resultado;
        exibirResultadoCalculo(resultado);
        
        // Habilitar botão salvar
        document.getElementById('salvarProdutoBtn').disabled = false;
    })
    .catch(error => {
        console.error('Erro no cálculo:', error);
        document.getElementById('resultadoContainer').innerHTML = '<p class="text-danger">Erro na comunicação com o servidor</p>';
    });
}

function exibirResultadoCalculo(resultado) {
    // Mostrar resumo no painel de resultado
    document.getElementById('resultadoContainer').innerHTML = `
        <div class="alert alert-success">
            <h6><i class="fas fa-check-circle"></i> Cálculo realizado!</h6>
            <p class="mb-1"><strong>Custo Total:</strong> R$ ${resultado.custo_total.toFixed(2)}</p>
            ${resultado.area_m2 ? `<p class="mb-1"><strong>Área:</strong> ${resultado.area_m2.toFixed(2)} m²</p>` : ''}
            ${resultado.custo_por_m2 ? `<p class="mb-1"><strong>Custo por m²:</strong> R$ ${resultado.custo_por_m2.toFixed(2)}</p>` : ''}
            <p class="mb-2"><small>${resultado.componentes.length} componente(s) calculado(s)</small></p>
        </div>
        
        <div class="mt-3">
            <label for="nomeProdutoParametrizado" class="form-label"><strong>Nome do Produto *</strong></label>
            <input type="text" class="form-control" id="nomeProdutoParametrizado" 
                   placeholder="Ex: Grade 2000x1000mm" required>
            <div class="form-text">Digite um nome descritivo para este produto</div>
        </div>
        
        <div class="mt-3">
            <label for="descricaoProdutoParametrizado" class="form-label">Descrição Adicional</label>
            <textarea class="form-control" id="descricaoProdutoParametrizado" rows="2" 
                      placeholder="Descrição detalhada do produto (opcional)"></textarea>
            <div class="form-text">Informações adicionais sobre o produto</div>
        </div>
    `;
    
    // Mostrar tabela de componentes
    const tbody = document.getElementById('componentesCalculadosTable');
    tbody.innerHTML = '';
    
    resultado.componentes.forEach(comp => {
        tbody.innerHTML += `
            <tr>
                <td>${comp.nome}</td>
                <td>${comp.produto}</td>
                <td>${comp.quantidade.toFixed(3)} ${comp.unidade || ''}</td>
                <td>R$ ${comp.custo_unitario.toFixed(2)}</td>
                <td>R$ ${comp.custo_total.toFixed(2)}</td>
            </tr>
        `;
    });
}

function salvarProdutoParametrizado() {
    const templateId = document.getElementById('templateSelect').value;
    
    // Verificar se é um perfil
    if (templateId === 'perfil_customizado') {
        return salvarPerfilParametrizado();
    }
    
    // Verificar se é uma grade
    if (templateId === 'grades_customizado') {
        return salvarGradeParametrizada();
    }
    
    // Verificar se é uma tampa montada
    if (templateId === 'tampa_montada_customizado') {
        return salvarTampaMontadaParametrizada();
    }
    
    // Verificar se é uma tampa injetada
    if (templateId === 'tampa_injetada_customizado') {
        return salvarTampaInjetadaParametrizada();
    }
    
    // Verificar se é degraus
    if (templateId === 'degraus_customizado') {
        return salvarDegrausParametrizado();
    }
    
    // Verificar se é degrau injetado
    if (templateId === 'degrau_injetado_customizado') {
        return salvarDegrauInjetadoParametrizado();
    }
    
    // Verificar se é guarda corpo horizontal
    if (templateId === 'guarda_corpo_horizontal_customizado') {
        return salvarGuardaCorpoHorizontalParametrizado();
    }
    if (templateId === 'guarda_corpo_vertical_customizado') {
        return salvarGuardaCorpoVerticalParametrizado();
    }
    
    const template = templatesCache.find(t => t.id == templateId);
    
    if (!template) {
        alert('Selecione um template primeiro!');
        return;
    }
    
    // Verificar se o cálculo foi feito
    const resultadoDiv = document.getElementById('resultadoCalculado');
    if (resultadoDiv.style.display === 'none') {
        alert('Realize o cálculo primeiro!');
        return;
    }
    
    // Verificar se nome foi preenchido
    const nomeInput = document.getElementById('nomeProdutoInput');
    if (!nomeInput || !nomeInput.value.trim()) {
        alert('Por favor, digite um nome para o produto!');
        nomeInput?.focus();
        return;
    }
    
    // Coletar parâmetros
    const parametros = {};
    const allInputs = document.querySelectorAll('.param-input');
    allInputs.forEach(input => {
        parametros[input.name] = input.value;
    });
    
    // Usar o nome digitado pelo usuário
    const descricaoFinal = nomeInput.value.trim();
    
    // Criar referência única
    const agora = new Date();
    const timestamp = agora.getTime();
    const referencia = `PARAM-${template.id}-${timestamp}`;
    
    // Obter custo e peso do resultado calculado
    const custoTexto = document.getElementById('custoTotalCalculado').textContent;
    const custoReais = parseFloat(custoTexto.replace('R$ ', '').replace(',', '.'));
    const custoCentavos = Math.round(custoReais * 100);
    
    const pesoTexto = document.getElementById('pesoTotalCalculado').textContent;
    const peso = parseFloat(pesoTexto.replace(' kg', ''));
    
    // Função para obter CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    
    // Dados do produto
    const produtoData = {
        descricao: descricaoFinal,
        custo_centavos: custoCentavos,
        peso_und: peso.toFixed(3),
        unidade: template.produto_base.unidade,
        referencia: referencia,
        tipo_produto: 'composto',  // Mudança: salvar como composto
        categoria: template.produto_base.categoria,
        subcategoria: 'Parametrizado'
    };
    
    console.log('Salvando produto:', produtoData);
    
    // Salvar produto
    fetch('/api/produtos/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(produtoData)
    })
    .then(response => {
        console.log('🔄 Resposta do servidor para produto principal:', response.status);
        if (!response.ok) {
            console.error('❌ Erro ao salvar produto principal:', response.status);
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(produto => {
        console.log('✅ Produto principal salvo com sucesso:', produto);
        console.log('   ID do produto:', produto.id, 'Tipo:', typeof produto.id);
        
        // Agora salvar todos os componentes calculados
        return salvarComponentesParametrizados(produto.id, csrftoken);
    })
    .then(produto => {
        console.log('Produto e componentes salvos com sucesso');
        alert(`Produto "${produto.descricao}" salvo com sucesso como produto composto!\nID: ${produto.id}\nCusto: R$ ${(produto.custo_centavos / 100).toFixed(2)}\nComponentes: ${produto.num_componentes || 'N/A'}`);
        
        // Fechar modal
        closeProdutoParametrizadoModal();
        
        // Recarregar lista de produtos
        fetchProdutos();
    })
    .catch(error => {
        console.error('Erro ao salvar produto:', error);
        alert('Erro ao salvar produto: ' + error.message);
    });
}

function salvarGradeParametrizada() {
    console.log('=== SALVANDO GRADE PARAMETRIZADA ===');
    
    // Função para obter cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Obter token CSRF
    const csrftoken = getCookie('csrftoken');
    
    // Verificar se o cálculo foi feito
    if (!ultimoCalculo || !ultimoCalculo.success) {
        alert('Realize o cálculo da grade primeiro!');
        return;
    }
    
    // Verificar se nome foi preenchido
    const nomeGrade = document.getElementById('grade_nome').value.trim();
    if (!nomeGrade) {
        alert('Por favor, digite um nome para a grade!');
        return;
    }
    
    console.log('Dados da grade para salvar:', ultimoCalculo);
    
    // Usar sempre o custo_total que já foi corrigido no ultimoCalculo
    // (que foi atualizado na função calcularGrade com a soma correta dos componentes)
    const custoTotalComponentes = ultimoCalculo.componentes.reduce((total, comp) => total + comp.custo_total, 0);
    console.log(`💰 Verificação de custos:`);
    console.log(`   ultimoCalculo.custo_total (já corrigido): ${ultimoCalculo.custo_total} centavos = R$ ${(ultimoCalculo.custo_total/100).toFixed(2)}`);
    console.log(`   Soma manual dos componentes: ${custoTotalComponentes} centavos = R$ ${(custoTotalComponentes/100).toFixed(2)}`);
    
    // Usar o custo_total que já foi corrigido na função calcularGrade
    const custoFinalCentavos = Math.round(ultimoCalculo.custo_total);
    
    // Dados do produto principal (grade)
    const produtoData = {
        descricao: nomeGrade,
        custo_centavos: custoFinalCentavos,
        peso_und: parseFloat(ultimoCalculo.peso_total.toFixed(3)),
        unidade: 'm²',
        referencia: gerarReferenciaGrade(nomeGrade),
        tipo_produto: 'composto',
        categoria: 'Grade',
        subcategoria: 'Estrutural'
    };
    
    console.log('Salvando grade com custo corrigido:', produtoData);
    
    // Salvar produto principal
    fetch('/api/produtos/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(produtoData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(produto => {
        console.log('✅ Grade principal salva:', produto);
        
        // Salvar componentes da grade
        return salvarComponentesCalculados(produto.id, csrftoken);
    })
    .then(() => {
        alert('Grade salva com sucesso na base de dados!');
        
        // Limpar formulário
        document.getElementById('grade_nome').value = '';
        document.getElementById('grade_vao').value = '';
        document.getElementById('grade_comprimento').value = '';
        document.getElementById('grade_eixo_i').value = '';
        document.getElementById('grade_perfil').value = '';
        
        // Ocultar resultado
        document.getElementById('resultadoCalculado').style.display = 'none';
        
        // Desabilitar botão
        document.getElementById('salvarProdutoBtn').disabled = true;
        
        // Limpar tabela
        document.getElementById('componentesCalculadosTable').innerHTML = '';
        
        console.log('✅ Grade salva e formulário limpo');
    })
    .catch(error => {
        console.error('Erro ao salvar grade:', error);
        alert('Erro ao salvar grade: ' + error.message);
    });
}

function gerarReferenciaGrade(nomeGrade) {
    // Gerar referência baseada no nome da grade
    const palavras = nomeGrade.split(' ').filter(p => p.length > 0);
    let referencia = palavras.slice(0, 3).join('').substring(0, 6).toUpperCase();
    
    // Adicionar timestamp para unicidade
    const timestamp = Date.now().toString().slice(-4);
    referencia += timestamp;
    
    console.log(`Referência gerada: ${referencia} para "${nomeGrade}"`);
    return referencia;
}

function salvarTampaMontadaParametrizada() {
    console.log('=== SALVANDO TAMPA MONTADA PARAMETRIZADA ===');
    
    // Função para obter cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Obter token CSRF
    const csrftoken = getCookie('csrftoken');
    
    // Verificar se o cálculo foi feito
    if (!ultimoCalculo || !ultimoCalculo.success) {
        alert('Realize o cálculo da tampa montada primeiro!');
        return;
    }
    
    // Verificar se nome foi preenchido
    const nomeTampa = document.getElementById('tampa_nome').value.trim();
    if (!nomeTampa) {
        alert('Por favor, digite um nome para a tampa montada!');
        return;
    }
    
    console.log('Dados da tampa montada para salvar:', ultimoCalculo);
    
    // Usar sempre o custo_total que já foi corrigido no ultimoCalculo
    const custoTotalComponentes = ultimoCalculo.componentes.reduce((total, comp) => total + comp.custo_total, 0);
    console.log(`💰 Verificação de custos:`);
    console.log(`   ultimoCalculo.custo_total: ${ultimoCalculo.custo_total} centavos = R$ ${(ultimoCalculo.custo_total/100).toFixed(2)}`);
    console.log(`   Soma manual dos componentes: ${custoTotalComponentes} centavos = R$ ${(custoTotalComponentes/100).toFixed(2)}`);
    
    // Usar o custo_total que já foi corrigido na função calcularTampaMontada
    const custoFinalCentavos = Math.round(ultimoCalculo.custo_total);
    
    // Dados do produto principal (tampa montada)
    const produtoData = {
        descricao: nomeTampa,
        custo_centavos: custoFinalCentavos,
        peso_und: parseFloat(ultimoCalculo.peso_total.toFixed(3)),
        unidade: 'm²',
        referencia: gerarReferenciaTampa(nomeTampa),
        tipo_produto: 'composto',
        categoria: 'Tampa',
        subcategoria: 'Montada'
    };
    
    console.log('Salvando tampa montada com custo corrigido:', produtoData);
    
    // Salvar produto principal
    fetch('/api/produtos/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(produtoData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(produto => {
        console.log('✅ Tampa montada principal salva:', produto);
        
        // Salvar componentes da tampa montada
        return salvarComponentesCalculados(produto.id, csrftoken);
    })
    .then(() => {
        alert('Tampa montada salva com sucesso na base de dados!');
        
        // Limpar formulário
        document.getElementById('tampa_nome').value = '';
        document.getElementById('tampa_vao').value = '';
        document.getElementById('tampa_comprimento').value = '';
        document.getElementById('tampa_eixo_i').value = '';
        document.getElementById('tampa_perfil').value = '';
        document.getElementById('tampa_quadro_u4').checked = false;
        document.getElementById('tampa_alca').checked = false;
        document.getElementById('tampa_chapa_ev').checked = false;
        
        // Ocultar resultado
        document.getElementById('resultadoCalculado').style.display = 'none';
        
        // Desabilitar botão
        document.getElementById('salvarProdutoBtn').disabled = true;
        
        // Limpar tabela
        document.getElementById('componentesCalculadosTable').innerHTML = '';
        
        // Fechar modal
        closeProdutoParametrizadoModal();
        
        // Recarregar lista de produtos
        fetchProdutos();
        
        console.log('✅ Tampa montada salva e formulário limpo');
    })
    .catch(error => {
        console.error('Erro ao salvar tampa montada:', error);
        alert('Erro ao salvar tampa montada: ' + error.message);
    });
}

function salvarTampaInjetadaParametrizada() {
    console.log('=== SALVANDO TAMPA INJETADA PARAMETRIZADA ===');
    
    // Função para obter cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Obter token CSRF
    const csrftoken = getCookie('csrftoken');
    
    // Verificar se o cálculo foi feito
    if (!ultimoCalculo || !ultimoCalculo.success) {
        alert('Realize o cálculo da tampa injetada primeiro!');
        return;
    }
    
    // Verificar se nome foi preenchido
    const nomeTampa = document.getElementById('tampa_inj_nome').value.trim();
    if (!nomeTampa) {
        alert('Por favor, digite um nome para a tampa injetada!');
        return;
    }
    
    console.log('Dados da tampa injetada para salvar:', ultimoCalculo);
    
    // Usar o custo_total corrigido
    const custoFinalCentavos = Math.round(ultimoCalculo.custo_total);
    
    // Dados do produto principal (tampa injetada)
    const produtoData = {
        descricao: nomeTampa,
        custo_centavos: custoFinalCentavos,
        peso_und: parseFloat(ultimoCalculo.peso_total.toFixed(3)),
        unidade: 'm²',
        referencia: gerarReferenciaTampa(nomeTampa),
        tipo_produto: 'composto',
        categoria: 'Tampa',
        subcategoria: 'Injetada'
    };
    
    console.log('Salvando tampa injetada:', produtoData);
    
    // Salvar produto principal
    fetch('/api/produtos/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(produtoData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(produto => {
        console.log('✅ Tampa injetada principal salva:', produto);
        
        // Salvar componentes da tampa injetada
        return salvarComponentesTampaInjetada(produto.id, csrftoken);
    })
    .then(() => {
        alert('Tampa injetada salva com sucesso na base de dados!');
        
        // Limpar formulário
        document.getElementById('tampa_inj_nome').value = '';
        document.getElementById('tampa_inj_vao').value = '';
        document.getElementById('tampa_inj_comprimento').value = '';
        document.getElementById('tampa_inj_grade').value = '';
        document.getElementById('tampa_inj_quadro_u4').checked = false;
        document.getElementById('tampa_inj_alca').checked = false;
        document.getElementById('tampa_inj_chapa_ev').checked = false;
        
        // Fechar modal
        closeProdutoParametrizadoModal();
        
        // Recarregar lista de produtos
        fetchProdutos();
        
        console.log('✅ Tampa injetada salva e formulário limpo');
    })
    .catch(error => {
        console.error('Erro ao salvar tampa injetada:', error);
        alert('Erro ao salvar tampa injetada: ' + error.message);
    });
}

function gerarReferenciaTampa(nomeTampa) {
    // Gerar referência baseada no nome da tampa
    const palavras = nomeTampa.split(' ').filter(p => p.length > 0);
    let referencia = 'TAMPA-' + palavras.slice(0, 2).join('').substring(0, 8).toUpperCase();
    
    // Adicionar timestamp para unicidade
    const timestamp = Date.now().toString().slice(-4);
    referencia += timestamp;
    
    console.log(`Referência gerada: ${referencia} para "${nomeTampa}"`);
    return referencia;
}

async function salvarComponentesCalculados(produtoId, csrftoken) {
    console.log('=== SALVANDO COMPONENTES CALCULADOS ===');
    
    try {
        // Primeiro, limpar componentes existentes deste produto para evitar conflitos
        console.log('🧹 Limpando componentes existentes do produto...');
        try {
            const componentesExistentesResponse = await fetch(`/api/componentes/?produto_principal=${produtoId}`);
            if (componentesExistentesResponse.ok) {
                const componentesExistentes = await componentesExistentesResponse.json();
                
                console.log(`   Encontrados ${componentesExistentes.length} componentes existentes`);
                
                for (const comp of componentesExistentes) {
                    const deleteResponse = await fetch(`/api/componentes/${comp.id}/`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': csrftoken
                        }
                    });
                    
                    if (deleteResponse.ok) {
                        console.log(`   ✅ Removido componente ID ${comp.id}`);
                    } else {
                        console.warn(`   ⚠️ Erro ao remover componente ID ${comp.id}: ${deleteResponse.status}`);
                    }
                }
                
                console.log('✅ Limpeza de componentes existentes concluída');
            } else {
                console.warn('⚠️ Erro ao buscar componentes existentes:', componentesExistentesResponse.status);
            }
        } catch (error) {
            console.warn('⚠️ Erro ao limpar componentes existentes:', error);
        }
        
        // Array para rastrear componentes já processados (evitar duplicatas)
        const componentesProcessados = new Map();
        
        console.log(`💾 Salvando ${ultimoCalculo.componentes.length} componentes únicos...`);
        console.log('📋 Lista completa de componentes:', ultimoCalculo.componentes.map(c => `"${c.nome}"`));
        
        for (const componente of ultimoCalculo.componentes) {
            console.log(`\n🔧 Processando componente: "${componente.nome}"`);
            
            // Encontrar o ID do produto componente baseado no nome
            let produtoComponenteId = null;
            
            // PRIMEIRO: Verificar mão de obra (deve vir antes de U4 e outras verificações)
            if (componente.nome.toLowerCase().includes('processamento') || 
                componente.nome.toLowerCase().includes('montagem') ||
                componente.nome.toLowerCase().includes('mão de obra')) {
                // Detectada mão de obra
                console.log('🔧 DETECTADA MÃO DE OBRA:', componente.nome);
                
                // Usar o ID do produto de mão de obra do ultimoCalculo ou ID fixo conhecido
                const maoObraProduto = ultimoCalculo.mao_obra_produto_id || 1374;
                produtoComponenteId = maoObraProduto;
                console.log('✅ Usando ID da mão de obra:', produtoComponenteId);
            
            // Para perfis I25, I32, I38
            } else if (componente.nome.includes('I25')) {
                produtoComponenteId = componente.nome.includes('Leve') ? 1331 : 1328;
            } else if (componente.nome.includes('I32')) {
                produtoComponenteId = 1329;
            } else if (componente.nome.includes('I38')) {
                produtoComponenteId = 1330;
            } else if (componente.nome.includes('Chaveta')) {
                produtoComponenteId = 1332; // ID fixo da chaveta
            } else if (componente.nome.includes('COLA ESTRUTURAL')) {
                produtoComponenteId = 1183; // ID fixo da cola estrutural 4500 A/B
            } else if (componente.nome.includes('TRAV')) {
                // Buscar perfil TRAV dinamicamente
                const produto = await buscarProdutoPorDescricao('trav');
                produtoComponenteId = produto.id;
            } else if (componente.nome.toLowerCase().includes('chapa') && componente.nome.toLowerCase().includes('lisa')) {
                // Buscar chapa lisa 2,5mm dinamicamente
                const produto = await buscarProdutoPorDescricao('chapa lisa');
                produtoComponenteId = produto.id;
            } else if (componente.nome.toLowerCase().includes('chapa') && componente.nome.toLowerCase().includes('2,5')) {
                // Buscar chapa 2,5mm dinamicamente
                const produto = await buscarProdutoPorDescricao('chapa 2,5');
                produtoComponenteId = produto.id;
            } else if (componente.nome.toLowerCase().includes('chapa') && componente.nome.toLowerCase().includes('ev')) {
                // Para Chapa EV com valor fixo, criar produto se não existir
                produtoComponenteId = await buscarOuCriarChapaEV(csrftoken);
            } else if (componente.nome.toLowerCase().includes('u4')) {
                // Buscar perfil U4" dinamicamente
                const produto = await buscarProdutoPorDescricao('u4');
                produtoComponenteId = produto.id;
            } else if (componente.nome.toLowerCase().includes('alça')) {
                // Buscar alça dinamicamente
                const produto = await buscarProdutoPorDescricao('alça');
                produtoComponenteId = produto.id;
            } else if (componente.nome.toLowerCase().includes('grade') && componente.nome.toLowerCase().includes('injetada')) {
                // Buscar grade injetada dinamicamente
                const produto = await buscarProdutoPorDescricao('grade injetada');
                produtoComponenteId = produto.id;
            }
            
            if (!produtoComponenteId) {
                console.error(`❌ Não foi possível mapear o componente: ${componente.nome}`);
                throw new Error(`Componente não mapeado: ${componente.nome}`);
            }
            
            // Verificar se já foi processado este produto componente (evitar duplicatas)
            if (componentesProcessados.has(produtoComponenteId)) {
                console.warn(`⚠️ Produto componente já processado, somando quantidades: ${componente.nome} (ID: ${produtoComponenteId})`);
                
                // Somar as quantidades se for o mesmo produto
                const componenteExistente = componentesProcessados.get(produtoComponenteId);
                componenteExistente.quantidade += Math.round(parseFloat(componente.quantidade.toFixed(3)) * 1000) / 1000;
                componenteExistente.custo_total += Math.round(componente.custo_total);
                
                console.log(`   Nova quantidade total: ${componenteExistente.quantidade}`);
                console.log(`   Novo custo total: ${componenteExistente.custo_total} centavos`);
                continue;
            }
            
            // Salvar custos calculados na observação como JSON
            const custosCalculados = {
                custo_unitario: Math.round(componente.custo_unitario),
                custo_total: Math.round(componente.custo_total),
                nome_componente: componente.nome,
                calculated_at: new Date().toISOString()
            };
            
            const componenteData = {
                produto_principal: produtoId,
                produto_componente: produtoComponenteId,
                quantidade: Math.round(parseFloat(componente.quantidade.toFixed(3)) * 1000) / 1000, // Garantir max 3 decimais
                observacao: JSON.stringify(custosCalculados)
            };
            
            // Adicionar ao mapa de componentes processados
            componentesProcessados.set(produtoComponenteId, {
                ...componenteData,
                nome: componente.nome,
                custo_total: Math.round(componente.custo_total)
            });
            
            console.log(`Preparando componente: ${componente.nome}`);
            console.log('Dados originais do componente:', {
                nome: componente.nome,
                quantidade: componente.quantidade,
                custo_unitario_original: componente.custo_unitario,
                custo_total_original: componente.custo_total
            });
            console.log('Dados processados:', componenteData);
        }
        
        // Agora salvar todos os componentes únicos
        console.log(`\n💾 Salvando ${componentesProcessados.size} componentes únicos...`);
        
        for (const [produtoComponenteId, dadosComponente] of componentesProcessados) {
            try {
                console.log(`Salvando componente: ${dadosComponente.nome} (ID: ${produtoComponenteId})`);
                
                const response = await fetch('/api/componentes/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        produto_principal: dadosComponente.produto_principal,
                        produto_componente: produtoComponenteId,
                        quantidade: dadosComponente.quantidade,
                        observacao: dadosComponente.observacao
                    })
                });
                
                console.log(`Response status: ${response.status} para componente: ${dadosComponente.nome}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Erro detalhado para ${dadosComponente.nome}:`, errorText);
                    throw new Error(`Erro ao salvar componente ${dadosComponente.nome}: ${response.status} - ${errorText}`);
                }
                
                const componenteSalvo = await response.json();
                console.log(`✅ Componente salvo:`, componenteSalvo);
                
            } catch (error) {
                console.error(`❌ Erro ao salvar componente ${dadosComponente.nome}:`, error);
                throw error;
            }
        }
        console.log('✅ Todos os componentes foram salvos');
        
    } catch (error) {
        console.error('❌ Erro ao salvar componentes:', error);
        throw error;
    }
}

async function salvarDegrausParametrizado() {
    console.log('=== SALVANDO DEGRAUS PARAMETRIZADO ===');
    
    if (!ultimoCalculo) {
        alert('Realize o cálculo antes de salvar!');
        return;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    // Dados do produto principal
    const produtoData = {
        descricao: ultimoCalculo.nome,
        categoria: ultimoCalculo.categoria,
        tipo_produto: 'composto',
        custo_centavos: Math.round(ultimoCalculo.custo_total),
        preco_venda_centavos: Math.round(ultimoCalculo.custo_total * 1.3), // 30% de margem padrão
        peso_und: 0, // Será calculado a partir dos componentes
        unidade: 'unid',
        observacoes: `Degrau calculado automaticamente - ${ultimoCalculo.parametros.tipo_perfil}`,
        referencia: gerarReferenciaDegrau(ultimoCalculo.nome),
        data_revisao: new Date().toISOString(),
        ativo: true
    };
    
    console.log('Dados do produto degrau:', produtoData);
    console.log('ultimoCalculo completo:', ultimoCalculo);
    
    // Validar dados antes de enviar
    if (!produtoData.descricao || produtoData.descricao.trim() === '') {
        alert('Nome do degrau é obrigatório');
        return;
    }
    
    if (!produtoData.custo_centavos || produtoData.custo_centavos <= 0) {
        alert('Custo do degrau deve ser maior que zero');
        return;
    }
    
    // Salvar produto principal
    fetch('/api/produtos/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(produtoData)
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                console.error('Erro na resposta do servidor:', text);
                throw new Error(`Erro HTTP ${response.status}: ${response.statusText}. Detalhes: ${text}`);
            });
        }
        return response.json();
    })
    .then(produto => {
        console.log('✅ Degrau principal salvo:', produto);
        
        // Salvar componentes do degrau
        return salvarComponentesDegrau(produto.id, csrftoken);
    })
    .then(() => {
        alert('Degrau salvo com sucesso na base de dados!');
        
        // Limpar formulário
        document.getElementById('degraus_nome').value = '';
        document.getElementById('degraus_perfil').value = '';
        document.getElementById('degraus_largura').value = '';
        document.getElementById('degraus_comprimento').value = '';
        
        // Fechar modal
        closeProdutoParametrizadoModal();
        
        // Recarregar lista de produtos
        fetchProdutos();
        
        console.log('✅ Degrau salvo e formulário limpo');
    })
    .catch(error => {
        console.error('Erro ao salvar degrau:', error);
        alert('Erro ao salvar degrau: ' + error.message);
    });
}

function gerarReferenciaDegrau(nomeDegrau) {
    // Gerar referência baseada no nome do degrau
    const palavras = nomeDegrau.split(' ').filter(p => p.length > 0);
    let referencia = 'DEGR-' + palavras.slice(0, 2).join('').substring(0, 8).toUpperCase();
    
    // Adicionar timestamp para unicidade
    const timestamp = Date.now().toString().slice(-4);
    referencia += timestamp;
    
    console.log(`Referência gerada: ${referencia} para "${nomeDegrau}"`);
    return referencia;
}

function gerarReferenciaDegrauInjetado(nomeDegrau) {
    // Gerar referência baseada no nome do degrau injetado
    const palavras = nomeDegrau.split(' ').filter(p => p.length > 0);
    let referencia = 'DEGI-' + palavras.slice(0, 2).join('').substring(0, 8).toUpperCase();
    
    // Adicionar timestamp para unicidade
    const timestamp = Date.now().toString().slice(-4);
    referencia += timestamp;
    
    console.log(`Referência gerada: ${referencia} para "${nomeDegrau}"`);
    return referencia;
}

async function salvarComponentesDegrau(produtoId, csrftoken) {
    console.log('=== SALVANDO COMPONENTES DE DEGRAU ===');
    
    if (!ultimoCalculo || !ultimoCalculo.componentes) {
        throw new Error('Nenhum componente calculado encontrado');
    }
    
    console.log(`💾 Salvando ${ultimoCalculo.componentes.length} componentes para produto ${produtoId}`);
    
    for (const componente of ultimoCalculo.componentes) {
        console.log(`\n📦 Processando: ${componente.nome}`);
        console.log(`   Quantidade: ${componente.quantidade}`);
        console.log(`   Custo total: R$ ${(componente.custo_total/100).toFixed(2)}`);
        
        // Identificar o produto componente
        let produtoComponenteId;
        
        // Lógica de identificação de produtos baseada no nome do componente
        if (componente.nome.toLowerCase().includes('processamento') || componente.nome.toLowerCase().includes('montagem')) {
            // Mão de obra - usar ID fixo 1374
            produtoComponenteId = 1374;
        } else if (componente.nome.toLowerCase().includes('i25')) {
            // Perfil I25
            const produto = await buscarProdutoPorDescricao('I25mm');
            produtoComponenteId = produto.id;
        } else if (componente.nome.toLowerCase().includes('i38')) {
            // Perfil I38
            const produto = await buscarProdutoPorDescricao('I38mm');
            produtoComponenteId = produto.id;
        } else if (componente.nome.toLowerCase().includes('trav')) {
            // Travessa
            const produto = await buscarProdutoPorDescricao('TRAV');
            produtoComponenteId = produto.id;
        } else if (componente.nome.toLowerCase().includes('cola')) {
            // Cola estrutural
            produtoComponenteId = 1183; // ID fixo da cola estrutural
        } else if (componente.nome.toLowerCase().includes('perfil f')) {
            // Perfil F para reforço
            const produto = await buscarProdutoPorDescricao('PERFIL F');
            produtoComponenteId = produto.id;
        } else if (componente.nome.toLowerCase().includes(' e ')) {
            // Perfil E para reforço
            const produto = await buscarProdutoPorDescricao('E');
            produtoComponenteId = produto.id;
        } else if (componente.nome.toLowerCase().includes('tubo quadrado')) {
            // Tubo quadrado
            const produto = await buscarProdutoPorDescricao('Tubo Quadrado');
            produtoComponenteId = produto.id;
        } else if (componente.nome.toLowerCase().includes('paraf-sxt-m6x40')) {
            // Parafuso M6x40
            const produto = await buscarProdutoPorDescricao('PARAF-SXT-M6X40');
            produtoComponenteId = produto.id;
        } else if (componente.nome.toLowerCase().includes('paraf-sxt-m6x60')) {
            // Parafuso M6x60
            const produto = await buscarProdutoPorDescricao('PARAF-SXT-M6X60');
            produtoComponenteId = produto.id;
        } else if (componente.nome.toLowerCase().includes('por-sxt-m6')) {
            // Porca M6
            const produto = await buscarProdutoPorDescricao('POR-SXT-M6');
            produtoComponenteId = produto.id;
        } else {
            console.warn(`⚠️ Produto não reconhecido: ${componente.nome}`);
            continue;
        }
        
        if (!produtoComponenteId) {
            console.error(`❌ Produto não encontrado para: ${componente.nome}`);
            continue;
        }
        
        console.log(`   ✅ Produto componente ID: ${produtoComponenteId}`);
        
        // Criar dados do componente
        const componenteData = {
            produto_principal: produtoId,
            produto_componente: produtoComponenteId,
            quantidade: Math.round(componente.quantidade * 1000) / 1000, // Arredondar para 3 casas decimais
            observacao: `Componente de degrau - ${componente.nome}`
        };
        
        console.log('   📝 Dados do componente:', componenteData);
        
        // Salvar componente
        const response = await fetch('/api/componentes/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(componenteData)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error(`❌ Erro ao salvar componente ${componente.nome}:`, errorText);
            throw new Error(`Erro ao salvar ${componente.nome}: ${response.status}`);
        }
        
        const componenteSalvo = await response.json();
        console.log(`   ✅ Componente salvo: ID ${componenteSalvo.id}`);
    }
    
    console.log('✅ Todos os componentes de degrau foram salvos com sucesso');
}

async function salvarDegrauInjetadoParametrizado() {
    console.log('=== SALVANDO DEGRAU INJETADO PARAMETRIZADO ===');
    
    if (!ultimoCalculo) {
        alert('Realize o cálculo antes de salvar!');
        return;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    // Dados do produto principal
    const produtoData = {
        descricao: ultimoCalculo.nome,
        categoria: ultimoCalculo.categoria,
        tipo_produto: 'composto',
        custo_centavos: Math.round(ultimoCalculo.custo_total),
        preco_venda_centavos: Math.round(ultimoCalculo.custo_total * 1.3), // 30% de margem padrão
        peso_und: 0, // Será calculado a partir dos componentes
        unidade: 'unid',
        observacoes: `Degrau Injetado calculado automaticamente - Grade ID ${ultimoCalculo.parametros.grade_id}`,
        referencia: gerarReferenciaDegrauInjetado(ultimoCalculo.nome),
        data_revisao: new Date().toISOString(),
        ativo: true
    };
    
    console.log('Dados do produto degrau injetado:', produtoData);
    
    // Salvar produto principal
    fetch('/api/produtos/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(produtoData)
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`Erro ${response.status}: ${text}`);
            });
        }
        return response.json();
    })
    .then(produto => {
        console.log('✅ Degrau injetado salvo:', produto);
        
        // Salvar componentes
        salvarComponentesDegrauInjetado(produto.id, csrftoken);
        
        alert('Degrau injetado salvo com sucesso na base de dados!');
        
        // Limpar formulário e resultado
        document.getElementById('parametrosContainer').innerHTML = '<p class="text-muted">Selecione um template para começar...</p>';
        document.getElementById('resultadoCalculado').style.display = 'none';
        document.getElementById('salvarProdutoBtn').disabled = true;
        ultimoCalculo = null;
        
        // Recarregar produtos
        fetchProdutos();
    })
    .catch(error => {
        console.error('❌ Erro ao salvar degrau injetado:', error);
        alert('Erro ao salvar degrau injetado: ' + (error.message || 'Erro desconhecido'));
    });
}

async function salvarComponentesDegrauInjetado(produtoId, csrftoken) {
    console.log('=== SALVANDO COMPONENTES DEGRAU INJETADO ===');
    
    try {
        for (const componente of ultimoCalculo.componentes) {
            // Encontrar o ID do produto componente baseado no nome
            let produtoComponenteId = null;
            
            // Verificar mão de obra
            if (componente.nome.toLowerCase().includes('processamento') || 
                componente.nome.toLowerCase().includes('montagem')) {
                produtoComponenteId = 1374; // ID fixo da mão de obra (mesmo usado em degraus normais)
            } 
            // Verificar grade injetada
            else if (componente.nome.toLowerCase().includes('grade injetada')) {
                produtoComponenteId = ultimoCalculo.parametros.grade_id;
            }
            // Verificar perfil reforço E
            else if (componente.nome.toLowerCase().includes('e - 4')) {
                const produto = await buscarProdutoPorDescricao('E - 4\'x1.3/16\' #3/16\'');
                produtoComponenteId = produto.id;
            }
            // Verificar perfil reforço F
            else if (componente.nome.toLowerCase().includes('f - 4')) {
                const produto = await buscarProdutoPorDescricao('F - 4\'x1.1/4\' #3/16\'');
                produtoComponenteId = produto.id;
            }
            // Verificar tubo quadrado
            else if (componente.nome.toLowerCase().includes('tubo quadrado')) {
                const produto = await buscarProdutoPorDescricao('Tubo Quadrado 25x38#3mm');
                produtoComponenteId = produto.id;
            }
            // Verificar parafusos e porcas
            else if (componente.nome.toLowerCase().includes('paraf-sxt-m6x40')) {
                const produto = await buscarProdutoPorDescricao('PARAF-SXT-M6X40');
                produtoComponenteId = produto.id;
            } else if (componente.nome.toLowerCase().includes('paraf-sxt-m6x60')) {
                const produto = await buscarProdutoPorDescricao('PARAF-SXT-M6X60');
                produtoComponenteId = produto.id;
            } else if (componente.nome.toLowerCase().includes('por-sxt-m6')) {
                const produto = await buscarProdutoPorDescricao('POR-SXT-M6');
                produtoComponenteId = produto.id;
            }
            
            if (!produtoComponenteId) {
                console.warn(`❓ Produto componente não encontrado para: ${componente.nome}`);
                continue;
            }
            
            // Criar dados do componente
            const componenteData = {
                produto_principal: produtoId,
                produto_componente: produtoComponenteId,
                quantidade: Math.round(componente.quantidade * 1000) / 1000, // Arredondar para 3 casas decimais
                observacao: JSON.stringify({
                    nome_componente: componente.nome,
                    custo_unitario: componente.custo_unitario,
                    custo_total: componente.custo_total,
                    tipo_calculo: 'degrau_injetado',
                    unidade: componente.unidade || 'unid'
                })
            };
            
            console.log(`💾 Salvando componente: ${componente.nome} (ID: ${produtoComponenteId})`);
            console.log('Dados do componente:', componenteData);
            
            // Salvar componente
            const response = await fetch('/api/componentes/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(componenteData)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Erro detalhado:', errorText);
                throw new Error(`Erro ao salvar componente ${componente.nome}: ${response.statusText}. Detalhes: ${errorText}`);
            }
            
            console.log(`✅ Componente salvo: ${componente.nome}`);
        }
    } catch (error) {
        console.error('❌ Erro ao salvar componentes de degrau injetado:', error);
        throw error;
    }
    
    console.log('✅ Todos os componentes de degrau injetado foram salvos com sucesso');
}

async function salvarGuardaCorpoHorizontalParametrizado() {
    console.log('=== SALVANDO GUARDA CORPO - HORIZONTAL PARAMETRIZADO ===');
    alert('Função de salvamento horizontal em desenvolvimento. Use o template vertical por enquanto.');
    return;
}

async function salvarGuardaCorpoVerticalParametrizado() {
    console.log('=== SALVANDO GUARDA CORPO - VERTICAL PARAMETRIZADO ===');
    if (!ultimoCalculo) {
        alert('Realize o cálculo antes de salvar!');
        return;
    }
    const csrftoken = getCookie('csrftoken');
    const produtoData = {
        descricao: ultimoCalculo.nome,
        categoria: ultimoCalculo.categoria,
        tipo_produto: 'composto',
        custo_centavos: Math.round(ultimoCalculo.custo_total),
        preco_venda_centavos: Math.round(ultimoCalculo.custo_total * 1.3),
        peso_und: 0,
        unidade: 'unid',
        observacao: JSON.stringify({
            tipo_calculo: 'guarda_corpo_vertical',
            parametros: ultimoCalculo.parametros,
            larg_modulo: ultimoCalculo.parametros.larg_modulo,
            altura: ultimoCalculo.parametros.altura,
            n_colunas: ultimoCalculo.parametros.n_colunas,
            tipo_tubo_quad: ultimoCalculo.parametros.tipo_tubo_quad,
            tipo_sapata: ultimoCalculo.parametros.tipo_sapata,
            vao_livre: ultimoCalculo.parametros.vao_livre,
            vao: ultimoCalculo.parametros.vao
        }),
        referencia: gerarReferenciaGuardaCorpo(ultimoCalculo.nome),
        data_revisao: new Date().toISOString(),
        ativo: true
    };
    console.log('Dados do produto guarda corpo vertical:', produtoData);
    console.log('ultimoCalculo completo:', ultimoCalculo);
    if (!produtoData.descricao || produtoData.descricao.trim() === '') {
        alert('Nome do guarda corpo é obrigatório');
        return;
    }
    if (!produtoData.custo_centavos || produtoData.custo_centavos <= 0) {
        alert('Custo do guarda corpo deve ser maior que zero');
        return;
    }
    fetch('/api/produtos/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(produtoData)
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                console.error('Erro na resposta do servidor:', text);
                throw new Error(`Erro HTTP ${response.status}: ${response.statusText}. Detalhes: ${text}`);
            });
        }
        return response.json();
    })
    .then(async produto => {
        console.log('✅ Guarda corpo vertical salvo:', produto);
        await salvarComponentesGuardaCorpoVertical(produto.id, csrftoken);
        alert('Guarda corpo vertical salvo com sucesso na base de dados!');
        document.getElementById('parametrosContainer').innerHTML = '<p class="text-muted">Selecione um template para começar...</p>';
        document.getElementById('resultadoCalculado').style.display = 'none';
        document.getElementById('salvarProdutoBtn').disabled = true;
        ultimoCalculo = null;
        fetchProdutos();
    })
    .catch(error => {
        console.error('❌ Erro ao salvar guarda corpo vertical:', error);
        alert('Erro ao salvar guarda corpo vertical: ' + (error.message || 'Erro desconhecido'));
    });
}

async function salvarComponentesGuardaCorpoVertical(produtoId, csrftoken) {
    console.log('=== SALVANDO COMPONENTES GUARDA CORPO - VERTICAL ===');
    if (!ultimoCalculo || !ultimoCalculo.parametros || !ultimoCalculo.componentes) {
        console.error('❌ Erro: ultimoCalculo não está disponível ou está incompleto');
        console.error('ultimoCalculo atual:', ultimoCalculo);
        alert('Erro: É necessário fazer um cálculo antes de salvar os componentes.');
        return;
    }
    
    let componentesSalvos = 0;
    
    try {
        // Buscar componentes existentes para este produto
        console.log('� Verificando componentes existentes para o produto:', produtoId);
        const existingResponse = await fetch(`/api/componentes/?produto_principal=${produtoId}`);
        if (existingResponse.ok) {
            const existingComponents = await existingResponse.json();
            console.log(`Encontrados ${existingComponents.length} componentes existentes`);
            
            // Deletar cada componente existente de forma sequencial
            for (const component of existingComponents) {
                try {
                    const deleteResponse = await fetch(`/api/componentes/${component.id}/`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': csrftoken
                        }
                    });
                    if (deleteResponse.ok) {
                        console.log(`✅ Componente deletado: ID ${component.id}`);
                    } else {
                        console.warn(`⚠️ Erro ao deletar componente ID ${component.id}`);
                    }
                } catch (delError) {
                    console.warn(`⚠️ Erro ao deletar componente ID ${component.id}:`, delError);
                }
            }
            
            // Aguardar um pouco para garantir que todas as deleções foram processadas
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        console.log(`🔍 Total de componentes a processar: ${ultimoCalculo.componentes.length}`);
        ultimoCalculo.componentes.forEach((comp, index) => {
            console.log(`${index + 1}. ${comp.nome} - Qtd: ${comp.quantidade}`);
        });
        
        for (const componente of ultimoCalculo.componentes) {
            console.log(`\n=== PROCESSANDO COMPONENTE: ${componente.nome} ===`);
            let produtoComponenteId = null;
            
            // Mesma lógica do horizontal, pode ser ajustada depois
            try {
                if (componente.nome.toLowerCase().includes('processamento') || 
                    componente.nome.toLowerCase().includes('montagem')) {
                    produtoComponenteId = 1374;
                    console.log('✅ Mapeado para mão de obra (ID: 1374)');
                } else if (componente.nome.toLowerCase().includes('tubo quadrado') && componente.nome.toLowerCase().includes('3mm')) {
                    // Tubo 3mm automático deve buscar especificamente o produto 3mm
                    console.log('🔍 Buscando tubo quadrado 3mm automático');
                    const produto = await buscarProdutoPorDescricao('Tubo Quadrado 50 #3mm');
                    produtoComponenteId = produto.id;
                    console.log(`✅ Tubo quadrado 3mm encontrado (ID: ${produtoComponenteId})`);
                } else if (componente.nome.toLowerCase().includes('tubo quadrado')) {
                    console.log('🔍 Buscando tubo quadrado:', ultimoCalculo.parametros.tipo_tubo_quad);
                    const produto = await buscarProdutoPorDescricao(ultimoCalculo.parametros.tipo_tubo_quad);
                    produtoComponenteId = produto.id;
                    console.log(`✅ Tubo quadrado encontrado (ID: ${produtoComponenteId})`);
                } else if (componente.nome.toLowerCase().includes('tubo redondo')) {
                    // Para tubo redondo, usar o tipo selecionado nos parâmetros
                    if (ultimoCalculo.parametros.tipo_tubo_redondo && ultimoCalculo.parametros.tipo_tubo_redondo !== '') {
                        console.log('🔍 Buscando tubo redondo:', ultimoCalculo.parametros.tipo_tubo_redondo);
                        const produto = await buscarProdutoPorDescricao(ultimoCalculo.parametros.tipo_tubo_redondo);
                        produtoComponenteId = produto.id;
                        console.log(`✅ Tubo redondo encontrado (ID: ${produtoComponenteId})`);
                    } else {
                        console.warn(`❓ Tubo redondo calculado mas não selecionado nos parâmetros: ${componente.nome}`);
                        continue;
                    }
                } else if (componente.nome.toLowerCase().includes('omega') || componente.nome.toLowerCase().includes('ômega')) {
                    console.log('🔍 Buscando omega:', ultimoCalculo.parametros.tipo_omega);
                    const produto = await buscarProdutoPorDescricao(ultimoCalculo.parametros.tipo_omega);
                    produtoComponenteId = produto.id;
                    console.log(`✅ Omega encontrado (ID: ${produtoComponenteId})`);
                } else if (componente.nome.toLowerCase().includes('sapata')) {
                    console.log('🔍 Buscando sapata:', ultimoCalculo.parametros.tipo_sapata);
                    const produto = await buscarProdutoPorDescricao(ultimoCalculo.parametros.tipo_sapata);
                    produtoComponenteId = produto.id;
                    console.log(`✅ Sapata encontrada (ID: ${produtoComponenteId})`);
                } else if (componente.nome.toLowerCase().includes('corrimão') || componente.nome.toLowerCase().includes('corrimao')) {
                    produtoComponenteId = 1322;
                    console.log('✅ Mapeado para corrimão (ID: 1322)');
                } else if (componente.nome.toLowerCase().includes('rodapé') || componente.nome.toLowerCase().includes('rodape')) {
                    produtoComponenteId = 1323;
                    console.log('✅ Mapeado para rodapé (ID: 1323)');
                } else if (componente.nome.toLowerCase().includes('paraf-sxt-m6x40')) {
                    console.log('🔍 Buscando parafuso M6x40');
                    const produto = await buscarProdutoPorDescricao('PARAF-SXT-M6X40-AI304');
                    produtoComponenteId = produto.id;
                    console.log(`✅ Parafuso M6x40 encontrado (ID: ${produtoComponenteId})`);
                } else if (componente.nome.toLowerCase().includes('paraf-sxt-m6x60')) {
                    console.log('🔍 Buscando parafuso M6x60');
                    const produto = await buscarProdutoPorDescricao('PARAF-SXT-M6X60-AI304');
                    produtoComponenteId = produto.id;
                    console.log(`✅ Parafuso M6x60 encontrado (ID: ${produtoComponenteId})`);
                } else if (componente.nome.toLowerCase().includes('paraf-sxt-m6x70')) {
                    console.log('🔍 Buscando parafuso M6x70');
                    const produto = await buscarProdutoPorDescricao('PARAF-SXT-M6X70-AI304');
                    produtoComponenteId = produto.id;
                    console.log(`✅ Parafuso M6x70 encontrado (ID: ${produtoComponenteId})`);
                } else if (componente.nome.toLowerCase().includes('por-sxt-m6')) {
                    console.log('🔍 Buscando porca M6');
                    const produto = await buscarProdutoPorDescricao('POR-SXT-M6-AI304');
                    produtoComponenteId = produto.id;
                    console.log(`✅ Porca M6 encontrada (ID: ${produtoComponenteId})`);
                } else if (
                    componente.nome.toLowerCase().includes('paraf-aa-pn-ph-4,8x19') ||
                    componente.nome.toLowerCase().includes('paraf aa pn ph 4,8x19') ||
                    componente.nome.toLowerCase().includes('paraf-aa-pn-ph')
                ) {
                    console.log('🔍 Buscando parafuso AA-PN-PH-4,8x19');
                    const produto = await buscarProdutoPorDescricao('PARAF-AA-PN-PH-4,8X19-AI304');
                    produtoComponenteId = produto.id;
                    console.log(`✅ Parafuso AA-PN-PH encontrado (ID: ${produtoComponenteId})`);
                }
            } catch (searchError) {
                console.warn(`❓ Erro ao buscar produto para: ${componente.nome}`, searchError);
                continue;
            }
            
            if (!produtoComponenteId) {
                console.warn(`❓ Produto componente não encontrado para: ${componente.nome}`);
                continue;
            }
            
            // Componente será criado (não há duplicação pois deletamos os existentes)
            
            const componenteData = {
                produto_principal: produtoId,
                produto_componente: produtoComponenteId,
                quantidade: Math.round(componente.quantidade * 1000) / 1000,
                observacao: JSON.stringify({
                    nome_componente: componente.nome,
                    custo_unitario: componente.custo_unitario,
                    custo_total: componente.custo_total,
                    tipo_calculo: 'guarda_corpo_vertical',
                    unidade: componente.unidade || 'unid'
                })
            };
            
            console.log(`💾 Processando componente: ${componente.nome} (ID: ${produtoComponenteId})`);
            console.log('Dados do componente:', componenteData);
            
            // Criar novo componente (os existentes já foram deletados no início)
            console.log(`➕ Criando novo componente: ${componente.nome}`);
            const response = await fetch('/api/componentes/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(componenteData)
            });
            
            // Verificar resultado final
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Erro detalhado:', errorText);
                console.warn(`⚠️ Erro ao processar componente ${componente.nome}: ${response.statusText}`);
                continue; // Pular este componente em vez de falhar todo o processo
            }
            
            console.log(`✅ Componente processado com sucesso: ${componente.nome}`);
            componentesSalvos++;
        }
    } catch (error) {
        console.error('❌ Erro ao salvar componentes de guarda corpo vertical:', error);
        throw error;
    }
    console.log(`✅ Salvamento concluído - Total de componentes salvos: ${componentesSalvos}/${ultimoCalculo.componentes.length}`);
}

async function salvarComponentesGuardaCorpoHorizontal(produtoId, csrftoken) {
    console.log('=== SALVANDO COMPONENTES GUARDA CORPO - HORIZONTAL ===');
    alert('Função de salvamento de componentes horizontal em desenvolvimento.');
    return;
}

function gerarReferenciaGuardaCorpo(nomeGuardaCorpo) {
    // Gerar referência baseada no nome do guarda corpo
    const palavras = nomeGuardaCorpo.split(' ').filter(p => p.length > 0);
    let referencia = 'GC-HORIZ-' + palavras.slice(0, 2).join('').substring(0, 8).toUpperCase();
    
    // Adicionar timestamp para garantir unicidade
    const timestamp = Date.now().toString().slice(-4);
    referencia += '-' + timestamp;
    
    return referencia;
}

async function salvarComponentesTampaInjetada(produtoId, csrftoken) {
    console.log('=== SALVANDO COMPONENTES TAMPA INJETADA ===');
    
    try {
        for (const componente of ultimoCalculo.componentes) {
            // Encontrar o ID do produto componente baseado no nome
            let produtoComponenteId = null;
            
            // PRIMEIRO: Verificar mão de obra (deve vir antes de U4 e outras verificações)
            if (componente.nome.toLowerCase().includes('processamento') || 
                componente.nome.toLowerCase().includes('montagem') ||
                componente.nome.toLowerCase().includes('mão de obra')) {
                // Detectada mão de obra
                console.log('🔧 DETECTADA MÃO DE OBRA TAMPA INJETADA:', componente.nome);
                
                // Usar o ID do produto de mão de obra do ultimoCalculo ou ID fixo conhecido
                const maoObraProduto = ultimoCalculo.mao_obra_produto_id || 1374;
                produtoComponenteId = maoObraProduto;
                console.log('✅ Usando ID da mão de obra:', produtoComponenteId);
            
            } else if (componente.nome.toLowerCase().includes('grade') && componente.nome.toLowerCase().includes('injetada')) {
                // Buscar grade injetada dinamicamente
                const produto = await buscarProdutoPorDescricao('grade injetada');
                produtoComponenteId = produto.id;
            } else if (componente.nome.includes('COLA ESTRUTURAL')) {
                produtoComponenteId = 1183; // ID fixo da cola estrutural 4500 A/B
            } else if (componente.nome.toLowerCase().includes('chapa') && componente.nome.toLowerCase().includes('2,5')) {
                // Buscar chapa lisa 2,5mm dinamicamente
                const produto = await buscarProdutoPorDescricao('chapa lisa');
                produtoComponenteId = produto.id;
            } else if (componente.nome.toLowerCase().includes('chapa') && componente.nome.toLowerCase().includes('ev')) {
                // Para Chapa EV com valor fixo, criar produto se não existir
                produtoComponenteId = await buscarOuCriarChapaEV(csrftoken);
            } else if (componente.nome.toLowerCase().includes('u4')) {
                // Buscar perfil U4" dinamicamente
                const produto = await buscarProdutoPorDescricao('u4');
                produtoComponenteId = produto.id;
            } else if (componente.nome.toLowerCase().includes('alça')) {
                // Buscar alça dinamicamente
                const produto = await buscarProdutoPorDescricao('alça');
                produtoComponenteId = produto.id;
            }
            
            if (!produtoComponenteId) {
                console.error(`❌ Não foi possível mapear o componente: ${componente.nome}`);
                throw new Error(`Componente não mapeado: ${componente.nome}`);
            }
            
            // Salvar custos calculados na observação como JSON
            const custosCalculados = {
                custo_unitario: Math.round(componente.custo_unitario),
                custo_total: Math.round(componente.custo_total),
                nome_componente: componente.nome,
                calculated_at: new Date().toISOString()
            };
            
            const componenteData = {
                produto_principal: produtoId,
                produto_componente: produtoComponenteId,
                quantidade: Math.round(parseFloat(componente.quantidade.toFixed(3)) * 1000) / 1000,
                observacao: JSON.stringify(custosCalculados)
            };
            
            console.log(`Salvando componente tampa injetada: ${componente.nome}`);
            
            const response = await fetch('/api/componentes/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(componenteData)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Erro ao salvar componente ${componente.nome}: ${response.status} - ${errorText}`);
            }
            
            const componenteSalvo = await response.json();
            console.log(`✅ Componente tampa injetada salvo:`, componenteSalvo);
        }
        
        console.log('✅ Todos os componentes da tampa injetada foram salvos');
        
    } catch (error) {
        console.error('❌ Erro ao salvar componentes da tampa injetada:', error);
        throw error;
    }
}

async function buscarOuCriarChapaEV(csrftoken) {
    try {
        // Primeiro, tentar buscar chapa EV existente
        const response = await fetch('/api/produtos/');
        const produtos = await response.json();
        
        const chapaEV = produtos.find(p => p.id === 1384);
        
        if (chapaEV) {
            console.log(`✅ Chapa EV encontrada: ID ${chapaEV.id} - ${chapaEV.descricao}`);
            return chapaEV.id;
        }
        
        // Se não encontrar, criar produto para Chapa EV
        console.log('🔧 Criando produto para Chapa EV...');
        const chapaEVData = {
            descricao: 'Chapa EV - Res. Poliéster',
            custo_centavos: 27750, // R$ 277,50 fixo
            peso_und: '2.500',
            unidade: 'm²',
            referencia: 'CHAPA-EV',
            tipo_produto: 'simples',
            categoria: 'Chapa',
            subcategoria: 'EV'
        };
        
        const createResponse = await fetch('/api/produtos/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(chapaEVData)
        });
        
        if (createResponse.ok) {
            const novaChapaEV = await createResponse.json();
            console.log(`✅ Chapa EV criada: ID ${novaChapaEV.id}`);
            return novaChapaEV.id;
        } else {
            throw new Error('Erro ao criar produto Chapa EV');
        }
        
    } catch (error) {
        console.error('❌ Erro ao buscar/criar Chapa EV:', error);
        throw error;
    }
}

async function salvarComponentesParametrizados(produtoId, csrftoken) {
    console.log('=== SALVANDO COMPONENTES PARAMETRIZADOS ===');
    console.log('Produto ID:', produtoId, 'Tipo:', typeof produtoId);
    
    // Validar produto ID
    if (!produtoId || produtoId === 'undefined' || produtoId === 'null') {
        console.error('❌ Produto ID inválido:', produtoId);
        throw new Error('Produto ID inválido');
    }
    
    // Obter dados do último cálculo
    if (!ultimoCalculo || !ultimoCalculo.componentes) {
        throw new Error('Dados do cálculo não encontrados');
    }
    
    const componentes = ultimoCalculo.componentes;
    console.log('Componentes a salvar:', componentes.length);
    
    // Mapeamento dos componentes para IDs na tabela MP_Produtos
    const componentesMapeamento = {
        'Roving 4400': 1237,
        'Manta 300': 1238,
        'Véu': 1239,
        'Resina Poliéster': 1269,
        'Resina Isoftálica': 1268,
        'Resina Éster Vinílica': 1270,
        'Monômero de estireno': 1266,
        'Anti UV': 1243,
        'Anti OX': 1244,
        'BPO': 1245,
        'TBPB': 1246,
        'Desmoldante': 1247,
        'Antichama': 1248,
        'Carga mineral': 1249,
        'Pigmento': 1250,
        // Mapeamento especial para mão de obra
        'Mão de Obra - Pultrusão': null  // Será definido dinamicamente
    };
    
    let componentesSalvos = 0;
    let produtoFinal = null;
    
        // Primeiro, limpar componentes existentes deste produto para evitar conflitos
        console.log('🧹 Limpando componentes existentes do produto...');
        try {
            const componentesExistentesResponse = await fetch(`/api/componentes/?produto_principal=${produtoId}`);
            if (componentesExistentesResponse.ok) {
                const componentesExistentes = await componentesExistentesResponse.json();
                
                console.log(`   Encontrados ${componentesExistentes.length} componentes existentes`);
                
                for (const comp of componentesExistentes) {
                    const deleteResponse = await fetch(`/api/componentes/${comp.id}/`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': csrftoken
                        }
                    });
                    
                    if (deleteResponse.ok) {
                        console.log(`   ✅ Removido componente ID ${comp.id}`);
                    } else {
                        console.warn(`   ⚠️ Erro ao remover componente ID ${comp.id}: ${deleteResponse.status}`);
                    }
                }
                
                console.log('✅ Limpeza de componentes existentes concluída');
            } else {
                console.warn('⚠️ Erro ao buscar componentes existentes:', componentesExistentesResponse.status);
            }
        } catch (error) {
            console.warn('⚠️ Erro ao limpar componentes existentes:', error);
        }    // Primeiro, buscar todos os produtos para fazer mapeamento dinâmico
    const produtosResponse = await fetch('/api/produtos/');
    const todosProdutos = await produtosResponse.json();
    
    // Verificar se existe produto para mão de obra, senão criar
    let maoObraProductId = null;
    const maoObraProduto = todosProdutos.find(p => 
        p.descricao && p.descricao.toLowerCase().includes('mão de obra') && 
        p.descricao.toLowerCase().includes('pultrusão')
    );
    
    if (maoObraProduto) {
        maoObraProductId = maoObraProduto.id;
        console.log(`✅ Produto mão de obra encontrado: ID ${maoObraProductId} - ${maoObraProduto.descricao}`);
    } else {
        // Criar produto para mão de obra se não existir
        console.log('🔧 Criando produto para mão de obra...');
        try {
            const maoObraData = {
                descricao: 'Mão de Obra - Pultrusão',
                custo_centavos: 1, // Custo simbólico, o valor real vem do cálculo
                peso_und: '0.000',
                unidade: 'H',
                referencia: 'MAO-OBRA-PULT',
                tipo_produto: 'simples',
                categoria: 'Mão de Obra',
                subcategoria: 'Pultrusão'
            };
            
            const createResponse = await fetch('/api/produtos/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(maoObraData)
            });
            
            if (createResponse.ok) {
                const novoProdutoMaoObra = await createResponse.json();
                maoObraProductId = novoProdutoMaoObra.id;
                console.log(`✅ Produto mão de obra criado: ID ${maoObraProductId}`);
                
                // Atualizar lista de produtos
                todosProdutos.push(novoProdutoMaoObra);
            } else {
                console.error('❌ Erro ao criar produto de mão de obra');
            }
        } catch (error) {
            console.error('❌ Erro ao criar produto de mão de obra:', error);
        }
    }
    
    // Atualizar mapeamento com ID da mão de obra
    if (maoObraProductId) {
        componentesMapeamento['Mão de Obra - Pultrusão'] = maoObraProductId;
    }
    
    // Criar mapeamento por nome de produto
    const produtosPorNome = {};
    
    // Primeiro, mapear por nome exato
    todosProdutos.forEach(produto => {
        produtosPorNome[produto.descricao] = produto.id;
    });
    
    // Depois, criar mapeamentos específicos por palavras-chave (sem sobrescrever)
    todosProdutos.forEach(produto => {
        const desc = produto.descricao.toLowerCase();
        
        // Mapeamento específico - apenas se ainda não foi mapeado
        if (desc.includes('roving') && !produtosPorNome['Roving 4400']) {
            produtosPorNome['Roving 4400'] = produto.id;
        }
        if (desc.includes('manta') && desc.includes('300') && !produtosPorNome['Manta 300']) {
            produtosPorNome['Manta 300'] = produto.id;
        }
        if ((desc.includes('véu') || desc.includes('veu')) && !produtosPorNome['Véu']) {
            produtosPorNome['Véu'] = produto.id;
        }
        if (desc.includes('resina') && desc.includes('poliéster') && !produtosPorNome['Resina Poliéster']) {
            produtosPorNome['Resina Poliéster'] = produto.id;
        }
        if (desc.includes('resina') && desc.includes('isoftálica') && !produtosPorNome['Resina Isoftálica']) {
            produtosPorNome['Resina Isoftálica'] = produto.id;
        }
        if (desc.includes('resina') && desc.includes('éster') && !produtosPorNome['Resina Éster Vinílica']) {
            produtosPorNome['Resina Éster Vinílica'] = produto.id;
        }
        if ((desc.includes('monômero') || desc.includes('estireno')) && !produtosPorNome['Monômero de estireno']) {
            produtosPorNome['Monômero de estireno'] = produto.id;
        }
        if (desc.includes('anti') && desc.includes('uv') && !produtosPorNome['Anti UV']) {
            produtosPorNome['Anti UV'] = produto.id;
        }
        if (desc.includes('anti') && desc.includes('ox') && !produtosPorNome['Anti OX']) {
            produtosPorNome['Anti OX'] = produto.id;
        }
        if (desc.includes('bpo') && !produtosPorNome['BPO']) {
            produtosPorNome['BPO'] = produto.id;
        }
        if (desc.includes('tbpb') && !produtosPorNome['TBPB']) {
            produtosPorNome['TBPB'] = produto.id;
        }
        if (desc.includes('desmoldante') && !produtosPorNome['Desmoldante']) {
            produtosPorNome['Desmoldante'] = produto.id;
        }
        if (desc.includes('antichama') && !produtosPorNome['Antichama']) {
            produtosPorNome['Antichama'] = produto.id;
        }
        if (desc.includes('carga') && desc.includes('mineral') && !produtosPorNome['Carga mineral']) {
            produtosPorNome['Carga mineral'] = produto.id;
        }
        if (desc.includes('pigmento') && !produtosPorNome['Pigmento']) {
            produtosPorNome['Pigmento'] = produto.id;
        }
    });
    
    console.log('Mapeamento de produtos por nome:', produtosPorNome);
    console.log('Total de produtos encontrados:', todosProdutos.length);
    console.log('Componentes a mapear:', componentes.map(c => c.nome));
    
    // Verificar mapeamentos específicos
    console.log('=== VERIFICAÇÃO DE MAPEAMENTOS ===');
    componentes.forEach(comp => {
        const id = produtosPorNome[comp.nome];
        console.log(`${comp.nome} -> ID: ${id}`);
    });
    
    // Salvar cada componente individualmente
    for (const componente of componentes) {
        try {
            let produtoComponenteId = null;
            
            // Verificar se é componente de mão de obra
            if (componente.nome === 'Mão de Obra - Pultrusão') {
                produtoComponenteId = componentesMapeamento['Mão de Obra - Pultrusão'];
                console.log(`🔧 Processando mão de obra: ID ${produtoComponenteId}`);
                
                // CORREÇÃO: Atualizar o custo do produto de mão de obra com o valor calculado
                if (produtoComponenteId && componente.custo_total > 0) {
                    console.log(`🔄 Atualizando custo do produto mão de obra...`);
                    const updateData = {
                        custo_centavos: componente.custo_total
                    };
                    
                    try {
                        const updateResponse = await fetch(`/api/produtos/${produtoComponenteId}/`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrftoken
                            },
                            body: JSON.stringify(updateData)
                        });
                        
                        if (updateResponse.ok) {
                            console.log(`✅ Custo do produto mão de obra atualizado para ${componente.custo_total} centavos`);
                        } else {
                            console.warn(`⚠️ Erro ao atualizar custo do produto mão de obra`);
                        }
                    } catch (error) {
                        console.warn(`⚠️ Erro ao atualizar produto mão de obra:`, error);
                    }
                }
            } else {
                // Encontrar ID do produto componente usando mapeamento dinâmico
                produtoComponenteId = produtosPorNome[componente.nome];
                console.log(`🔍 Buscando componente: "${componente.nome}"`);
                console.log(`   - Mapeamento dinâmico: ${produtoComponenteId}`);
                
                // Se não encontrar, tentar mapeamento fixo
                if (!produtoComponenteId) {
                    produtoComponenteId = componentesMapeamento[componente.nome];
                    console.log(`   - Mapeamento fixo: ${produtoComponenteId}`);
                }
            }
            
            // Se ainda não encontrar, tentar busca aproximada ou pular
            if (!produtoComponenteId) {
                console.warn(`❌ Componente não encontrado: ${componente.nome}`);
                console.log('Produtos disponíveis:', Object.keys(produtosPorNome));
                
                // Para mão de obra, não pular - mostrar erro específico
                if (componente.nome === 'Mão de Obra - Pultrusão') {
                    console.error('❌ ERRO CRÍTICO: Não foi possível mapear mão de obra!');
                }
                continue;
            }
            
            console.log(`✅ Componente "${componente.nome}" mapeado para ID: ${produtoComponenteId}`);
            
            const componenteData = {
                produto_principal: produtoId,
                produto_componente: produtoComponenteId,
                quantidade: Math.round(parseFloat(componente.quantidade) * 1000) / 1000, // Arredondar para 3 casas decimais
                observacao: componente.nome === 'Mão de Obra - Pultrusão' 
                    ? `Mão de obra parametrizada: ${componente.produto}` 
                    : `Componente parametrizado calculado automaticamente`
            };
            
            console.log(`💾 Salvando componente: ${componente.nome} (ID: ${produtoComponenteId}) - Quantidade: ${componenteData.quantidade}`);
            
            const response = await fetch('/api/componentes/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(componenteData)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`❌ Erro ao salvar componente ${componente.nome}:`, response.status);
                console.error(`   Detalhes do erro:`, errorText);
                
                // Tentar parsear como JSON para ver erro estruturado
                try {
                    const errorJson = JSON.parse(errorText);
                    console.error(`   Erro estruturado:`, errorJson);
                } catch (e) {
                    console.error(`   Erro como texto:`, errorText);
                }
                continue;
            }
            
            const componenteSalvo = await response.json();
            console.log(`✅ Componente salvo: ${componente.nome} ${componente.nome === 'Mão de Obra - Pultrusão' ? '(MÃO DE OBRA)' : ''}`);
            componentesSalvos++;
            
        } catch (error) {
            console.error(`❌ Erro ao processar componente ${componente.nome}:`, error);
        }
    }
    
    console.log(`=== SALVAMENTO CONCLUÍDO ===`);
    console.log(`Componentes salvos: ${componentesSalvos}/${componentes.length}`);
    
    // Buscar o produto atualizado para retornar
    const produtoResponse = await fetch(`/api/produtos/${produtoId}/`);
    produtoFinal = await produtoResponse.json();
    produtoFinal.num_componentes = componentesSalvos;
    
    return produtoFinal;
}

// Função para recalcular um componente específico baseado no novo fator
function recalcularComponente(componenteIndex) {
    if (!ultimoCalculo || !ultimoCalculo.componentes[componenteIndex]) {
        alert('Erro: Componente não encontrado!');
        return;
    }
    
    const fatorInput = document.querySelector(`input[data-component-index="${componenteIndex}"]`);
    const novoFator = parseFloat(fatorInput.value);
    
    if (isNaN(novoFator) || novoFator < 0 || novoFator > 100) {
        alert('Fator deve ser um número entre 0 e 100!');
        return;
    }
    
    const componente = ultimoCalculo.componentes[componenteIndex];
    const pesoResinaBase = ultimoCalculo.peso_resina_base;
    
    // Recalcular quantidade baseada no novo fator
    const novaQuantidade = pesoResinaBase * (novoFator / 100);
    const novoCustoTotal = novaQuantidade * componente.custo_unitario;
    
    // Atualizar o componente
    componente.quantidade = novaQuantidade;
    componente.custo_total = novoCustoTotal;
    
    // Atualizar a exibição na tabela
    const row = document.querySelector(`input[data-component-index="${componenteIndex}"]`).closest('tr');
    row.querySelector('.quantidade-display').textContent = novaQuantidade.toFixed(4);
    row.querySelector('.custo-total-display').textContent = `R$ ${novoCustoTotal.toFixed(2)}`;
    
    // Recalcular total geral
    atualizarTotalGeral();
    
    console.log(`Componente ${componente.nome} recalculado: Fator: ${novoFator}%, Qtd: ${novaQuantidade.toFixed(4)}, Custo: R$ ${novoCustoTotal.toFixed(2)}`);
}

// Função para recalcular todos os componentes
function recalcularTodosComponentes() {
    if (!ultimoCalculo || !ultimoCalculo.componentes) {
        alert('Erro: Nenhum cálculo encontrado!');
        return;
    }
    
    console.log('=== RECALCULANDO TODOS OS COMPONENTES ===');
    
    const fatoresInputs = document.querySelectorAll('.fator-input');
    
    fatoresInputs.forEach(input => {
        const componenteIndex = parseInt(input.getAttribute('data-component-index'));
        const novoFator = parseFloat(input.value);
        
        if (!isNaN(novoFator) && novoFator >= 0 && novoFator <= 100) {
            const componente = ultimoCalculo.componentes[componenteIndex];
            const pesoResinaBase = ultimoCalculo.peso_resina_base;
            
            // Recalcular
            const novaQuantidade = pesoResinaBase * (novoFator / 100);
            const novoCustoTotal = novaQuantidade * componente.custo_unitario;
            
            // Atualizar componente
            componente.quantidade = novaQuantidade;
            componente.custo_total = novoCustoTotal;
            
            // Atualizar exibição
            const row = input.closest('tr');
            row.querySelector('.quantidade-display').textContent = novaQuantidade.toFixed(4);
            row.querySelector('.custo-total-display').textContent = `R$ ${novoCustoTotal.toFixed(2)}`;
            
            console.log(`Recalculado ${componente.nome}: ${novoFator}% = ${novaQuantidade.toFixed(4)} kg = R$ ${novoCustoTotal.toFixed(2)}`);
        }
    });
    
    // Atualizar total geral
    atualizarTotalGeral();
    
    alert('Todos os componentes foram recalculados com sucesso!');
}

// Função para atualizar o total geral
function atualizarTotalGeral() {
    if (!ultimoCalculo || !ultimoCalculo.componentes) return;
    
    const custoTotalGeral = ultimoCalculo.componentes.reduce((total, comp) => total + comp.custo_total, 0);
    
    // Atualizar exibição na tabela
    const totalElement = document.getElementById('custo-total-geral');
    if (totalElement) {
        totalElement.textContent = `R$ ${custoTotalGeral.toFixed(2)}`;
    }
    
    // Atualizar no resumo também
    ultimoCalculo.custo_total = Math.round(custoTotalGeral * 100);
    document.getElementById('custoTotalCalculado').textContent = `R$ ${custoTotalGeral.toFixed(2)}`;
    
    console.log(`Total geral atualizado: R$ ${custoTotalGeral.toFixed(2)}`);
}

// Função auxiliar para buscar produto por descrição
async function buscarProdutoPorDescricao(termo) {
    try {
        const response = await fetch('/api/produtos/');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const produtos = await response.json();
        
        const produto = produtos.find(p => 
            p.descricao && 
            p.descricao.toLowerCase().includes(termo.toLowerCase())
        );
        
        if (!produto) {
            throw new Error(`Produto com termo "${termo}" não encontrado`);
        }
        
        console.log(`✅ Produto encontrado para "${termo}": ID ${produto.id} - ${produto.descricao}`);
        return produto; // Retornar o produto completo em vez de apenas o ID
    } catch (error) {
        console.error(`❌ Erro ao buscar produto "${termo}":`, error);
        throw error;
    }
}

async function buscarProdutoPorId(id) {
    try {
        const response = await fetch('/api/produtos/');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const produtos = await response.json();
        
        const produto = produtos.find(p => p.id === id);
        
        if (!produto) {
            throw new Error(`Produto com ID "${id}" não encontrado`);
        }
        
        console.log(`✅ Produto encontrado por ID "${id}": ${produto.descricao}`);
        return produto;
    } catch (error) {
        console.error(`❌ Erro ao buscar produto por ID "${id}":`, error);
        throw error;
    }
}

window.onload = function() {
    fetchProdutos();
};
</script>
</body>
</html>
