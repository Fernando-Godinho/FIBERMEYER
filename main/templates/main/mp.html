<style>
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            color: #fff;
        }
        .nav-pills .nav-link:hover {
            background-color: #e2e6ea;
            color: #0d6efd;
        }
        
        /* Estilos para tabela de componentes edit√°veis */
        .fator-input {
            width: 80px !important;
            text-align: center;
            font-size: 0.875rem;
        }
        
        .fator-input:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        
        .quantidade-display, .custo-total-display {
            font-weight: 500;
        }
        
        #componentesCalculadosTable th {
            background-color: #f8f9fa;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        #componentesCalculadosTable td {
            vertical-align: middle;
            font-size: 0.875rem;
        }
        
        .btn-sm i {
            font-size: 0.75rem;
        }
        
        /* Destaque para linha de total */
        #componentesCalculadosTable tr:last-child {
            background-color: #e3f2fd;
            font-weight: bold;
        }
        
        /* Estilos para busca de componentes */
        #listaProdutosComponente {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            background-color: #fff;
        }
        
        #listaProdutosComponente .dropdown-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f1f3f5;
            transition: background-color 0.15s ease-in-out;
        }
        
        #listaProdutosComponente .dropdown-item:last-child {
            border-bottom: none;
        }
        
        #listaProdutosComponente .dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        #listaProdutosComponente .dropdown-item:active {
            background-color: #e9ecef;
        }
        
        #searchComponenteProduto:focus + input + #listaProdutosComponente {
            display: block !important;
        }
        
        .produto-selecionado-feedback {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
</style>
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Produtos / MP - FIBERMEYER</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
<div class="d-flex">
  <nav class="flex-shrink-0 p-3 bg-light border-end" style="width: 220px; min-height: 100vh;">
          <h4 class="mb-4">FIBERMEYER</h4>
          <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
              <a class="nav-link d-flex align-items-center" data-bs-toggle="collapse" href="#parametrosSubmenu" role="button" aria-expanded="false" aria-controls="parametrosSubmenu">
                <span>Par√¢metros</span>
                <span class="ms-auto caret-indicator" style="transition: transform 0.2s;"></span>
              </a>
              <div class="collapse ms-3" id="parametrosSubmenu">
                <ul class="nav flex-column">
                  <li class="nav-item"><a class="nav-link active" href="/mp/">Produtos / MP</a></li>
                  <li class="nav-item"><a class="nav-link" href="/produtos-compostos/">Produtos Compostos</a></li>
                  <li class="nav-item"><a class="nav-link" href="/impostos/">Impostos</a></li>
                  <li class="nav-item"><a class="nav-link" href="/mao_de_obra/">M√£o de Obra</a></li>
                </ul>
              </div>
            </li>
            <li><a href="/" class="nav-link">Dashboard</a></li>
            <li><a href="/orcamento/" class="nav-link">Or√ßamentos</a></li>
            <li><a href="/about/" class="nav-link">Sobre</a></li>
            <li><a href="/admin/" class="nav-link">Administra√ß√£o</a></li>
          </ul>
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              var parametrosLink = document.querySelector('[href="#parametrosSubmenu"]');
              var parametrosSubmenu = document.getElementById('parametrosSubmenu');
              var caret = parametrosLink.querySelector('.caret-indicator');
              parametrosSubmenu.addEventListener('show.bs.collapse', function () {
                caret.style.transform = 'rotate(180deg)';
              });
              parametrosSubmenu.addEventListener('hide.bs.collapse', function () {
                caret.style.transform = 'rotate(0deg)';
              });
            });
          </script>
  </nav>
  <div class="container-fluid p-4">
    <h1>Produtos / MP</h1>
    <div class="mb-3">
      <button class="btn btn-primary me-2" onclick="openFormProduto()">
        <i class="fas fa-plus"></i> Adicionar Produto Simples
      </button>
      <button class="btn btn-success me-2" onclick="openFormProdutoComposto()">
        <i class="fas fa-layer-group"></i> Criar Produto Composto
      </button>
      <button class="btn btn-warning me-2" onclick="openFormProdutoParametrizado()">
        <i class="fas fa-calculator"></i> Produto Parametrizado
      </button>
      <button class="btn btn-info" onclick="openCreateFromExisting()">
        <i class="fas fa-clone"></i> Criar Baseado em Produto Existente
      </button>
    </div>
    
    <!-- Filtros -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="row">
          <div class="col-md-4">
            <label for="filtroDescricao" class="form-label">Filtrar por Descri√ß√£o:</label>
            <input type="text" class="form-control" id="filtroDescricao" placeholder="Digite para filtrar..." onkeyup="aplicarFiltros()">
          </div>
          <div class="col-md-3">
            <label for="filtroTipo" class="form-label">Tipo:</label>
            <select class="form-select" id="filtroTipo" onchange="aplicarFiltros()">
              <option value="">Todos</option>
              <option value="Simples">Simples</option>
              <option value="Composto">Composto</option>
              <option value="Parametrizado">Parametrizado</option>
              <option value="Resina">Apenas Resinas</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="filtroReferencia" class="form-label">Refer√™ncia:</label>
            <select class="form-select" id="filtroReferencia" onchange="aplicarFiltros()">
              <option value="">Todas</option>
              <option value="Votorantim">Votorantim</option>
              <option value="Gerdau">Gerdau</option>
              <option value="ArcelorMittal">ArcelorMittal</option>
              <option value="CSN">CSN</option>
              <option value="Usiminas">Usiminas</option>
              <option value="Belgo">Belgo</option>
              <option value="Aperam">Aperam</option>
              <option value="Nippon">Nippon</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <button type="button" class="btn btn-outline-secondary d-block w-100" onclick="limparFiltros()">
              <i class="fas fa-times"></i> Limpar
            </button>
          </div>
        </div>
      </div>
    </div>
    <table class="table table-bordered" id="produtos-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Descri√ß√£o</th>
                <th>Tipo</th>
                <th>Custo</th>
                <th>Peso (Kg)</th>
                <th>Unidade</th>
                <th>Refer√™ncia</th>
                <th>Data Revis√£o</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
  </div>
</div>

<!-- Modal Produto -->
<div class="modal" tabindex="-1" id="produtoModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitleProduto">Adicionar Produto</h5>
        <button type="button" class="btn-close" onclick="closeFormProduto()"></button>
      </div>
      <div class="modal-body">
        <form id="produtoForm">
          <input type="hidden" id="produtoId">
          <input type="hidden" id="isDuplicate">
          
          <!-- Alert para duplica√ß√£o -->
          <div id="duplicateAlert" class="alert alert-info d-none" role="alert">
            <i class="fas fa-info-circle"></i> Voc√™ est√° criando uma c√≥pia de um produto existente. Modifique os dados conforme necess√°rio.
          </div>
          
          <div class="mb-3">
            <label for="descricao" class="form-label">Descri√ß√£o</label>
            <input type="text" class="form-control" id="descricao" required>
          </div>
          <div class="mb-3">
            <label for="custo_centavos" class="form-label">Custo (R$)</label>
            <input type="text" class="form-control" id="custo_centavos" required pattern="^\d+(,\d{2})?$" placeholder="Ex: 12,34">
          </div>
          <div class="mb-3">
            <label for="peso_und" class="form-label">Peso UND</label>
            <input type="number" step="0.000001" class="form-control" id="peso_und" required>
          </div>
          <div class="mb-3">
            <label for="unidade" class="form-label">Unidade</label>
            <select class="form-select" id="unidade" required>
              <option value="">Selecione</option>
              <option value="UN">UN</option>
              <option value="M">M</option>
              <option value="M¬≤">M¬≤</option>
              <option value="CM">CM</option>
              <option value="KG">KG</option>
              <option value="L">L</option>
              <option value="P√á">P√á</option>
              <option value="CX">CX</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="referencia" class="form-label">Refer√™ncia</label>
            <select class="form-select" id="referencia">
              <option value="">Selecione</option>
              <option value="Votorantim">Votorantim</option>
              <option value="Gerdau">Gerdau</option>
              <option value="ArcelorMittal">ArcelorMittal</option>
              <option value="CSN">CSN</option>
              <option value="Usiminas">Usiminas</option>
              <option value="Belgo">Belgo</option>
              <option value="Aperam">Aperam</option>
              <option value="Nippon">Nippon</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeFormProduto()">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="submitFormProduto()">Salvar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Sele√ß√£o de Produto Base -->
<div class="modal" tabindex="-1" id="selectProductModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Selecionar Produto Base</h5>
        <button type="button" class="btn-close" onclick="closeSelectProductModal()"></button>
      </div>
      <div class="modal-body">
        <p class="mb-3">Selecione um produto existente para usar como base para o novo produto:</p>
        
        <!-- Campo de busca -->
        <div class="mb-3">
          <input type="text" class="form-control" id="searchProduct" placeholder="Digite para filtrar produtos..." onkeyup="filterProducts()">
        </div>
        
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
          <table class="table table-hover">
            <thead class="table-light sticky-top">
              <tr>
                <th>ID</th>
                <th>Descri√ß√£o</th>
                <th>Custo</th>
                <th>Unidade</th>
                <th>Refer√™ncia</th>
                <th>A√ß√£o</th>
              </tr>
            </thead>
            <tbody id="selectProductTableBody">
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeSelectProductModal()">Cancelar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Produto Parametrizado -->
<div class="modal fade" id="produtoParametrizadoModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Criar Produto Parametrizado</h5>
        <button type="button" class="btn-close" onclick="closeProdutoParametrizadoModal()"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- Sele√ß√£o de Template -->
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">1. Selecione o Tipo</h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <select class="form-select" id="templateSelect" onchange="carregarTemplate()">
                    <option value="">Escolha um template...</option>
                  </select>
                </div>
                <div id="templateDescription" class="text-muted small"></div>
              </div>
            </div>
          </div>
          
          <!-- Par√¢metros -->
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">2. Par√¢metros</h6>
              </div>
              <div class="card-body" id="parametrosContainer">
                <p class="text-muted">Selecione um template primeiro</p>
              </div>
            </div>
          </div>
          
          <!-- Resultado -->
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">3. Resultado</h6>
              </div>
              <div class="card-body" id="resultadoContainer">
                <p class="text-muted">Configure os par√¢metros para ver o resultado</p>
                <div id="resultadoCalculado" style="display: none;">
                  <div class="mb-3">
                    <strong>Produto Base:</strong> <span id="nomeProdutoCalculado"></span>
                  </div>
                  <div class="mb-2">
                    <strong>Custo Total:</strong> <span id="custoTotalCalculado" class="text-success"></span>
                  </div>
                  <div class="mb-2">
                    <strong>Peso Total:</strong> <span id="pesoTotalCalculado"></span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Componentes calculados -->
        <div class="row mt-3">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">Componentes Calculados</h6>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Material/Servi√ßo</th>
                        <th>Descri√ß√£o do Produto</th>
                        <th>Fator %</th>
                        <th>Quantidade</th>
                        <th>Custo Unit√°rio</th>
                        <th>Custo Total</th>
                        <th>A√ß√£o</th>
                      </tr>
                    </thead>
                    <tbody id="componentesCalculadosTable">
                      <tr>
                        <td colspan="7" class="text-center text-muted">Nenhum c√°lculo realizado</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeProdutoParametrizadoModal()">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="salvarProdutoParametrizado()" disabled id="salvarProdutoBtn">
          <i class="fas fa-save"></i> Salvar na Base
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Produto Composto -->
<div class="modal fade" id="produtoCompostoModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitleProdutoComposto">Criar Produto Composto</h5>
        <button type="button" class="btn-close" onclick="closeProdutoCompostoModal()"></button>
      </div>
      <div class="modal-body">
        <form id="produtoCompostoForm">
          <input type="hidden" id="produtoCompostoId">
          
          <!-- Informa√ß√µes b√°sicas do produto -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="descricaoComposto" class="form-label">Descri√ß√£o do Produto Composto *</label>
              <input type="text" class="form-control" id="descricaoComposto" required 
                     placeholder="Ex: Kit de Montagem de Estrutura Completa">
            </div>
            <div class="col-md-3">
              <label for="referenciaComposto" class="form-label">Refer√™ncia</label>
              <input type="text" class="form-control" id="referenciaComposto" placeholder="Refer√™ncia personalizada">
            </div>
            <div class="col-md-3">
              <label for="percentualPerdaComposto" class="form-label">% Perda</label>
              <div class="input-group">
                <input type="number" step="0.01" class="form-control" id="percentualPerdaComposto" 
                       min="0" max="100" value="0" placeholder="0.00" 
                       onchange="validarPercentualPerda(); calcularCustoTotalComposto();"
                       oninput="validarPercentualPerda();">
                <span class="input-group-text">%</span>
              </div>
              <div class="form-text">Percentual de perda aplicado ao custo total</div>
              <div class="invalid-feedback" id="feedbackPercentualPerda" style="display: none;"></div>
            </div>
          </div>
          
          <!-- Se√ß√£o de componentes -->
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">Componentes do Produto</h6>
            </div>
            <div class="card-body">
              <!-- Adicionar componente -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="componenteProduto" class="form-label">Produto</label>
                  <div class="position-relative">
                    <div class="input-group">
                      <span class="input-group-text">
                        <i class="fas fa-search"></i>
                      </span>
                      <input type="text" class="form-control" id="searchComponenteProduto" 
                             placeholder="Digite o nome ou ID do produto..." autocomplete="off"
                             onkeyup="filtrarProdutosComponente()" onfocus="mostrarListaProdutos()"
                             onblur="setTimeout(ocultarListaProdutos, 200)">
                    </div>
                    <input type="hidden" id="componenteProduto" value="">
                    <div id="listaProdutosComponente" class="dropdown-menu position-absolute w-100" 
                         style="max-height: 200px; overflow-y: auto; display: none; z-index: 1000; top: 100%;">
                    </div>
                    <div class="form-text" id="produtoSelecionado" style="display: none;">
                      <i class="fas fa-check-circle text-success"></i> <span id="produtoSelecionadoTexto"></span>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <label for="componenteQuantidade" class="form-label">Quantidade</label>
                  <input type="number" step="0.01" class="form-control" id="componenteQuantidade" min="0.01" placeholder="1.00">
                </div>
                <div class="col-md-3">
                  <label class="form-label">&nbsp;</label>
                  <button type="button" class="btn btn-success d-block w-100" onclick="adicionarComponente()">
                    <i class="fas fa-plus"></i> Adicionar
                  </button>
                </div>
              </div>
              
              <!-- Lista de componentes -->
              <div class="table-responsive">
                <table class="table table-striped" id="componentesTable">
                  <thead>
                    <tr>
                      <th>Produto</th>
                      <th>Quantidade</th>
                      <th>Custo Unit√°rio</th>
                      <th>Custo Total</th>
                      <th>A√ß√£o</th>
                    </tr>
                  </thead>
                  <tbody id="componentesTableBody">
                    <tr id="noComponentsRow">
                      <td colspan="5" class="text-center text-muted">Nenhum componente adicionado</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <!-- Resumo de custos -->
              <div class="row mt-3">
                <div class="col-md-6 offset-md-6">
                  <div class="card">
                    <div class="card-header">
                      <h6 class="mb-0">üí∞ Resumo de Custos</h6>
                    </div>
                    <div class="card-body">
                      <div id="custoTotalComposto">R$ 0,00</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeProdutoCompostoModal()">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="salvarProdutoComposto()">Salvar Produto Composto</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const apiProdutos = '/api/produtos/';
const apiComponentes = '/api/componentes/';
const apiTemplates = '/api/templates/';
const apiCalcular = '/calcular-produto/';
let produtoModal = null;
let selectProductModal = null;
let produtoCompostoModal = null;
let produtoParametrizadoModal = null;
let allProducts = []; // Cache dos produtos para filtragem
let allProductsOriginal = []; // Cache original sem filtro
let componentesTemp = []; // Array tempor√°rio para componentes
let templateAtual = null;
let templatesCache = [];
let ultimoCalculo = null;

// Fun√ß√£o global para obter CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

if(document.getElementById('produtoModal')) produtoModal = new bootstrap.Modal(document.getElementById('produtoModal'));
if(document.getElementById('selectProductModal')) selectProductModal = new bootstrap.Modal(document.getElementById('selectProductModal'));
if(document.getElementById('produtoCompostoModal')) produtoCompostoModal = new bootstrap.Modal(document.getElementById('produtoCompostoModal'));
if(document.getElementById('produtoParametrizadoModal')) produtoParametrizadoModal = new bootstrap.Modal(document.getElementById('produtoParametrizadoModal'));

// PRODUTOS CRUD
function fetchProdutos() {
    console.log('Fazendo fetch de produtos na URL:', apiProdutos);
    fetch(apiProdutos)
        .then(res => {
            console.log('Resposta da API:', res.status, res.statusText);
            return res.json();
        })
        .then(data => {
            console.log('Dados recebidos:', data);
            console.log('Total de produtos:', data.length);
            allProductsOriginal = data.map(produto => ({
                ...produto,
                tipo: produto.is_composto ? 'Composto' : 'Simples'
            }));
            displayProductsInTable(allProductsOriginal);
        })
        .catch(error => {
            console.error('Erro ao carregar produtos:', error);
            alert('Erro ao carregar produtos: ' + error.message);
        });
}

function displayProductsInTable(produtos) {
    const tbody = document.querySelector('#produtos-table tbody');
    tbody.innerHTML = '';
    
  produtos.forEach(async produto => {
    let tipo = produto.tipo || 'Simples';
    let tipoClass = tipo === 'Composto' ? 'badge bg-success' : (tipo === 'Parametrizado' ? 'badge bg-warning' : 'badge bg-primary');
    let custo_reais = 'R$ 0,00';
    let pesoFormatado = Number(produto.peso_und).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});

    if (tipo === 'Composto') {
      // Para produtos compostos, usar o custo salvo no produto principal
      // (que j√° foi calculado corretamente baseado nos componentes)
      let centavos = Number(produto.custo_centavos);
      let reais = !isNaN(centavos) ? centavos / 100 : 0;
      custo_reais = 'R$ ' + reais.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    } else if (tipo === 'Parametrizado') {
      // Se poss√≠vel, calcular custo dos componentes calculados
      if (produto.detalhes_calculo && produto.detalhes_calculo.custo_total) {
        custo_reais = 'R$ ' + Number(produto.detalhes_calculo.custo_total).toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      } else {
        let centavos = Number(produto.custo_centavos);
        let reais = !isNaN(centavos) ? centavos / 100 : 0;
        custo_reais = 'R$ ' + reais.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
      }
    } else {
      let centavos = Number(produto.custo_centavos);
      let reais = !isNaN(centavos) ? centavos / 100 : 0;
      custo_reais = 'R$ ' + reais.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }

    let actionButtons = '';
    if (tipo === 'Simples') {
      actionButtons = `
        <button class="btn btn-info btn-sm me-1" onclick="duplicateProduto(${produto.id})" title="Duplicar Produto">
          <i class="fas fa-copy"></i>
        </button>
        <button class="btn btn-warning btn-sm me-1" onclick="editProduto(${produto.id})">Editar</button>
      `;
    } else {
      actionButtons = `
        <button class="btn btn-info btn-sm me-1" onclick="verComponentes(${produto.id})" title="Ver Componentes">
          <i class="fas fa-list"></i>
        </button>
        <button class="btn btn-warning btn-sm me-1" onclick="editProdutoComposto(${produto.id})">Editar</button>
      `;
    }
    actionButtons += `<button class="btn btn-danger btn-sm" onclick="deleteProduto(${produto.id})">Excluir</button>`;

    tbody.innerHTML += `
      <tr>
        <td class="text-center">${produto.id}</td>
        <td>${produto.descricao}</td>
        <td class="text-center"><span class="${tipoClass}">${tipo}</span></td>
        <td class="text-end">${custo_reais}</td>
        <td class="text-end">${pesoFormatado}</td>
        <td class="text-center">${produto.unidade}</td>
        <td>${produto.referencia || ''}</td>
        <td class="text-center">${produto.data_revisao || ''}</td>
        <td class="text-center">
          ${actionButtons}
        </td>
      </tr>
    `;
  });
}
function openFormProduto(id=null, isDuplicate=false) {
    document.getElementById('produtoForm').reset();
    document.getElementById('produtoId').value = '';
    document.getElementById('isDuplicate').value = isDuplicate ? 'true' : 'false';
    document.getElementById('modalTitleProduto').innerText = 'Adicionar Produto';
    
    // Ocultar ou mostrar alert de duplica√ß√£o
    const duplicateAlert = document.getElementById('duplicateAlert');
    if (isDuplicate) {
        duplicateAlert.classList.remove('d-none');
        document.getElementById('modalTitleProduto').innerText = 'Duplicar Produto';
    } else {
        duplicateAlert.classList.add('d-none');
    }
    
    if (id) {
        fetch(apiProdutos + id + '/')
            .then(res => res.json())
            .then(produto => {
                if (!isDuplicate) {
                    document.getElementById('produtoId').value = produto.id;
                    document.getElementById('modalTitleProduto').innerText = 'Editar Produto';
                } else {
                    // Para duplica√ß√£o, limpar o ID para criar novo produto
                    document.getElementById('produtoId').value = '';
                    // Adicionar prefixo na descri√ß√£o para indicar c√≥pia
                    document.getElementById('descricao').value = 'C√ìPIA - ' + produto.descricao;
                }
                
                if (isDuplicate) {
                    document.getElementById('descricao').value = 'C√ìPIA - ' + produto.descricao;
                } else {
                    document.getElementById('descricao').value = produto.descricao;
                }
                
                document.getElementById('custo_centavos').value = produto.custo_centavos;
                document.getElementById('peso_und').value = produto.peso_und;
                document.getElementById('unidade').value = produto.unidade;
                document.getElementById('referencia').value = produto.referencia || '';
                
                // Para duplica√ß√£o, n√£o preencher data de revis√£o (ser√° gerada nova)
                if (!isDuplicate) {
                    document.getElementById('data_revisao').value = produto.data_revisao || '';
                }
            });
    }
    produtoModal.show();
}
function closeFormProduto() {
    produtoModal.hide();
}
function submitFormProduto() {
    const id = document.getElementById('produtoId').value;
    const isDuplicate = document.getElementById('isDuplicate').value === 'true';
    const descricao = document.getElementById('descricao').value;
    
    // Converte valor monet√°rio para centavos
    let custo_valor = document.getElementById('custo_centavos').value.replace('.', '').replace(',', '.');
    let custo_centavos = Math.round(parseFloat(custo_valor) * 100);
    const peso_und = document.getElementById('peso_und').value;
    const unidade = document.getElementById('unidade').value;
    const referencia = document.getElementById('referencia').value;
    
    // Gera data/hora atual no formato ISO para o campo data_revisao
    const now = new Date();
    const data_revisao = now.toISOString();
    
    // Se √© duplica√ß√£o, sempre criar novo (POST), mesmo que tenha ID
    const method = (id && !isDuplicate) ? 'PUT' : 'POST';
    const url = (id && !isDuplicate) ? apiProdutos + id + '/' : apiProdutos;
    
    const csrftoken = getCookie('csrftoken');
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({descricao, custo_centavos, peso_und, unidade, referencia, data_revisao})
    })
    .then(res => {
        if (res.ok) {
            closeFormProduto();
            fetchProdutos();
            if (isDuplicate) {
                // Mostrar mensagem de sucesso para duplica√ß√£o
                alert('Produto duplicado com sucesso!');
            }
        } else {
            res.json().then(data => alert('Erro: ' + JSON.stringify(data)));
        }
    });
}

function duplicateProduto(id) {
    openFormProduto(id, true);
}

// Fun√ß√µes para modal de sele√ß√£o de produto base
function openCreateFromExisting() {
    populateSelectProductModal();
    selectProductModal.show();
}

function closeSelectProductModal() {
    selectProductModal.hide();
    document.getElementById('searchProduct').value = '';
}

function populateSelectProductModal() {
    fetch(apiProdutos)
        .then(res => res.json())
        .then(data => {
            allProducts = data; // Armazenar produtos para filtro
            displayProducts(data);
        })
        .catch(error => {
            console.error('Erro ao carregar produtos:', error);
            alert('Erro ao carregar produtos. Tente novamente.');
        });
}

function displayProducts(produtos) {
    const tbody = document.getElementById('selectProductTableBody');
    tbody.innerHTML = '';
    
    if (produtos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Nenhum produto encontrado</td></tr>';
        return;
    }
    
    produtos.forEach(produto => {
        let centavos = Number(produto.custo_centavos);
        let reais = !isNaN(centavos) ? centavos / 100 : 0;
        let custo_reais = 'R$ ' + reais.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        tbody.innerHTML += `
            <tr>
                <td>${produto.id}</td>
                <td>${produto.descricao}</td>
                <td>${custo_reais}</td>
                <td>${produto.unidade}</td>
                <td>${produto.referencia || '-'}</td>
                <td>
                    <button class="btn btn-success btn-sm" onclick="selectProductAsBase(${produto.id})" title="Usar como Base">
                        <i class="fas fa-check"></i> Usar como Base
                    </button>
                </td>
            </tr>
        `;
    });
}

function filterProducts() {
    const searchTerm = document.getElementById('searchProduct').value.toLowerCase();
    const filteredProducts = allProducts.filter(produto => 
        produto.descricao.toLowerCase().includes(searchTerm) ||
        (produto.referencia && produto.referencia.toLowerCase().includes(searchTerm)) ||
        produto.id.toString().includes(searchTerm)
    );
    displayProducts(filteredProducts);
}

function selectProductAsBase(id) {
    closeSelectProductModal();
    openFormProduto(id, true);
}

// Fun√ß√µes para filtros
function aplicarFiltros() {
    const filtroDescricao = document.getElementById('filtroDescricao').value.toLowerCase();
    const filtroTipo = document.getElementById('filtroTipo').value;
    const filtroReferencia = document.getElementById('filtroReferencia').value;
    
    let produtosFiltrados = allProductsOriginal.filter(produto => {
        const matchDescricao = !filtroDescricao || produto.descricao.toLowerCase().includes(filtroDescricao);
        
        let matchTipo = true;
        if (filtroTipo) {
            if (filtroTipo === 'Resina') {
                matchTipo = produto.descricao.toLowerCase().includes('resina');
            } else {
                matchTipo = produto.tipo === filtroTipo;
            }
        }
        
        const matchReferencia = !filtroReferencia || produto.referencia === filtroReferencia;
        
        return matchDescricao && matchTipo && matchReferencia;
    });
    
    console.log(`Filtros aplicados: Descri√ß√£o="${filtroDescricao}", Tipo="${filtroTipo}", Refer√™ncia="${filtroReferencia}"`);
    console.log(`Produtos filtrados: ${produtosFiltrados.length} de ${allProductsOriginal.length}`);
    
    displayProductsInTable(produtosFiltrados);
}

function limparFiltros() {
    document.getElementById('filtroDescricao').value = '';
    document.getElementById('filtroTipo').value = '';
    document.getElementById('filtroReferencia').value = '';
    displayProductsInTable(allProductsOriginal);
}

// Fun√ß√µes para produto composto
function openFormProdutoComposto() {
    componentesTemp = [];
    document.getElementById('produtoCompostoForm').reset();
    document.getElementById('produtoCompostoId').value = '';
    carregarProdutosParaSelect();
    atualizarTabelaComponentes();
    produtoCompostoModal.show();
}

function closeProdutoCompostoModal() {
  produtoCompostoModal.hide();
  fetchProdutos();
}

function carregarProdutosParaSelect() {
    // Fun√ß√£o mantida para compatibilidade, mas agora usa o sistema de busca din√¢mica
    filtrarProdutosComponente();
}

// Vari√°veis globais para controle da busca de componentes
let produtosDisponiveis = [];
let produtoSelecionadoComponente = null;

function inicializarProdutosComponente() {
    produtosDisponiveis = allProductsOriginal
        .filter(produto => produto.tipo_produto === 'simples') // Apenas produtos simples como componentes
        .map(produto => ({
            id: produto.id,
            descricao: produto.descricao,
            custo: produto.custo_centavos / 100,
            searchText: produto.descricao.toLowerCase()
        }));
}

function filtrarProdutosComponente() {
    const input = document.getElementById('searchComponenteProduto');
    const lista = document.getElementById('listaProdutosComponente');
    const termo = input.value.toLowerCase().trim();
    
    if (!produtosDisponiveis.length) {
        inicializarProdutosComponente();
    }
    
    lista.innerHTML = '';
    
    if (termo === '') {
        // Mostrar todos os produtos quando n√£o h√° filtro
        const produtosFiltrados = produtosDisponiveis.slice(0, 20); // Limitar a 20 itens
        mostrarProdutosFiltrados(produtosFiltrados);
    } else {
        // Filtrar produtos baseado no termo
        const produtosFiltrados = produtosDisponiveis
            .filter(produto => 
                produto.searchText.includes(termo) ||
                produto.id.toString().includes(termo)
            )
            .slice(0, 20); // Limitar a 20 resultados
            
        mostrarProdutosFiltrados(produtosFiltrados);
    }
    
    if (lista.children.length > 0) {
        lista.style.display = 'block';
    } else {
        lista.innerHTML = '<div class="dropdown-item text-muted">Nenhum produto encontrado</div>';
        lista.style.display = 'block';
    }
}

// Adicionar eventos de teclado para navega√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    let selectedIndex = -1;
    
    document.addEventListener('keydown', function(e) {
        const input = document.getElementById('searchComponenteProduto');
        const lista = document.getElementById('listaProdutosComponente');
        
        if (input && input === document.activeElement && lista.style.display === 'block') {
            const items = lista.querySelectorAll('.dropdown-item:not(.text-muted)');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                updateSelection(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedIndex >= 0 && items[selectedIndex]) {
                    items[selectedIndex].click();
                }
            } else if (e.key === 'Escape') {
                ocultarListaProdutos();
                selectedIndex = -1;
            }
        }
    });
    
    function updateSelection(items) {
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.style.backgroundColor = '#0d6efd';
                item.style.color = '#fff';
                item.scrollIntoView({ block: 'nearest' });
            } else {
                item.style.backgroundColor = '';
                item.style.color = '';
            }
        });
    }
});

function mostrarProdutosFiltrados(produtos) {
    const lista = document.getElementById('listaProdutosComponente');
    
    produtos.forEach(produto => {
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        item.style.cursor = 'pointer';
        item.innerHTML = `
            <div>
                <strong>${produto.descricao}</strong>
                <small class="text-muted d-block">ID: ${produto.id} - R$ ${produto.custo.toFixed(2)}</small>
            </div>
        `;
        
        item.onclick = () => selecionarProdutoComponente(produto);
        lista.appendChild(item);
    });
}

function selecionarProdutoComponente(produto) {
    produtoSelecionadoComponente = produto;
    
    // Atualizar campos
    document.getElementById('searchComponenteProduto').value = produto.descricao;
    document.getElementById('componenteProduto').value = produto.id;
    
    // Mostrar feedback visual com anima√ß√£o
    const feedbackDiv = document.getElementById('produtoSelecionado');
    const feedbackTexto = document.getElementById('produtoSelecionadoTexto');
    feedbackTexto.textContent = `${produto.descricao} - R$ ${produto.custo.toFixed(2)}`;
    
    feedbackDiv.className = 'form-text produto-selecionado-feedback';
    feedbackDiv.style.display = 'block';
    
    // Ocultar lista
    ocultarListaProdutos();
    
    // Focar no campo quantidade
    setTimeout(() => {
        document.getElementById('componenteQuantidade').focus();
    }, 100);
}

function mostrarListaProdutos() {
    setTimeout(() => {
        filtrarProdutosComponente();
    }, 100);
}

function ocultarListaProdutos() {
    const lista = document.getElementById('listaProdutosComponente');
    lista.style.display = 'none';
}

function limparSelecaoComponente() {
    produtoSelecionadoComponente = null;
    document.getElementById('searchComponenteProduto').value = '';
    document.getElementById('componenteProduto').value = '';
    document.getElementById('produtoSelecionado').style.display = 'none';
    ocultarListaProdutos();
}

function adicionarComponente() {
    const produtoId = document.getElementById('componenteProduto').value;
    const quantidade = parseFloat(document.getElementById('componenteQuantidade').value);
    
    if (!produtoId || !quantidade || quantidade <= 0) {
        alert('Selecione um produto e informe uma quantidade v√°lida!');
        return;
    }
    
    // Verificar se o produto j√° foi adicionado
    if (componentesTemp.find(c => c.produto_id == produtoId)) {
        alert('Este produto j√° foi adicionado aos componentes!');
        return;
    }
    
    const produto = produtoSelecionadoComponente || allProductsOriginal.find(p => p.id == produtoId);
    if (!produto) {
        alert('Produto n√£o encontrado!');
        return;
    }
    
    const custo_unitario = produto.custo || (produto.custo_centavos / 100);
    
    const componente = {
        produto_id: produtoId,
        produto_descricao: produto.descricao,
        quantidade: quantidade,
        custo_unitario: custo_unitario,
        custo_total: custo_unitario * quantidade
    };
    
    componentesTemp.push(componente);
    atualizarTabelaComponentes();
    calcularCustoTotalComposto();
    
    // Limpar formul√°rio
    limparFormularioComponente();
}

function limparFormularioComponente() {
    document.getElementById('componenteQuantidade').value = '';
    limparSelecaoComponente();
}

function removerComponente(index) {
    componentesTemp.splice(index, 1);
    atualizarTabelaComponentes();
    calcularCustoTotalComposto();
}

function atualizarTabelaComponentes() {
    const tbody = document.getElementById('componentesTableBody');
    const noComponentsRow = document.getElementById('noComponentsRow');
    
    if (componentesTemp.length === 0) {
        tbody.innerHTML = '<tr id="noComponentsRow"><td colspan="5" class="text-center text-muted">Nenhum componente adicionado</td></tr>';
        document.getElementById('custoTotalComposto').textContent = 'R$ 0,00';
        return;
    }
    
    let html = '';
    let custoTotal = 0;
    
    componentesTemp.forEach((comp, index) => {
        custoTotal += comp.custo_total;
        html += `
            <tr>
                <td>${comp.produto_descricao}</td>
                <td>${comp.quantidade.toFixed(2)}</td>
                <td>R$ ${comp.custo_unitario.toFixed(2)}</td>
                <td>R$ ${comp.custo_total.toFixed(2)}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="removerComponente(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    calcularCustoTotalComposto(custoTotal);
}

function calcularCustoTotalComposto(custoBase = null) {
    // Se n√£o foi passado custo base, recalcular
    if (custoBase === null) {
        custoBase = componentesTemp.reduce((total, comp) => total + comp.custo_total, 0);
    }
    
    // Obter percentual de perda
    const percentualPerda = parseFloat(document.getElementById('percentualPerdaComposto').value) || 0;
    
    // Debug
    console.log('=== DEBUG CALCULO ===');
    console.log('Custo Base:', custoBase);
    console.log('Percentual Perda input value:', document.getElementById('percentualPerdaComposto').value);
    console.log('Percentual Perda parseado:', percentualPerda);
    
    // Calcular valor da perda
    const valorPerda = custoBase * (percentualPerda / 100);
    
    // Custo total final com perda
    const custoTotalFinal = custoBase + valorPerda;
    
    console.log('Valor Perda:', valorPerda);
    console.log('Custo Total Final:', custoTotalFinal);
    
    // Atualizar display
    const elementoCustoTotal = document.getElementById('custoTotalComposto');
    if (percentualPerda > 0) {
        elementoCustoTotal.innerHTML = `
            <div class="row">
                <div class="col-6">Subtotal:</div>
                <div class="col-6 text-end">R$ ${custoBase.toFixed(2)}</div>
            </div>
            <div class="row text-muted small">
                <div class="col-6">Perda (${percentualPerda}%):</div>
                <div class="col-6 text-end">R$ ${valorPerda.toFixed(2)}</div>
            </div>
            <hr class="my-2">
            <div class="row">
                <div class="col-6"><strong>Total Final:</strong></div>
                <div class="col-6 text-end"><strong>R$ ${custoTotalFinal.toFixed(2)}</strong></div>
            </div>
        `;
    } else {
        elementoCustoTotal.innerHTML = `
            <div class="row">
                <div class="col-6"><strong>Total:</strong></div>
                <div class="col-6 text-end"><strong>R$ ${custoTotalFinal.toFixed(2)}</strong></div>
            </div>
        `;
    }
    
    return custoTotalFinal;
}

function validarPercentualPerda() {
    const input = document.getElementById('percentualPerdaComposto');
    const feedback = document.getElementById('feedbackPercentualPerda');
    const valor = parseFloat(input.value);
    
    // Remover classes de valida√ß√£o anteriores
    input.classList.remove('is-valid', 'is-invalid');
    feedback.style.display = 'none';
    
    if (isNaN(valor)) {
        input.value = 0;
        return true;
    }
    
    if (valor < 0) {
        input.classList.add('is-invalid');
        feedback.textContent = 'O percentual n√£o pode ser negativo';
        feedback.style.display = 'block';
        input.value = 0;
        return false;
    }
    
    if (valor > 100) {
        input.classList.add('is-invalid');
        feedback.textContent = 'O percentual n√£o pode ser maior que 100%';
        feedback.style.display = 'block';
        input.value = 100;
        return false;
    }
    
    if (valor >= 0 && valor <= 100) {
        input.classList.add('is-valid');
        return true;
    }
    
    return true;
}

function salvarProdutoComposto() {
    const descricao = document.getElementById('descricaoComposto').value;
    const referencia = document.getElementById('referenciaComposto').value;
    const percentualPerda = parseFloat(document.getElementById('percentualPerdaComposto').value) || 0;
    
    if (!descricao.trim()) {
        alert('Informe a descri√ß√£o do produto composto!');
        return;
    }
    
    if (componentesTemp.length === 0) {
        alert('Adicione pelo menos um componente ao produto!');
        return;
    }
    
    // Validar percentual de perda
    if (percentualPerda < 0 || percentualPerda > 100) {
        alert('O percentual de perda deve estar entre 0% e 100%!');
        return;
    }
    
    // Calcular custo total com perda
    const custoBase = componentesTemp.reduce((total, comp) => total + comp.custo_total, 0);
    const valorPerda = custoBase * (percentualPerda / 100);
    const custoTotalFinal = custoBase + valorPerda;
    const custoCentavos = Math.round(custoTotalFinal * 100);

    // Debug: mostrar os c√°lculos
    console.log('üîç SALVAMENTO - Custo Base:', custoBase.toFixed(2));
    console.log('üîç SALVAMENTO - Percentual:', percentualPerda + '%');
    console.log('üîç SALVAMENTO - Valor Perda:', valorPerda.toFixed(2));
    console.log('üîç SALVAMENTO - Total Final:', custoTotalFinal.toFixed(2));
    console.log('üîç SALVAMENTO - Centavos:', custoCentavos);

    // Gerar data de revis√£o no formato ISO
    const now = new Date();
    const data_revisao = now.toISOString();

    const produtoId = document.getElementById('produtoCompostoId').value;
    const produtoData = {
        descricao: descricao,
        custo_centavos: custoCentavos,
        peso_und: 0, // Peso pode ser calculado se necess√°rio
        unidade: 'UN', // Padr√£o para produtos compostos
        referencia: referencia || '',
        data_revisao: data_revisao,
        tipo_produto: 'composto'
    };

    // Debug: mostrar dados que ser√£o enviados
    console.log('üì§ DADOS ENVIADOS:', produtoData);

  let method = 'POST';
  let url = apiProdutos;
  if (produtoId) {
    method = 'PUT';
    url = apiProdutos + produtoId + '/';
  }

  fetch(url, {
    method: method,
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(produtoData)
  })
  .then(res => res.json())
  .then(produto => {
    if (produto.id) {
      // Excluir componentes antigos se for edi√ß√£o
      let compDeletePromise = Promise.resolve();
      if (produtoId) {
        compDeletePromise = fetch(apiComponentes + '?produto_principal=' + produtoId)
          .then(res => res.json())
          .then(componentesAntigos => {
            return Promise.all(componentesAntigos.map(comp =>
              fetch(apiComponentes + '/' + comp.id + '/', {method: 'DELETE'})
            ));
          });
      }
      compDeletePromise.then(() => {
        // Salvar componentes novos
        const componentesPromises = componentesTemp.map(comp => {
          return fetch(apiComponentes, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
              produto_principal: produto.id,
              produto_componente: comp.produto_id,
              quantidade: comp.quantidade
            })
          });
        });
        Promise.all(componentesPromises)
          .then(() => {
            closeProdutoCompostoModal();
            fetchProdutos();
            alert(produtoId ? 'Produto composto editado com sucesso!' : 'Produto composto criado com sucesso!');
          });
      });
    } else {
      alert('Erro ao criar/editar produto: ' + JSON.stringify(produto));
    }
  })
  .catch(error => {
    console.error('Erro ao salvar produto:', error);
    alert('Erro ao salvar produto!');
  });
}
function editProduto(id) {
    openFormProduto(id);
}
function deleteProduto(id) {
    if (confirm('Tem certeza que deseja excluir este produto?')) {
        fetch(apiProdutos + id + '/', {method: 'DELETE'})
            .then(res => {
                if (res.ok) fetchProdutos();
                else alert('Erro ao excluir!');
            });
    }
}

// Fun√ß√£o para ver componentes de um produto composto
function verComponentes(produtoId) {
    fetch(`${apiComponentes}?produto_pai=${produtoId}`)
        .then(res => res.json())
        .then(componentes => {
            if (componentes.length === 0) {
                alert('Este produto n√£o possui componentes cadastrados.');
                return;
            }
            
            let detalhes = 'Componentes do produto:\n\n';
            let custoTotal = 0;
            
            componentes.forEach(comp => {
                const produto = allProductsOriginal.find(p => p.id === comp.produto_componente);
                if (produto) {
                    const custoUnitario = produto.custo_centavos / 100;
                    const custoItem = custoUnitario * comp.quantidade;
                    custoTotal += custoItem;
                    
                    detalhes += `‚Ä¢ ${produto.descricao}\n`;
                    detalhes += `  Quantidade: ${comp.quantidade}\n`;
                    detalhes += `  Custo unit√°rio: R$ ${custoUnitario.toFixed(2)}\n`;
                    detalhes += `  Custo total: R$ ${custoItem.toFixed(2)}\n\n`;
                }
            });
            
            detalhes += `Custo total do produto: R$ ${custoTotal.toFixed(2)}`;
            alert(detalhes);
        })
        .catch(error => {
            console.error('Erro ao carregar componentes:', error);
            alert('Erro ao carregar componentes do produto.');
        });
}

// Fun√ß√£o para editar produto composto (simplificada)
function editProdutoComposto(id) {
  // Buscar dados do produto composto
  fetch(apiProdutos + id + '/')
    .then(res => res.json())
    .then(produto => {
      // Abrir modal e preencher dados
      document.getElementById('produtoCompostoForm').reset();
      document.getElementById('produtoCompostoId').value = produto.id;
      document.getElementById('descricaoComposto').value = produto.descricao;
      document.getElementById('referenciaComposto').value = produto.referencia || '';
      document.getElementById('modalTitleProdutoComposto').innerText = 'Editar Produto Composto';
      // Buscar componentes
      fetch(apiComponentes + '?produto_principal=' + produto.id)
        .then(res => res.json())
        .then(componentes => {
          componentesTemp = [];
          componentes.forEach(comp => {
            const produtoComp = allProductsOriginal.find(p => p.id == comp.produto_componente);
            if (produtoComp) {
              let custoUnitario = produtoComp.custo_centavos / 100;
              let custoTotal = custoUnitario * parseFloat(comp.quantidade);
              let descricaoComponente = produtoComp.descricao;
              
              // Tentar extrair custos calculados da observa√ß√£o
              if (comp.observacao) {
                try {
                  const custosCalculados = JSON.parse(comp.observacao);
                  if (custosCalculados.custo_unitario && custosCalculados.custo_total) {
                    custoUnitario = custosCalculados.custo_unitario / 100;
                    custoTotal = custosCalculados.custo_total / 100;
                    if (custosCalculados.nome_componente) {
                      descricaoComponente = custosCalculados.nome_componente;
                    }
                    console.log(`‚úÖ Custos recuperados da observa√ß√£o para ${descricaoComponente}: Unit: R$ ${custoUnitario.toFixed(2)}, Total: R$ ${custoTotal.toFixed(2)}`);
                  }
                } catch (e) {
                  console.warn(`‚ö†Ô∏è Erro ao parsear observa√ß√£o do componente ${comp.id}:`, e);
                }
              }
              
              componentesTemp.push({
                produto_id: produtoComp.id,
                produto_descricao: descricaoComponente,
                quantidade: parseFloat(comp.quantidade),
                custo_unitario: custoUnitario,
                custo_total: custoTotal
              });
            }
          });
          carregarProdutosParaSelect();
          atualizarTabelaComponentes();
          produtoCompostoModal.show();
        });
    });
}

function carregarInterfaceNovoPerfil() {
    console.log('=== CARREGANDO INTERFACE NOVO PERFIL ===');
    
    // Limpar estado anterior
    templateAtual = { id: 'perfil_customizado', tipo: 'perfil' };
    ultimoCalculo = null;
    
    // Mostrar descri√ß√£o
    document.getElementById('templateDescription').innerHTML = `
        <h6 class="text-primary">Novo Perfil</h6>
        <small class="text-muted">Categoria: PRODUTO_FINAL</small>
        <br><small class="text-info">Template para cria√ß√£o de perfis pultrusados customizados</small>
    `;
    
    // Criar APENAS os 11 campos solicitados + descri√ß√£o t√©cnica
    const parametrosContainer = document.getElementById('parametrosContainer');
    parametrosContainer.innerHTML = `
        <div class="mb-3">
            <label for="perfil_nome" class="form-label">Nome perfil *</label>
            <input type="text" class="form-control param-input" id="perfil_nome" name="nome_perfil" required>
        </div>
        
        <div class="mb-3">
            <label for="perfil_descricao_tecnica" class="form-label">Descri√ß√£o T√©cnica</label>
            <textarea class="form-control param-input" id="perfil_descricao_tecnica" name="descricao_tecnica" rows="3" placeholder="Descri√ß√£o t√©cnica detalhada do perfil..."></textarea>
            <div class="form-text">Informa√ß√µes t√©cnicas sobre material, dimens√µes, aplica√ß√µes, etc.</div>
        </div>
        
        <div class="mb-3">
            <label for="perfil_roving" class="form-label">Roving 4400 KG *</label>
            <input type="number" step="0.001" class="form-control param-input" id="perfil_roving" name="roving_4400_kg" required>
        </div>
        
        <div class="mb-3">
            <label for="perfil_manta" class="form-label">Manta 300 KG *</label>
            <input type="number" step="0.001" class="form-control param-input" id="perfil_manta" name="manta_300_kg" required>
        </div>
        
        <div class="mb-3">
            <label for="perfil_veu" class="form-label">V√©u KG *</label>
            <input type="number" step="0.001" class="form-control param-input" id="perfil_veu" name="veu_kg" required>
        </div>
        
        <div class="mb-3">
            <label for="perfil_peso_metro" class="form-label">Peso/m kg *</label>
            <input type="number" step="0.001" class="form-control param-input" id="perfil_peso_metro" name="peso_metro_kg" required>
        </div>
        
        <div class="mb-3">
            <label for="perfil_n_matrizes" class="form-label">N matrizes *</label>
            <input type="number" class="form-control param-input" id="perfil_n_matrizes" name="n_matrizes" required min="1">
        </div>
        
        <div class="mb-3">
            <label for="perfil_n_maquinas" class="form-label">N m√°quinas *</label>
            <input type="number" class="form-control param-input" id="perfil_n_maquinas" name="n_maquinas" required min="1">
        </div>
        
        <div class="mb-3">
            <label for="perfil_metros_h" class="form-label">Metro produzidos/h *</label>
            <input type="number" step="0.1" class="form-control param-input" id="perfil_metros_h" name="metros_produzidos_h" required>
        </div>
        
        <div class="mb-3">
            <label for="perfil_perda" class="form-label">% de perda *</label>
            <input type="number" step="0.1" class="form-control param-input" id="perfil_perda" name="percentual_perda" required min="0" max="100">
        </div>
        
        <div class="mb-3">
            <label for="perfil_tipo_resina" class="form-label">Tipo de Resina *</label>
            <select class="form-select param-input" id="perfil_tipo_resina" name="tipo_resina" required>
                <option value="">Carregando resinas...</option>
            </select>
        </div>
        
        <div class="mb-3">
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="perfil_pintura" name="tem_pintura" onchange="toggleAreaPintura()">
                <label for="perfil_pintura" class="form-check-label">Pintura?</label>
            </div>
        </div>
        
        <div class="mb-3" id="perfil_area_pintura_container" style="display: none;">
            <label for="perfil_area_pintura" class="form-label">√Årea pintura (m¬≤) *</label>
            <input type="number" step="0.01" class="form-control param-input" id="perfil_area_pintura" name="area_pintura_m2">
        </div>
        
        <!-- Campo de Unidade de Medida -->
        <div class="mb-3">
            <label for="perfil_unidade" class="form-label">Unidade de Medida *</label>
            <select class="form-select param-input" id="perfil_unidade" name="unidade" required>
                <option value="M">M (Metro Linear)</option>
                <option value="M¬≤">M¬≤ (Metro Quadrado)</option>
                <option value="UN">UN (Unidade)</option>
                <option value="KG">KG (Quilograma)</option>
                <option value="PC">PC (Pe√ßa)</option>
                <option value="CJ">CJ (Conjunto)</option>
                <option value="L">L (Litro)</option>
                <option value="M¬≥">M¬≥ (Metro C√∫bico)</option>
            </select>
            <div class="form-text">Define a unidade de medida para o produto final</div>
        </div>
        
        <div class="mt-3 text-center">
            <button type="button" class="btn btn-primary" onclick="calcularProdutoParametrizado()" id="calcularBtn">
                <i class="fas fa-calculator"></i> Calcular
            </button>
        </div>
    `;
    
    // Carregar tipos de resina dispon√≠veis
    carregarTiposResina();
    
    console.log('Interface Novo Perfil carregada com 12 campos (incluindo tipo de resina)');
}

function carregarTiposResina() {
    console.log('=== CARREGANDO TIPOS DE RESINA ===');
    
    const selectResina = document.getElementById('perfil_tipo_resina');
    if (!selectResina) {
        console.warn('Select de resina n√£o encontrado');
        return;
    }
    
    // Buscar tipos de resina via API
    fetch('/api/tipos-resina/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.resinas) {
                console.log(`‚úÖ ${data.resinas.length} tipos de resina carregados`);
                
                // Limpar op√ß√µes atuais
                selectResina.innerHTML = '<option value="">Selecione uma resina...</option>';
                
                // Adicionar op√ß√µes das resinas
                data.resinas.forEach(resina => {
                    const option = document.createElement('option');
                    option.value = resina.id;
                    option.textContent = `${resina.descricao} - R$ ${resina.custo_reais.toFixed(2)}`;
                    selectResina.appendChild(option);
                    
                    console.log(`   ‚Ä¢ ${resina.descricao}: R$ ${resina.custo_reais.toFixed(2)}`);
                });
                
                // Selecionar Resina Poli√©ster como padr√£o (ID 1269)
                selectResina.value = '1269';
                
            } else {
                throw new Error(data.error || 'Erro desconhecido');
            }
        })
        .catch(error => {
            console.error('‚ùå Erro ao carregar tipos de resina:', error);
            
            // Fallback: adicionar op√ß√µes b√°sicas
            selectResina.innerHTML = `
                <option value="">Erro ao carregar resinas</option>
                <option value="1269">Resina Poli√©ster (padr√£o)</option>
                <option value="1268">Resina Isoft√°lica</option>
                <option value="1270">Resina √âster Vin√≠lica</option>
            `;
            selectResina.value = '1269';
        });
}

function carregarInterfaceGrades() {
    console.log('=== CARREGANDO INTERFACE GRADES ===');
    
    // Limpar estado anterior
    templateAtual = { id: 'grades_customizado', tipo: 'grades' };
    ultimoCalculo = null;
    
    // Definir valor do select
    document.getElementById('templateSelect').value = 'grades_customizado';
    
    // Mostrar descri√ß√£o
    document.getElementById('templateDescription').innerHTML = `
        <h6 class="text-primary">Grades</h6>
        <small class="text-muted">Categoria: ESTRUTURAS</small>
        <br><small class="text-info">Template para grades estruturais em fibra de vidro</small>
        <p class="mt-2 text-info small">
            <strong>F√≥rmula:</strong> (((comprimento/eixo i)*v√£o/1000)* peso do perfil)
        </p>
    `;
    
    // Criar campos espec√≠ficos para grades + descri√ß√£o t√©cnica
    const parametrosContainer = document.getElementById('parametrosContainer');
    parametrosContainer.innerHTML = `
        <div class="mb-3">
            <label for="grade_nome" class="form-label">Nome da Grade *</label>
            <input type="text" class="form-control param-input" id="grade_nome" name="nome_grade" required>
        </div>
        
        <div class="mb-3">
            <label for="grade_descricao_tecnica" class="form-label">Descri√ß√£o T√©cnica</label>
            <textarea class="form-control param-input" id="grade_descricao_tecnica" name="descricao_tecnica" rows="3" placeholder="Descri√ß√£o t√©cnica da grade..."></textarea>
            <div class="form-text">Especifica√ß√µes t√©cnicas, carga suportada, aplica√ß√µes, etc.</div>
        </div>
        
        <div class="mb-3">
            <label for="grade_vao" class="form-label">V√£o (mm) *</label>
            <input type="number" step="0.1" class="form-control param-input" id="grade_vao" name="vao" required min="0">
            <div class="form-text">Dist√¢ncia entre apoios em mil√≠metros</div>
        </div>
        
        <div class="mb-3">
            <label for="grade_comprimento" class="form-label">Comprimento (mm) *</label>
            <input type="number" step="0.1" class="form-control param-input" id="grade_comprimento" name="comprimento" required min="0">
            <div class="form-text">Comprimento total da grade em mil√≠metros</div>
        </div>
        
        <div class="mb-3">
            <label for="grade_eixo_i" class="form-label">Eixo I (mm) *</label>
            <input type="number" step="0.1" class="form-control param-input" id="grade_eixo_i" name="eixo_i" required min="0">
            <div class="form-text">Espa√ßamento entre perfis em mil√≠metros</div>
        </div>
        
        <div class="mb-3">
            <label for="grade_perfil" class="form-label">Selecione o Perfil *</label>
            <select class="form-select param-input" id="grade_perfil" name="perfil_id" required>
                <option value="">Carregando perfis...</option>
            </select>
            <div class="form-text">Perfil que ser√° utilizado na estrutura</div>
        </div>
        
        <div class="mb-3">
            <label for="grade_perda" class="form-label">Perda (%)</label>
            <input type="number" step="0.1" class="form-control param-input" id="grade_perda" name="perda" value="10" min="0" max="100">
            <div class="form-text">Percentual de perda do material (padr√£o: 5%)</div>
        </div>
        
        <!-- Se√ß√£o de M√£o de Obra -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-tools"></i> M√£o de Obra</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="grade_tempo_proc" class="form-label">Tempo PROC (h)</label>
                        <input type="number" step="0.1" class="form-control param-input" id="grade_tempo_proc" name="tempo_proc" value="0.7" min="0">
                        <div class="form-text">Tempo de processamento em horas</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="grade_tempo_mtg" class="form-label">Tempo MTG (h)</label>
                        <input type="number" step="0.1" class="form-control param-input" id="grade_tempo_mtg" name="tempo_mtg" value="0.3" min="0">
                        <div class="form-text">Tempo de montagem em horas</div>
                    </div>
                </div>
                <div class="alert alert-info">
                    <small><i class="fas fa-info-circle"></i> M√£o de Obra: Processamento/Montagem - R$ 65,79/hora</small>
                </div>
            </div>
        </div>
        
        <!-- Campo de Unidade de Medida -->
        <div class="mb-3">
            <label for="grade_unidade" class="form-label">Unidade de Medida *</label>
            <select class="form-select param-input" id="grade_unidade" name="unidade" required>
                <option value="M¬≤">M¬≤ (Metro Quadrado)</option>
                <option value="ML">ML (Metro Linear)</option>
                <option value="UN">UN (Unidade)</option>
                <option value="KG">KG (Quilograma)</option>
                <option value="PC">PC (Pe√ßa)</option>
                <option value="CJ">CJ (Conjunto)</option>
                <option value="L">L (Litro)</option>
                <option value="M¬≥">M¬≥ (Metro C√∫bico)</option>
            </select>
            <div class="form-text">Define a unidade de medida para o produto final</div>
        </div>
        
        <div class="mt-3 text-center">
            <button type="button" class="btn btn-primary" onclick="calcularGrade()" id="calcularGradeBtn">
                <i class="fas fa-calculator"></i> Calcular Grade
            </button>
        </div>
    `;
    
    // Carregar perfis dispon√≠veis
    carregarPerfisGrade();
    
    console.log('Interface Grades carregada com campos de perda e MO');
}

function carregarPerfisGrade() {
    console.log('=== CARREGANDO PERFIS PARA GRADE ===');
    
    const selectPerfil = document.getElementById('grade_perfil');
    if (!selectPerfil) {
        console.warn('Select de perfil n√£o encontrado');
        return;
    }
    
    // Buscar perfis I25, I32, I38 via API
    fetch('/api/produtos/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(produtos => {
            console.log(`‚úÖ ${produtos.length} produtos carregados, filtrando perfis...`);
            
            // Filtrar perfis I25, I32, I38
            const perfisGrade = produtos.filter(produto => {
                const desc = produto.descricao.toLowerCase();
                return (desc.includes('i25') || desc.includes('i32') || desc.includes('i38')) && 
                       desc.includes('mm');
            });
            
            console.log(`üìä ${perfisGrade.length} perfis de grade encontrados`);
            
            // Limpar op√ß√µes atuais
            selectPerfil.innerHTML = '<option value="">Selecione um perfil...</option>';
            
            // Ordenar perfis por descri√ß√£o
            perfisGrade.sort((a, b) => a.descricao.localeCompare(b.descricao));
            
            // Adicionar op√ß√µes dos perfis
            perfisGrade.forEach(perfil => {
                const option = document.createElement('option');
                option.value = perfil.id;
                option.textContent = `${perfil.descricao} - ${perfil.peso_und}kg - R$ ${(perfil.custo_centavos/100).toFixed(2)}`;
                selectPerfil.appendChild(option);
                
                console.log(`   ‚Ä¢ ${perfil.descricao}: ${perfil.peso_und}kg - R$ ${(perfil.custo_centavos/100).toFixed(2)}`);
            });
            
            if (perfisGrade.length === 0) {
                selectPerfil.innerHTML = '<option value="">Nenhum perfil encontrado</option>';
                console.warn('‚ö†Ô∏è Nenhum perfil I25/I32/I38 encontrado');
            }
            
        })
        .catch(error => {
            console.error('‚ùå Erro ao carregar perfis:', error);
            
            // Fallback: adicionar op√ß√µes b√°sicas com IDs conhecidos
            selectPerfil.innerHTML = `
                <option value="">Erro ao carregar perfis</option>
                <option value="1331">I25mm Leve - 0.298kg (fallback)</option>
                <option value="1328">I25mm - 0.497kg (fallback)</option>
                <option value="1329">I32mm - 0.539kg (fallback)</option>
                <option value="1330">I38mm - 0.590kg (fallback)</option>
            `;
        });
}

function carregarInterfaceTampaInjetada() {
    console.log('=== CARREGANDO INTERFACE TAMPA INJETADA ===');
    
    // Limpar estado anterior
    templateAtual = { id: 'tampa_injetada_customizado', tipo: 'tampa_injetada' };
    ultimoCalculo = null;
    
    // Definir valor do select
    document.getElementById('templateSelect').value = 'tampa_injetada_customizado';
    
    // Mostrar descri√ß√£o
    document.getElementById('templateDescription').innerHTML = `
        <h6 class="text-primary">Tampa Injetada</h6>
        <small class="text-muted">Categoria: TAMPAS</small>
        <p class="mt-2 text-info small">
            <strong>F√≥rmula:</strong> Grade injetada com pre√ßo por m¬≤ fixo
        </p>
    `;
    
    // Criar campos espec√≠ficos para tampa injetada
    const parametrosContainer = document.getElementById('parametrosContainer');
    parametrosContainer.innerHTML = `
        <div class="mb-3">
            <label for="tampa_inj_nome" class="form-label">Nome da Tampa Injetada *</label>
            <input type="text" class="form-control param-input" id="tampa_inj_nome" name="nome_tampa" required>
        </div>
        
        <div class="mb-3">
            <label for="tampa_inj_vao" class="form-label">V√£o (mm) *</label>
            <input type="number" step="0.1" class="form-control param-input" id="tampa_inj_vao" name="vao" required min="0">
            <div class="form-text">Dist√¢ncia entre apoios em mil√≠metros</div>
        </div>
        
        <div class="mb-3">
            <label for="tampa_inj_comprimento" class="form-label">Comprimento (mm) *</label>
            <input type="number" step="0.1" class="form-control param-input" id="tampa_inj_comprimento" name="comprimento" required min="0">
            <div class="form-text">Comprimento total da tampa em mil√≠metros</div>
        </div>
        
        <div class="mb-3">
            <label for="tampa_inj_grade" class="form-label">Selecione a Grade Injetada *</label>
            <select class="form-select param-input" id="tampa_inj_grade" name="grade_id" required>
                <option value="">Carregando grades injetadas...</option>
            </select>
            <div class="form-text">Grade injetada que ser√° utilizada</div>
        </div>
        
        <div class="mb-3">
            <label for="tampa_inj_perda" class="form-label">Perda (%)</label>
            <input type="number" step="0.1" class="form-control param-input" id="tampa_inj_perda" name="perda" value="5" min="0" max="100">
            <div class="form-text">Percentual de perda do material (padr√£o: 5%)</div>
        </div>
        
        <!-- Op√ß√µes Adicionais -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-cogs"></i> Op√ß√µes Adicionais</h6>
            </div>
            <div class="card-body">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="tampa_inj_quadro_u4" name="quadro_u4">
                    <label class="form-check-label" for="tampa_inj_quadro_u4">
                        Quadro U4" (2 unidades)
                    </label>
                </div>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="tampa_inj_alca" name="alca">
                    <label class="form-check-label" for="tampa_inj_alca">
                        Al√ßa Met√°lica (2 unidades)
                    </label>
                </div>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="tampa_inj_chapa_ev" name="chapa_ev">
                    <label class="form-check-label" for="tampa_inj_chapa_ev">
                        Chapa EV (R$ 277,50 fixo)
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Se√ß√£o de M√£o de Obra -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-tools"></i> M√£o de Obra</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="tampa_inj_tempo_proc" class="form-label">Tempo PROC (h)</label>
                        <input type="number" step="0.1" class="form-control param-input" id="tampa_inj_tempo_proc" name="tempo_proc" value="0.7" min="0">
                        <div class="form-text">Tempo de processamento em horas</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="tampa_inj_tempo_mtg" class="form-label">Tempo MTG (h)</label>
                        <input type="number" step="0.1" class="form-control param-input" id="tampa_inj_tempo_mtg" name="tempo_mtg" value="0.3" min="0">
                        <div class="form-text">Tempo de montagem em horas</div>
                    </div>
                </div>
                <div class="alert alert-info">
                    <small><i class="fas fa-info-circle"></i> M√£o de Obra: Processamento/Montagem - R$ 65,79/hora</small>
                </div>
            </div>
        </div>
        
        <!-- Campo de Unidade de Medida -->
        <div class="mb-3">
            <label for="tampa_inj_unidade" class="form-label">Unidade de Medida *</label>
            <select class="form-select param-input" id="tampa_inj_unidade" name="unidade" required>
                <option value="M¬≤">M¬≤ (Metro Quadrado)</option>
                <option value="ML">ML (Metro Linear)</option>
                <option value="UN">UN (Unidade)</option>
                <option value="KG">KG (Quilograma)</option>
                <option value="PC">PC (Pe√ßa)</option>
                <option value="CJ">CJ (Conjunto)</option>
                <option value="L">L (Litro)</option>
                <option value="M¬≥">M¬≥ (Metro C√∫bico)</option>
            </select>
            <div class="form-text">Define a unidade de medida para o produto final</div>
        </div>
        
        <div class="mt-3 text-center">
            <button type="button" class="btn btn-primary" onclick="calcularTampaInjetada()" id="calcularTampaInjetadaBtn">
                <i class="fas fa-calculator"></i> Calcular Tampa Injetada
            </button>
        </div>
    `;
    
    // Carregar grades injetadas dispon√≠veis
    carregarGradesInjetadas();
    
    console.log('Interface Tampa Injetada carregada');
}

function carregarGradesInjetadas() {
    console.log('=== CARREGANDO GRADES INJETADAS ===');
    
    const selectGrade = document.getElementById('tampa_inj_grade');
    if (!selectGrade) {
        console.warn('Select de grade injetada n√£o encontrado');
        return;
    }
    
    // Buscar grades injetadas via API
    fetch('/api/produtos/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(produtos => {
            console.log(`‚úÖ ${produtos.length} produtos carregados, filtrando grades injetadas...`);
            
            // Filtrar grades injetadas
            const gradesInjetadas = produtos.filter(produto => {
                const desc = produto.descricao.toLowerCase();
                return desc.includes('grade') && desc.includes('injetada');
            });
            
            console.log(`üìä ${gradesInjetadas.length} grades injetadas encontradas`);
            
            // Limpar op√ß√µes atuais
            selectGrade.innerHTML = '<option value="">Selecione uma grade injetada...</option>';
            
            // Ordenar por descri√ß√£o
            gradesInjetadas.sort((a, b) => a.descricao.localeCompare(b.descricao));
            
            // Adicionar op√ß√µes das grades
            gradesInjetadas.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade.id;
                option.textContent = `${grade.descricao} - R$ ${(grade.custo_centavos/100).toFixed(2)}/m¬≤`;
                selectGrade.appendChild(option);
                
                console.log(`   ‚Ä¢ ${grade.descricao}: R$ ${(grade.custo_centavos/100).toFixed(2)}/m¬≤`);
            });
            
            if (gradesInjetadas.length === 0) {
                selectGrade.innerHTML = '<option value="">Nenhuma grade injetada encontrada</option>';
                console.warn('‚ö†Ô∏è Nenhuma grade injetada encontrada');
            }
            
        })
        .catch(error => {
            console.error('‚ùå Erro ao carregar grades injetadas:', error);
            selectGrade.innerHTML = '<option value="">Erro ao carregar</option>';
        });
}

function carregarInterfaceDegraus() {
    console.log('=== CARREGANDO INTERFACE DEGRAUS ===');
    
    // Limpar estado anterior
    templateAtual = { id: 'degraus_customizado', tipo: 'degraus' };
    ultimoCalculo = null;
    
    // Definir valor do select
    document.getElementById('templateSelect').value = 'degraus_customizado';
    
    // Mostrar descri√ß√£o
    document.getElementById('templateDescription').innerHTML = `
        <h6 class="text-primary">Degraus</h6>
        <small class="text-muted">Categoria: ESTRUTURAS</small>
        <p class="mt-2 text-info small">
            <strong>Componentes:</strong> Perfis I25/I38, Travessas, Refor√ßos F4"/E, Tubos, Parafusos, Cola
        </p>
    `;
    
    // Criar campos espec√≠ficos para degraus
    const parametrosContainer = document.getElementById('parametrosContainer');
    parametrosContainer.innerHTML = `
        <div class="mb-3">
            <label for="degraus_nome" class="form-label">Nome do Degrau *</label>
            <input type="text" class="form-control param-input" id="degraus_nome" name="nome_degrau" required>
        </div>
        
        <div class="mb-3">
            <label for="degraus_perfil" class="form-label">Tipo de Perfil *</label>
            <select class="form-select param-input" id="degraus_perfil" name="tipo_perfil" required>
                <option value="">Selecione o perfil...</option>
                <option value="I25">I25mm - R$ 6,48</option>
                <option value="I38">I38mm - R$ 7,81</option>
            </select>
            <div class="form-text">I25 usa refor√ßo E (R$ 14,73), I38 usa refor√ßo F (R$ 19,70)</div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="degraus_largura" class="form-label">Largura (mm) *</label>
                <input type="number" step="0.1" class="form-control param-input" id="degraus_largura" name="largura" required min="0">
                <div class="form-text">Largura do degrau em mil√≠metros</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="degraus_comprimento" class="form-label">Comprimento (mm) *</label>
                <input type="number" step="0.1" class="form-control param-input" id="degraus_comprimento" name="comprimento" required min="0">
                <div class="form-text">Comprimento do degrau em mil√≠metros</div>
            </div>
        </div>
        
        <!-- Se√ß√£o de M√£o de Obra -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-tools"></i> M√£o de Obra</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="degraus_tempo_proc" class="form-label">Tempo PROC (h)</label>
                        <input type="number" step="0.1" class="form-control param-input" id="degraus_tempo_proc" name="tempo_proc" value="1.0" min="0">
                        <div class="form-text">Tempo de processamento em horas</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="degraus_tempo_mtg" class="form-label">Tempo MTG (h)</label>
                        <input type="number" step="0.1" class="form-control param-input" id="degraus_tempo_mtg" name="tempo_mtg" value="1.5" min="0">
                        <div class="form-text">Tempo de montagem em horas</div>
                    </div>
                </div>
                <div class="alert alert-info">
                    <small><i class="fas fa-info-circle"></i> M√£o de Obra: Processamento/Montagem - R$ 65,79/hora</small>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <label for="degraus_perda" class="form-label">Percentual de Perda (%)</label>
            <input type="number" step="0.1" class="form-control param-input" id="degraus_perda" name="percentual_perda" value="3.0" min="0" max="100">
            <div class="form-text">Percentual de perda aplicado aos materiais (padr√£o: 3%)</div>
        </div>
        
        <!-- Campo de Unidade de Medida -->
        <div class="mb-3">
            <label for="degraus_unidade" class="form-label">Unidade de Medida *</label>
            <select class="form-select param-input" id="degraus_unidade" name="unidade" required>
                <option value="UN">UN (Unidade)</option>
                <option value="M¬≤">M¬≤ (Metro Quadrado)</option>
                <option value="ML">ML (Metro Linear)</option>
                <option value="KG">KG (Quilograma)</option>
                <option value="PC">PC (Pe√ßa)</option>
                <option value="CJ">CJ (Conjunto)</option>
                <option value="L">L (Litro)</option>
                <option value="M¬≥">M¬≥ (Metro C√∫bico)</option>
            </select>
            <div class="form-text">Define a unidade de medida para o produto final</div>
        </div>
        
        <div class="mt-3 text-center">
            <button type="button" class="btn btn-primary" onclick="calcularDegraus()" id="calcularDegrausBtn">
                <i class="fas fa-calculator"></i> Calcular Degraus
            </button>
        </div>
    `;
    
    console.log('Interface Degraus carregada');
}

function carregarInterfaceDegrauInjetado() {
    console.log('=== CARREGANDO INTERFACE DEGRAU INJETADO ===');
    
    // Limpar estado anterior
    templateAtual = { id: 'degrau_injetado_customizado', tipo: 'degrau_injetado' };
    ultimoCalculo = null;
    
    // Definir valor do select
    document.getElementById('templateSelect').value = 'degrau_injetado_customizado';
    
    // Mostrar descri√ß√£o
    document.getElementById('templateDescription').innerHTML = `
        <h6 class="text-primary">Degrau Injetado</h6>
        <small class="text-muted">Categoria: ESTRUTURAS</small>
        <p class="mt-2 text-info small">
            C√°lculo de degraus usando grade injetada ao inv√©s de perfil I. F√≥rmulas e componentes iguais aos degraus normais.
        </p>
    `;
    
    // Criar campos espec√≠ficos para degrau injetado (similar aos degraus normais)
    const parametrosContainer = document.getElementById('parametrosContainer');
    parametrosContainer.innerHTML = `
        <div class="mb-3">
            <label for="degrau_inj_nome" class="form-label">Nome do Degrau *</label>
            <input type="text" class="form-control param-input" id="degrau_inj_nome" name="nome_degrau" required>
        </div>
        
        <div class="mb-3">
            <label for="degrau_inj_grade" class="form-label">Grade Injetada *</label>
            <select class="form-select param-input" id="degrau_inj_grade" name="grade_injetada" required>
                <option value="">Selecione a grade injetada...</option>
            </select>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="degrau_inj_largura" class="form-label">Largura (mm) *</label>
                    <input type="number" class="form-control param-input" id="degrau_inj_largura" name="largura" step="0.01" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="degrau_inj_comprimento" class="form-label">Comprimento (mm) *</label>
                    <input type="number" class="form-control param-input" id="degrau_inj_comprimento" name="comprimento" step="0.01" required>
                </div>
            </div>
        </div>
        
        <!-- Se√ß√£o de M√£o de Obra -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">M√£o de Obra</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="degrau_inj_tempo_proc" class="form-label">Tempo Processamento (h)</label>
                            <input type="number" class="form-control param-input" id="degrau_inj_tempo_proc" name="tempo_proc" step="0.1" value="1.0">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="degrau_inj_tempo_mtg" class="form-label">Tempo Montagem (h)</label>
                            <input type="number" class="form-control param-input" id="degrau_inj_tempo_mtg" name="tempo_mtg" step="0.1" value="1.5">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <label for="degrau_inj_perda" class="form-label">Perda (%)</label>
            <input type="number" class="form-control param-input" id="degrau_inj_perda" name="percentual_perda" step="0.1" value="3.0" min="0">
        </div>
        
        <!-- Campo de Unidade de Medida -->
        <div class="mb-3">
            <label for="degrau_inj_unidade" class="form-label">Unidade de Medida *</label>
            <select class="form-select param-input" id="degrau_inj_unidade" name="unidade" required>
                <option value="UN">UN (Unidade)</option>
                <option value="M¬≤">M¬≤ (Metro Quadrado)</option>
                <option value="ML">ML (Metro Linear)</option>
                <option value="KG">KG (Quilograma)</option>
                <option value="PC">PC (Pe√ßa)</option>
                <option value="CJ">CJ (Conjunto)</option>
                <option value="L">L (Litro)</option>
                <option value="M¬≥">M¬≥ (Metro C√∫bico)</option>
            </select>
            <div class="form-text">Define a unidade de medida para o produto final</div>
        </div>
        
        <div class="mt-3 text-center">
            <button type="button" class="btn btn-success" onclick="calcularDegrauInjetado()">
                <i class="fas fa-calculator"></i> Calcular Degrau Injetado
            </button>
        </div>
    `;
    
    // Carregar grades injetadas dispon√≠veis
    carregarGradesInjetadasDegrau();
    
    console.log('Interface Degrau Injetado carregada');
}

function carregarGradesInjetadasDegrau() {
    console.log('=== CARREGANDO GRADES INJETADAS PARA DEGRAU ===');
    
    const selectGrade = document.getElementById('degrau_inj_grade');
    if (!selectGrade) {
        console.warn('Select de grade injetada para degrau n√£o encontrado');
        return;
    }
    
    // Buscar grades injetadas via API
    fetch('/api/produtos/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(produtos => {
            console.log(`üì¶ ${produtos.length} produtos carregados da API`);
            
            // Filtrar produtos que s√£o grades injetadas
            const gradesInjetadas = produtos.filter(produto => 
                produto.descricao && 
                produto.descricao.toLowerCase().includes('grade injetada') &&
                produto.descricao.toLowerCase().includes('gi')
            );
            
            console.log(`üîç ${gradesInjetadas.length} grades injetadas encontradas`);
            
            selectGrade.innerHTML = '<option value="">Selecione a grade injetada...</option>';
            
            gradesInjetadas.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade.id;
                option.textContent = `${grade.descricao} - R$ ${(grade.custo_centavos/100).toFixed(2)}/m¬≤`;
                selectGrade.appendChild(option);
                console.log(`‚úì Grade adicionada: ${grade.descricao} - ID ${grade.id}`);
            });
            
        })
        .catch(error => {
            console.error('‚ùå Erro ao carregar grades injetadas:', error);
            selectGrade.innerHTML = '<option value="">Erro ao carregar</option>';
        });
}

function carregarInterfaceGuardaCorpoHorizontal() {
    console.log('=== CARREGANDO INTERFACE GUARDA CORPO - HORIZONTAL ===');
    
    // Limpar estado anterior
    templateAtual = { id: 'guarda_corpo_horizontal_customizado', tipo: 'guarda_corpo_horizontal' };
    ultimoCalculo = null;
    
    // Definir valor do select
    document.getElementById('templateSelect').value = 'guarda_corpo_horizontal_customizado';
    
    // Mostrar descri√ß√£o
    document.getElementById('templateDescription').innerHTML = `
        <h6 class="text-primary">Guarda Corpo - Horizontal</h6>
        <small class="text-muted">Categoria: ESTRUTURAS</small>
        <p class="mt-2 text-info small">
            C√°lculo de guarda corpo horizontal com colunas, barras intermedi√°rias, tubos quadrados, perfis √¥mega e sapatas.
        </p>
    `;
    
    // Criar campos espec√≠ficos para guarda corpo horizontal
    const parametrosContainer = document.getElementById('parametrosContainer');
    parametrosContainer.innerHTML = `
        <div class="mb-3">
            <label for="gc_horiz_nome" class="form-label">Nome do Guarda Corpo *</label>
            <input type="text" class="form-control param-input" id="gc_horiz_nome" name="nome_guarda_corpo" required>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="gc_horiz_larg_modulo" class="form-label">Largura (m) *</label>
                    <input type="number" class="form-control param-input" id="gc_horiz_larg_modulo" name="larg_modulo" step="0.01" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="gc_horiz_altura" class="form-label">Altura (m) *</label>
                    <input type="number" class="form-control param-input" id="gc_horiz_altura" name="altura" step="0.01" required>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="gc_horiz_n_colunas" class="form-label">N¬∫ Colunas *</label>
                    <input type="number" class="form-control param-input" id="gc_horiz_n_colunas" name="n_colunas" min="0.01" step="0.01" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="gc_horiz_n_br_intermediaria" class="form-label">N¬∫ Brr. Intermed.*</label>
                    <input type="number" class="form-control param-input" id="gc_horiz_n_br_intermediaria" name="n_br_intermediaria" min="0" required>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <label for="gc_horiz_tipo_tubo_quad" class="form-label">Tipo de Tubo Quadrado *</label>
            <select class="form-select param-input" id="gc_horiz_tipo_tubo_quad" name="tipo_tubo_quad" required>
                <option value="">Selecione o tipo de tubo quadrado...</option>
                <option value="Tubo Quadrado 50 #6mm">Tubo Quadrado 50 #6mm</option>
                <option value="Tubo Quadrado 50 #4mm">Tubo Quadrado 50 #4mm</option>
                <option value="Tubo Quadrado 50 #3mm">Tubo Quadrado 50 #3mm</option>
            </select>
        </div>
        
        <div class="mb-3">
            <label for="gc_horiz_tipo_omega" class="form-label">Tipo de √îmega *</label>
            <select class="form-select param-input" id="gc_horiz_tipo_omega" name="tipo_omega" required>
                <option value="">Selecione o tipo de √¥mega...</option>
                <option value="PERFIL OMEGA 45X20MM">PERFIL OMEGA 45X20MM</option>
                <option value="Perfil √¥mega 50mm">Perfil √¥mega 50mm</option>
            </select>
        </div>
        
        <div class="mb-3">
            <label for="gc_horiz_tipo_sapata" class="form-label">Tipo de Sapata *</label>
            <select class="form-select param-input" id="gc_horiz_tipo_sapata" name="tipo_sapata" required>
                <option value="">Selecione o tipo de sapata...</option>
                <option value="SAPATA LAMINADA">SAPATA LAMINADA</option>
                <option value="SAPATA INOX 150#3MM">SAPATA INOX 150#3MM</option>
            </select>
        </div>
        
        <!-- Se√ß√£o de M√£o de Obra -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">M√£o de Obra</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="gc_horiz_tempo_proc" class="form-label">Tempo Processamento (h)</label>
                            <input type="number" class="form-control param-input" id="gc_horiz_tempo_proc" name="tempo_proc" step="0.1" value="2.0">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="gc_horiz_tempo_mtg" class="form-label">Tempo Montagem (h)</label>
                            <input type="number" class="form-control param-input" id="gc_horiz_tempo_mtg" name="tempo_mtg" step="0.1" value="3.0">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <label for="gc_horiz_perda" class="form-label">Perda (%)</label>
            <input type="number" class="form-control param-input" id="gc_horiz_perda" name="percentual_perda" step="0.1" value="3.0" min="0">
        </div>
        
        <!-- Campo de Unidade de Medida -->
        <div class="mb-3">
            <label for="gc_horiz_unidade" class="form-label">Unidade de Medida *</label>
            <select class="form-select param-input" id="gc_horiz_unidade" name="unidade" required>
                <option value="ML">ML (Metro Linear)</option>
                <option value="M¬≤">M¬≤ (Metro Quadrado)</option>
                <option value="UN">UN (Unidade)</option>
                <option value="KG">KG (Quilograma)</option>
                <option value="PC">PC (Pe√ßa)</option>
                <option value="CJ">CJ (Conjunto)</option>
                <option value="L">L (Litro)</option>
                <option value="M¬≥">M¬≥ (Metro C√∫bico)</option>
            </select>
            <div class="form-text">Define a unidade de medida para o produto final</div>
        </div>
        
        <div class="mt-3 text-center">
            <button type="button" class="btn btn-success" onclick="calcularGuardaCorpoHorizontal()">
                <i class="fas fa-calculator"></i> Calcular Guarda Corpo
            </button>
        </div>
    `;
    
    console.log('Interface Guarda Corpo - Horizontal carregada');
}

function carregarInterfaceEscada() {
    console.log('=== CARREGANDO INTERFACE ESCADA ===');
    
    // Limpar estado anterior
    templateAtual = { id: 'escada_customizado', tipo: 'escada' };
    ultimoCalculo = null;
    
    // Definir valor do select
    document.getElementById('templateSelect').value = 'escada_customizado';
    
    // Mostrar descri√ß√£o
    document.getElementById('templateDescription').innerHTML = `
        <h6 class="text-primary">Escada</h6>
        <small class="text-muted">Categoria: ESTRUTURAS</small>
        <p class="mt-2 text-info small">
            C√°lculo de escada com componentes customiz√°veis incluindo arcos, sa√≠da para piscina, portinhola e t√∫nel.
        </p>
    `;
    
    // Criar campos espec√≠ficos para escada
    const parametrosContainer = document.getElementById('parametrosContainer');
    parametrosContainer.innerHTML = `
        <div class="mb-3">
            <label for="escada_nome" class="form-label">Nome da Escada *</label>
            <input type="text" class="form-control param-input" id="escada_nome" name="nome_escada" required>
        </div>
        
        <div class="mb-3">
            <label for="escada_comprimento" class="form-label">Comprimento da Escada (m) *</label>
            <input type="number" class="form-control param-input" id="escada_comprimento" name="comprimento_escada" step="0.01" min="0.1" required>
            <div class="form-text">Comprimento total da escada em metros</div>
        </div>
        
        <div class="mb-3">
            <label for="escada_arco_guarda_corpo" class="form-label">Arco de Guarda Corpo</label>
            <select class="form-select param-input" id="escada_arco_guarda_corpo" name="arco_guarda_corpo">
                <option value="">Selecione um arco (opcional)...</option>
            </select>
            <div class="form-text">Arcos dispon√≠veis ser√£o carregados automaticamente</div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input param-input" type="checkbox" id="escada_saida_piscina" name="saida_piscina" value="1">
                        <label class="form-check-label" for="escada_saida_piscina">
                            <strong>Sa√≠da Piscina</strong>
                        </label>
                        <div class="form-text">Adicionar componentes espec√≠ficos para sa√≠da de piscina</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input param-input" type="checkbox" id="escada_portinhola" name="portinhola" value="1">
                        <label class="form-check-label" for="escada_portinhola">
                            <strong>Portinhola</strong>
                        </label>
                        <div class="form-text">Incluir portinhola na escada</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <div class="form-check">
                <input class="form-check-input param-input" type="checkbox" id="escada_tunel_2000mm" name="tunel_2000mm" value="1">
                <label class="form-check-label" for="escada_tunel_2000mm">
                    <strong>T√∫nel 2000MM</strong>
                </label>
                <div class="form-text">Adicionar t√∫nel de 2000mm √† escada</div>
            </div>
        </div>
        
        <!-- Se√ß√£o de M√£o de Obra -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0">M√£o de Obra</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="escada_tempo_proc" class="form-label">Tempo Processamento (h)</label>
                            <input type="number" class="form-control param-input" id="escada_tempo_proc" name="tempo_proc" step="0.1" value="3.0">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="escada_tempo_mtg" class="form-label">Tempo Montagem (h)</label>
                            <input type="number" class="form-control param-input" id="escada_tempo_mtg" name="tempo_mtg" step="0.1" value="2.0">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Campo de Unidade de Medida -->
        <div class="mb-3">
            <label for="escada_unidade" class="form-label">Unidade de Medida *</label>
            <select class="form-select param-input" id="escada_unidade" name="unidade" required>
                <option value="UN">UN (Unidade)</option>
                <option value="ML">ML (Metro Linear)</option>
                <option value="M¬≤">M¬≤ (Metro Quadrado)</option>
                <option value="KG">KG (Quilograma)</option>
                <option value="PC">PC (Pe√ßa)</option>
                <option value="CJ">CJ (Conjunto)</option>
                <option value="L">L (Litro)</option>
                <option value="M¬≥">M¬≥ (Metro C√∫bico)</option>
            </select>
            <div class="form-text">Define a unidade de medida para o produto final</div>
        </div>
        
        <!-- Bot√£o de c√°lculo -->
        <div class="d-grid gap-2">
            <button type="button" class="btn btn-primary" onclick="calcularEscada()" id="calcularEscadaBtn">
                <i class="fas fa-calculator"></i> Calcular Escada
            </button>
        </div>
    `;
    
    // Carregar arcos dispon√≠veis
    carregarArcosDisponiveis();
    
    console.log('Interface Escada carregada');
}

function carregarArcosDisponiveis() {
    console.log('Carregando arcos dispon√≠veis...');
    
    const select = document.getElementById('escada_arco_guarda_corpo');
    
    // Limpar completamente o select e remover qualquer valor selecionado
    select.innerHTML = '<option value="">Selecione um arco (opcional)...</option>';
    select.value = '';
    
    // Buscar produtos que contenham "arco" na descri√ß√£o
    fetch(apiProdutos)
        .then(res => res.json())
        .then(produtos => {
            
            // Filtrar produtos que contenham "arco" no nome (case insensitive) e tenham dados v√°lidos
            const arcos = produtos.filter(produto => {
                const temDescricao = produto.descricao && produto.descricao.toLowerCase().includes('arco');
                const temId = produto.id && !isNaN(produto.id) && produto.id > 0;
                const temCusto = produto.custo_centavos !== undefined && produto.custo_centavos !== null;
                
                if (temDescricao && temId && temCusto) {
                    console.log(`‚úÖ Arco v√°lido encontrado: ID ${produto.id} - ${produto.descricao}`);
                    return true;
                } else if (temDescricao) {
                    console.warn(`‚ùå Arco com dados inv√°lidos: ID ${produto.id} - ${produto.descricao}`, {
                        temId,
                        temCusto,
                        produto
                    });
                }
                return false;
            });
            
            // Limpar options existentes (garantir que n√£o h√° valores antigos)
            select.innerHTML = '<option value="">Selecione um arco (opcional)...</option>';
            select.value = '';
            
            // Adicionar arcos encontrados
            arcos.forEach(arco => {
                // Valida√ß√£o adicional antes de adicionar
                if (arco.id && arco.descricao && arco.custo_centavos !== undefined) {
                    const option = document.createElement('option');
                    option.value = arco.id;
                    option.textContent = `${arco.descricao} - R$ ${(arco.custo_centavos / 100).toFixed(2)}`;
                    select.appendChild(option);
                    console.log(`Arco adicionado ao select: ID ${arco.id}`);
                } else {
                    console.warn(`Arco rejeitado para o select: ID ${arco.id}`, arco);
                }
            });
            
            console.log(`${arcos.length} arcos carregados`);
        })
        .catch(error => {
            console.error('Erro ao carregar arcos:', error);
        });
}

function carregarInterfaceTampaMontada() {
    console.log('=== CARREGANDO INTERFACE TAMPA MONTADA ===');
    
    // Limpar estado anterior
    templateAtual = { id: 'tampa_montada_customizado', tipo: 'tampa_montada' };
    ultimoCalculo = null;
    
    // Selecionar o template correto
    document.getElementById('templateSelect').value = 'tampa_montada_customizado';
    
    // Mostrar descri√ß√£o
    document.getElementById('templateDescription').innerHTML = `
        <h6 class="text-primary">Tampa Montada</h6>
        <small class="text-muted">Categoria: PRODUTO_FINAL</small>
    `;
    
    // Criar campos espec√≠ficos para tampa montada
    const parametrosContainer = document.getElementById('parametrosContainer');
    parametrosContainer.innerHTML = `
        <div class="mb-3">
            <label for="tampa_nome" class="form-label">Nome da Tampa *</label>
            <input type="text" class="form-control param-input" id="tampa_nome" name="nome_tampa" required>
        </div>
        
        <div class="mb-3">
            <label for="tampa_vao" class="form-label">V√£o (mm) *</label>
            <input type="number" step="0.1" class="form-control param-input" id="tampa_vao" name="vao" required min="0">
            <div class="form-text">V√£o da tampa em mil√≠metros</div>
        </div>
        
        <div class="mb-3">
            <label for="tampa_comprimento" class="form-label">Comprimento (mm) *</label>
            <input type="number" step="0.1" class="form-control param-input" id="tampa_comprimento" name="comprimento" required min="0">
            <div class="form-text">Comprimento total da tampa em mil√≠metros</div>
        </div>
        
        <div class="mb-3">
            <label for="tampa_eixo_i" class="form-label">Eixo I (mm) *</label>
            <input type="number" step="0.1" class="form-control param-input" id="tampa_eixo_i" name="eixo_i" required min="0">
            <div class="form-text">Dist√¢ncia entre perfis em mil√≠metros</div>
        </div>
        
        <div class="mb-3">
            <label for="tampa_perfil" class="form-label">Selecione o Perfil *</label>
            <select class="form-select param-input" id="tampa_perfil" name="perfil_id" required>
                <option value="">Carregando perfis...</option>
            </select>
        </div>
        
        <div class="mb-3">
            <label for="tampa_perda" class="form-label">Perda (%)</label>
            <input type="number" step="0.1" class="form-control param-input" id="tampa_perda" name="perda" value="5" min="0" max="100">
            <div class="form-text">Percentual de perda dos materiais (padr√£o: 3%)</div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="tampa_tempo_proc" class="form-label">Tempo Processamento (h)</label>
                    <input type="number" step="0.1" class="form-control param-input" id="tampa_tempo_proc" name="tempo_proc" value="0.7" min="0">
                    <div class="form-text">Tempo de processamento em horas</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="tampa_tempo_mtg" class="form-label">Tempo Montagem (h)</label>
                    <input type="number" step="0.1" class="form-control param-input" id="tampa_tempo_mtg" name="tempo_mtg" value="0.3" min="0">
                    <div class="form-text">Tempo de montagem em horas</div>
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="tampa_quadro_u4" name="quadro_u4">
                <label class="form-check-label" for="tampa_quadro_u4">
                    Incluir Quadro U4" (2 unidades)
                </label>
            </div>
        </div>
        
        <div class="mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="tampa_alca" name="alca">
                <label class="form-check-label" for="tampa_alca">
                    Incluir Al√ßas (2 unidades)
                </label>
            </div>
        </div>
        
        <div class="mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="tampa_chapa_ev" name="chapa_ev">
                <label class="form-check-label" for="tampa_chapa_ev">
                    Incluir Chapa EV
                </label>
            </div>
        </div>
        
        <!-- Campo de Unidade de Medida -->
        <div class="mb-3">
            <label for="tampa_unidade" class="form-label">Unidade de Medida *</label>
            <select class="form-select param-input" id="tampa_unidade" name="unidade" required>
                <option value="M¬≤">M¬≤ (Metro Quadrado)</option>
                <option value="ML">ML (Metro Linear)</option>
                <option value="UN">UN (Unidade)</option>
                <option value="KG">KG (Quilograma)</option>
                <option value="PC">PC (Pe√ßa)</option>
                <option value="CJ">CJ (Conjunto)</option>
                <option value="L">L (Litro)</option>
                <option value="M¬≥">M¬≥ (Metro C√∫bico)</option>
            </select>
            <div class="form-text">Define a unidade de medida para o produto final</div>
        </div>
        
        <div class="d-grid gap-2">
            <button type="button" class="btn btn-primary" onclick="calcularTampaMontada()" id="calcularTampaBtn">
                <i class="fas fa-calculator"></i> Calcular Tampa Montada
            </button>
        </div>
    `;
    
    // Habilitar bot√£o calcular
    const calcularBtn = document.getElementById('calcularBtn');
    if (calcularBtn) {
        calcularBtn.disabled = false;
    }
    
    // Carregar perfis dispon√≠veis
    carregarPerfisTampa();
    
    console.log('Interface Tampa Montada carregada com campos extras');
}

function carregarPerfisTampa() {
    console.log('=== CARREGANDO PERFIS PARA TAMPA MONTADA ===');
    
    const selectPerfil = document.getElementById('tampa_perfil');
    if (!selectPerfil) {
        console.warn('Select de perfil n√£o encontrado');
        return;
    }
    
    // Buscar perfis I25, I32, I38, TRAV via API
    fetch('/api/produtos/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(produtos => {
            console.log(`‚úÖ ${produtos.length} produtos carregados da API`);
            
            // Filtrar perfis I25, I32, I38 e TRAV (excluir porca sextavada)
            const perfis = produtos.filter(p => {
                const desc = p.descricao ? p.descricao.toLowerCase() : '';
                const incluiPerfil = desc.includes('i25') || desc.includes('i32') || desc.includes('i38') || desc.includes('trav');
                const excluirPorca = desc.includes('por-sxt') || desc.includes('travante') || desc.includes('porca');
                return incluiPerfil && !excluirPorca;
            });
            
            console.log(`‚úÖ ${perfis.length} perfis encontrados:`, perfis.map(p => `${p.id}: ${p.descricao}`));
            
            // Limpar op√ß√µes atuais
            selectPerfil.innerHTML = '<option value="">Selecione um perfil...</option>';
            
            // Adicionar op√ß√µes dos perfis
            perfis.forEach(perfil => {
                const option = document.createElement('option');
                option.value = perfil.id;
                option.textContent = `${perfil.descricao} - ${perfil.peso_und}kg - R$ ${(perfil.custo_centavos/100).toFixed(2)}`;
                selectPerfil.appendChild(option);
            });
            
            if (perfis.length === 0) {
                selectPerfil.innerHTML = '<option value="">Nenhum perfil I25/I32/I38/TRAV encontrado</option>';
            }
        })
        .catch(error => {
            console.error('‚ùå Erro ao carregar perfis:', error);
            // Fallback com perfis b√°sicos
            selectPerfil.innerHTML = `
                <option value="">Erro ao carregar perfis</option>
                <option value="1331">I25mm Leve - 0.298kg (fallback)</option>
                <option value="1328">I25mm - 0.497kg (fallback)</option>
                <option value="1329">I32mm - 0.539kg (fallback)</option>
                <option value="1330">I38mm - 0.590kg (fallback)</option>
            `;
        });
}

function calcularGrade() {
    console.log('=== CALCULANDO GRADE ===');
    
    // Verificar se todos os campos obrigat√≥rios est√£o preenchidos
    const camposObrigatorios = [
        'grade_nome', 'grade_vao', 'grade_comprimento', 'grade_eixo_i', 'grade_perfil'
    ];
    
    let todosCamposPreenchidos = true;
    const dados = {};
    
    camposObrigatorios.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (!elemento || !elemento.value.trim()) {
            todosCamposPreenchidos = false;
            console.warn(`Campo ${campo} n√£o preenchido`);
            return;
        }
        
        const valor = elemento.value.trim();
        if (campo === 'grade_nome') {
            dados[elemento.name] = valor;
        } else {
            dados[elemento.name] = parseFloat(valor) || 0;
        }
    });
    
    if (!todosCamposPreenchidos) {
        alert('Por favor, preencha todos os campos obrigat√≥rios.');
        return;
    }
    
    // Coletar dados opcionais
    const perdaElement = document.getElementById('grade_perda');
    dados.perda = perdaElement ? (parseFloat(perdaElement.value) || 3) : 3;
    
    const tempoProc = document.getElementById('grade_tempo_proc');
    dados.tempo_proc = tempoProc ? (parseFloat(tempoProc.value) || 1.5) : 1.5;
    
    const tempoMtg = document.getElementById('grade_tempo_mtg');  
    dados.tempo_mtg = tempoMtg ? (parseFloat(tempoMtg.value) || 0.5) : 0.5;
    
    console.log('Dados coletados:', dados);
    console.log('DEBUG - Campos dos dados:', Object.keys(dados));
    console.log('DEBUG - dados.perfil_id:', dados.perfil_id);
    console.log('DEBUG - dados.nome_grade:', dados.nome_grade);
    console.log('DEBUG - dados.vao:', dados.vao);
    console.log('DEBUG - dados.comprimento:', dados.comprimento);
    console.log('DEBUG - dados.eixo_i:', dados.eixo_i);
    
    // Buscar dados dos produtos
    fetch('/api/produtos/')
        .then(response => response.json())
        .then(produtos => {
            console.log('‚úÖ Produtos carregados da base');
            console.log('DEBUG - Total de produtos:', produtos.length);
            
            // Encontrar o perfil selecionado
            console.log('DEBUG - Procurando perfil com ID:', dados.perfil_id);
            const perfilSelecionado = produtos.find(p => p.id == dados.perfil_id);
            console.log('DEBUG - Perfil encontrado:', perfilSelecionado);
            if (!perfilSelecionado) {
                throw new Error(`Perfil ID ${dados.perfil_id} n√£o encontrado`);
            }
            
            // Encontrar a chaveta (ID fixo 1332)
            const chaveta = produtos.find(p => p.id == 1332);
            if (!chaveta) {
                throw new Error('Perfil Chaveta (ID 1332) n√£o encontrado no banco');
            }
            
            // Encontrar a cola (ID fixo 1183)
            const cola = produtos.find(p => p.id == 1183);
            if (!cola) {
                throw new Error('COLA ESTRUTURAL 4500 A/B (ID 1183) n√£o encontrada no banco');
            }
            
            // Encontrar m√£o de obra processamento/montagem
            const maoObraProcessamento = produtos.find(p => 
                p.descricao && 
                p.descricao.toLowerCase().includes('m√£o de obra') && 
                p.descricao.toLowerCase().includes('processamento')
            );
            if (!maoObraProcessamento) {
                throw new Error('Produto de m√£o de obra Processamento/Montagem n√£o encontrado no banco');
            }
            
            console.log(`üìê Perfil selecionado: ${perfilSelecionado.descricao}`);
            console.log(`   ‚Ä¢ Peso: ${perfilSelecionado.peso_und} kg/m (tipo: ${typeof perfilSelecionado.peso_und})`);
            console.log(`   ‚Ä¢ Custo: R$ ${(perfilSelecionado.custo_centavos/100).toFixed(2)}/m`);
            
            console.log(`üîß Chaveta inclu√≠da: ${chaveta.descricao}`);
            console.log(`   ‚Ä¢ Peso: ${chaveta.peso_und} kg/m (tipo: ${typeof chaveta.peso_und})`);
            console.log(`   ‚Ä¢ Custo: R$ ${(chaveta.custo_centavos/100).toFixed(2)}/m`);
            
            console.log(`üß¥ Cola inclu√≠da: ${cola.descricao}`);
            console.log(`   ‚Ä¢ Peso: ${cola.peso_und} kg/unid (tipo: ${typeof cola.peso_und})`);
            console.log(`   ‚Ä¢ Custo: R$ ${(cola.custo_centavos/100).toFixed(2)}/unid`);
            
            // APLICAR F√ìRMULA: (((comprimento/eixo i)*v√£o/1000)* peso do perfil)
            const metrosLinearesPorM2 = (dados.comprimento / dados.eixo_i) * (dados.vao / 1000);
            
            // Calcular para o perfil - CONVERTER STRINGS PARA N√öMEROS
            const pesoPerfilKg = metrosLinearesPorM2 * parseFloat(perfilSelecionado.peso_und);
            const custoPerfilCentavos = metrosLinearesPorM2 * perfilSelecionado.custo_centavos;
            
            // Calcular para a chaveta - F√ìRMULA ESPEC√çFICA: v√£o / 150 * 2 * pre√ßo do perfil
            const quantidadeChaveta = (dados.vao / 150) * 2;
            const pesoChaveta = quantidadeChaveta * parseFloat(chaveta.peso_und);
            const custoChaveta = quantidadeChaveta * chaveta.custo_centavos;
            
            // Calcular para a cola - F√ìRMULA: quantidade fixa 0.06 unid/m¬≤
            const quantidadeCola = 0.06; // Quantidade fixa
            const pesoCola = quantidadeCola * parseFloat(cola.peso_und);
            const custoCola = quantidadeCola * cola.custo_centavos;
            
            // Aplicar perda aos materiais
            const fatorPerda = 1 + (dados.perda / 100);
            
            // Calcular m√£o de obra - R$ 65.79/hora
            const valorHoraMO = 65.79; // R$/hora
            const tempoTotal = dados.tempo_proc + dados.tempo_mtg;
            const custoMaoObraTotal = tempoTotal * valorHoraMO * 100; // em centavos
            const maoObraDescricao = `Processamento/Montagem (${tempoTotal}h)`;
            
            console.log(`üíº M√£o de Obra: ${maoObraDescricao} - R$ ${(custoMaoObraTotal/100).toFixed(2)}/m¬≤`);
            
            // CUSTO TOTAL = Materiais com perda + M√£o de obra (sem perda)
            let pesoTotalKg = (pesoPerfilKg + pesoChaveta + pesoCola) * fatorPerda;
            let custoTotalCentavos = (custoPerfilCentavos + custoChaveta + custoCola) * fatorPerda + custoMaoObraTotal;
            
            console.log('\nüßÆ C√ÅLCULO DETALHADO:');
            console.log(`Perfil - F√≥rmula: (${dados.comprimento}/${dados.eixo_i}) * (${dados.vao}/1000)`);
            console.log(`Perfil - Metros lineares/m¬≤: ${metrosLinearesPorM2.toFixed(4)} m/m¬≤`);
            console.log(`Perfil - Peso: ${pesoPerfilKg.toFixed(3)} kg/m¬≤ | Custo: R$ ${(custoPerfilCentavos/100).toFixed(2)}/m¬≤`);
            console.log(`Chaveta - F√≥rmula: (${dados.vao}/150) * 2`);
            console.log(`Chaveta - Quantidade: ${quantidadeChaveta.toFixed(4)} m/m¬≤`);
            console.log(`Chaveta - Peso: ${pesoChaveta.toFixed(3)} kg/m¬≤ | Custo: R$ ${(custoChaveta/100).toFixed(2)}/m¬≤`);
            console.log(`Cola - F√≥rmula: 0.06 unid/m¬≤ (quantidade fixa)`);
            console.log(`Cola - Quantidade: ${quantidadeCola.toFixed(4)} unid/m¬≤`);
            console.log(`Cola - Peso: ${pesoCola.toFixed(3)} kg/m¬≤ | Custo: R$ ${(custoCola/100).toFixed(2)}/m¬≤`);
            console.log(`\nüí∞ RESUMO DE CUSTOS:`);
            console.log(`   Materiais (com ${dados.perda}% perda): R$ ${((custoPerfilCentavos + custoChaveta + custoCola) * fatorPerda/100).toFixed(2)}/m¬≤`);
            console.log(`   M√£o de Obra (sem perda): R$ ${(custoMaoObraTotal/100).toFixed(2)}/m¬≤`);
            console.log(`   TOTAL FINAL: R$ ${(custoTotalCentavos/100).toFixed(2)}/m¬≤ | Peso: ${pesoTotalKg.toFixed(3)} kg/m¬≤`);
            
            console.log('\nüîç DEBUG CUSTOS INDIVIDUAIS:');
            console.log(`Perfil com perda: ${custoPerfilCentavos * fatorPerda} centavos`);
            console.log(`Chaveta com perda: ${custoChaveta * fatorPerda} centavos`);
            console.log(`Cola com perda: ${custoCola * fatorPerda} centavos`);
            console.log(`M√£o de obra (sem perda): ${custoMaoObraTotal} centavos`);
            
            // Criar resultado final
            const resultado = {
                success: true,
                nome_produto: dados.nome_grade,
                custo_total: custoTotalCentavos,
                peso_total: pesoTotalKg,
                metros_lineares_por_m2: metrosLinearesPorM2,
                mao_obra_produto_id: maoObraProcessamento.id, // Adicionar ID do produto de m√£o de obra
                componentes: [
                    {
                        nome: `${perfilSelecionado.descricao} (com ${dados.perda}% perda)`,
                        produto_nome: perfilSelecionado.descricao,
                        quantidade: metrosLinearesPorM2 * fatorPerda, // Quantidade COM perda para exibi√ß√£o
                        custo_unitario: perfilSelecionado.custo_centavos,
                        custo_total: custoPerfilCentavos * fatorPerda,
                        unidade: 'm'
                    },
                    {
                        nome: `${chaveta.descricao} (com ${dados.perda}% perda)`,
                        produto_nome: chaveta.descricao,
                        quantidade: quantidadeChaveta * fatorPerda, // Quantidade COM perda para exibi√ß√£o
                        custo_unitario: chaveta.custo_centavos,
                        custo_total: custoChaveta * fatorPerda,
                        unidade: 'm'
                    },
                    {
                        nome: `${cola.descricao} (com ${dados.perda}% perda)`,
                        produto_nome: cola.descricao,
                        quantidade: quantidadeCola * fatorPerda, // Quantidade COM perda para exibi√ß√£o
                        custo_unitario: cola.custo_centavos,
                        custo_total: custoCola * fatorPerda,
                        unidade: 'unid'
                    }
                ]
            };
            
            // Adicionar m√£o de obra aos componentes
            if (custoMaoObraTotal > 0) {
                resultado.componentes.push({
                nome: maoObraDescricao,
                produto_nome: maoObraDescricao,
                quantidade: dados.tempo_proc + dados.tempo_mtg,
                custo_unitario: valorHoraMO * 100, // R$ 65.79/hora em centavos
                custo_total: custoMaoObraTotal,
                unidade: 'h'
                });
            }
            
            // Debug final: verificar soma dos componentes
            const somaComponentes = resultado.componentes.reduce((total, comp) => total + comp.custo_total, 0);
            console.log(`\nüîé VERIFICA√á√ÉO FINAL:`);
            console.log(`Custo total calculado: ${custoTotalCentavos} centavos = R$ ${(custoTotalCentavos/100).toFixed(2)}`);
            console.log(`Soma dos componentes: ${somaComponentes} centavos = R$ ${(somaComponentes/100).toFixed(2)}`);
            console.log(`Diferen√ßa: ${Math.abs(custoTotalCentavos - somaComponentes)} centavos = R$ ${(Math.abs(custoTotalCentavos - somaComponentes)/100).toFixed(2)}`);
            
            // Atualizar o custo_total do resultado com a soma correta dos componentes
            resultado.custo_total = somaComponentes;
            
            // Salvar resultado globalmente
            ultimoCalculo = resultado;
            
            // Mostrar resultado na interface
            document.getElementById('nomeProdutoCalculado').textContent = dados.nome_grade;
            document.getElementById('custoTotalCalculado').textContent = `R$ ${(custoTotalCentavos / 100).toFixed(2)}/m¬≤`;
            document.getElementById('pesoTotalCalculado').textContent = `${pesoTotalKg.toFixed(3)} kg/m¬≤`;
            document.getElementById('resultadoCalculado').style.display = 'block';
            
            // Preencher tabela de componentes
            preencherTabelaComponentesGrade(resultado);
            
            // Habilitar bot√£o salvar
            document.getElementById('salvarProdutoBtn').disabled = false;
            
            console.log('‚úÖ C√°lculo de grade conclu√≠do:', resultado);
        })
        .catch(error => {
            console.error('‚ùå Erro ao calcular grade:', error);
            alert('Erro ao calcular grade: ' + error.message);
        });
}

function preencherTabelaComponentesGrade(resultado) {
    console.log('=== PREENCHENDO TABELA DE COMPONENTES PARA GRADE ===');
    
    const tbody = document.getElementById('componentesCalculadosTable');
    if (!tbody) {
        console.warn('Tabela componentesCalculadosTable n√£o encontrada');
        return;
    }
    
    // Limpar tabela
    tbody.innerHTML = '';
    
    // Adicionar linha para cada componente
    resultado.componentes.forEach((comp, index) => {
        const row = tbody.insertRow();
        
        // Componentes de grade n√£o t√™m fator edit√°vel
        const fatorCol = '<span class="text-muted">-</span>';
        const acaoCol = '<span class="text-muted">-</span>';
        
        row.innerHTML = `
            <td>${comp.nome || 'N/A'}</td>
            <td>${comp.produto_nome || 'N/A'}</td>
            <td>${fatorCol}</td>
            <td><span class="quantidade-display">${comp.quantidade ? comp.quantidade.toFixed(4) : '0.0000'}</span></td>
            <td>R$ ${comp.custo_unitario ? (comp.custo_unitario/100).toFixed(2) : '0.00'}</td>
            <td><span class="custo-total-display">R$ ${comp.custo_total ? (comp.custo_total/100).toFixed(2) : '0.00'}</span></td>
            <td>${acaoCol}</td>`;
        
        console.log(`‚úì Componente adicionado: ${comp.nome} - ${comp.quantidade.toFixed(4)} ${comp.unidade || 'm'}`);
    });
    
    // Adicionar linha de total
    const totalRow = tbody.insertRow();
    const custoTotalGeral = resultado.componentes.reduce((total, comp) => total + comp.custo_total, 0);
    totalRow.innerHTML = `
        <td colspan="5"><strong>TOTAL GERAL</strong></td>
        <td><strong>R$ ${(custoTotalGeral/100).toFixed(2)}</strong></td>
        <td></td>`;
    totalRow.style.backgroundColor = '#f8f9fa';
    
    console.log(`‚úÖ Tabela preenchida com ${resultado.componentes.length} componentes. Total: R$ ${(custoTotalGeral/100).toFixed(2)}`);
}

function calcularTampaInjetada() {
    console.log('=== CALCULANDO TAMPA INJETADA ===');
    
    // Verificar se todos os campos obrigat√≥rios est√£o preenchidos
    const camposObrigatorios = [
        'tampa_inj_nome', 'tampa_inj_vao', 'tampa_inj_comprimento', 'tampa_inj_grade'
    ];
    
    let todosCamposPreenchidos = true;
    const dados = {};
    
    camposObrigatorios.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (!elemento || !elemento.value.trim()) {
            todosCamposPreenchidos = false;
            console.warn(`Campo ${campo} n√£o preenchido`);
            return;
        }
        
        const valor = elemento.value.trim();
        if (campo === 'tampa_inj_nome') {
            dados.nome_tampa = valor;
        } else if (campo === 'tampa_inj_grade') {
            dados.grade_id = parseInt(valor);
        } else {
            const nomeLimpo = campo.replace('tampa_inj_', '');
            dados[nomeLimpo] = parseFloat(valor);
        }
    });
    
    // Campos opcionais
    dados.perda = parseFloat(document.getElementById('tampa_inj_perda').value) || 5;
    dados.tempo_proc = parseFloat(document.getElementById('tampa_inj_tempo_proc').value) || 0.3;
    dados.tempo_mtg = parseFloat(document.getElementById('tampa_inj_tempo_mtg').value) || 0.3;
    dados.quadro_u4 = document.getElementById('tampa_inj_quadro_u4').checked;
    dados.alca = document.getElementById('tampa_inj_alca').checked;
    dados.chapa_ev = document.getElementById('tampa_inj_chapa_ev').checked;
    dados.unidade = document.getElementById('tampa_inj_unidade').value || 'M¬≤'; // Unidade selecionada
    dados.tipo_calculo = 'tampa_injetada';
    
    if (!todosCamposPreenchidos) {
        alert('Por favor, preencha todos os campos obrigat√≥rios (marcados com *).');
        return;
    }
    
    console.log('Dados da tampa injetada:', dados);
    
    // Buscar produtos necess√°rios
    fetch('/api/produtos/')
        .then(response => response.json())
        .then(produtos => {
            console.log(`‚úÖ ${produtos.length} produtos carregados da API`);
            
            // Encontrar grade injetada selecionada
            const gradeSelecionada = produtos.find(p => p.id === dados.grade_id);
            if (!gradeSelecionada) {
                throw new Error(`Grade injetada com ID ${dados.grade_id} n√£o encontrada`);
            }
            
            // Encontrar cola estrutural (sempre ID 1183)
            const cola = produtos.find(p => p.id === 1183);
            if (!cola) {
                throw new Error('COLA ESTRUTURAL 4500 A/B (ID 1183) n√£o encontrada no banco');
            }
            
            // Encontrar chapa 2,5mm (buscar por descri√ß√£o)
            const chapa25 = produtos.find(p => 
                p.descricao && 
                p.descricao.toLowerCase().includes('chapa') && 
                p.descricao.toLowerCase().includes('2,5')
            );
            if (!chapa25) {
                throw new Error('Chapa 2,5mm n√£o encontrada no banco');
            }
            
            // Encontrar perfil U4" (se necess√°rio)
            let perfilU4 = null;
            if (dados.quadro_u4) {
                perfilU4 = produtos.find(p => 
                    p.descricao && 
                    p.descricao.toLowerCase().includes('u4')
                );
                if (!perfilU4) {
                    throw new Error('Perfil U4" n√£o encontrado no banco');
                }
            }
            
            // Encontrar al√ßa (se necess√°rio)
            let alca = null;
            if (dados.alca) {
                alca = produtos.find(p => 
                    p.descricao && 
                    p.descricao.toLowerCase().includes('al√ßa')
                );
                if (!alca) {
                    throw new Error('Al√ßa n√£o encontrada no banco');
                }
            }
            
            // Encontrar m√£o de obra processamento/montagem
            const maoObraProcessamento = produtos.find(p => 
                p.descricao && 
                p.descricao.toLowerCase().includes('m√£o de obra') && 
                p.descricao.toLowerCase().includes('processamento')
            );
            if (!maoObraProcessamento) {
                throw new Error('Produto de m√£o de obra Processamento/Montagem n√£o encontrado no banco');
            }
            
            console.log(`üìã Grade selecionada: ${gradeSelecionada.descricao}`);
            console.log(`üß¥ Cola inclu√≠da: ${cola.descricao}`);
            console.log(`üìã Chapa 2,5mm: ${chapa25.descricao}`);
            if (perfilU4) console.log(`üî≤ Perfil U4": ${perfilU4.descricao}`);
            if (alca) console.log(`üéØ Al√ßa: ${alca.descricao}`);
            
            // APLICAR F√ìRMULAS DA TAMPA INJETADA
            const fatorPerda = 1 + (dados.perda / 100);
            
            // 1. Grade injetada - √°rea √ó pre√ßo/m¬≤
            const areaTampa = (dados.vao / 1000) * (dados.comprimento / 1000); // em m¬≤
            const pesoGrade = areaTampa * gradeSelecionada.peso_und;
            let custoGradeCentavos = areaTampa * gradeSelecionada.custo_centavos;
            
            // 2. Cola - 0,1 * custo da cola
            const quantidadeCola = 0.1;
            const pesoCola = quantidadeCola * cola.peso_und;
            let custoCola = quantidadeCola * cola.custo_centavos;
            
            // 3. Chapa 2,5mm - √°rea √ó custo chapa (em m¬≤)
            const areaChapa = (dados.vao / 1000) * (dados.comprimento / 1000); // em m¬≤
            const pesoChapa25 = areaChapa * chapa25.peso_und;
            
            // AJUSTE ESPECIAL: Se Chapa EV marcada, usar valor fixo R$ 277,50
            let custoChapa25;
            let nomeChapa, descricaoChapa;
            if (dados.chapa_ev) {
                custoChapa25 = 27750; // R$ 277,50 em centavos (valor fixo quando EV marcada)
                nomeChapa = "Chapa EV - Res. Poli√©ster";
                descricaoChapa = "Chapa EV - Res. Poli√©ster";
                console.log(`üîß CHAPA EV MARCADA: Custo da chapa alterado para R$ 277,50 (fixo)`);
            } else {
                custoChapa25 = areaChapa * chapa25.custo_centavos; // C√°lculo normal
                nomeChapa = chapa25.descricao;
                descricaoChapa = chapa25.descricao;
            }
            
            // 4. Quadro U4" - se 'sim' custo perfil u4 * 2
            let pesoU4 = 0, custoU4 = 0;
            if (dados.quadro_u4 && perfilU4) {
                pesoU4 = 2 * perfilU4.peso_und;
                custoU4 = 2 * perfilU4.custo_centavos;
            }
            
            // 5. Al√ßa - se sim custo da al√ßa * 2
            let pesoAlca = 0, custoAlca = 0;
            if (dados.alca && alca) {
                pesoAlca = 2 * alca.peso_und;
                custoAlca = 2 * alca.custo_centavos;
            }
            
            // Aplicar perda aos materiais individuais (exceto m√£o de obra)
            custoGradeCentavos = custoGradeCentavos * fatorPerda;
            custoCola = custoCola * fatorPerda;
            custoChapa25 = custoChapa25 * fatorPerda;
            custoU4 = custoU4 * fatorPerda;
            custoAlca = custoAlca * fatorPerda;
            
            // Total dos materiais com perda j√° aplicada
            const custoTotalMateriaisCentavos = custoGradeCentavos + custoCola + custoChapa25 + custoU4 + custoAlca;
            
            // Calcular m√£o de obra (sem perda) - L√ìGICA ESPECIAL PARA TAMPA INJETADA
            const valorHoraMO = 65.79; // R$/hora
            const custoMaoObraBase = (dados.tempo_proc + dados.tempo_mtg) * valorHoraMO * 100; // custo base em centavos
            
            // Para Tampa Injetada, m√£o de obra n√£o √© multiplicada
            let multiplicadorMO = 1.0; // sempre 1.0 para Tampa Injetada
            let descricaoOpcoes = '';
            
            if (dados.quadro_u4 && dados.alca) {
                descricaoOpcoes = ' (com Quadro U4" + Al√ßa)';
            } else if (!dados.quadro_u4 && dados.alca) {
                descricaoOpcoes = ' (com Al√ßa)';
            } else if (dados.quadro_u4 && !dados.alca) {
                descricaoOpcoes = ' (com Quadro U4")';
            } else {
                descricaoOpcoes = ' (b√°sico)';
            }
            
            const custoMaoObraTotal = Math.round(custoMaoObraBase * multiplicadorMO);
            const maoObraDescricao = `M√ÉO DE OBRA Processamento/Montagem${descricaoOpcoes}`;
            
            console.log(`\nüîß C√ÅLCULO ESPECIAL M√ÉO DE OBRA TAMPA INJETADA:`);
            console.log(`   ‚Ä¢ Custo base: R$ ${(custoMaoObraBase/100).toFixed(2)}`);
            console.log(`   ‚Ä¢ Multiplicador: ${multiplicadorMO}x ${descricaoOpcoes}`);
            console.log(`   ‚Ä¢ Custo final MO: R$ ${(custoMaoObraTotal/100).toFixed(2)}`);
            
            // Custo total
            const custoTotalCentavos = custoTotalMateriaisCentavos + custoMaoObraTotal;
            
            // Peso total
            const pesoTotalKg = (pesoGrade + pesoCola + pesoChapa25 + pesoU4 + pesoAlca) * fatorPerda;
            
            console.log('\nüßÆ C√ÅLCULO DETALHADO TAMPA INJETADA:');
            console.log(`√Årea da tampa: ${areaTampa.toFixed(4)} m¬≤`);
            console.log(`Grade - Peso: ${pesoGrade.toFixed(3)} kg | Custo: R$ ${(custoGradeCentavos/100).toFixed(2)}`);
            console.log(`Cola - Quantidade fixa: ${quantidadeCola} unid`);
            console.log(`${nomeChapa} - √Årea: ${areaChapa.toFixed(4)} m¬≤ | Custo: R$ ${(custoChapa25/100).toFixed(2)}`);
            if (dados.quadro_u4) console.log(`Quadro U4" - 2 unidades | Custo: R$ ${(custoU4/100).toFixed(2)}`);
            if (dados.alca) console.log(`Al√ßas - 2 unidades | Custo: R$ ${(custoAlca/100).toFixed(2)}`);
            console.log(`\nüí∞ RESUMO DE CUSTOS:`);
            console.log(`   Materiais (com ${dados.perda}% perda): R$ ${(custoTotalMateriaisCentavos/100).toFixed(2)}`);
            console.log(`   M√£o de Obra (sem perda): R$ ${(custoMaoObraTotal/100).toFixed(2)}`);
            console.log(`   TOTAL FINAL: R$ ${(custoTotalCentavos/100).toFixed(2)} | Peso: ${pesoTotalKg.toFixed(3)} kg`);
            
            // Criar resultado final
            const resultado = {
                success: true,
                nome_produto: dados.nome_tampa,
                custo_total: custoTotalCentavos,
                peso_total: pesoTotalKg,
                area_tampa: areaTampa,
                mao_obra_produto_id: maoObraProcessamento.id,
                componentes: [
                    {
                        nome: `${gradeSelecionada.descricao} (com ${dados.perda}% perda no custo)`,
                        descricao_produto: gradeSelecionada.descricao,
                        quantidade: areaTampa,
                        custo_unitario: Math.round(gradeSelecionada.custo_centavos * fatorPerda),
                        custo_total: custoGradeCentavos,
                        unidade: 'm¬≤'
                    },
                    {
                        nome: `${cola.descricao} - Quantidade fixa 0,1`,
                        descricao_produto: cola.descricao,
                        quantidade: quantidadeCola,
                        custo_unitario: cola.custo_centavos,
                        custo_total: custoCola,
                        unidade: 'unid'
                    },
                    {
                        nome: `${nomeChapa} - √Årea completa`,
                        descricao_produto: descricaoChapa,
                        quantidade: areaChapa,
                        custo_unitario: dados.chapa_ev ? 27750 : chapa25.custo_centavos,
                        custo_total: custoChapa25,
                        unidade: 'm¬≤'
                    }
                ]
            };
            
            // Adicionar componentes opcionais
            if (dados.quadro_u4 && perfilU4) {
                resultado.componentes.push({
                    nome: `${perfilU4.descricao} - 2 unidades`,
                    descricao_produto: perfilU4.descricao,
                    quantidade: 2,
                    custo_unitario: perfilU4.custo_centavos,
                    custo_total: custoU4,
                    unidade: 'unid'
                });
            }
            
            if (dados.alca && alca) {
                resultado.componentes.push({
                    nome: `${alca.descricao} - 2 unidades`,
                    descricao_produto: alca.descricao,
                    quantidade: 2,
                    custo_unitario: alca.custo_centavos,
                    custo_total: custoAlca,
                    unidade: 'unid'
                });
            }
            
            // Adicionar m√£o de obra aos componentes se selecionada
            if (custoMaoObraTotal > 0) {
                resultado.componentes.push({
                    nome: maoObraDescricao,
                    descricao_produto: maoObraDescricao,
                    quantidade: dados.tempo_proc + dados.tempo_mtg,
                    custo_unitario: valorHoraMO * 100,
                    custo_total: custoMaoObraTotal,
                    unidade: 'h'
                });
            }
            
            // Verificar soma dos componentes
            const somaComponentes = resultado.componentes.reduce((total, comp) => total + comp.custo_total, 0);
            console.log(`\nüîé VERIFICA√á√ÉO FINAL:`);
            console.log(`Custo total calculado: ${custoTotalCentavos} centavos = R$ ${(custoTotalCentavos/100).toFixed(2)}`);
            console.log(`Soma dos componentes: ${somaComponentes} centavos = R$ ${(somaComponentes/100).toFixed(2)}`);
            
            // Atualizar o custo_total com a soma correta
            resultado.custo_total = somaComponentes;
            
            // Salvar resultado globalmente
            ultimoCalculo = resultado;
            
            // Mostrar componentes na tabela
            mostrarComponentesCalculados(resultado.componentes);
            
            // Habilitar bot√£o salvar
            document.getElementById('salvarProdutoBtn').disabled = false;
            
            console.log('‚úÖ C√°lculo da Tampa Injetada conclu√≠do com sucesso');
            
        })
        .catch(error => {
            console.error('‚ùå Erro no c√°lculo:', error);
            alert(`Erro no c√°lculo: ${error.message}`);
        });
}

function calcularDegraus() {
    console.log('=== CALCULANDO DEGRAUS ===');
    
    // Verificar se todos os campos obrigat√≥rios est√£o preenchidos
    const camposObrigatorios = [
        'degraus_nome', 'degraus_perfil', 'degraus_largura', 'degraus_comprimento'
    ];
    
    let todosCamposPreenchidos = true;
    const dados = {};
    
    camposObrigatorios.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (!elemento || !elemento.value.trim()) {
            todosCamposPreenchidos = false;
            console.warn(`Campo ${campo} n√£o preenchido`);
            return;
        }
        
        const valor = elemento.value.trim();
        if (campo === 'degraus_nome') {
            dados.nome_degrau = valor;
        } else if (campo === 'degraus_perfil') {
            dados.tipo_perfil = valor;
        } else {
            const nomeLimpo = campo.replace('degraus_', '');
            dados[nomeLimpo] = parseFloat(valor);
        }
    });
    
    // Campos opcionais
    dados.quantidade = 1; // Fixo em 1 unidade
    dados.tempo_proc = parseFloat(document.getElementById('degraus_tempo_proc')?.value || '1.0');
    dados.tempo_mtg = parseFloat(document.getElementById('degraus_tempo_mtg')?.value || '1.5');
    dados.percentual_perda = parseFloat(document.getElementById('degraus_perda')?.value || '3.0');
    
    if (!todosCamposPreenchidos) {
        alert('Por favor, preencha todos os campos obrigat√≥rios.');
        return;
    }
    
    console.log('Dados coletados:', dados);
    
    // Buscar produtos necess√°rios dinamicamente
    Promise.all([
        buscarProdutoPorDescricao(dados.tipo_perfil === 'I25' ? 'I25mm' : 'I38mm'),
        buscarProdutoPorDescricao('Perfil Chaveta'), // Travessa R$ 2,12
        buscarProdutoPorId(1183), // Cola estrutural - ID fixo
        dados.tipo_perfil === 'I25' ? buscarProdutoPorDescricao('E - 4\'x1.3/16\' #3/16\'') : buscarProdutoPorDescricao('PERFIL F 4"'), // Perfil E para I25, Perfil F para I38
        buscarProdutoPorDescricao('Tubo Quadrado 25x38#3mm'),
        buscarProdutoPorDescricao('PARAF-SXT-M6X40-AI304'),
        buscarProdutoPorDescricao('PARAF-SXT-M6X60-AI304'),
        buscarProdutoPorDescricao('POR-SXT-M6-AI304')
    ]).then(([perfilPrincipal, travessa, cola, perfilReforco, tuboQuadrado, paraf40, paraf60, porca]) => {
        
        console.log('=== PRODUTOS ENCONTRADOS ===');
        console.log('Perfil Principal:', perfilPrincipal);
        console.log('Travessa:', travessa);
        console.log('Cola:', cola);
        console.log('Refor√ßo:', perfilReforco);
        console.log('Tubo Quadrado:', tuboQuadrado);
        console.log('Parafusos:', { paraf40, paraf60, porca });
        
        // Calcular dimens√µes e quantidades
        const areaDegrau = (dados.largura * dados.comprimento) / 1000000; // m¬≤
        const alturaFixa = 150; // Altura fixa de 150mm para degraus
        const volumeDegrau = areaDegrau * (alturaFixa / 1000); // m¬≥
        
        // Calcular quantidades baseadas nas dimens√µes
        const comprimentoPerfil = (5 * dados.comprimento) / 1000; // 5*comprimento/1000 metros
        const quantidadeTravessas = (((dados.comprimento - 100) / 150) * dados.largura * 2) / 1000; // ((comprimento-100)/150)*largura*2/1000
        
        // Quantidades fixas de parafusos e porcas por degrau conforme especifica√ß√£o
        let quantidadeParafusos40, quantidadeParafusos60, quantidadePorcas;
        
        if (dados.tipo_perfil === 'I38') {
            // Quantidades para perfil I38
            quantidadeParafusos40 = 2; // 2 parafusos M6X40 por degrau
            quantidadeParafusos60 = 4; // 4 parafusos M6X60 por degrau  
            quantidadePorcas = 6; // 6 porcas M6 por degrau
        } else {
            // Quantidades para perfil I25 (padr√£o)
            quantidadeParafusos40 = 4; // 4 parafusos M6X40 por degrau
            quantidadeParafusos60 = 2; // 2 parafusos M6X60 por degrau  
            quantidadePorcas = 6; // 6 porcas M6 por degrau
        }
        
        // Aplicar fator de perda conforme definido no formul√°rio
        const fatorPerda = 1 + (dados.percentual_perda / 100);
        
        // Calcular custos individuais (com perda para materiais)
        const custoPerfil = (5 * dados.comprimento * perfilPrincipal.custo_centavos / 1000 * dados.quantidade) * fatorPerda;
        const custoTravessa = (quantidadeTravessas * travessa.custo_centavos * dados.quantidade) * fatorPerda;
        const custoCola = (0.05 * (dados.largura * dados.comprimento) * cola.custo_centavos / 1000000 * dados.quantidade) * fatorPerda;
        const custoReforco = (perfilReforco && perfilReforco.id !== cola.id) ? 
                           (2 * dados.largura * perfilReforco.custo_centavos / 1000 * dados.quantidade) * fatorPerda : 0;
        const custoTubo = (dados.comprimento / 1000 * tuboQuadrado.custo_centavos * dados.quantidade) * fatorPerda;
        const custoParaf40 = (quantidadeParafusos40 * paraf40.custo_centavos * dados.quantidade) * fatorPerda;
        const custoParaf60 = (quantidadeParafusos60 * paraf60.custo_centavos * dados.quantidade) * fatorPerda;
        const custoPorcas = (quantidadePorcas * porca.custo_centavos * dados.quantidade) * fatorPerda;
        
        // Total dos materiais
        const custoTotalMateriaisCentavos = custoPerfil + custoTravessa + custoCola + custoReforco + 
                                          custoTubo + custoParaf40 + custoParaf60 + custoPorcas;
        
        // Calcular m√£o de obra (sem perda)
        const valorHoraMO = 65.79; // R$/hora
        const custoMaoObraTotal = (dados.tempo_proc + dados.tempo_mtg) * valorHoraMO * 100 * dados.quantidade;
        
        // Custo total
        const custoTotalCentavos = custoTotalMateriaisCentavos + custoMaoObraTotal;
        
        // Criar resultado
        const resultado = {
            nome: dados.nome_degrau,
            categoria: 'ESTRUTURAS',
            tipo_calculo: 'degraus',
            custo_total: custoTotalCentavos,
            parametros: dados,
            componentes: []
        };
        
        // Adicionar componentes ao resultado
        resultado.componentes.push({
            nome: `${perfilPrincipal.descricao} - ${comprimentoPerfil.toFixed(2)}m`,
            descricao_produto: perfilPrincipal.descricao,
            quantidade: comprimentoPerfil * dados.quantidade,
            custo_unitario: perfilPrincipal.custo_centavos,
            custo_total: custoPerfil,
            unidade: 'm'
        });
        
        // Travessa (Perfil Chaveta)
        resultado.componentes.push({
            nome: `${travessa.descricao} - ${quantidadeTravessas.toFixed(3)}m`,
            descricao_produto: travessa.descricao,
            quantidade: quantidadeTravessas * dados.quantidade,
            custo_unitario: travessa.custo_centavos,
            custo_total: custoTravessa,
            unidade: 'm'
        });
        
        // Cola Estrutural
        const quantidadeCola = (0.05 * (dados.largura * dados.comprimento) / 1000000) * dados.quantidade; // kg
        resultado.componentes.push({
            nome: `${cola.descricao} - ${quantidadeCola.toFixed(3)}kg`,
            descricao_produto: cola.descricao,
            quantidade: quantidadeCola,
            custo_unitario: cola.custo_centavos,
            custo_total: custoCola,
            unidade: 'kg'
        });
        
        // Perfil de refor√ßo E
        const quantidadeReforco = (2 * dados.largura / 1000) * dados.quantidade; // 2*Largura/1000
        resultado.componentes.push({
            nome: `${perfilReforco.descricao} - ${quantidadeReforco.toFixed(2)}m`,
            descricao_produto: perfilReforco.descricao,
            quantidade: quantidadeReforco,
            custo_unitario: perfilReforco.custo_centavos,
            custo_total: custoReforco,
            unidade: 'm'
        });
        
        // Tubo quadrado (comprimento √ó 2)
        const quantidadeTubo = ((dados.comprimento * 2) / 1000) * dados.quantidade;
        resultado.componentes.push({
            nome: `${tuboQuadrado.descricao} - ${quantidadeTubo.toFixed(2)}m`,
            descricao_produto: tuboQuadrado.descricao,
            quantidade: quantidadeTubo,
            custo_unitario: tuboQuadrado.custo_centavos,
            custo_total: custoTubo,
            unidade: 'm'
        });
        
        resultado.componentes.push({
            nome: `${paraf40.descricao} - ${quantidadeParafusos40} unid`,
            descricao_produto: paraf40.descricao,
            quantidade: quantidadeParafusos40 * dados.quantidade,
            custo_unitario: paraf40.custo_centavos,
            custo_total: custoParaf40,
            unidade: 'unid'
        });
        
        resultado.componentes.push({
            nome: `${paraf60.descricao} - ${quantidadeParafusos60} unid`,
            descricao_produto: paraf60.descricao,
            quantidade: quantidadeParafusos60 * dados.quantidade,
            custo_unitario: paraf60.custo_centavos,
            custo_total: custoParaf60,
            unidade: 'unid'
        });
        
        resultado.componentes.push({
            nome: `${porca.descricao} - ${quantidadePorcas} unid`,
            descricao_produto: porca.descricao,
            quantidade: quantidadePorcas * dados.quantidade,
            custo_unitario: porca.custo_centavos,
            custo_total: custoPorcas,
            unidade: 'unid'
        });
        
        // Adicionar m√£o de obra se houver
        if (custoMaoObraTotal > 0) {
            const maoObraDescricao = `Processamento/Montagem - ${dados.tempo_proc + dados.tempo_mtg}h`;
            resultado.componentes.push({
                nome: maoObraDescricao,
                descricao_produto: maoObraDescricao,
                quantidade: (dados.tempo_proc + dados.tempo_mtg) * dados.quantidade,
                custo_unitario: valorHoraMO * 100,
                custo_total: custoMaoObraTotal,
                unidade: 'h'
            });
        }
        
        // Salvar resultado globalmente
        ultimoCalculo = resultado;
        
        // Mostrar componentes na tabela
        mostrarComponentesCalculados(resultado.componentes);
        
        // Habilitar bot√£o de salvar
        document.getElementById('salvarProdutoBtn').disabled = false;
        
        console.log('‚úÖ C√°lculo de Degraus conclu√≠do com sucesso');
        console.log('Resultado final:', resultado);
        
    }).catch(error => {
        console.error('‚ùå Erro no c√°lculo:', error);
        alert(`Erro no c√°lculo: ${error.message}`);
    });
}

function calcularDegrauInjetado() {
    console.log('=== CALCULANDO DEGRAU INJETADO ===');
    
    // Verificar se todos os campos obrigat√≥rios est√£o preenchidos
    const camposObrigatorios = [
        'degrau_inj_nome', 'degrau_inj_grade', 'degrau_inj_largura', 'degrau_inj_comprimento'
    ];
    
    let todosCamposPreenchidos = true;
    const dados = {};
    
    camposObrigatorios.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (!elemento || !elemento.value.trim()) {
            todosCamposPreenchidos = false;
            console.warn(`Campo ${campo} n√£o preenchido`);
            return;
        }
        
        const valor = elemento.value.trim();
        if (campo === 'degrau_inj_nome') {
            dados.nome_degrau = valor;
        } else if (campo === 'degrau_inj_grade') {
            dados.grade_id = parseInt(valor);
        } else {
            const nomeLimpo = campo.replace('degrau_inj_', '');
            dados[nomeLimpo] = parseFloat(valor);
        }
    });
    
    // Campos opcionais
    dados.quantidade = 1; // Fixo em 1 unidade
    dados.tempo_proc = parseFloat(document.getElementById('degrau_inj_tempo_proc')?.value || '1.0');
    dados.tempo_mtg = parseFloat(document.getElementById('degrau_inj_tempo_mtg')?.value || '1.5');
    dados.percentual_perda = parseFloat(document.getElementById('degrau_inj_perda')?.value || '3.0');
    
    if (!todosCamposPreenchidos) {
        alert('Por favor, preencha todos os campos obrigat√≥rios.');
        return;
    }
    
    console.log('Dados coletados (Degrau Injetado):', dados);
    
    // Buscar produtos necess√°rios dinamicamente (sem cola e chaveta)
    Promise.all([
        buscarProdutoPorId(dados.grade_id), // Grade injetada selecionada
        buscarProdutoPorDescricao('E - 4\'x1.3/16\' #3/16\''), // Sempre perfil E para degrau injetado
        buscarProdutoPorDescricao('PERFIL F 4"'), // Perfil F para grades 38mm
        buscarProdutoPorDescricao('Tubo Quadrado 25x38#3mm'),
        buscarProdutoPorDescricao('PARAF-SXT-M6X40-AI304'),
        buscarProdutoPorDescricao('PARAF-SXT-M6X60-AI304'),
        buscarProdutoPorDescricao('POR-SXT-M6-AI304')
    ]).then(([gradeInjetada, perfilE, perfilF, tuboQuadrado, paraf40, paraf60, porca]) => {
        
        console.log('=== PRODUTOS ENCONTRADOS (DEGRAU INJETADO) ===');
        console.log('Grade Injetada:', gradeInjetada);
        console.log('Perfil E:', perfilE);
        console.log('Perfil F:', perfilF);
        console.log('Tubo Quadrado:', tuboQuadrado);
        console.log('Parafusos:', { paraf40, paraf60, porca });
        
        // Verificar se √© grade de 38mm (e N√ÉO de 25mm)
        const isGrade38 = gradeInjetada.descricao && 
                         gradeInjetada.descricao.toLowerCase().includes('38') && 
                         !gradeInjetada.descricao.toLowerCase().includes('25');
        
        // Calcular dimens√µes e quantidades (igual aos degraus normais)
        const areaDegrau = (dados.largura * dados.comprimento) / 1000000; // m¬≤
        const alturaFixa = 150; // Altura fixa de 150mm para degraus
        const volumeDegrau = areaDegrau * (alturaFixa / 1000); // m¬≥
        
        // Quantidades espec√≠ficas para degrau injetado
        const quantidadeParafusos40 = 4; // 4 parafusos M6X40 por degrau
        const quantidadeParafusos60 = 4; // 4 parafusos M6X60 por degrau  
        const quantidadePorcas = 8; // 8 porcas M6 por degrau
        
        // Aplicar fator de perda conforme definido no formul√°rio
        const fatorPerda = 1 + (dados.percentual_perda / 100);
        
        // Calcular custos individuais (com perda para materiais)
        // Para grade injetada: usar √°rea do degrau √ó custo/m¬≤ da grade
        const custoGrade = (areaDegrau * gradeInjetada.custo_centavos * dados.quantidade) * fatorPerda;
        
        // Perfil E (apenas para grades que N√ÉO s√£o 38mm)
        const custoPerfilE = !isGrade38 ? (2 * dados.largura * perfilE.custo_centavos / 1000 * dados.quantidade) * fatorPerda : 0;
        
        // Perfil F (apenas para grades 38mm)
        const custoPerfilF = isGrade38 ? (2 * dados.largura * perfilF.custo_centavos / 1000 * dados.quantidade) * fatorPerda : 0;
        
        const custoTubo = ((dados.comprimento * 2) / 1000 * tuboQuadrado.custo_centavos * dados.quantidade) * fatorPerda; // Comprimento √ó 2
        const custoParaf40 = (quantidadeParafusos40 * paraf40.custo_centavos * dados.quantidade) * fatorPerda;
        const custoParaf60 = (quantidadeParafusos60 * paraf60.custo_centavos * dados.quantidade) * fatorPerda;
        const custoPorcas = (quantidadePorcas * porca.custo_centavos * dados.quantidade) * fatorPerda;
        
        // Total dos materiais (sem cola e travessa)
        const custoTotalMateriaisCentavos = custoGrade + custoPerfilE + custoPerfilF + 
                                          custoTubo + custoParaf40 + custoParaf60 + custoPorcas;
        
        // Calcular m√£o de obra (sem perda)
        const valorHoraMO = 65.79; // R$/hora
        const custoMaoObraTotal = (dados.tempo_proc + dados.tempo_mtg) * valorHoraMO * 100 * dados.quantidade;
        
        // Custo total
        const custoTotalCentavos = custoTotalMateriaisCentavos + custoMaoObraTotal;
        
        // Criar resultado
        const resultado = {
            nome: dados.nome_degrau,
            categoria: 'ESTRUTURAS',
            tipo_calculo: 'degrau_injetado',
            custo_total: custoTotalCentavos,
            parametros: dados,
            componentes: []
        };
        
        // Adicionar componentes ao resultado
        resultado.componentes.push({
            nome: `${gradeInjetada.descricao} - ${areaDegrau.toFixed(4)}m¬≤`,
            descricao_produto: gradeInjetada.descricao,
            quantidade: areaDegrau * dados.quantidade,
            custo_unitario: gradeInjetada.custo_centavos,
            custo_total: custoGrade,
            unidade: 'm¬≤'
        });
        
        // Perfil E (apenas para grades que N√ÉO s√£o 38mm)
        if (!isGrade38) {
            const quantidadePerfilE = (2 * dados.largura / 1000) * dados.quantidade; // 2*Largura/1000
            resultado.componentes.push({
                nome: `${perfilE.descricao} - ${quantidadePerfilE.toFixed(2)}m`,
                descricao_produto: perfilE.descricao,
                quantidade: quantidadePerfilE,
                custo_unitario: perfilE.custo_centavos,
                custo_total: custoPerfilE,
                unidade: 'm'
            });
        }
        
        // Perfil F (apenas para grades 38mm)
        if (isGrade38) {
            const quantidadePerfilF = (2 * dados.largura / 1000) * dados.quantidade; // 2*Largura/1000
            resultado.componentes.push({
                nome: `${perfilF.descricao} - ${quantidadePerfilF.toFixed(2)}m`,
                descricao_produto: perfilF.descricao,
                quantidade: quantidadePerfilF,
                custo_unitario: perfilF.custo_centavos,
                custo_total: custoPerfilF,
                unidade: 'm'
            });
        }
        
        // Tubo quadrado (comprimento √ó 2)
        const quantidadeTubo = ((dados.comprimento * 2) / 1000) * dados.quantidade;
        resultado.componentes.push({
            nome: `${tuboQuadrado.descricao} - ${quantidadeTubo.toFixed(2)}m`,
            descricao_produto: tuboQuadrado.descricao,
            quantidade: quantidadeTubo,
            custo_unitario: tuboQuadrado.custo_centavos,
            custo_total: custoTubo,
            unidade: 'm'
        });
        
        resultado.componentes.push({
            nome: `${paraf40.descricao} - ${quantidadeParafusos40} unid`,
            descricao_produto: paraf40.descricao,
            quantidade: quantidadeParafusos40 * dados.quantidade,
            custo_unitario: paraf40.custo_centavos,
            custo_total: custoParaf40,
            unidade: 'unid'
        });
        
        resultado.componentes.push({
            nome: `${paraf60.descricao} - ${quantidadeParafusos60} unid`,
            descricao_produto: paraf60.descricao,
            quantidade: quantidadeParafusos60 * dados.quantidade,
            custo_unitario: paraf60.custo_centavos,
            custo_total: custoParaf60,
            unidade: 'unid'
        });
        
        resultado.componentes.push({
            nome: `${porca.descricao} - ${quantidadePorcas} unid`,
            descricao_produto: porca.descricao,
            quantidade: quantidadePorcas * dados.quantidade,
            custo_unitario: porca.custo_centavos,
            custo_total: custoPorcas,
            unidade: 'unid'
        });
        
        // Adicionar m√£o de obra se houver
        if (custoMaoObraTotal > 0) {
            const maoObraDescricao = `Processamento/Montagem - ${dados.tempo_proc + dados.tempo_mtg}h`;
            resultado.componentes.push({
                nome: maoObraDescricao,
                descricao_produto: maoObraDescricao,
                quantidade: (dados.tempo_proc + dados.tempo_mtg) * dados.quantidade,
                custo_unitario: valorHoraMO * 100,
                custo_total: custoMaoObraTotal,
                unidade: 'h'
            });
        }
        
        // Salvar resultado globalmente
        ultimoCalculo = resultado;
        
        // Mostrar componentes na tabela
        mostrarComponentesCalculados(resultado.componentes);
        
        // Habilitar bot√£o de salvar
        document.getElementById('salvarProdutoBtn').disabled = false;
        
        console.log('‚úÖ C√°lculo de Degrau Injetado conclu√≠do com sucesso');
        console.log('Resultado final:', resultado);
        
    }).catch(error => {
        console.error('‚ùå Erro no c√°lculo:', error);
        alert(`Erro no c√°lculo: ${error.message}`);
    });
}

function calcularTampaMontada() {
    console.log('=== CALCULANDO TAMPA MONTADA ===');
    
    // Verificar se todos os campos obrigat√≥rios est√£o preenchidos
    const camposObrigatorios = [
        'tampa_nome', 'tampa_vao', 'tampa_comprimento', 'tampa_eixo_i', 'tampa_perfil'
    ];
    
    let todosCamposPreenchidos = true;
    const dados = {};
    
    camposObrigatorios.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (!elemento || !elemento.value.trim()) {
            todosCamposPreenchidos = false;
            console.warn(`Campo ${campo} n√£o preenchido`);
            return;
        }
        
        const valor = elemento.value.trim();
        if (campo === 'tampa_nome') {
            dados.nome_tampa = valor;
        } else if (campo === 'tampa_perfil') {
            dados.perfil_id = parseInt(valor);
        } else {
            const nomeLimpo = campo.replace('tampa_', '');
            dados[nomeLimpo] = parseFloat(valor);
        }
    });
    
    // Campos opcionais
    dados.perda = parseFloat(document.getElementById('tampa_perda').value) || 3;
    dados.tempo_proc = parseFloat(document.getElementById('tampa_tempo_proc').value) || 1.5;
    dados.tempo_mtg = parseFloat(document.getElementById('tampa_tempo_mtg').value) || 0.5;
    dados.quadro_u4 = document.getElementById('tampa_quadro_u4').checked;
    dados.alca = document.getElementById('tampa_alca').checked;
    dados.chapa_ev = document.getElementById('tampa_chapa_ev').checked;
    dados.tipo_calculo = 'tampa_montada';
    
    if (!todosCamposPreenchidos) {
        alert('Por favor, preencha todos os campos obrigat√≥rios (marcados com *).');
        return;
    }
    
    console.log('Dados da tampa montada:', dados);
    
    // Buscar produtos necess√°rios
    fetch('/api/produtos/')
        .then(response => response.json())
        .then(produtos => {
            console.log(`‚úÖ ${produtos.length} produtos carregados da API`);
            
            // Encontrar perfil selecionado
            const perfilSelecionado = produtos.find(p => p.id === dados.perfil_id);
            if (!perfilSelecionado) {
                throw new Error(`Perfil com ID ${dados.perfil_id} n√£o encontrado`);
            }
            
            // Encontrar chaveta (sempre ID 1332)
            const chaveta = produtos.find(p => p.id === 1332);
            if (!chaveta) {
                throw new Error('Chaveta Perfil I (ID 1332) n√£o encontrada no banco');
            }
            
            // Encontrar cola estrutural (sempre ID 1183)
            const cola = produtos.find(p => p.id === 1183);
            if (!cola) {
                throw new Error('COLA ESTRUTURAL 4500 A/B (ID 1183) n√£o encontrada no banco');
            }
            
            // Encontrar chapa 2,5mm (buscar por descri√ß√£o)
            const chapa25 = produtos.find(p => 
                p.descricao && 
                p.descricao.toLowerCase().includes('chapa') && 
                p.descricao.toLowerCase().includes('2,5')
            );
            if (!chapa25) {
                throw new Error('Chapa 2,5mm n√£o encontrada no banco');
            }
            
            // Encontrar perfil U4" (se necess√°rio)
            let perfilU4 = null;
            if (dados.quadro_u4) {
                perfilU4 = produtos.find(p => 
                    p.descricao && 
                    p.descricao.toLowerCase().includes('u4')
                );
                if (!perfilU4) {
                    throw new Error('Perfil U4" n√£o encontrado no banco');
                }
            }
            
            // Encontrar al√ßa (se necess√°rio)
            let alca = null;
            if (dados.alca) {
                alca = produtos.find(p => 
                    p.descricao && 
                    p.descricao.toLowerCase().includes('al√ßa')
                );
                if (!alca) {
                    throw new Error('Al√ßa n√£o encontrada no banco');
                }
            }
            
            // Encontrar chapa EV (se necess√°rio)
            let chapaEV = null;
            if (dados.chapa_ev) {
                chapaEV = produtos.find(p => 
                    p.descricao && 
                    p.descricao.toLowerCase().includes('chapa') &&
                    p.descricao.toLowerCase().includes('ev')
                );
                if (!chapaEV) {
                    throw new Error('Chapa EV n√£o encontrada no banco');
                }
            }
            
            // Encontrar m√£o de obra processamento/montagem
            const maoObraProcessamento = produtos.find(p => 
                p.descricao && 
                p.descricao.toLowerCase().includes('m√£o de obra') && 
                p.descricao.toLowerCase().includes('processamento')
            );
            if (!maoObraProcessamento) {
                throw new Error('Produto de m√£o de obra Processamento/Montagem n√£o encontrado no banco');
            }
            
            console.log(`üìê Perfil selecionado: ${perfilSelecionado.descricao}`);
            console.log(`üîß Chaveta inclu√≠da: ${chaveta.descricao}`);
            console.log(`üß¥ Cola inclu√≠da: ${cola.descricao}`);
            console.log(`üìã Chapa 2,5mm: ${chapa25.descricao}`);
            if (perfilU4) console.log(`üî≤ Perfil U4": ${perfilU4.descricao}`);
            if (alca) console.log(`üéØ Al√ßa: ${alca.descricao}`);
            if (chapaEV) console.log(`üìã Chapa EV: ${chapaEV.descricao}`);
            
            // APLICAR F√ìRMULAS DA TAMPA MONTADA
            const fatorPerda = 1 + (dados.perda / 100);
            
            // 1. Perfil (mesma l√≥gica da grade)
            const metrosLinearesPorM2 = (dados.comprimento / dados.eixo_i) * (dados.vao / 1000);
            const pesoPerfilKg = metrosLinearesPorM2 * perfilSelecionado.peso_und;
            let custoPerfilCentavos = metrosLinearesPorM2 * perfilSelecionado.custo_centavos;
            
            // 2. Chaveta (mesma l√≥gica da grade)
            const quantidadeChaveta = (dados.vao / 150) * 2;
            const pesoChaveta = quantidadeChaveta * chaveta.peso_und;
            let custoChaveta = quantidadeChaveta * chaveta.custo_centavos;
            
            // 3. Cola - 0,1 * custo da cola
            const quantidadeCola = 0.1;
            const pesoCola = quantidadeCola * cola.peso_und;
            let custoCola = quantidadeCola * cola.custo_centavos;
            
            // 4. Chapa 2,5mm - v√£o * comprimento * custo chapa (em m¬≤)
            const areaChapa = (dados.vao / 1000) * (dados.comprimento / 1000); // em m¬≤
            const pesoChapa25 = areaChapa * chapa25.peso_und;
            
            // AJUSTE ESPECIAL: Se Chapa EV marcada, usar valor fixo R$ 277,50
            let custoChapa25;
            let nomeChapa, descricaoChapa;
            if (dados.chapa_ev) {
                custoChapa25 = 27750; // R$ 277,50 em centavos (valor fixo quando EV marcada)
                nomeChapa = "Chapa EV - Res. Poli√©ster";
                descricaoChapa = "Chapa EV - Res. Poli√©ster";
                console.log(`üîß CHAPA EV MARCADA: Custo da chapa alterado para R$ 277,50 (fixo)`);
            } else {
                custoChapa25 = areaChapa * chapa25.custo_centavos; // C√°lculo normal
                nomeChapa = chapa25.descricao;
                descricaoChapa = chapa25.descricao;
            }
            
            // 5. Quadro U4" - se 'sim' custo perfil u4 * 2
            let pesoU4 = 0, custoU4 = 0;
            if (dados.quadro_u4 && perfilU4) {
                pesoU4 = 2 * perfilU4.peso_und;
                custoU4 = 2 * perfilU4.custo_centavos;
            }
            
            // 6. Al√ßa - se sim custo da al√ßa * 2
            let pesoAlca = 0, custoAlca = 0;
            if (dados.alca && alca) {
                pesoAlca = 2 * alca.peso_und;
                custoAlca = 2 * alca.custo_centavos;
            }
            
            // 7. Chapa EV - REMOVIDO: agora integrado na l√≥gica da chapa principal
            
            // Aplicar perda aos materiais individuais (exceto m√£o de obra)
            custoPerfilCentavos = custoPerfilCentavos * fatorPerda;
            custoChaveta = custoChaveta * fatorPerda;
            custoCola = custoCola * fatorPerda;
            custoChapa25 = custoChapa25 * fatorPerda;
            custoU4 = custoU4 * fatorPerda;
            custoAlca = custoAlca * fatorPerda;
            
            // Total dos materiais com perda j√° aplicada
            const custoTotalMateriaisCentavos = custoPerfilCentavos + custoChaveta + custoCola + custoChapa25 + custoU4 + custoAlca;
            
            // Calcular m√£o de obra (sem perda) - L√ìGICA ESPECIAL PARA TAMPA MONTADA
            const valorHoraMO = 65.79; // R$/hora
            const custoMaoObraBase = (dados.tempo_proc + dados.tempo_mtg) * valorHoraMO * 100; // custo base em centavos
            
            // Aplicar multiplicador baseado nas op√ß√µes selecionadas
            let multiplicadorMO = 1.0; // padr√£o: nenhuma op√ß√£o selecionada
            let descricaoOpcoes = '';
            
            if (dados.quadro_u4 && dados.alca) {
                multiplicadorMO = 2.0;
                descricaoOpcoes = ' (com Quadro U4" + Al√ßa)';
            } else if (!dados.quadro_u4 && dados.alca) {
                multiplicadorMO = 1.9;
                descricaoOpcoes = ' (com Al√ßa)';
            } else if (dados.quadro_u4 && !dados.alca) {
                multiplicadorMO = 1.1;
                descricaoOpcoes = ' (com Quadro U4")';
            } else {
                multiplicadorMO = 1.0;
                descricaoOpcoes = ' (b√°sico)';
            }
            
            const custoMaoObraTotal = Math.round(custoMaoObraBase * multiplicadorMO);
            const maoObraDescricao = `M√ÉO DE OBRA Processamento/Montagem${descricaoOpcoes}`;
            
            console.log(`\nüîß C√ÅLCULO ESPECIAL M√ÉO DE OBRA TAMPA:`);
            console.log(`   ‚Ä¢ Custo base: R$ ${(custoMaoObraBase/100).toFixed(2)}`);
            console.log(`   ‚Ä¢ Multiplicador: ${multiplicadorMO}x ${descricaoOpcoes}`);
            console.log(`   ‚Ä¢ Custo final MO: R$ ${(custoMaoObraTotal/100).toFixed(2)}`);
            
            // Custo total
            const custoTotalCentavos = custoTotalMateriaisCentavos + custoMaoObraTotal;
            
            // Peso total
            const pesoTotalKg = (pesoPerfilKg + pesoChaveta + pesoCola + pesoChapa25 + pesoU4 + pesoAlca) * fatorPerda;
            
            console.log('\nüßÆ C√ÅLCULO DETALHADO TAMPA MONTADA:');
            console.log(`Perfil - Metros lineares/m¬≤: ${metrosLinearesPorM2.toFixed(4)} m/m¬≤`);
            console.log(`Perfil - Peso: ${pesoPerfilKg.toFixed(3)} kg/m¬≤ | Custo: R$ ${(custoPerfilCentavos/100).toFixed(2)}/m¬≤`);
            console.log(`Chaveta - Quantidade: ${quantidadeChaveta.toFixed(4)} m/m¬≤`);
            console.log(`Cola - Quantidade fixa: ${quantidadeCola} unid`);
            console.log(`${nomeChapa} - √Årea: ${areaChapa.toFixed(4)} m¬≤ | Custo: R$ ${(custoChapa25/100).toFixed(2)}`);
            if (dados.quadro_u4) console.log(`Quadro U4" - 2 unidades | Custo: R$ ${(custoU4/100).toFixed(2)}`);
            if (dados.alca) console.log(`Al√ßas - 2 unidades | Custo: R$ ${(custoAlca/100).toFixed(2)}`);
            console.log(`\nüí∞ RESUMO DE CUSTOS:`);
            console.log(`   Materiais (com ${dados.perda}% perda): R$ ${(custoTotalMateriaisCentavos/100).toFixed(2)}/m¬≤`);
            console.log(`   M√£o de Obra (sem perda): R$ ${(custoMaoObraTotal/100).toFixed(2)}/m¬≤`);
            console.log(`   TOTAL FINAL: R$ ${(custoTotalCentavos/100).toFixed(2)}/m¬≤ | Peso: ${pesoTotalKg.toFixed(3)} kg/m¬≤`);
            
            // Criar resultado final
            const resultado = {
                success: true,
                nome_produto: dados.nome_tampa,
                custo_total: custoTotalCentavos,
                peso_total: pesoTotalKg,
                metros_lineares_por_m2: metrosLinearesPorM2,
                mao_obra_produto_id: maoObraProcessamento.id,
                componentes: [
                    {
                        nome: `${perfilSelecionado.descricao} (com ${dados.perda}% perda no custo)`,
                        produto_nome: perfilSelecionado.descricao,
                        quantidade: metrosLinearesPorM2,
                        custo_unitario: perfilSelecionado.custo_centavos,
                        custo_total: custoPerfilCentavos,
                        unidade: 'm'
                    },
                    {
                        nome: `${chaveta.descricao} (com ${dados.perda}% perda no custo)`,
                        produto_nome: chaveta.descricao,
                        quantidade: quantidadeChaveta,
                        custo_unitario: chaveta.custo_centavos,
                        custo_total: custoChaveta,
                        unidade: 'm'
                    },
                    {
                        nome: `${cola.descricao} - Quantidade fixa 0,1`,
                        produto_nome: cola.descricao,
                        quantidade: quantidadeCola,
                        custo_unitario: cola.custo_centavos,
                        custo_total: custoCola,
                        unidade: 'unid'
                    },
                    {
                        nome: `${nomeChapa} - √Årea completa`,
                        produto_nome: descricaoChapa,
                        quantidade: areaChapa,
                        custo_unitario: dados.chapa_ev ? 27750 : chapa25.custo_centavos,
                        custo_total: custoChapa25,
                        unidade: 'm¬≤'
                    }
                ]
            };
            
            // Adicionar componentes opcionais
            if (dados.quadro_u4 && perfilU4) {
                resultado.componentes.push({
                    nome: `${perfilU4.descricao} - 2 unidades`,
                    produto_nome: perfilU4.descricao,
                    quantidade: 2,
                    custo_unitario: perfilU4.custo_centavos,
                    custo_total: custoU4,
                    unidade: 'unid'
                });
            }
            
            if (dados.alca && alca) {
                resultado.componentes.push({
                    nome: `${alca.descricao} - 2 unidades`,
                    produto_nome: alca.descricao,
                    quantidade: 2,
                    custo_unitario: alca.custo_centavos,
                    custo_total: custoAlca,
                    unidade: 'unid'
                });
            }
            
            // Chapa EV agora √© integrada na chapa principal - n√£o adicionar separadamente
            
            // Adicionar m√£o de obra aos componentes se selecionada
            if (custoMaoObraTotal > 0) {
                resultado.componentes.push({
                    nome: maoObraDescricao,
                    produto_nome: maoObraDescricao,
                    quantidade: dados.tempo_proc + dados.tempo_mtg,
                    custo_unitario: valorHoraMO * 100,
                    custo_total: custoMaoObraTotal,
                    unidade: 'h'
                });
            }
            
            // Verificar soma dos componentes
            const somaComponentes = resultado.componentes.reduce((total, comp) => total + comp.custo_total, 0);
            console.log(`\nüîé VERIFICA√á√ÉO FINAL:`);
            console.log(`Custo total calculado: ${custoTotalCentavos} centavos = R$ ${(custoTotalCentavos/100).toFixed(2)}`);
            console.log(`Soma dos componentes: ${somaComponentes} centavos = R$ ${(somaComponentes/100).toFixed(2)}`);
            
            // Atualizar o custo_total com a soma correta
            resultado.custo_total = somaComponentes;
            
            // Salvar resultado globalmente
            ultimoCalculo = resultado;
            
            // Mostrar resultado na interface
            document.getElementById('nomeProdutoCalculado').textContent = dados.nome_tampa;
            document.getElementById('custoTotalCalculado').textContent = `R$ ${(custoTotalCentavos / 100).toFixed(2)}/m¬≤`;
            document.getElementById('pesoTotalCalculado').textContent = `${pesoTotalKg.toFixed(3)} kg/m¬≤`;
            document.getElementById('resultadoCalculado').style.display = 'block';
            
            // Preencher tabela de componentes
            preencherTabelaComponentesTampa(resultado);
            
            // Habilitar bot√£o salvar
            document.getElementById('salvarProdutoBtn').disabled = false;
            
            console.log('‚úÖ C√°lculo de tampa montada conclu√≠do:', resultado);
        })
        .catch(error => {
            console.error('‚ùå Erro ao calcular tampa montada:', error);
            alert('Erro ao calcular tampa montada: ' + error.message);
        });
}

function preencherTabelaComponentesTampa(resultado) {
    console.log('=== PREENCHENDO TABELA DE COMPONENTES PARA TAMPA MONTADA ===');
    
    const tbody = document.getElementById('componentesCalculadosTable');
    if (!tbody) {
        console.warn('Tabela componentesCalculadosTable n√£o encontrada');
        return;
    }
    
    // Limpar tabela
    tbody.innerHTML = '';
    
    // Adicionar linha para cada componente
    resultado.componentes.forEach((comp, index) => {
        const row = tbody.insertRow();
        
        // Componentes de tampa montada n√£o t√™m fator edit√°vel
        const fatorCol = '<span class="text-muted">-</span>';
        const acaoCol = '<span class="text-muted">-</span>';
        
        row.innerHTML = `
            <td>${comp.nome || 'N/A'}</td>
            <td>${comp.produto_nome || 'N/A'}</td>
            <td>${fatorCol}</td>
            <td><span class="quantidade-display">${comp.quantidade ? comp.quantidade.toFixed(4) : '0.0000'}</span></td>
            <td>R$ ${comp.custo_unitario ? (comp.custo_unitario/100).toFixed(2) : '0.00'}</td>
            <td><span class="custo-total-display">R$ ${comp.custo_total ? (comp.custo_total/100).toFixed(2) : '0.00'}</span></td>
            <td>${acaoCol}</td>`;
        
        console.log(`‚úì Componente adicionado: ${comp.nome} - ${comp.quantidade.toFixed(4)} ${comp.unidade || 'm'}`);
    });
    
    // Adicionar linha de total
    const totalRow = tbody.insertRow();
    const custoTotalGeral = resultado.componentes.reduce((total, comp) => total + comp.custo_total, 0);
    totalRow.innerHTML = `
        <td colspan="5"><strong>TOTAL GERAL</strong></td>
        <td><strong>R$ ${(custoTotalGeral/100).toFixed(2)}</strong></td>
        <td></td>`;
    totalRow.style.backgroundColor = '#f8f9fa';
    
    console.log(`‚úÖ Tabela preenchida com ${resultado.componentes.length} componentes. Total: R$ ${(custoTotalGeral/100).toFixed(2)}`);
}

function calcularGuardaCorpoHorizontal() {
    console.log('=== CALCULANDO GUARDA CORPO - HORIZONTAL ===');
    
    // Verificar se todos os campos obrigat√≥rios est√£o preenchidos
    const camposObrigatorios = [
        'gc_horiz_nome', 'gc_horiz_larg_modulo', 'gc_horiz_altura', 
        'gc_horiz_n_colunas', 'gc_horiz_n_br_intermediaria', 
        'gc_horiz_tipo_tubo_quad', 'gc_horiz_tipo_omega', 'gc_horiz_tipo_sapata'
    ];
    
    let todosCamposPreenchidos = true;
    const dados = {};
    
    camposObrigatorios.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (!elemento || !elemento.value.trim()) {
            todosCamposPreenchidos = false;
            console.warn(`Campo ${campo} n√£o preenchido`);
            return;
        }
        
        const valor = elemento.value.trim();
        if (campo === 'gc_horiz_nome') {
            dados.nome_guarda_corpo = valor;
        } else {
            const nomeLimpo = campo.replace('gc_horiz_', '');
            if (['larg_modulo', 'altura'].includes(nomeLimpo)) {
                dados[nomeLimpo] = parseFloat(valor);
            } else if (['n_colunas', 'n_br_intermediaria'].includes(nomeLimpo)) {
                dados[nomeLimpo] = parseFloat(valor); // Mudado de parseInt para parseFloat
            } else {
                dados[nomeLimpo] = valor;
            }
        }
    });
    
    // Campos opcionais
    dados.quantidade = 1; // Fixo em 1 unidade
    dados.tempo_proc = parseFloat(document.getElementById('gc_horiz_tempo_proc')?.value || '2.0');
    dados.tempo_mtg = parseFloat(document.getElementById('gc_horiz_tempo_mtg')?.value || '3.0');
    dados.percentual_perda = parseFloat(document.getElementById('gc_horiz_perda')?.value || '3.0');
    
    if (!todosCamposPreenchidos) {
        alert('Por favor, preencha todos os campos obrigat√≥rios.');
        return;
    }
    
    console.log('Dados coletados (Guarda Corpo - Horizontal):', dados);
    
    // Buscar produtos necess√°rios dinamicamente
    Promise.all([
        buscarProdutoPorDescricao(dados.tipo_tubo_quad), // Tubo quadrado selecionado
        buscarProdutoPorDescricao(dados.tipo_omega), // Perfil √¥mega selecionado
        buscarProdutoPorDescricao(dados.tipo_sapata), // Sapata selecionada
        buscarProdutoPorDescricao('Perfil Corrim√£o (s/ pintura) - Res. Poli√©ster'), // Corrim√£o fixo
        buscarProdutoPorDescricao('Perfil Rodap√© 200mm (s/ pintura) - Res. Poli√©ster'), // Rodap√© fixo
        buscarProdutoPorDescricao('PARAF-SXT-M6X70-AI304'),
        buscarProdutoPorDescricao('POR-SXT-M6-AI304'),
        buscarProdutoPorDescricao('PARAF-AA-PN-PH-4,8X19-AI304')
    ]).then(([tuboQuadrado, perfilOmega, sapata, corrimao, rodape, paraf70, porca, parafAA]) => {
        
        console.log('=== PRODUTOS ENCONTRADOS (GUARDA CORPO - HORIZONTAL) ===');
        console.log('Tubo Quadrado:', tuboQuadrado);
        console.log('Perfil √îmega:', perfilOmega);
        console.log('Sapata:', sapata);
        console.log('Corrim√£o:', corrimao);
        console.log('Rodap√©:', rodape);
        console.log('Parafusos:', { paraf70, porca, parafAA });
        
        // Aplicar fator de perda conforme definido no formul√°rio
        const fatorPerda = 1 + (dados.percentual_perda / 100);
        
        // Debug: mostrar valores usados no c√°lculo
        console.log('=== VALORES PARA C√ÅLCULO DO TUBO QUADRADO ===');
        console.log('Largura m√≥dulo:', dados.larg_modulo);
        console.log('N¬∞ colunas:', dados.n_colunas);
        console.log('Altura:', dados.altura);
        console.log('Quantidade:', dados.quantidade);
        console.log('F√≥rmula: (largura/n_colunas) √ó largura √ó altura (apenas metros)');
        console.log(`C√°lculo: (${dados.larg_modulo}/${dados.n_colunas}) √ó ${dados.larg_modulo} √ó ${dados.altura}`);
        
        // Calcular quantidades baseadas nas especifica√ß√µes
        // Tubo Quadrado: (largura/n_colunas) √ó largura √ó altura (resultado em metros)
        // O custo ser√° aplicado separadamente na tabela de componentes
        const quantidadeTuboQuadrado = ( dados.n_colunas/dados.larg_modulo ) * dados.larg_modulo * dados.altura;
        
        console.log('Resultado c√°lculo tubo quadrado:', quantidadeTuboQuadrado.toFixed(3), 'm');
        
        // Perfil √îmega: qtd barras √ó largura (resultado em metros)
        // O custo ser√° aplicado separadamente na tabela de componentes
        const metrosOmega = dados.n_br_intermediaria * dados.larg_modulo;
        
        console.log('=== C√ÅLCULO PERFIL √îMEGA ===');
        console.log('Qtd barras:', dados.n_br_intermediaria);
        console.log('Largura m√≥dulo:', dados.larg_modulo);
        console.log('F√≥rmula: qtd_barras √ó largura');
        console.log(`C√°lculo: ${dados.n_br_intermediaria} √ó ${dados.larg_modulo}`);
        console.log('Resultado perfil √¥mega:', metrosOmega.toFixed(3), 'm');
        
        // Corrim√£o: largura (resultado em metros)
        // O custo ser√° aplicado separadamente na tabela de componentes
        const metrosCorrimao = dados.larg_modulo;
        
        console.log('=== C√ÅLCULO CORRIM√ÉO ===');
        console.log('Largura m√≥dulo:', dados.larg_modulo);
        console.log('F√≥rmula: largura');
        console.log(`Resultado corrim√£o: ${metrosCorrimao.toFixed(3)} m`);
        
        // Rodap√©: largura (resultado em metros)
        // O custo ser√° aplicado separadamente na tabela de componentes
        const metrosRodape = dados.larg_modulo;
        
        console.log('=== C√ÅLCULO RODAP√â ===');
        console.log('Largura m√≥dulo:', dados.larg_modulo);
        console.log('F√≥rmula: largura');
        console.log(`Resultado rodap√©: ${metrosRodape.toFixed(3)} m`);
        
        // Sapatas: 1 por coluna
        const quantidadeSapatas = dados.n_colunas * dados.quantidade;
        
        // Parafusos estimados baseadas nas especifica√ß√µes
        // PARAF-SXT-M6X70-AI304: (qtd colunas / largura) √ó largura √ó 2
        const quantidadeParaf70 = (dados.n_colunas / dados.larg_modulo) * dados.larg_modulo * 2;
        
        // POR-SXT-M6-AI304: usa a mesma l√≥gica do parafuso M6x70
        const quantidadePorcas = (dados.n_colunas / dados.larg_modulo) * dados.larg_modulo * 2;
        
        // PARAF-AA-PN-PH-4,8X19-AI304: (qtd colunas / largura) √ó largura √ó (n barras √ó 2 + 6)
        const quantidadeParafAA = (dados.n_colunas / dados.larg_modulo) * dados.larg_modulo * (dados.n_br_intermediaria * 2 + 6);
        
        console.log('=== C√ÅLCULO PARAF-SXT-M6X70 ===');
        console.log('N¬∞ colunas:', dados.n_colunas);
        console.log('Largura m√≥dulo:', dados.larg_modulo);
        console.log('F√≥rmula: (qtd_colunas / largura) √ó largura √ó 2');
        console.log(`C√°lculo: (${dados.n_colunas} / ${dados.larg_modulo}) √ó ${dados.larg_modulo} √ó 2`);
        console.log('Resultado paraf M6x70:', quantidadeParaf70.toFixed(0), 'unid');
        console.log('Resultado porcas M6:', quantidadePorcas.toFixed(0), 'unid');
        
        console.log('=== C√ÅLCULO PARAF-AA-PN-PH-4,8X19 ===');
        console.log('N¬∞ barras intermedi√°rias:', dados.n_br_intermediaria);
        console.log('F√≥rmula: (qtd_colunas / largura) √ó largura √ó (n_barras √ó 2 + 6)');
        console.log(`C√°lculo: (${dados.n_colunas} / ${dados.larg_modulo}) √ó ${dados.larg_modulo} √ó (${dados.n_br_intermediaria} √ó 2 + 6)`);
        console.log('Resultado paraf AA:', quantidadeParafAA.toFixed(0), 'unid');
        
        // Calcular custos individuais (com perda para materiais)
        const custoTuboQuadrado = (quantidadeTuboQuadrado * tuboQuadrado.custo_centavos) * fatorPerda;
        const custoPerfilOmega = (metrosOmega * perfilOmega.custo_centavos) * fatorPerda;
        const custoCorrimao = (metrosCorrimao * corrimao.custo_centavos) * fatorPerda;
        const custoRodape = (metrosRodape * rodape.custo_centavos) * fatorPerda;
        const custoSapatas = (quantidadeSapatas * sapata.custo_centavos) * fatorPerda;
        const custoParaf70 = (quantidadeParaf70 * paraf70.custo_centavos) * fatorPerda;
        // VALOR FIXO: POR-SXT-M6-AI304 fixado em 41 centavos para Guarda Corpo
        const custoPorcas = (quantidadePorcas * 41) * fatorPerda; // Valor fixo de 41 centavos
        const custoParafAA = (quantidadeParafAA * parafAA.custo_centavos) * fatorPerda;
        
        // Total dos materiais
        const custoTotalMateriaisCentavos = custoTuboQuadrado + custoPerfilOmega + custoCorrimao + custoRodape + custoSapatas + 
                                          custoParaf70 + custoPorcas + custoParafAA;
        
        // Calcular m√£o de obra (sem perda)
        const valorHoraMO = 65.79; // R$/hora
        const custoMaoObraTotal = (dados.tempo_proc + dados.tempo_mtg) * valorHoraMO * 100 * dados.quantidade;
        
        // Custo total
        const custoTotalCentavos = custoTotalMateriaisCentavos + custoMaoObraTotal;
        
        // Criar resultado
        const resultado = {
            nome: dados.nome_guarda_corpo,
            categoria: 'ESTRUTURAS',
            tipo_calculo: 'guarda_corpo_horizontal',
            custo_total: custoTotalCentavos,
            parametros: dados,
            componentes: []
        };
        
        // Adicionar componentes ao resultado
        resultado.componentes.push({
            nome: `${tuboQuadrado.descricao} - ${quantidadeTuboQuadrado.toFixed(2)}m`,
            descricao_produto: tuboQuadrado.descricao,
            quantidade: quantidadeTuboQuadrado,
            custo_unitario: tuboQuadrado.custo_centavos,
            custo_total: custoTuboQuadrado,
            unidade: 'm'
        });
        
        resultado.componentes.push({
            nome: `${perfilOmega.descricao} - ${metrosOmega.toFixed(2)}m`,
            descricao_produto: perfilOmega.descricao,
            quantidade: metrosOmega * dados.quantidade,
            custo_unitario: perfilOmega.custo_centavos,
            custo_total: custoPerfilOmega,
            unidade: 'm'
        });
        
        resultado.componentes.push({
            nome: `${corrimao.descricao} - ${metrosCorrimao.toFixed(2)}m`,
            descricao_produto: corrimao.descricao,
            quantidade: metrosCorrimao * dados.quantidade,
            custo_unitario: corrimao.custo_centavos,
            custo_total: custoCorrimao,
            unidade: 'm'
        });
        
        resultado.componentes.push({
            nome: `${rodape.descricao} - ${metrosRodape.toFixed(2)}m`,
            descricao_produto: rodape.descricao,
            quantidade: metrosRodape * dados.quantidade,
            custo_unitario: rodape.custo_centavos,
            custo_total: custoRodape,
            unidade: 'm'
        });
        
        resultado.componentes.push({
            nome: `${sapata.descricao} - ${quantidadeSapatas} unid`,
            descricao_produto: sapata.descricao,
            quantidade: quantidadeSapatas,
            custo_unitario: sapata.custo_centavos,
            custo_total: custoSapatas,
            unidade: 'unid'
        });
        
        resultado.componentes.push({
            nome: `${paraf70.descricao} - ${quantidadeParaf70} unid`,
            descricao_produto: paraf70.descricao,
            quantidade: quantidadeParaf70,
            custo_unitario: paraf70.custo_centavos,
            custo_total: custoParaf70,
            unidade: 'unid'
        });
        
        resultado.componentes.push({
            nome: `${porca.descricao} - ${quantidadePorcas} unid`,
            descricao_produto: porca.descricao,
            quantidade: quantidadePorcas,
            custo_unitario: 41, // Valor fixo de 41 centavos para GC
            custo_total: custoPorcas,
            unidade: 'unid'
        });
        
        resultado.componentes.push({
            nome: `${parafAA.descricao} - ${quantidadeParafAA} unid`,
            descricao_produto: parafAA.descricao,
            quantidade: quantidadeParafAA,
            custo_unitario: parafAA.custo_centavos,
            custo_total: custoParafAA,
            unidade: 'unid'
        });
        
        // Adicionar m√£o de obra se houver
        if (custoMaoObraTotal > 0) {
            const maoObraDescricao = `Processamento/Montagem - ${dados.tempo_proc + dados.tempo_mtg}h`;
            resultado.componentes.push({
                nome: maoObraDescricao,
                descricao_produto: maoObraDescricao,
                quantidade: (dados.tempo_proc + dados.tempo_mtg) * dados.quantidade,
                custo_unitario: valorHoraMO * 100,
                custo_total: custoMaoObraTotal,
                unidade: 'h'
            });
        }
        
        // Salvar resultado globalmente
        ultimoCalculo = resultado;
        
        console.log('=== RESULTADO FINAL (GUARDA CORPO - HORIZONTAL) ===');
        console.log(`Nome: ${resultado.nome}`);
        console.log(`Custo Total: R$ ${(resultado.custo_total / 100).toFixed(2)}`);
        console.log(`Componentes: ${resultado.componentes.length}`);
        
        // Preencher campos do resultado
        document.getElementById('nomeProdutoCalculado').textContent = resultado.nome;
        document.getElementById('custoTotalCalculado').textContent = `R$ ${(resultado.custo_total / 100).toFixed(2)}`;
        document.getElementById('pesoTotalCalculado').textContent = 'Calculado pelos componentes';
        document.getElementById('resultadoCalculado').style.display = 'block';
        
        // Preencher tabela de componentes
        preencherTabelaComponentesGuardaCorpo(resultado);
        
        // Habilitar bot√£o salvar
        const salvarBtn = document.getElementById('salvarProdutoBtn');
        if (salvarBtn) {
            salvarBtn.disabled = false;
        }
        
    }).catch(error => {
        console.error('‚ùå Erro ao calcular guarda corpo horizontal:', error);
        alert('Erro no c√°lculo: ' + error.message);
    });
}

function preencherTabelaComponentesGuardaCorpo(resultado) {
    console.log('=== PREENCHENDO TABELA DE COMPONENTES PARA GUARDA CORPO - HORIZONTAL ===');
    
    const tbody = document.getElementById('componentesCalculadosTable');
    if (!tbody) {
        console.warn('Tabela componentesCalculadosTable n√£o encontrada');
        return;
    }
    
    // Limpar tabela
    tbody.innerHTML = '';
    
    // Adicionar linha para cada componente
    resultado.componentes.forEach((comp, index) => {
        const row = tbody.insertRow();
        
        // Componentes de guarda corpo n√£o t√™m fator edit√°vel
        const fatorCol = '<span class="text-muted">-</span>';
        const acaoCol = '<span class="text-muted">-</span>';
        
        row.innerHTML = `
            <td>${comp.nome || 'N/A'}</td>
            <td>${comp.descricao_produto || 'N/A'}</td>
            <td>${fatorCol}</td>
            <td><span class="quantidade-display">${comp.quantidade ? comp.quantidade.toFixed(4) : '0.0000'}</span></td>
            <td>R$ ${comp.custo_unitario ? (comp.custo_unitario/100).toFixed(2) : '0.00'}</td>
            <td><span class="custo-total-display">R$ ${comp.custo_total ? (comp.custo_total/100).toFixed(2) : '0.00'}</span></td>
            <td>${acaoCol}</td>`;
        
        console.log(`‚úì Componente adicionado: ${comp.nome} - ${comp.quantidade.toFixed(4)} ${comp.unidade || 'unid'}`);
    });
    
    // Adicionar linha de total
    const totalRow = tbody.insertRow();
    const custoTotalGeral = resultado.componentes.reduce((total, comp) => total + comp.custo_total, 0);
    totalRow.innerHTML = `
        <td colspan="5"><strong>TOTAL GERAL</strong></td>
        <td><strong>R$ ${(custoTotalGeral/100).toFixed(2)}</strong></td>
        <td></td>`;
    totalRow.style.backgroundColor = '#f8f9fa';
    
    console.log(`‚úÖ Tabela preenchida com ${resultado.componentes.length} componentes. Total: R$ ${(custoTotalGeral/100).toFixed(2)}`);
}

function toggleAreaPintura() {
    const checkbox = document.getElementById('perfil_pintura');
    const container = document.getElementById('perfil_area_pintura_container');
    const input = document.getElementById('perfil_area_pintura');
    
    if (checkbox.checked) {
        container.style.display = 'block';
        input.required = true;
    } else {
        container.style.display = 'none';
        input.required = false;
        input.value = '';
    }
    
    // Recalcular se j√° tiver dados
    calcularPerfilParametrizado();
}

function calcularEscada() {
    console.log('=== CALCULANDO ESCADA ===');
    
    // Verificar se todos os campos obrigat√≥rios est√£o preenchidos
    const camposObrigatorios = ['escada_nome', 'escada_comprimento'];
    
    let todosCamposPreenchidos = true;
    const dados = {};
    
    camposObrigatorios.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (!elemento || !elemento.value.trim()) {
            todosCamposPreenchidos = false;
            console.warn(`Campo ${campo} n√£o preenchido`);
            return;
        }
        
        if (campo === 'escada_nome') {
            dados.nome_escada = elemento.value.trim();
        } else if (campo === 'escada_comprimento') {
            dados.comprimento_escada = parseFloat(elemento.value);
        }
    });
    
    if (!todosCamposPreenchidos) {
        alert('Por favor, preencha todos os campos obrigat√≥rios (nome e comprimento).');
        return;
    }
    
    // Coletar campos opcionais
    const arcoSelecionado = document.getElementById('escada_arco_guarda_corpo')?.value || null;
    
    // Validar arco selecionado
    if (arcoSelecionado && arcoSelecionado !== "" && !isNaN(arcoSelecionado)) {
        dados.arco_guarda_corpo = arcoSelecionado;
        console.log(`Arco selecionado v√°lido: ${arcoSelecionado}`);
    } else {
        dados.arco_guarda_corpo = null;
        if (arcoSelecionado) {
            console.warn(`Arco selecionado inv√°lido: "${arcoSelecionado}" - ser√° ignorado`);
        }
    }
    
    dados.saida_piscina = document.getElementById('escada_saida_piscina')?.checked || false;
    dados.portinhola = document.getElementById('escada_portinhola')?.checked || false;
    dados.tunel_2000mm = document.getElementById('escada_tunel_2000mm')?.checked || false;
    dados.tempo_proc = parseFloat(document.getElementById('escada_tempo_proc')?.value || '3.0');
    dados.tempo_mtg = parseFloat(document.getElementById('escada_tempo_mtg')?.value || '2.0');
    dados.quantidade = 1; // Fixo em 1 unidade
    
    console.log('Dados coletados (Escada):', dados);
    
    // NOVA L√ìGICA SIMPLIFICADA: Usar produto base ESCADA DE MARINHEIRO (ID 1465)
    const produtosNecessarios = [];
    
    // Buscar produto base da escada (ID 1465)
    produtosNecessarios.push(buscarProdutoPorId(1465)); // ESCADA DE MARINHEIRO
    
    // Adicionar produtos opcionais
    if (dados.saida_piscina) {
        produtosNecessarios.push(buscarProdutoPorId(1472)); // SA√çDA PISCINA
    }
    
    if (dados.portinhola) {
        produtosNecessarios.push(
            buscarProdutoPorDescricao('PORTINHOLA').catch(() => null)
        );
    }
    
    if (dados.tunel_2000mm) {
        produtosNecessarios.push(
            buscarProdutoPorDescricao('TUNEL').catch(() => null)
        );
    }
    
    // Adicionar arco se selecionado e v√°lido
    if (dados.arco_guarda_corpo && dados.arco_guarda_corpo !== "" && !isNaN(dados.arco_guarda_corpo)) {
        console.log(`Verificando arco ID: ${dados.arco_guarda_corpo}`);
        produtosNecessarios.push(
            buscarProdutoPorId(dados.arco_guarda_corpo).catch(error => {
                console.warn(`Arco ID ${dados.arco_guarda_corpo} n√£o encontrado:`, error);
                return null;
            })
        );
    } else if (dados.arco_guarda_corpo) {
        console.warn(`ID de arco inv√°lido: "${dados.arco_guarda_corpo}"`);
    }
    
    // Processar todos os produtos necess√°rios
    Promise.all(produtosNecessarios).then((produtos) => {
        // Filtrar produtos v√°lidos
        const produtosValidos = produtos.filter(p => p !== null);
        
        console.log('=== PRODUTOS ENCONTRADOS (ESCADA SIMPLIFICADA) ===');
        produtosValidos.forEach(produto => {
            if (produto) {
                console.log(`${produto.descricao}: R$ ${(produto.custo_centavos / 100).toFixed(2)}`);
            }
        });
        
        // Calcular custo baseado no produto base ESCADA DE MARINHEIRO
        const componentes = [];
        let custoTotal = 0;
        
        // 1. ESCADA DE MARINHEIRO - Multiplicar pelo comprimento
        const escadaBase = produtosValidos[0]; // Produto ID 1465
        if (escadaBase) {
            const quantidadeEscada = dados.comprimento_escada; // 1 unidade por metro
            const custoEscada = (escadaBase.custo_centavos / 100) * quantidadeEscada;
            custoTotal += custoEscada;
            
            componentes.push({
                nome: escadaBase.descricao,
                produto_nome: escadaBase.descricao,
                produto_id: escadaBase.id,
                quantidade: quantidadeEscada,
                custo_unitario: escadaBase.custo_centavos / 100,
                custo_total: custoEscada,
                observacao: `${quantidadeEscada}m de escada`
            });
        }
        
        // 2. COMPONENTES OPCIONAIS
        let componenteIndex = 1; // Come√ßar do √≠ndice 1 (ap√≥s escada base)
        
        if (dados.saida_piscina) {
            const produto = produtosValidos[componenteIndex];
            if (produto) {
                const custo = produto.custo_centavos / 100;
                custoTotal += custo;
                
                componentes.push({
                    nome: produto.descricao,
                    produto_nome: produto.descricao,
                    produto_id: produto.id,
                    quantidade: 1,
                    custo_unitario: custo,
                    custo_total: custo,
                    observacao: 'Sa√≠da para piscina'
                });
                
                console.log(`‚úÖ Sa√≠da piscina: ${produto.descricao} - R$ ${custo.toFixed(2)}`);
            } else {
                console.warn('Produto SA√çDA PISCINA n√£o encontrado');
            }
            componenteIndex++;
        }
        
        if (dados.portinhola) {
            const produto = produtosValidos[componenteIndex];
            if (produto) {
                const custo = produto.custo_centavos / 100;
                custoTotal += custo;
                
                componentes.push({
                    nome: produto.descricao,
                    produto_nome: produto.descricao,
                    produto_id: produto.id,
                    quantidade: 1,
                    custo_unitario: custo,
                    custo_total: custo,
                    observacao: 'Portinhola'
                });
            }
            componenteIndex++;
        }
        
        if (dados.tunel_2000mm) {
            const produto = produtosValidos[componenteIndex];
            if (produto) {
                const custo = produto.custo_centavos / 100;
                custoTotal += custo;
                
                componentes.push({
                    nome: produto.descricao,
                    produto_nome: produto.descricao,
                    produto_id: produto.id,
                    quantidade: 1,
                    custo_unitario: custo,
                    custo_total: custo,
                    observacao: 'T√∫nel 2000mm'
                });
            }
            componenteIndex++;
        }
        
        if (dados.arco_guarda_corpo) {
            const produto = produtosValidos[componenteIndex];
            if (produto) {
                // Quantidade de arco = comprimento da escada - 2 metros
                const quantidadeArco = Math.max(0, dados.comprimento_escada - 2);
                const custoUnitario = produto.custo_centavos / 100;
                const custoTotal_arco = custoUnitario * quantidadeArco;
                custoTotal += custoTotal_arco;
                
                componentes.push({
                    nome: produto.descricao,
                    produto_nome: produto.descricao,
                    produto_id: produto.id,
                    quantidade: quantidadeArco,
                    custo_unitario: custoUnitario,
                    custo_total: custoTotal_arco,
                    observacao: `Arco de guarda corpo - ${quantidadeArco}m (escada ${dados.comprimento_escada}m - 2m)`
                });
                
                console.log(`üìè Arco calculado: ${dados.comprimento_escada}m escada - 2m = ${quantidadeArco}m de arco`);
            } else {
                console.warn('Arco selecionado n√£o encontrado');
            }
        }
        
        // 3. M√ÉO DE OBRA (mantida igual)
        const custoMaoObraProcessamento = 50.00 * dados.tempo_proc; // R$ 50/h estimado
        const custoMaoObraMontagem = 45.00 * dados.tempo_mtg; // R$ 45/h estimado
        const custoMaoObraTotal = custoMaoObraProcessamento + custoMaoObraMontagem;
        custoTotal += custoMaoObraTotal;
        
        componentes.push({
            nome: 'M√ÉO DE OBRA - PROCESSAMENTO',
            produto_nome: 'M√ÉO DE OBRA - PROCESSAMENTO',
            produto_id: 'mao_obra_proc',
            quantidade: dados.tempo_proc,
            custo_unitario: 50.00,
            custo_total: custoMaoObraProcessamento,
            observacao: 'Processamento'
        });
        
        componentes.push({
            nome: 'M√ÉO DE OBRA - MONTAGEM',
            produto_nome: 'M√ÉO DE OBRA - MONTAGEM',
            produto_id: 'mao_obra_mtg',
            quantidade: dados.tempo_mtg,
            custo_unitario: 45.00,
            custo_total: custoMaoObraMontagem,
            observacao: 'Montagem'
        });
        
        // Armazenar resultado
        ultimoCalculo = {
            template: 'escada_customizado',
            componentes: componentes,  // Mover componentes para o n√≠vel correto
            produto: {
                nome: dados.nome_escada,
                descricao: `Escada ${dados.comprimento_escada}m${dados.saida_piscina ? ' c/ Sa√≠da Piscina' : ''}${dados.portinhola ? ' c/ Portinhola' : ''}${dados.tunel_2000mm ? ' c/ T√∫nel 2000mm' : ''}`,
                custo_total: custoTotal
            },
            parametros: dados
        };
        
        // Atualizar interface
        preencherTabelaComponentes(ultimoCalculo);
        
        // Habilitar bot√£o salvar
        document.getElementById('salvarProdutoBtn').disabled = false;
        
        console.log('=== C√ÅLCULO ESCADA SIMPLIFICADO CONCLU√çDO ===');
        console.log('Custo Total:', custoTotal.toFixed(2));
        console.log('Componentes:', componentes.length);
        console.log('Base da escada: R$', (escadaBase?.custo_centavos / 100)?.toFixed(2), 'x', dados.comprimento_escada, 'm');
        
    }).catch(error => {
        console.error('Erro ao processar produtos para escada:', error);
        alert('Erro ao processar produtos necess√°rios para o c√°lculo da escada. Verifique o console para detalhes.');
    });
}

function calcularNovoPerfil() {
    console.log('=== CALCULANDO NOVO PERFIL ===');
    
    // Verificar se todos os campos obrigat√≥rios est√£o preenchidos
    const camposObrigatorios = [
        'perfil_nome', 'perfil_roving', 'perfil_manta', 'perfil_veu', 
        'perfil_peso_metro', 'perfil_n_matrizes', 'perfil_n_maquinas', 
        'perfil_metros_h', 'perfil_perda', 'perfil_tipo_resina'
    ];
    
    let todosCamposPreenchidos = true;
    const dados = {};
    
    camposObrigatorios.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (!elemento || !elemento.value.trim()) {
            todosCamposPreenchidos = false;
            return;
        }
        
        const valor = elemento.value.trim();
        if (campo === 'perfil_nome') {
            dados[elemento.name] = valor;
        } else {
            dados[elemento.name] = parseFloat(valor) || 0;
        }
    });
    
    // Verificar pintura
    const temPintura = document.getElementById('perfil_pintura').checked;
    dados.tem_pintura = temPintura;
    
    if (temPintura) {
        const areaPintura = document.getElementById('perfil_area_pintura').value;
        if (!areaPintura || parseFloat(areaPintura) <= 0) {
            alert('√Årea de pintura deve ser preenchida quando pintura est√° marcada!');
            return;
        }
        dados.area_pintura_m2 = parseFloat(areaPintura);
    } else {
        dados.area_pintura_m2 = 0;
    }
    
    if (!todosCamposPreenchidos) {
        alert('Preencha todos os campos obrigat√≥rios!');
        return;
    }
    
    console.log('Dados coletados:', dados);
    
    // Buscar pre√ßos da base de dados MP_Produtos antes de calcular
    console.log('üîç Buscando pre√ßos da base de dados...');
    
    fetch('/api/produtos/')
        .then(response => response.json())
        .then(produtos => {
            console.log('‚úÖ Produtos carregados da base:', produtos.length);
            
            // Criar mapeamento de produtos por nome/descri√ß√£o
            const precosProdutos = {};
            
            produtos.forEach(produto => {
                const desc = produto.descricao.toLowerCase();
                const precoReais = produto.custo_centavos / 100;
                
                // Mapear produtos espec√≠ficos
                if (desc.includes('roving') && desc.includes('4400')) {
                    precosProdutos['roving'] = precoReais;
                } else if (desc.includes('manta') && desc.includes('300')) {
                    precosProdutos['manta'] = precoReais;
                } else if (desc.includes('v√©u') || desc.includes('veu')) {
                    precosProdutos['veu'] = precoReais;
                } else if (desc.includes('resina') && (desc.includes('pet') || desc.includes('poli√©ster'))) {
                    precosProdutos['resina'] = precoReais;
                } else if (desc.includes('mon√¥mero') || desc.includes('estireno')) {
                    precosProdutos['monomero'] = precoReais;
                } else if (desc.includes('anti') && desc.includes('uv')) {
                    precosProdutos['antiUV'] = precoReais;
                } else if (desc.includes('anti') && desc.includes('ox')) {
                    precosProdutos['antiOX'] = precoReais;
                } else if (desc.includes('bpo')) {
                    precosProdutos['bpo'] = precoReais;
                } else if (desc.includes('tbpb')) {
                    precosProdutos['tbpb'] = precoReais;
                } else if (desc.includes('desmoldante')) {
                    precosProdutos['desmoldante'] = precoReais;
                } else if (desc.includes('antichama')) {
                    precosProdutos['antichama'] = precoReais;
                } else if (desc.includes('carga') && desc.includes('mineral')) {
                    precosProdutos['cargaMineral'] = precoReais;
                } else if (desc.includes('pigmento')) {
                    precosProdutos['pigmento'] = precoReais;
                } else if (desc.includes('pintura')) {
                    precosProdutos['pintura'] = precoReais;
                }
            });
            
            console.log('üí∞ Pre√ßos mapeados:', precosProdutos);
            
            // Definir pre√ßos padr√£o caso n√£o encontre na base
            const precosDefault = {
                roving: 8.50,
                manta: 12.00,
                veu: 25.00,
                resina: 12.96,
                monomero: 8.00,
                antiUV: 45.00,
                antiOX: 35.00,
                bpo: 28.00,
                tbpb: 42.00,
                desmoldante: 22.00,
                antichama: 18.50,
                cargaMineral: 3.20,
                pigmento: 15.80,
                pintura: 15.00
            };
            
            // Usar pre√ßo da base ou padr√£o se n√£o encontrar
            const precos = {};
            Object.keys(precosDefault).forEach(key => {
                precos[key] = precosProdutos[key] || precosDefault[key];
                if (!precosProdutos[key]) {
                    console.warn(`‚ö†Ô∏è Pre√ßo n√£o encontrado na base para ${key}, usando padr√£o: R$ ${precosDefault[key]}`);
                }
            });
            
            // BUSCAR PRE√áO ESPEC√çFICO DA RESINA SELECIONADA
            const tipoResinaId = dados.tipo_resina;
            console.log(`üéØ Tipo de resina selecionado: ID ${tipoResinaId}`);
            
            const resinaSelecionada = produtos.find(p => p.id == tipoResinaId);
            if (resinaSelecionada) {
                precos.resina = resinaSelecionada.custo_centavos / 100;
                console.log(`‚úÖ Pre√ßo da resina selecionada (${resinaSelecionada.descricao}): R$ ${precos.resina.toFixed(2)}`);
            } else {
                console.warn(`‚ö†Ô∏è Resina ID ${tipoResinaId} n√£o encontrada, usando pre√ßo padr√£o: R$ ${precos.resina}`);
            }
            
            // C√ÅLCULO CORRETO DOS COMPONENTES DA RESINA
            // Peso da resina base = peso do metro - (roving + manta + v√©u)
            const pesoResinaBase = dados.peso_metro_kg - (dados.roving_4400_kg + dados.manta_300_kg + dados.veu_kg);
            
            console.log('C√°lculo da resina:');
            console.log(`Peso do metro: ${dados.peso_metro_kg} kg`);
            console.log(`Peso fibras (roving + manta + v√©u): ${dados.roving_4400_kg + dados.manta_300_kg + dados.veu_kg} kg`);
            console.log(`Peso resina base: ${pesoResinaBase} kg`);
            
            // Fatores de multiplica√ß√£o conforme especificado
            const fatores = {
                resina: 0.6897,           // 68.97%
                monomero: 0.0213,         // 2.13%
                antiUV: 0.0028,           // 0.28%
                antiOX: 0.0011,           // 0.11%
                bpo: 0.0071,              // 0.71%
                tbpb: 0.0043,             // 0.43%
                desmoldante: 0.0071,      // 0.71%
                antichama: 0.1777,        // 17.77%
                cargaMineral: 0.0711,     // 7.11%
                pigmento: 0.0178          // 1.78%
            };
            
            // Calcular componentes da resina usando pre√ßos da base
            const componentes = [
                {
                    nome: 'Roving 4400 KG',
                    produto_nome: 'Roving 4400 tex',
                    quantidade: dados.roving_4400_kg,
                    custo_unitario: precos.roving,
                    custo_total: dados.roving_4400_kg * precos.roving
                },
                {
                    nome: 'Manta 300 KG',
                    produto_nome: 'Manta 300 g/m¬≤',
                    quantidade: dados.manta_300_kg,
                    custo_unitario: precos.manta,
                    custo_total: dados.manta_300_kg * precos.manta
                },
                {
                    nome: 'V√©u KG',
                    produto_nome: 'V√©u de Superf√≠cie',
                    quantidade: dados.veu_kg,
                    custo_unitario: precos.veu,
                    custo_total: dados.veu_kg * precos.veu
                },
                {
                    nome: 'Resina PET',
                    produto_nome: 'Resina Poli√©ster',
                    quantidade: pesoResinaBase * fatores.resina,
                    custo_unitario: precos.resina,
                    custo_total: (pesoResinaBase * fatores.resina) * precos.resina
                },
                {
                    nome: 'Mon√¥mero de estireno',
                    produto_nome: 'Estireno',
                    quantidade: pesoResinaBase * fatores.monomero,
                    custo_unitario: precos.monomero,
                    custo_total: (pesoResinaBase * fatores.monomero) * precos.monomero
                },
                {
                    nome: 'Anti UV',
                    produto_nome: 'Aditivo Anti UV',
                    quantidade: pesoResinaBase * fatores.antiUV,
                    custo_unitario: precos.antiUV,
                    custo_total: (pesoResinaBase * fatores.antiUV) * precos.antiUV
                },
                {
                    nome: 'Anti OX',
                    produto_nome: 'Aditivo Anti Oxidante',
                    quantidade: pesoResinaBase * fatores.antiOX,
                    custo_unitario: precos.antiOX,
                    custo_total: (pesoResinaBase * fatores.antiOX) * precos.antiOX
                },
                {
                    nome: 'BPO',
                    produto_nome: 'Per√≥xido de Benzo√≠la',
                    quantidade: pesoResinaBase * fatores.bpo,
                    custo_unitario: precos.bpo,
                    custo_total: (pesoResinaBase * fatores.bpo) * precos.bpo
                },
                {
                    nome: 'TBPB',
                    produto_nome: 'Terc-Butil Perbenzoato',
                    quantidade: pesoResinaBase * fatores.tbpb,
                    custo_unitario: precos.tbpb,
                    custo_total: (pesoResinaBase * fatores.tbpb) * precos.tbpb
                },
                {
                    nome: 'Desmoldante',
                    produto_nome: 'Desmoldante Industrial',
                    quantidade: pesoResinaBase * fatores.desmoldante,
                    custo_unitario: precos.desmoldante,
                    custo_total: (pesoResinaBase * fatores.desmoldante) * precos.desmoldante
                },
                {
                    nome: 'Antichama',
                    produto_nome: 'Aditivo Antichama',
                    quantidade: pesoResinaBase * fatores.antichama,
                    custo_unitario: precos.antichama,
                    custo_total: (pesoResinaBase * fatores.antichama) * precos.antichama
                },
                {
                    nome: 'Carga mineral',
                    produto_nome: 'Carbonato de C√°lcio',
                    quantidade: pesoResinaBase * fatores.cargaMineral,
                    custo_unitario: precos.cargaMineral,
                    custo_total: (pesoResinaBase * fatores.cargaMineral) * precos.cargaMineral
                },
                {
                    nome: 'Pigmento',
                    produto_nome: 'Pigmento Colorante',
                    quantidade: pesoResinaBase * fatores.pigmento,
                    custo_unitario: precos.pigmento,
                    custo_total: (pesoResinaBase * fatores.pigmento) * precos.pigmento
                }
            ];
            
            // Adicionar pintura se necess√°rio
            if (temPintura && dados.area_pintura_m2 > 0) {
                componentes.push({
                    nome: '√Årea pintura (m¬≤)',
                    produto_nome: 'Pintura Industrial',
                    quantidade: dados.area_pintura_m2,
                    custo_unitario: precos.pintura,
                    custo_total: dados.area_pintura_m2 * precos.pintura
                });
            }
            
            // ADICIONAR M√ÉO DE OBRA - NOVA F√ìRMULA
            // ((mo_pultrusao / 3) * n¬∞ de m√°quinas) / (VELOCIDADE M/H * N¬∞ MATRIZES * 24 * 21 * 0,5)
            if (dados.metros_produzidos_h > 0 && dados.n_matrizes > 0) {
                const mo_pultrusao = 9976258; // Valor da tabela main_maoobra ID=1 em centavos
                const velocidade = dados.metros_produzidos_h;
                const matrizes = dados.n_matrizes;
                const maquinas = dados.n_maquinas;
                
                // Aplicar nova f√≥rmula
                const numerador = (mo_pultrusao / 3) * maquinas;
                const denominador = velocidade * matrizes * 24 * 21 * 0.5;
                const custo_raw = numerador / denominador;
                const custo_mao_obra_centavos = Math.max(1, Math.floor(custo_raw));
                const custo_mao_obra_reais = custo_mao_obra_centavos / 100;
                
                console.log('=== C√ÅLCULO M√ÉO DE OBRA (NOVA F√ìRMULA) ===');
                console.log(`Par√¢metros: velocidade=${velocidade}, matrizes=${matrizes}, m√°quinas=${maquinas}`);
                console.log(`Numerador: (${mo_pultrusao} / 3) * ${maquinas} = ${numerador.toFixed(2)}`);
                console.log(`Denominador: ${velocidade} * ${matrizes} * 24 * 21 * 0.5 = ${denominador}`);
                console.log(`Resultado: ${numerador.toFixed(2)} / ${denominador} = ${custo_raw.toFixed(8)}`);
                console.log(`Custo final: ${custo_mao_obra_centavos} centavos = R$ ${custo_mao_obra_reais.toFixed(2)}`);
                
                componentes.push({
                    nome: 'M√£o de Obra - Pultrus√£o',
                    produto_nome: 'M√£o de Obra Industrial',
                    quantidade: 1.0,
                    custo_unitario: custo_mao_obra_reais,
                    custo_total: custo_mao_obra_reais
                });
            }
            
            // Calcular custo total com 3% de perda nas mat√©rias-primas
            // Separar mat√©rias-primas de m√£o de obra
            const custoMateriasPrimas = componentes
                .filter(comp => comp.nome !== 'M√£o de Obra - Pultrus√£o')
                .reduce((total, comp) => total + comp.custo_total, 0);
            
            const custoMaoObra = componentes
                .filter(comp => comp.nome === 'M√£o de Obra - Pultrus√£o')
                .reduce((total, comp) => total + comp.custo_total, 0);
            
            // Aplicar 3% de perda nas mat√©rias-primas
            const custoMateriasComPerda = custoMateriasPrimas * 1.03; // 3% de perda
            const custoTotal = custoMateriasComPerda + custoMaoObra;
            
            console.log('=== APLICA√á√ÉO DE 3% DE PERDA ===');
            console.log(`Custo mat√©rias-primas sem perda: R$ ${custoMateriasPrimas.toFixed(2)}`);
            console.log(`Custo mat√©rias-primas com 3% perda: R$ ${custoMateriasComPerda.toFixed(2)}`);
            console.log(`Custo m√£o de obra: R$ ${custoMaoObra.toFixed(2)}`);
            console.log(`Custo total final: R$ ${custoTotal.toFixed(2)}`);
            
            // Criar resultado
            ultimoCalculo = {
                success: true,
                custo_total: Math.round(custoTotal * 100), // em centavos
                peso_total: dados.peso_metro_kg,
                peso_resina_base: pesoResinaBase,
                peso_fibras: dados.roving_4400_kg + dados.manta_300_kg + dados.veu_kg,
                nome_produto: dados.nome_perfil,
                componentes: componentes,
                dados_originais: dados, // Para poder recalcular
                fatores_originais: { // Para exibir na tabela
                    'Resina PET': fatores.resina * 100,
                    'Mon√¥mero de estireno': fatores.monomero * 100,
                    'Anti UV': fatores.antiUV * 100,
                    'Anti OX': fatores.antiOX * 100,
                    'BPO': fatores.bpo * 100,
                    'TBPB': fatores.tbpb * 100,
                    'Desmoldante': fatores.desmoldante * 100,
                    'Antichama': fatores.antichama * 100,
                    'Carga mineral': fatores.cargaMineral * 100,
                    'Pigmento': fatores.pigmento * 100
                }
            };
            
            // Mostrar resultado na interface padr√£o
            document.getElementById('nomeProdutoCalculado').textContent = dados.nome_perfil;
            document.getElementById('custoTotalCalculado').textContent = `R$ ${(ultimoCalculo.custo_total / 100).toFixed(2)} (pre√ßos atualizados + 3% perda)`;
            document.getElementById('pesoTotalCalculado').textContent = `${dados.peso_metro_kg} kg`;
            document.getElementById('resultadoCalculado').style.display = 'block';
            
            // Preencher tabela de componentes (usar fun√ß√£o existente)
            preencherTabelaComponentes(ultimoCalculo);
            
            console.log('‚úÖ C√°lculo de Novo Perfil conclu√≠do com pre√ßos da base:', ultimoCalculo);
        })
        .catch(error => {
            console.error('‚ùå Erro ao buscar pre√ßos da base:', error);
            alert('Erro ao carregar pre√ßos da base de dados. Usando valores padr√£o.');
            
            // Em caso de erro, usar valores padr√£o e continuar c√°lculo
            calcularNovoPerfilComPrecosDefault(dados, temPintura);
        });
}

// Fun√ß√£o auxiliar para calcular com pre√ßos padr√£o em caso de erro no MP
function calcularNovoPerfilComPrecosDefault(dados, temPintura) {
    console.log('‚ö†Ô∏è Usando pre√ßos padr√£o devido a erro na base de dados');
    
    // Pre√ßos padr√£o baseados no tipo de resina selecionado
    let precoResina = 12.96; // Padr√£o poli√©ster
    const tipoResinaId = dados.tipo_resina;
    console.log(`üéØ Ajustando pre√ßo de resina para ID ${tipoResinaId} (fallback MP)`);
    
    // Pre√ßos conhecidos das resinas
    const precosResinas = {
        '1269': 12.96,  // Resina Poli√©ster (padr√£o)
        '1268': 18.34,  // Resina Isoft√°lica  
        '1270': 35.97   // Resina √âster Vin√≠lica
    };
    
    if (precosResinas[tipoResinaId]) {
        precoResina = precosResinas[tipoResinaId];
        console.log(`‚úÖ Pre√ßo de resina ajustado para: R$ ${precoResina.toFixed(2)}`);
    }
    
    // CONTINUAR COM L√ìGICA PADR√ÉO (c√≥digo existente)
    const pesoResinaBase = dados.peso_metro_kg - (dados.roving_4400_kg + dados.manta_300_kg + dados.veu_kg);
    
    const fatores = {
        resina: 0.6897, monomero: 0.0213, antiUV: 0.0028, antiOX: 0.0011,
        bpo: 0.0071, tbpb: 0.0043, desmoldante: 0.0071, antichama: 0.1777,
        cargaMineral: 0.0711, pigmento: 0.0178
    };
    
    const componentes = [
        { nome: 'Roving 4400 KG', produto_nome: 'Roving 4400 tex', quantidade: dados.roving_4400_kg, custo_unitario: 8.50, custo_total: dados.roving_4400_kg * 8.50 },
        { nome: 'Manta 300 KG', produto_nome: 'Manta 300 g/m¬≤', quantidade: dados.manta_300_kg, custo_unitario: 12.00, custo_total: dados.manta_300_kg * 12.00 },
        { nome: 'V√©u KG', produto_nome: 'V√©u de Superf√≠cie', quantidade: dados.veu_kg, custo_unitario: 25.00, custo_total: dados.veu_kg * 25.00 },
        { nome: 'Resina PET', produto_nome: 'Resina Selecionada', quantidade: pesoResinaBase * fatores.resina, custo_unitario: precoResina, custo_total: (pesoResinaBase * fatores.resina) * precoResina },
        { nome: 'Mon√¥mero de estireno', produto_nome: 'Estireno', quantidade: pesoResinaBase * fatores.monomero, custo_unitario: 8.00, custo_total: (pesoResinaBase * fatores.monomero) * 8.00 },
        { nome: 'Anti UV', produto_nome: 'Aditivo Anti UV', quantidade: pesoResinaBase * fatores.antiUV, custo_unitario: 45.00, custo_total: (pesoResinaBase * fatores.antiUV) * 45.00 },
        { nome: 'Anti OX', produto_nome: 'Aditivo Anti Oxidante', quantidade: pesoResinaBase * fatores.antiOX, custo_unitario: 35.00, custo_total: (pesoResinaBase * fatores.antiOX) * 35.00 },
        { nome: 'BPO', produto_nome: 'Per√≥xido de Benzo√≠la', quantidade: pesoResinaBase * fatores.bpo, custo_unitario: 28.00, custo_total: (pesoResinaBase * fatores.bpo) * 28.00 },
        { nome: 'TBPB', produto_nome: 'Terc-Butil Perbenzoato', quantidade: pesoResinaBase * fatores.tbpb, custo_unitario: 42.00, custo_total: (pesoResinaBase * fatores.tbpb) * 42.00 },
        { nome: 'Desmoldante', produto_nome: 'Desmoldante Industrial', quantidade: pesoResinaBase * fatores.desmoldante, custo_unitario: 22.00, custo_total: (pesoResinaBase * fatores.desmoldante) * 22.00 },
        { nome: 'Antichama', produto_nome: 'Aditivo Antichama', quantidade: pesoResinaBase * fatores.antichama, custo_unitario: 18.50, custo_total: (pesoResinaBase * fatores.antichama) * 18.50 },
        { nome: 'Carga mineral', produto_nome: 'Carbonato de C√°lcio', quantidade: pesoResinaBase * fatores.cargaMineral, custo_unitario: 3.20, custo_total: (pesoResinaBase * fatores.cargaMineral) * 3.20 },
        { nome: 'Pigmento', produto_nome: 'Pigmento Colorante', quantidade: pesoResinaBase * fatores.pigmento, custo_unitario: 15.80, custo_total: (pesoResinaBase * fatores.pigmento) * 15.80 }
    ];
    
    if (temPintura && dados.area_pintura_m2 > 0) {
        componentes.push({
            nome: '√Årea pintura (m¬≤)', produto_nome: 'Pintura Industrial',
            quantidade: dados.area_pintura_m2, custo_unitario: 15.86,
            custo_total: dados.area_pintura_m2 * 15.86
        });
    }
    
    // M√£o de obra
    if (dados.metros_produzidos_h > 0 && dados.n_matrizes > 0) {
        const mo_pultrusao = 9976258, numerador = (mo_pultrusao / 3) * dados.n_maquinas;
        const denominador = dados.metros_produzidos_h * dados.n_matrizes * 24 * 21 * 0.5;
        const custo_mao_obra_reais = Math.max(0.01, numerador / denominador / 100);
        
        componentes.push({
            nome: 'M√£o de Obra - Pultrus√£o', produto_nome: 'M√£o de Obra Industrial',
            quantidade: 1.0, custo_unitario: custo_mao_obra_reais, custo_total: custo_mao_obra_reais
        });
    }
    
    // Calcular custo total com 3% de perda nas mat√©rias-primas
    const custoMateriasPrimas = componentes
        .filter(comp => comp.nome !== 'M√£o de Obra - Pultrus√£o')
        .reduce((total, comp) => total + comp.custo_total, 0);
    
    const custoMaoObra = componentes
        .filter(comp => comp.nome === 'M√£o de Obra - Pultrus√£o')
        .reduce((total, comp) => total + comp.custo_total, 0);
    
    // Aplicar 3% de perda nas mat√©rias-primas
    const custoMateriasComPerda = custoMateriasPrimas * 1.03;
    const custoTotal = custoMateriasComPerda + custoMaoObra;
    
    console.log('‚ö†Ô∏è C√ÅLCULO COM PRE√áOS PADR√ÉO + 3% PERDA');
    console.log(`Mat√©rias-primas: R$ ${custoMateriasPrimas.toFixed(2)} ‚Üí R$ ${custoMateriasComPerda.toFixed(2)} (+3%)`);
    console.log(`Total final: R$ ${custoTotal.toFixed(2)}`);
    
    ultimoCalculo = {
        success: true, custo_total: Math.round(custoTotal * 100),
        peso_total: dados.peso_metro_kg, nome_produto: dados.nome_perfil,
        componentes: componentes, dados_originais: dados,
        fatores_originais: {
            'Resina PET': fatores.resina * 100, 'Mon√¥mero de estireno': fatores.monomero * 100,
            'Anti UV': fatores.antiUV * 100, 'Anti OX': fatores.antiOX * 100,
            'BPO': fatores.bpo * 100, 'TBPB': fatores.tbpb * 100,
            'Desmoldante': fatores.desmoldante * 100, 'Antichama': fatores.antichama * 100,
            'Carga mineral': fatores.cargaMineral * 100, 'Pigmento': fatores.pigmento * 100
        }
    };
    
    document.getElementById('nomeProdutoCalculado').textContent = dados.nome_perfil;
    document.getElementById('custoTotalCalculado').textContent = `R$ ${(ultimoCalculo.custo_total / 100).toFixed(2)} (valores padr√£o + 3% perda)`;
    document.getElementById('pesoTotalCalculado').textContent = `${dados.peso_metro_kg} kg`;
    document.getElementById('resultadoCalculado').style.display = 'block';
    
    preencherTabelaComponentes(ultimoCalculo);
    console.log('‚ö†Ô∏è C√°lculo conclu√≠do com pre√ßos padr√£o:', ultimoCalculo);
}

// Fun√ß√£o auxiliar para preencher tabela de componentes
function preencherTabelaComponentes(calculo) {
    const tbody = document.getElementById('componentesCalculadosTable');
    tbody.innerHTML = '';
    
    console.log('=== PREENCHENDO TABELA DE COMPONENTES ===');
    
    // Verificar se calculo e componentes existem
    if (!calculo || !calculo.componentes || !Array.isArray(calculo.componentes)) {
        console.warn('‚ö†Ô∏è Dados de componentes inv√°lidos:', calculo);
        return;
    }
    
    calculo.componentes.forEach((comp, index) => {
        const row = tbody.insertRow();
        const isComponenteResina = ['Resina PET', 'Mon√¥mero de estireno', 'Anti UV', 'Anti OX', 'BPO', 'TBPB', 'Desmoldante', 'Antichama', 'Carga mineral', 'Pigmento'].includes(comp.nome);
        
        let fatorCol = '', acaoCol = '';
        if (isComponenteResina) {
            const fatorAtual = calculo.fatores_originais[comp.nome] || 0;
            fatorCol = `<input type="number" step="0.01" class="form-control form-control-sm fator-input" value="${fatorAtual.toFixed(2)}" data-component-index="${index}" style="width: 80px;" min="0" max="100">`;
            acaoCol = `<button class="btn btn-sm btn-success" onclick="recalcularComponente(${index})" title="Recalcular"><i class="fas fa-calculator"></i></button>`;
        } else {
            fatorCol = '<span class="text-muted">-</span>';
            acaoCol = '<span class="text-muted">-</span>';
        }
        
        row.innerHTML = `
            <td>${comp.nome || 'N/A'}</td>
            <td>${comp.produto_nome || 'N/A'}</td>
            <td>${fatorCol}</td>
            <td><span class="quantidade-display">${comp.quantidade ? comp.quantidade.toFixed(4) : '0.0000'}</span></td>
            <td>R$ ${comp.custo_unitario ? comp.custo_unitario.toFixed(2) : '0.00'}</td>
            <td><span class="custo-total-display">R$ ${comp.custo_total.toFixed(2)}</span></td>
            <td>${acaoCol}</td>`;
    });
    
    const totalRow = tbody.insertRow();
    const custoTotalGeral = calculo.componentes.reduce((total, comp) => total + comp.custo_total, 0);
    totalRow.innerHTML = `
        <td colspan="5"><strong>TOTAL GERAL</strong></td>
        <td><strong><span id="custo-total-geral">R$ ${custoTotalGeral.toFixed(2)}</span></strong></td>
        <td>
            <button class="btn btn-sm btn-warning" onclick="recalcularTodosComponentes()" title="Recalcular Todos">
                <i class="fas fa-sync-alt"></i>
            </button>
        </td>
    `;
    
    console.log('Tabela de componentes preenchida com sucesso!');
    document.getElementById('salvarProdutoBtn').disabled = false;
}

function gerarReferenciaPerfil(nomePerfil) {
    // Gerar refer√™ncia baseada no nome do perfil
    // Formato: PER-XXXX onde XXXX s√£o 4 d√≠gitos baseados no nome
    
    let referencia = 'PER-';
    
    // Remover caracteres especiais e espa√ßos
    const nomeSimplificado = nomePerfil
        .replace(/[^a-zA-Z0-9]/g, '')  // Remove caracteres especiais
        .toUpperCase()                  // Converte para mai√∫sculo
        .substring(0, 10);              // Pega apenas os primeiros 10 caracteres
    
    // Se tem n√∫meros no nome, usar eles
    const numeros = nomePerfil.match(/\d+/g);
    if (numeros && numeros.length > 0) {
        // Usar os n√∫meros encontrados no nome
        const numerosCombinados = numeros.join('');
        referencia += numerosCombinados.substring(0, 4).padStart(4, '0');
    } else {
        // Gerar c√≥digo baseado nas letras (hash simples)
        let hash = 0;
        for (let i = 0; i < nomeSimplificado.length; i++) {
            const char = nomeSimplificado.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // Converte para 32-bit
        }
        
        // Usar valor absoluto e pegar 4 d√≠gitos
        const codigo = Math.abs(hash).toString().substring(0, 4).padStart(4, '0');
        referencia += codigo;
    }
    
    // Adicionar timestamp para garantir unicidade
    const agora = new Date();
    const timestamp = (agora.getHours() * 60 + agora.getMinutes()).toString().padStart(4, '0');
    
    return referencia + '-' + timestamp.substring(0, 2);
}

function salvarPerfilParametrizado() {
    console.log('=== SALVANDO PERFIL PARAMETRIZADO ===');
    
    // Verificar se o c√°lculo foi feito
    if (!ultimoCalculo) {
        alert('Realize o c√°lculo primeiro!');
        return;
    }
    
    // Coletar dados do formul√°rio
    const dadosPerfil = {};
    const allInputs = document.querySelectorAll('.param-input');
    
    allInputs.forEach(input => {
        if (input.type === 'checkbox') {
            dadosPerfil[input.name] = input.checked;
        } else if (input.name === 'nome_perfil') {
            dadosPerfil[input.name] = input.value.trim();
        } else {
            dadosPerfil[input.name] = parseFloat(input.value) || 0;
        }
    });
    
    // Valida√ß√£o b√°sica
    if (!dadosPerfil.nome_perfil) {
        alert('Nome do perfil √© obrigat√≥rio!');
        return;
    }
    
    if (dadosPerfil.tem_pintura && dadosPerfil.area_pintura_m2 <= 0) {
        alert('√Årea de pintura deve ser maior que zero quando pintura est√° marcada!');
        return;
    }
    
    console.log('Dados do perfil:', dadosPerfil);
    
    // Criar produto na base de dados
    const produtoData = {
        descricao: dadosPerfil.nome_perfil,
        custo_centavos: ultimoCalculo.custo_total,
        peso_und: dadosPerfil.peso_metro_kg.toFixed(3),
        unidade: dadosPerfil.unidade || 'M', // Usar unidade selecionada ou Metro linear como padr√£o
        referencia: gerarReferenciaPerfil(dadosPerfil.nome_perfil),
        tipo_produto: 'composto', // CORRE√á√ÉO: Definir como composto
        categoria: 'Perfis',
        subcategoria: 'Pultrus√£o',
        data_revisao: new Date().toISOString(),
        // Dados espec√≠ficos do perfil
        dados_perfil: JSON.stringify(dadosPerfil)
    };
    
    console.log('Dados do produto:', produtoData);
    
    // Salvar produto
    fetch('/api/produtos/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(produtoData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(produto => {
        console.log('‚úÖ Perfil principal salvo:', produto);
        
        // Agora salvar os componentes calculados
        return salvarComponentesPerfil(produto.id).then(() => produto);
    })
    .then(produto => {
        console.log('‚úÖ Perfil e componentes salvos com sucesso');
        alert(`Perfil "${dadosPerfil.nome_perfil}" criado com sucesso como produto composto!\nID: ${produto.id}\nCusto: R$ ${(produto.custo_centavos / 100).toFixed(2)}`);
        
        // Fechar modal
        closeProdutoParametrizadoModal();
        
        // Atualizar lista de produtos
        fetchProdutos();
    })
    .catch(error => {
        console.error('Erro ao salvar perfil:', error);
        alert('Erro ao salvar perfil: ' + error.message);
    });
}

function salvarComponentesPerfil(produtoId) {
    console.log('=== SALVANDO COMPONENTES DO PERFIL ===');
    console.log('Produto ID:', produtoId);
    console.log('√öltimo c√°lculo:', ultimoCalculo);
    
    if (!ultimoCalculo || !ultimoCalculo.componentes) {
        console.warn('Nenhum componente para salvar');
        return Promise.resolve();
    }
    
    // Primeiro, buscar todos os produtos para mapear nomes para IDs
    return fetch('/api/produtos/')
        .then(response => response.json())
        .then(produtos => {
            console.log('‚úÖ Produtos carregados para mapeamento:', produtos.length);
            
            // Criar mapa de produto_nome para ID
            const mapaProdutos = {};
            produtos.forEach(produto => {
                const desc = produto.descricao.toLowerCase();
                
                // Mapear os nomes dos componentes para IDs dos produtos
                if (desc.includes('roving') && desc.includes('4400')) {
                    mapaProdutos['roving 4400 kg'] = produto.id;
                } else if (desc.includes('manta') && desc.includes('300')) {
                    mapaProdutos['manta 300 kg'] = produto.id;
                } else if (desc.includes('v√©u') || desc.includes('veu')) {
                    mapaProdutos['v√©u kg'] = produto.id;
                } else if (desc.includes('resina') && (desc.includes('pet') || desc.includes('poli√©ster'))) {
                    mapaProdutos['resina pet'] = produto.id;
                } else if (desc.includes('mon√¥mero') || desc.includes('estireno')) {
                    mapaProdutos['mon√¥mero de estireno'] = produto.id;
                } else if (desc.includes('anti') && desc.includes('uv')) {
                    mapaProdutos['anti uv'] = produto.id;
                } else if (desc.includes('anti') && desc.includes('ox')) {
                    mapaProdutos['anti ox'] = produto.id;
                } else if (desc.includes('bpo')) {
                    mapaProdutos['bpo'] = produto.id;
                } else if (desc.includes('tbpb')) {
                    mapaProdutos['tbpb'] = produto.id;
                } else if (desc.includes('desmoldante')) {
                    mapaProdutos['desmoldante'] = produto.id;
                } else if (desc.includes('antichama')) {
                    mapaProdutos['antichama'] = produto.id;
                } else if (desc.includes('carga') && desc.includes('mineral')) {
                    mapaProdutos['carga mineral'] = produto.id;
                } else if (desc.includes('pigmento')) {
                    mapaProdutos['pigmento'] = produto.id;
                } else if (desc.includes('pintura')) {
                    mapaProdutos['√°rea pintura (m¬≤)'] = produto.id;
                } else if (desc.includes('m√£o') && desc.includes('obra')) {
                    mapaProdutos['m√£o de obra - pultrus√£o'] = produto.id;
                }
            });
            
            console.log('üìã Mapa de produtos criado:', mapaProdutos);
            
            // Criar promessas para salvar componentes
            const componentesPromises = ultimoCalculo.componentes.map((comp, index) => {
                const nomeComponenteLower = comp.nome.toLowerCase();
                let produtoComponenteId = mapaProdutos[nomeComponenteLower];
                
                if (!produtoComponenteId) {
                    console.warn(`‚ö†Ô∏è ID n√£o encontrado para componente: ${comp.nome}`);
                    // Tentar encontrar por correspond√™ncia parcial
                    const chaves = Object.keys(mapaProdutos);
                    const chaveEncontrada = chaves.find(chave => 
                        nomeComponenteLower.includes(chave) || chave.includes(nomeComponenteLower)
                    );
                    
                    if (chaveEncontrada) {
                        produtoComponenteId = mapaProdutos[chaveEncontrada];
                        console.log(`‚úÖ Correspond√™ncia encontrada: ${comp.nome} ‚Üí ${chaveEncontrada} (ID: ${produtoComponenteId})`);
                    } else {
                        console.error(`‚ùå N√£o foi poss√≠vel mapear componente: ${comp.nome}`);
                        return Promise.resolve(null); // Pular este componente
                    }
                }
                
                const componenteData = {
                    produto_principal: produtoId,
                    produto_componente: produtoComponenteId,
                    quantidade: parseFloat(comp.quantidade.toFixed(3)), // Limitar a 3 casas decimais
                    observacao: JSON.stringify({
                        nome_componente: comp.nome,
                        custo_unitario: Math.round(comp.custo_unitario * 100), // em centavos
                        custo_total: Math.round(comp.custo_total * 100), // em centavos
                        origem: 'perfil_parametrizado',
                        ordem: index + 1
                    })
                };
                
                console.log(`Salvando componente ${index + 1}:`, componenteData);
                
                return fetch('/api/componentes/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify(componenteData)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`Erro ao salvar componente ${comp.nome}: HTTP ${response.status} - ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(componenteSalvo => {
                    console.log(`‚úÖ Componente ${comp.nome} salvo:`, componenteSalvo);
                    return componenteSalvo;
                });
            });
            
            return Promise.all(componentesPromises.filter(p => p !== null));
        })
        .then(componentesSalvos => {
            const salvosComSucesso = componentesSalvos.filter(c => c !== null);
            console.log(`‚úÖ ${salvosComSucesso.length} de ${ultimoCalculo.componentes.length} componentes do perfil foram salvos`);
            return salvosComSucesso;
        })
        .catch(error => {
            console.error('‚ùå Erro ao salvar componentes:', error);
            throw error;
        });
}

// Fun√ß√µes para produtos parametriz√°veis
function openFormProdutoParametrizado() {
    console.log('=== ABRINDO MODAL PRODUTO PARAMETRIZADO ===');
    
    // Limpar estado global
    templateAtual = null;
    ultimoCalculo = null;
    
    console.log('Estado limpo - templateAtual:', templateAtual, 'ultimoCalculo:', ultimoCalculo);
    
    // Resetar formul√°rio
    document.getElementById('templateSelect').value = '';
    document.getElementById('templateDescription').innerHTML = '';
    document.getElementById('parametrosContainer').innerHTML = '<p class="text-muted">Selecione um template primeiro</p>';
    
    // Reset da se√ß√£o de resultado
    const resultadoContainer = document.getElementById('resultadoContainer');
    resultadoContainer.querySelector('p').textContent = 'Configure os par√¢metros para ver o resultado';
    document.getElementById('resultadoCalculado').style.display = 'none';
    
    // Limpar campo de nome se existir
    const nomeInput = document.getElementById('nomeProdutoInput');
    if (nomeInput) {
        nomeInput.value = '';
    }
    
    // Verificar se bot√£o calcular existe antes de desabilit√°-lo
    const calcularBtn = document.getElementById('calcularBtn');
    if (calcularBtn) {
        calcularBtn.disabled = true;
    }
    
    // Limpar tabela de componentes
    const tbody = document.getElementById('componentesCalculadosTable');
    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum c√°lculo realizado</td></tr>';
    
    // Desabilitar bot√£o salvar
    document.getElementById('salvarProdutoBtn').disabled = true;
    
    console.log('Interface resetada - carregando templates...');
    
    carregarTemplates();
    produtoParametrizadoModal.show();
    
    console.log('Modal aberto com sucesso');
}

function closeProdutoParametrizadoModal() {
    produtoParametrizadoModal.hide();
}

function carregarTemplates() {
    fetch(apiTemplates)
        .then(res => res.json())
        .then(templates => {
            // Popular o cache
            templatesCache = templates;
            
            const select = document.getElementById('templateSelect');
            select.innerHTML = '<option value="">Escolha um template...</option>';
            
            // Adicionar op√ß√£o "Novo Perfil" primeiro
            const novoPerfilOption = document.createElement('option');
            novoPerfilOption.value = 'perfil_customizado';
            novoPerfilOption.textContent = 'Novo Perfil';
            select.appendChild(novoPerfilOption);
            
            // Adicionar op√ß√£o "Grades" 
            const gradesOption = document.createElement('option');
            gradesOption.value = 'grades_customizado';
            gradesOption.textContent = 'Grades';
            select.appendChild(gradesOption);
            
            // Adicionar op√ß√£o "Tampa Montada"
            const tampaOption = document.createElement('option');
            tampaOption.value = 'tampa_montada_customizado';
            tampaOption.textContent = 'Tampa Montada';
            select.appendChild(tampaOption);
            
            // Adicionar op√ß√£o "Tampa Injetada"
            const tampaInjetadaOption = document.createElement('option');
            tampaInjetadaOption.value = 'tampa_injetada_customizado';
            tampaInjetadaOption.textContent = 'Tampa Injetada';
            select.appendChild(tampaInjetadaOption);
            
            // Adicionar op√ß√£o "Degraus"
            const degrausOption = document.createElement('option');
            degrausOption.value = 'degraus_customizado';
            degrausOption.textContent = 'Degraus';
            select.appendChild(degrausOption);
            
            // Adicionar op√ß√£o "Degrau Injetado"
            const degrauInjetadoOption = document.createElement('option');
            degrauInjetadoOption.value = 'degrau_injetado_customizado';
            degrauInjetadoOption.textContent = 'Degrau Injetado';
            select.appendChild(degrauInjetadoOption);
            
            // Adicionar op√ß√£o "Guarda Corpo - Horizontal"
            const guardaCorpoHorizontalOption = document.createElement('option');
            guardaCorpoHorizontalOption.value = 'guarda_corpo_horizontal_customizado';
            guardaCorpoHorizontalOption.textContent = 'Guarda Corpo - Horizontal';
            select.appendChild(guardaCorpoHorizontalOption);
            
            // Adicionar op√ß√£o "Escada"
            const escadaOption = document.createElement('option');
            escadaOption.value = 'escada_customizado';
            escadaOption.textContent = 'Escada';
            select.appendChild(escadaOption);
            
            templates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                
                // Corre√ß√£o: usar produto_base.descricao em vez de template.nome
                if (template.produto_base && template.produto_base.descricao) {
                    option.textContent = `${template.produto_base.descricao} (${template.produto_base.categoria || 'Geral'})`;
                } else {
                    option.textContent = `Template ID: ${template.id} (Sem produto base)`;
                }
                
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Erro ao carregar templates:', error);
            alert('Erro ao carregar templates de produtos.');
        });
}

function carregarTemplate() {
    const templateId = document.getElementById('templateSelect').value;
    
    console.log('=== CARREGANDO TEMPLATE ===');
    console.log('Template ID:', templateId);
    
    if (!templateId) {
        console.log('Nenhum template selecionado - limpando interface');
        
        // Limpar completamente a interface
        document.getElementById('templateDescription').innerHTML = '';
        document.getElementById('parametrosContainer').innerHTML = '<p class="text-muted">Selecione um template primeiro</p>';
        document.getElementById('resultadoContainer').querySelector('p').textContent = 'Configure os par√¢metros para ver o resultado';
        document.getElementById('resultadoCalculado').style.display = 'none';
        
        // Verificar se bot√µes existem antes de desabilit√°-los
        const calcularBtn = document.getElementById('calcularBtn');
        if (calcularBtn) {
            calcularBtn.disabled = true;
        }
        document.getElementById('salvarProdutoBtn').disabled = true;
        
        // Limpar tabela de componentes
        const tbody = document.getElementById('componentesCalculadosTable');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum c√°lculo realizado</td></tr>';
        
        // Resetar vari√°vel global
        templateAtual = null;
        ultimoCalculo = null;
        
        return;
    }
    
    // Verificar se √© "Novo Perfil"
    if (templateId === 'perfil_customizado') {
        console.log('Carregando interface de Novo Perfil');
        carregarInterfaceNovoPerfil();
        return;
    }
    
    // Verificar se √© "Grades"
    if (templateId === 'grades_customizado') {
        console.log('Carregando interface de Grades');
        carregarInterfaceGrades();
        return;
    }
    
    // Verificar se √© "Tampa Montada"
    if (templateId === 'tampa_montada_customizado') {
        console.log('Carregando interface de Tampa Montada');
        carregarInterfaceTampaMontada();
        return;
    }
    
    // Verificar se √© "Tampa Injetada"
    if (templateId === 'tampa_injetada_customizado') {
        console.log('Carregando interface de Tampa Injetada');
        carregarInterfaceTampaInjetada();
        return;
    }
    
    // Verificar se √© "Degraus"
    if (templateId === 'degraus_customizado') {
        console.log('Carregando interface de Degraus');
        carregarInterfaceDegraus();
        return;
    }
    
    // Verificar se √© "Degrau Injetado"
    if (templateId === 'degrau_injetado_customizado') {
        console.log('Carregando interface de Degrau Injetado');
        carregarInterfaceDegrauInjetado();
        return;
    }
    
    // Verificar se √© "Guarda Corpo - Horizontal"
    if (templateId === 'guarda_corpo_horizontal_customizado') {
        console.log('Carregando interface de Guarda Corpo - Horizontal');
        carregarInterfaceGuardaCorpoHorizontal();
        return;
    }
    
    // Verificar se √© "Escada"
    if (templateId === 'escada_customizado') {
        console.log('Carregando interface de Escada');
        carregarInterfaceEscada();
        return;
    }
    
    // Usar o template j√° carregado no cache
    const template = templatesCache.find(t => t.id == templateId);
    if (!template) {
        console.error('Template n√£o encontrado no cache:', templateId);
        alert('Erro: Template n√£o encontrado. Tente recarregar a p√°gina.');
        return;
    }
    
    console.log('Template encontrado:', template);
    templateAtual = template;
    
    // Limpar estado anterior
    ultimoCalculo = null;
    document.getElementById('resultadoCalculado').style.display = 'none';
    
    // Verificar se bot√µes existem antes de desabilit√°-los
    const calcularBtn = document.getElementById('calcularBtn');
    if (calcularBtn) {
        calcularBtn.disabled = true;
    }
    document.getElementById('salvarProdutoBtn').disabled = true;
    
    // Limpar tabela de componentes
    const tbody = document.getElementById('componentesCalculadosTable');
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Configure os par√¢metros e clique em Calcular</td></tr>';
    
    // Mostrar descri√ß√£o
    const descricao = template.produto_base ? template.produto_base.descricao : 'Sem descri√ß√£o';
    const categoria = template.produto_base ? template.produto_base.categoria : 'Sem categoria';
    
    document.getElementById('templateDescription').innerHTML = `
        <strong>${descricao}</strong><br>
        <small class="text-muted">Categoria: ${categoria}</small>
    `;
    
    // Reset da se√ß√£o de resultado
    document.getElementById('resultadoContainer').querySelector('p').textContent = 'Configure os par√¢metros para ver o resultado';
    
    // Limpar campo de nome se existir
    const nomeInput = document.getElementById('nomeProdutoInput');
    if (nomeInput) {
        nomeInput.value = '';
    }
    
    console.log('Criando campos de par√¢metros...');
    
    // Criar campos de par√¢metros usando a nova estrutura
    criarCamposParametrosNovo(template);
}

function criarCamposParametrosNovo(template) {
    const container = document.getElementById('parametrosContainer');
    container.innerHTML = '';
    
    // Verificar se tem par√¢metros obrigat√≥rios ou opcionais
    const temObrigatorios = template.parametros_obrigatorios && template.parametros_obrigatorios.length > 0;
    const temOpcionais = template.parametros_opcionais && Object.keys(template.parametros_opcionais).length > 0;
    
    if (!temObrigatorios && !temOpcionais) {
        container.innerHTML = '<p class="text-muted">Este template n√£o possui par√¢metros configurados</p>';
        // N√£o precisa desabilitar calcularBtn aqui pois ele ainda n√£o foi criado
        return;
    }
    
    // Par√¢metros obrigat√≥rios
    if (temObrigatorios) {
        const obrigatoriosDiv = document.createElement('div');
        obrigatoriosDiv.innerHTML = '<h6 class="text-danger">Par√¢metros Obrigat√≥rios:</h6>';
        
        template.parametros_obrigatorios.forEach(param => {
            const div = document.createElement('div');
            div.className = 'mb-3';
            div.innerHTML = `
                <label for="param_${param}" class="form-label">${param.charAt(0).toUpperCase() + param.slice(1)}:</label>
                <input type="number" class="form-control param-input" id="param_${param}" name="${param}" 
                       value="0" step="0.001" required oninput="verificarParametros()">
            `;
            obrigatoriosDiv.appendChild(div);
        });
        
        container.appendChild(obrigatoriosDiv);
    }
    
    // Par√¢metros opcionais
    if (temOpcionais) {
        const opcionaisDiv = document.createElement('div');
        opcionaisDiv.innerHTML = '<h6 class="text-info mt-3">Par√¢metros Opcionais:</h6>';
        
        Object.entries(template.parametros_opcionais).forEach(([param, defaultValue]) => {
            const div = document.createElement('div');
            div.className = 'mb-3';
            
            let inputHTML = '';
            if (param === 'tipo_resina') {
                // Criar dropdown para sele√ß√£o de resina
                inputHTML = `
                    <label for="param_${param}" class="form-label">Tipo de Resina:</label>
                    <select class="form-control param-input" id="param_${param}" name="${param}" oninput="verificarParametros()">
                        <option value="1269" ${defaultValue === '1269' ? 'selected' : ''}>Resina Poli√©ster - R$ 12,96</option>
                        <option value="1268" ${defaultValue === '1268' ? 'selected' : ''}>Resina Isoft√°lica - R$ 18,34</option>
                        <option value="1270" ${defaultValue === '1270' ? 'selected' : ''}>Resina √âster Vin√≠lica - R$ 35,97</option>
                    </select>
                `;
            } else if (param === 'velocidade_m_h') {
                // Campo espec√≠fico para velocidade
                inputHTML = `
                    <label for="param_${param}" class="form-label">Velocidade (m/h):</label>
                    <input type="number" class="form-control param-input" id="param_${param}" name="${param}" 
                           value="${defaultValue}" step="0.1" min="0.1" oninput="verificarParametros()">
                    <div class="form-text">Velocidade de produ√ß√£o em metros por hora</div>
                `;
            } else if (param === 'num_matrizes') {
                // Campo espec√≠fico para n√∫mero de matrizes
                inputHTML = `
                    <label for="param_${param}" class="form-label">N¬∞ de Matrizes:</label>
                    <input type="number" class="form-control param-input" id="param_${param}" name="${param}" 
                           value="${defaultValue}" step="1" min="1" oninput="verificarParametros()">
                    <div class="form-text">Quantidade de matrizes utilizadas</div>
                `;
            } else if (param === 'num_maquinas_utilizadas') {
                // Campo espec√≠fico para n√∫mero de m√°quinas utilizadas
                inputHTML = `
                    <label for="param_${param}" class="form-label">N¬∞ de M√°quinas Utilizadas:</label>
                    <input type="number" class="form-control param-input" id="param_${param}" name="${param}" 
                           value="${defaultValue}" step="1" min="1" max="3" oninput="verificarParametros()">
                    <div class="form-text">M√°quinas utilizadas (m√°x. 3)</div>
                `;
            } else {
                // Campo normal para outros par√¢metros
                inputHTML = `
                    <label for="param_${param}" class="form-label">${param.charAt(0).toUpperCase() + param.slice(1)}:</label>
                    <input type="text" class="form-control param-input" id="param_${param}" name="${param}" value="${defaultValue}" oninput="verificarParametros()">
                `;
            }
            
            div.innerHTML = inputHTML;
            opcionaisDiv.appendChild(div);
        });
        
        container.appendChild(opcionaisDiv);
    }
    
    // Adicionar bot√£o de calcular na se√ß√£o de par√¢metros
    const calcularDiv = document.createElement('div');
    calcularDiv.className = 'mt-3 text-center';
    calcularDiv.innerHTML = `
        <button type="button" class="btn btn-primary" onclick="calcularProdutoParametrizado()" id="calcularBtn" disabled>
            <i class="fas fa-calculator"></i> Calcular Produto
        </button>
    `;
    container.appendChild(calcularDiv);
    
    // Verificar se pode habilitar o bot√£o
    verificarParametros();
}

function verificarParametros() {
    const calcularBtn = document.getElementById('calcularBtn');
    if (!calcularBtn) {
        console.log('Bot√£o calcular n√£o encontrado');
        return;
    }
    
    console.log('=== VERIFICANDO PAR√ÇMETROS ===');
    
    // Verificar se tem template selecionado
    const templateId = document.getElementById('templateSelect').value;
    if (!templateId) {
        console.log('Nenhum template selecionado');
        calcularBtn.disabled = true;
        return;
    }
    
    const templateAtual = templatesCache.find(t => t.id == templateId);
    if (!templateAtual) {
        console.log('Template n√£o encontrado no cache:', templateId);
        calcularBtn.disabled = true;
        return;
    }
    
    console.log('Template:', templateAtual);
    
    let todosPreenchidos = true;
    
    // Verificar par√¢metros obrigat√≥rios
    if (templateAtual.parametros_obrigatorios && templateAtual.parametros_obrigatorios.length > 0) {
        console.log('Verificando par√¢metros obrigat√≥rios:', templateAtual.parametros_obrigatorios);
        
        templateAtual.parametros_obrigatorios.forEach(param => {
            const input = document.getElementById(`param_${param}`);
            if (!input) {
                console.log(`Input n√£o encontrado para par√¢metro: ${param}`);
                todosPreenchidos = false;
            } else if (!input.value || input.value.trim() === '') {
                console.log(`Par√¢metro obrigat√≥rio vazio: ${param}`);
                todosPreenchidos = false;
            } else {
                console.log(`Par√¢metro OK: ${param} = ${input.value}`);
            }
        });
    }
    
    console.log('Todos preenchidos:', todosPreenchidos);
    calcularBtn.disabled = !todosPreenchidos;
    
    if (todosPreenchidos) {
        console.log('‚úÖ Bot√£o calcular habilitado');
    } else {
        console.log('‚ùå Bot√£o calcular desabilitado');
    }
}

function calcularProdutoParametrizado() {
    const templateId = document.getElementById('templateSelect').value;
    
    // Verificar se √© "Novo Perfil"
    if (templateId === 'perfil_customizado') {
        console.log('=== CALCULANDO NOVO PERFIL ===');
        calcularNovoPerfil();
        return;
    }
    
    const template = templatesCache.find(t => t.id == templateId);
    
    if (!template) {
        alert('Template n√£o encontrado!');
        return;
    }
    
    // Limpar resultado anterior
    document.getElementById('resultadoCalculado').style.display = 'none';
    document.getElementById('salvarProdutoBtn').disabled = true;
    
    // Limpar tabela de componentes
    const tbody = document.getElementById('componentesCalculadosTable');
    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Calculando...</td></tr>';
    
    // Coletar par√¢metros
    const parametros = {};
    const allInputs = document.querySelectorAll('.param-input');
    
    console.log('=== C√ÅLCULO PRODUTO PARAMETRIZADO ===');
    console.log('Template ID:', templateId);
    console.log('Template:', template);
    console.log('Inputs encontrados:', allInputs.length);
    
    allInputs.forEach((input, index) => {
        console.log(`Input ${index + 1}: name="${input.name}", value="${input.value}"`);
        parametros[input.name] = input.value;
    });
    
    console.log('Par√¢metros coletados:', parametros);
    
    // Mostrar o nome do produto
    document.getElementById('nomeProdutoCalculado').textContent = template.produto_base.descricao;
    
    const csrftoken = getCookie('csrftoken');
    
    const requestBody = {
        template_id: templateId,
        parametros: parametros
    };
    
    console.log('Request body:', JSON.stringify(requestBody, null, 2));
    
    // Fazer chamada para API de c√°lculo
    fetch('/api/calcular-produto-parametrizado/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(requestBody)
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('=== RESPOSTA DA API ===');
        console.log('Data completa:', data);
        console.log('Success:', data.success);
        console.log('Componentes:', data.componentes);
        console.log('N√∫mero de componentes:', data.componentes ? data.componentes.length : 'undefined');
        
        if (data.success) {
            // Armazenar resultado para usar no salvamento
            ultimoCalculo = data;
            
            // Mostrar resultado
            document.getElementById('custoTotalCalculado').textContent = `R$ ${(data.custo_total / 100).toFixed(2)}`;
            document.getElementById('pesoTotalCalculado').textContent = `${data.peso_total} kg`;
            document.getElementById('resultadoCalculado').style.display = 'block';
            
            // Preencher nome automaticamente baseado no template
            const nomeInput = document.getElementById('nomeProdutoInput');
            if (nomeInput && !nomeInput.value) {
                nomeInput.value = template.produto_base.descricao;
            }
            
            // Mostrar componentes calculados
            mostrarComponentesCalculados(data.componentes);
            
            // Habilitar bot√£o salvar
            document.getElementById('salvarProdutoBtn').disabled = false;
        } else {
            console.error('Erro no c√°lculo:', data.error);
            alert('Erro no c√°lculo: ' + (data.error || 'Erro desconhecido'));
            
            // Limpar tabela em caso de erro
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erro no c√°lculo</td></tr>';
        }
    })
    .catch(error => {
        console.error('Erro ao calcular:', error);
        alert('Erro ao calcular produto. Verifique o console para mais detalhes.');
        
        // Limpar tabela em caso de erro
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Erro na comunica√ß√£o</td></tr>';
    });
}

function mostrarComponentesCalculados(componentes) {
    console.log('=== MOSTRAR COMPONENTES ===');
    console.log('Componentes recebidos:', componentes);
    console.log('Tipo:', typeof componentes);
    console.log('√â array?', Array.isArray(componentes));
    console.log('Quantidade:', componentes ? componentes.length : 'undefined');
    
    const tbody = document.getElementById('componentesCalculadosTable');
    tbody.innerHTML = '';
    
    if (!componentes || componentes.length === 0) {
        console.log('Nenhum componente - mostrando mensagem vazia');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum componente calculado</td></tr>';
        return;
    }
    
    console.log('Adicionando', componentes.length, 'componentes √† tabela');
    componentes.forEach((comp, index) => {
        console.log(`Componente ${index + 1}:`, comp);
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${comp.nome}</td>
            <td>${comp.descricao_produto || comp.produto || 'N/A'}</td>
            <td></td>
            <td>${parseFloat(comp.quantidade).toFixed(3)}</td>
            <td>R$ ${(comp.custo_unitario / 100).toFixed(2)}</td>
            <td>R$ ${(comp.custo_total / 100).toFixed(2)}</td>
            <td></td>
        `;
        tbody.appendChild(row);
    });
    
    // Adicionar linha de total
    const custoTotalGeral = componentes.reduce((total, comp) => total + comp.custo_total, 0);
    const totalRow = document.createElement('tr');
    totalRow.innerHTML = `
        <td colspan="5"><strong>TOTAL GERAL</strong></td>
        <td><strong>R$ ${(custoTotalGeral/100).toFixed(2)}</strong></td>
        <td></td>
    `;
    totalRow.style.backgroundColor = '#f8f9fa'; // Mesmo estilo da Tampa Montada
    tbody.appendChild(totalRow);
    
    console.log('Tabela atualizada com', tbody.children.length, 'linhas');
}

function criarCamposParametros(parametros) {
    const container = document.getElementById('parametrosContainer');
    container.innerHTML = '';
    
    if (!parametros || parametros.length === 0) {
        container.innerHTML = '<p class="text-muted">Este template n√£o possui par√¢metros configurados</p>';
        return;
    }
    
    parametros.forEach(param => {
        const div = document.createElement('div');
        div.className = 'mb-3';
        
        let inputHTML = '';
        
        if (param.tipo === 'decimal' || param.tipo === 'inteiro') {
            const step = param.tipo === 'decimal' ? '0.01' : '1';
            inputHTML = `
                <input type="number" class="form-control" 
                       id="param_${param.nome}" 
                       step="${step}" 
                       value="${param.valor_padrao || ''}" 
                       placeholder="Digite o valor"
                       onchange="calcularProduto()"
                       ${param.obrigatorio ? 'required' : ''}>
            `;
        } else if (param.tipo === 'selecao') {
            // Campo de sele√ß√£o com op√ß√µes pr√©-definidas
            let opcoes = '';
            try {
                const opcoesData = typeof param.opcoes_selecao === 'string' 
                    ? JSON.parse(param.opcoes_selecao) 
                    : param.opcoes_selecao || [];
                
                opcoesData.forEach(opcao => {
                    const selected = opcao.id.toString() === param.valor_padrao ? 'selected' : '';
                    opcoes += `<option value="${opcao.id}" ${selected}>${opcao.descricao} - R$ ${opcao.preco.toFixed(2)}</option>`;
                });
            } catch (e) {
                console.error('Erro ao processar op√ß√µes de sele√ß√£o:', e);
                opcoes = '<option value="">Erro ao carregar op√ß√µes</option>';
            }
            
            inputHTML = `
                <select class="form-select" 
                        id="param_${param.nome}" 
                        onchange="calcularProduto()"
                        ${param.obrigatorio ? 'required' : ''}>
                    <option value="">Selecione...</option>
                    ${opcoes}
                </select>
            `;
        } else if (param.tipo === 'produto') {
            // Carregar produtos do banco para sele√ß√£o
            inputHTML = `
                <select class="form-select" 
                        id="param_${param.nome}" 
                        onchange="calcularProduto()"
                        ${param.obrigatorio ? 'required' : ''}>
                    <option value="">Carregando produtos...</option>
                </select>
            `;
            
            // Carregar produtos ap√≥s criar o elemento
            setTimeout(() => carregarProdutosParaParametro(param.nome), 100);
        }
        
        div.innerHTML = `
            <label for="param_${param.nome}" class="form-label">
                ${param.label} ${param.obrigatorio ? '*' : ''}
            </label>
            ${inputHTML}
            ${param.ajuda ? `<div class="form-text">${param.ajuda}</div>` : ''}
        `;
        
        container.appendChild(div);
    });
    
    // Bot√£o para calcular
    const btnDiv = document.createElement('div');
    btnDiv.innerHTML = `
        <button type="button" class="btn btn-primary w-100" onclick="calcularProduto()">
            <i class="fas fa-calculator"></i> Calcular
        </button>
    `;
    container.appendChild(btnDiv);
}

function carregarProdutosParaParametro(nomeParametro) {
    const select = document.getElementById(`param_${nomeParametro}`);
    if (!select) return;
    
    // Filtrar apenas produtos que podem ser usados como perfis/materiais
    const produtosFiltrados = allProductsOriginal.filter(produto => 
        produto.tipo === 'Simples' && 
        (produto.unidade === 'M' || produto.unidade === 'KG' || produto.unidade === 'UN')
    );
    
    select.innerHTML = '<option value="">Selecione um produto...</option>';
    
    produtosFiltrados.forEach(produto => {
        const option = document.createElement('option');
        option.value = produto.id;
        option.textContent = `${produto.descricao} - R$ ${(produto.custo_centavos / 100).toFixed(2)}/${produto.unidade}`;
        select.appendChild(option);
    });
}

function calcularProduto() {
    if (!templateAtual) return;
    
    // Coletar valores dos par√¢metros
    const parametros = {};
    let todosPreenchidos = true;
    
    templateAtual.parametros.forEach(param => {
        const input = document.getElementById(`param_${param.nome}`);
        if (input) {
            const valor = input.value;
            if (param.obrigatorio && !valor) {
                todosPreenchidos = false;
            }
            parametros[param.nome] = valor;
        }
    });
    
    if (!todosPreenchidos) {
        document.getElementById('resultadoContainer').innerHTML = '<p class="text-warning">Preencha todos os par√¢metros obrigat√≥rios</p>';
        return;
    }
    
    // Fazer chamada para calcular
    fetch(apiCalcular, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            template_id: templateAtual.id,
            parametros: parametros
        })
    })
    .then(res => res.json())
    .then(resultado => {
        if (resultado.erro) {
            document.getElementById('resultadoContainer').innerHTML = `<p class="text-danger">Erro: ${resultado.erro}</p>`;
            return;
        }
        
        ultimoCalculo = resultado;
        exibirResultadoCalculo(resultado);
        
        // Habilitar bot√£o salvar
        document.getElementById('salvarProdutoBtn').disabled = false;
    })
    .catch(error => {
        console.error('Erro no c√°lculo:', error);
        document.getElementById('resultadoContainer').innerHTML = '<p class="text-danger">Erro na comunica√ß√£o com o servidor</p>';
    });
}

function exibirResultadoCalculo(resultado) {
    // Mostrar resumo no painel de resultado
    document.getElementById('resultadoContainer').innerHTML = `
        <div class="alert alert-success">
            <h6><i class="fas fa-check-circle"></i> C√°lculo realizado!</h6>
            <p class="mb-1"><strong>Custo Total:</strong> R$ ${resultado.custo_total.toFixed(2)}</p>
            ${resultado.area_m2 ? `<p class="mb-1"><strong>√Årea:</strong> ${resultado.area_m2.toFixed(2)} m¬≤</p>` : ''}
            ${resultado.custo_por_m2 ? `<p class="mb-1"><strong>Custo por m¬≤:</strong> R$ ${resultado.custo_por_m2.toFixed(2)}</p>` : ''}
            <p class="mb-2"><small>${resultado.componentes.length} componente(s) calculado(s)</small></p>
        </div>
        
        <div class="mt-3">
            <label for="nomeProdutoParametrizado" class="form-label"><strong>Nome do Produto *</strong></label>
            <input type="text" class="form-control" id="nomeProdutoParametrizado" 
                   placeholder="Ex: Grade 2000x1000mm" required>
            <div class="form-text">Digite um nome descritivo para este produto</div>
        </div>
        
        <div class="mt-3">
            <label for="descricaoProdutoParametrizado" class="form-label">Descri√ß√£o Adicional</label>
            <textarea class="form-control" id="descricaoProdutoParametrizado" rows="2" 
                      placeholder="Descri√ß√£o detalhada do produto (opcional)"></textarea>
            <div class="form-text">Informa√ß√µes adicionais sobre o produto</div>
        </div>
    `;
    
    // Mostrar tabela de componentes
    const tbody = document.getElementById('componentesCalculadosTable');
    tbody.innerHTML = '';
    
    resultado.componentes.forEach(comp => {
        tbody.innerHTML += `
            <tr>
                <td>${comp.nome}</td>
                <td>${comp.produto}</td>
                <td>${comp.quantidade.toFixed(3)} ${comp.unidade || ''}</td>
                <td>R$ ${comp.custo_unitario.toFixed(2)}</td>
                <td>R$ ${comp.custo_total.toFixed(2)}</td>
            </tr>
        `;
    });
}

function salvarProdutoParametrizado() {
    const templateId = document.getElementById('templateSelect').value;
    
    // Verificar se √© um perfil
    if (templateId === 'perfil_customizado') {
        return salvarPerfilParametrizado();
    }
    
    // Verificar se √© uma grade
    if (templateId === 'grades_customizado') {
        return salvarGradeParametrizada();
    }
    
    // Verificar se √© uma tampa montada
    if (templateId === 'tampa_montada_customizado') {
        return salvarTampaMontadaParametrizada();
    }
    
    // Verificar se √© uma tampa injetada
    if (templateId === 'tampa_injetada_customizado') {
        return salvarTampaInjetadaParametrizada();
    }
    
    // Verificar se √© degraus
    if (templateId === 'degraus_customizado') {
        return salvarDegrausParametrizado();
    }
    
    // Verificar se √© degrau injetado
    if (templateId === 'degrau_injetado_customizado') {
        return salvarDegrauInjetadoParametrizado();
    }
    
    // Verificar se √© guarda corpo horizontal
    if (templateId === 'guarda_corpo_horizontal_customizado') {
        return salvarGuardaCorpoHorizontalParametrizado();
    }
    
    const template = templatesCache.find(t => t.id == templateId);
    
    if (!template) {
        alert('Selecione um template primeiro!');
        return;
    }
    
    // Verificar se o c√°lculo foi feito
    const resultadoDiv = document.getElementById('resultadoCalculado');
    if (resultadoDiv.style.display === 'none') {
        alert('Realize o c√°lculo primeiro!');
        return;
    }
    
    // Verificar se nome foi preenchido
    const nomeInput = document.getElementById('nomeProdutoInput');
    if (!nomeInput || !nomeInput.value.trim()) {
        alert('Por favor, digite um nome para o produto!');
        nomeInput?.focus();
        return;
    }
    
    // Coletar par√¢metros
    const parametros = {};
    const allInputs = document.querySelectorAll('.param-input');
    allInputs.forEach(input => {
        parametros[input.name] = input.value;
    });
    
    // Usar o nome digitado pelo usu√°rio
    const descricaoFinal = nomeInput.value.trim();
    
    // Criar refer√™ncia √∫nica
    const agora = new Date();
    const timestamp = agora.getTime();
    const referencia = `PARAM-${template.id}-${timestamp}`;
    
    // Obter custo e peso do resultado calculado
    const custoTexto = document.getElementById('custoTotalCalculado').textContent;
    const custoReais = parseFloat(custoTexto.replace('R$ ', '').replace(',', '.'));
    const custoCentavos = Math.round(custoReais * 100);
    
    const pesoTexto = document.getElementById('pesoTotalCalculado').textContent;
    const peso = parseFloat(pesoTexto.replace(' kg', ''));
    
    // Fun√ß√£o para obter CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    
    // Dados do produto
    const produtoData = {
        descricao: descricaoFinal,
        custo_centavos: custoCentavos,
        peso_und: peso.toFixed(3),
        unidade: template.produto_base.unidade,
        referencia: referencia,
        tipo_produto: 'composto',  // Mudan√ßa: salvar como composto
        categoria: template.produto_base.categoria,
        subcategoria: 'Parametrizado'
    };
    
    console.log('Salvando produto:', produtoData);
    
    // Salvar produto
    fetch('/api/produtos/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(produtoData)
    })
    .then(response => {
        console.log('üîÑ Resposta do servidor para produto principal:', response.status);
        if (!response.ok) {
            console.error('‚ùå Erro ao salvar produto principal:', response.status);
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(produto => {
        console.log('‚úÖ Produto principal salvo com sucesso:', produto);
        console.log('   ID do produto:', produto.id, 'Tipo:', typeof produto.id);
        
        // Agora salvar todos os componentes calculados
        return salvarComponentesParametrizados(produto.id, csrftoken);
    })
    .then(produto => {
        console.log('Produto e componentes salvos com sucesso');
        alert(`Produto "${produto.descricao}" salvo com sucesso como produto composto!\nID: ${produto.id}\nCusto: R$ ${(produto.custo_centavos / 100).toFixed(2)}\nComponentes: ${produto.num_componentes || 'N/A'}`);
        
        // Fechar modal
        closeProdutoParametrizadoModal();
        
        // Recarregar lista de produtos
        fetchProdutos();
    })
    .catch(error => {
        console.error('Erro ao salvar produto:', error);
        alert('Erro ao salvar produto: ' + error.message);
    });
}

function salvarGradeParametrizada() {
    console.log('=== SALVANDO GRADE PARAMETRIZADA ===');
    
    // Fun√ß√£o para obter cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Obter token CSRF
    const csrftoken = getCookie('csrftoken');
    
    // Verificar se o c√°lculo foi feito
    if (!ultimoCalculo || !ultimoCalculo.success) {
        alert('Realize o c√°lculo da grade primeiro!');
        return;
    }
    
    // Verificar se nome foi preenchido
    const nomeGrade = document.getElementById('grade_nome').value.trim();
    if (!nomeGrade) {
        alert('Por favor, digite um nome para a grade!');
        return;
    }
    
    console.log('Dados da grade para salvar:', ultimoCalculo);
    
    // Usar sempre o custo_total que j√° foi corrigido no ultimoCalculo
    // (que foi atualizado na fun√ß√£o calcularGrade com a soma correta dos componentes)
    const custoTotalComponentes = ultimoCalculo.componentes.reduce((total, comp) => total + comp.custo_total, 0);
    console.log(`üí∞ Verifica√ß√£o de custos:`);
    console.log(`   ultimoCalculo.custo_total (j√° corrigido): ${ultimoCalculo.custo_total} centavos = R$ ${(ultimoCalculo.custo_total/100).toFixed(2)}`);
    console.log(`   Soma manual dos componentes: ${custoTotalComponentes} centavos = R$ ${(custoTotalComponentes/100).toFixed(2)}`);
    
    // Usar o custo_total que j√° foi corrigido na fun√ß√£o calcularGrade
    const custoFinalCentavos = Math.round(ultimoCalculo.custo_total);
    
    // Dados do produto principal (grade)
    const produtoData = {
        descricao: nomeGrade,
        custo_centavos: custoFinalCentavos,
        peso_und: parseFloat(ultimoCalculo.peso_total.toFixed(3)),
        unidade: 'm¬≤',
        referencia: gerarReferenciaGrade(nomeGrade),
        tipo_produto: 'composto',
        categoria: 'Grade',
        subcategoria: 'Estrutural'
    };
    
    console.log('Salvando grade com custo corrigido:', produtoData);
    
    // Salvar produto principal
    fetch('/api/produtos/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(produtoData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(produto => {
        console.log('‚úÖ Grade principal salva:', produto);
        
        // Salvar componentes da grade
        return salvarComponentesCalculados(produto.id, csrftoken);
    })
    .then(() => {
        alert('Grade salva com sucesso na base de dados!');
        
        // Limpar formul√°rio
        document.getElementById('grade_nome').value = '';
        document.getElementById('grade_vao').value = '';
        document.getElementById('grade_comprimento').value = '';
        document.getElementById('grade_eixo_i').value = '';
        document.getElementById('grade_perfil').value = '';
        
        // Ocultar resultado
        document.getElementById('resultadoCalculado').style.display = 'none';
        
        // Desabilitar bot√£o
        document.getElementById('salvarProdutoBtn').disabled = true;
        
        // Limpar tabela
        document.getElementById('componentesCalculadosTable').innerHTML = '';
        
        console.log('‚úÖ Grade salva e formul√°rio limpo');
    })
    .catch(error => {
        console.error('Erro ao salvar grade:', error);
        alert('Erro ao salvar grade: ' + error.message);
    });
}

function gerarReferenciaGrade(nomeGrade) {
    // Gerar refer√™ncia baseada no nome da grade
    const palavras = nomeGrade.split(' ').filter(p => p.length > 0);
    let referencia = palavras.slice(0, 3).join('').substring(0, 6).toUpperCase();
    
    // Adicionar timestamp para unicidade
    const timestamp = Date.now().toString().slice(-4);
    referencia += timestamp;
    
    console.log(`Refer√™ncia gerada: ${referencia} para "${nomeGrade}"`);
    return referencia;
}

function salvarTampaMontadaParametrizada() {
    console.log('=== SALVANDO TAMPA MONTADA PARAMETRIZADA ===');
    
    // Fun√ß√£o para obter cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Obter token CSRF
    const csrftoken = getCookie('csrftoken');
    
    // Verificar se o c√°lculo foi feito
    if (!ultimoCalculo || !ultimoCalculo.success) {
        alert('Realize o c√°lculo da tampa montada primeiro!');
        return;
    }
    
    // Verificar se nome foi preenchido
    const nomeTampa = document.getElementById('tampa_nome').value.trim();
    if (!nomeTampa) {
        alert('Por favor, digite um nome para a tampa montada!');
        return;
    }
    
    // Obter unidade selecionada
    const unidadeSelecionada = document.getElementById('tampa_unidade').value || 'M¬≤';
    
    console.log('Dados da tampa montada para salvar:', ultimoCalculo);
    
    // Usar sempre o custo_total que j√° foi corrigido no ultimoCalculo
    const custoTotalComponentes = ultimoCalculo.componentes.reduce((total, comp) => total + comp.custo_total, 0);
    console.log(`üí∞ Verifica√ß√£o de custos:`);
    console.log(`   ultimoCalculo.custo_total: ${ultimoCalculo.custo_total} centavos = R$ ${(ultimoCalculo.custo_total/100).toFixed(2)}`);
    console.log(`   Soma manual dos componentes: ${custoTotalComponentes} centavos = R$ ${(custoTotalComponentes/100).toFixed(2)}`);
    
    // Usar o custo_total que j√° foi corrigido na fun√ß√£o calcularTampaMontada
    const custoFinalCentavos = Math.round(ultimoCalculo.custo_total);
    
    // Dados do produto principal (tampa montada)
    const produtoData = {
        descricao: nomeTampa,
        custo_centavos: custoFinalCentavos,
        peso_und: parseFloat(ultimoCalculo.peso_total.toFixed(3)),
        unidade: unidadeSelecionada, // Usar unidade selecionada pelo usu√°rio
        referencia: gerarReferenciaTampa(nomeTampa),
        tipo_produto: 'composto',
        categoria: 'Tampa',
        subcategoria: 'Montada'
    };
    
    console.log('Salvando tampa montada com custo corrigido:', produtoData);
    
    // Salvar produto principal
    fetch('/api/produtos/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(produtoData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(produto => {
        console.log('‚úÖ Tampa montada principal salva:', produto);
        
        // Salvar componentes da tampa montada
        return salvarComponentesCalculados(produto.id, csrftoken);
    })
    .then(() => {
        alert('Tampa montada salva com sucesso na base de dados!');
        
        // Limpar formul√°rio
        document.getElementById('tampa_nome').value = '';
        document.getElementById('tampa_vao').value = '';
        document.getElementById('tampa_comprimento').value = '';
        document.getElementById('tampa_eixo_i').value = '';
        document.getElementById('tampa_perfil').value = '';
        document.getElementById('tampa_quadro_u4').checked = false;
        document.getElementById('tampa_alca').checked = false;
        document.getElementById('tampa_chapa_ev').checked = false;
        
        // Ocultar resultado
        document.getElementById('resultadoCalculado').style.display = 'none';
        
        // Desabilitar bot√£o
        document.getElementById('salvarProdutoBtn').disabled = true;
        
        // Limpar tabela
        document.getElementById('componentesCalculadosTable').innerHTML = '';
        
        // Fechar modal
        closeProdutoParametrizadoModal();
        
        // Recarregar lista de produtos
        fetchProdutos();
        
        console.log('‚úÖ Tampa montada salva e formul√°rio limpo');
    })
    .catch(error => {
        console.error('Erro ao salvar tampa montada:', error);
        alert('Erro ao salvar tampa montada: ' + error.message);
    });
}

function salvarTampaInjetadaParametrizada() {
    console.log('=== SALVANDO TAMPA INJETADA PARAMETRIZADA ===');
    
    // Fun√ß√£o para obter cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Obter token CSRF
    const csrftoken = getCookie('csrftoken');
    
    // Verificar se o c√°lculo foi feito
    if (!ultimoCalculo || !ultimoCalculo.success) {
        alert('Realize o c√°lculo da tampa injetada primeiro!');
        return;
    }
    
    // Verificar se nome foi preenchido
    const nomeTampa = document.getElementById('tampa_inj_nome').value.trim();
    if (!nomeTampa) {
        alert('Por favor, digite um nome para a tampa injetada!');
        return;
    }
    
    // Obter unidade selecionada
    const unidadeSelecionada = document.getElementById('tampa_inj_unidade').value || 'M¬≤';
    
    console.log('Dados da tampa injetada para salvar:', ultimoCalculo);
    
    // Usar o custo_total corrigido
    const custoFinalCentavos = Math.round(ultimoCalculo.custo_total);
    
    // Dados do produto principal (tampa injetada)
    const produtoData = {
        descricao: nomeTampa,
        custo_centavos: custoFinalCentavos,
        peso_und: parseFloat(ultimoCalculo.peso_total.toFixed(3)),
        unidade: unidadeSelecionada, // Usar unidade selecionada pelo usu√°rio
        referencia: gerarReferenciaTampa(nomeTampa),
        tipo_produto: 'composto',
        categoria: 'Tampa',
        subcategoria: 'Injetada'
    };
    
    console.log('Salvando tampa injetada:', produtoData);
    
    // Salvar produto principal
    fetch('/api/produtos/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(produtoData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(produto => {
        console.log('‚úÖ Tampa injetada principal salva:', produto);
        
        // Salvar componentes da tampa injetada
        return salvarComponentesTampaInjetada(produto.id, csrftoken);
    })
    .then(() => {
        alert('Tampa injetada salva com sucesso na base de dados!');
        
        // Limpar formul√°rio
        document.getElementById('tampa_inj_nome').value = '';
        document.getElementById('tampa_inj_vao').value = '';
        document.getElementById('tampa_inj_comprimento').value = '';
        document.getElementById('tampa_inj_grade').value = '';
        document.getElementById('tampa_inj_quadro_u4').checked = false;
        document.getElementById('tampa_inj_alca').checked = false;
        document.getElementById('tampa_inj_chapa_ev').checked = false;
        
        // Fechar modal
        closeProdutoParametrizadoModal();
        
        // Recarregar lista de produtos
        fetchProdutos();
        
        console.log('‚úÖ Tampa injetada salva e formul√°rio limpo');
    })
    .catch(error => {
        console.error('Erro ao salvar tampa injetada:', error);
        alert('Erro ao salvar tampa injetada: ' + error.message);
    });
}

function gerarReferenciaTampa(nomeTampa) {
    // Gerar refer√™ncia baseada no nome da tampa
    const palavras = nomeTampa.split(' ').filter(p => p.length > 0);
    let referencia = 'TAMPA-' + palavras.slice(0, 2).join('').substring(0, 8).toUpperCase();
    
    // Adicionar timestamp para unicidade
    const timestamp = Date.now().toString().slice(-4);
    referencia += timestamp;
    
    console.log(`Refer√™ncia gerada: ${referencia} para "${nomeTampa}"`);
    return referencia;
}

async function salvarComponentesCalculados(produtoId, csrftoken) {
    console.log('=== SALVANDO COMPONENTES CALCULADOS ===');
    
    try {
        // Primeiro, limpar componentes existentes deste produto para evitar conflitos
        console.log('üßπ Limpando componentes existentes do produto...');
        try {
            const componentesExistentesResponse = await fetch(`/api/componentes/?produto_principal=${produtoId}`);
            if (componentesExistentesResponse.ok) {
                const componentesExistentes = await componentesExistentesResponse.json();
                
                console.log(`   Encontrados ${componentesExistentes.length} componentes existentes`);
                
                for (const comp of componentesExistentes) {
                    const deleteResponse = await fetch(`/api/componentes/${comp.id}/`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': csrftoken
                        }
                    });
                    
                    if (deleteResponse.ok) {
                        console.log(`   ‚úÖ Removido componente ID ${comp.id}`);
                    } else {
                        console.warn(`   ‚ö†Ô∏è Erro ao remover componente ID ${comp.id}: ${deleteResponse.status}`);
                    }
                }
                
                console.log('‚úÖ Limpeza de componentes existentes conclu√≠da');
            } else {
                console.warn('‚ö†Ô∏è Erro ao buscar componentes existentes:', componentesExistentesResponse.status);
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Erro ao limpar componentes existentes:', error);
        }
        
        // Array para rastrear componentes j√° processados (evitar duplicatas)
        const componentesProcessados = new Map();
        
        console.log(`üíæ Salvando ${ultimoCalculo.componentes.length} componentes √∫nicos...`);
        console.log('üìã Lista completa de componentes:', ultimoCalculo.componentes.map(c => `"${c.nome}"`));
        
        for (const componente of ultimoCalculo.componentes) {
            console.log(`\nüîß Processando componente: "${componente.nome}"`);
            
            // Encontrar o ID do produto componente baseado no nome
            let produtoComponenteId = null;
            
            // PRIMEIRO: Verificar m√£o de obra (deve vir antes de U4 e outras verifica√ß√µes)
            if (componente.nome.toLowerCase().includes('processamento') || 
                componente.nome.toLowerCase().includes('montagem') ||
                componente.nome.toLowerCase().includes('m√£o de obra')) {
                // Detectada m√£o de obra
                console.log('üîß DETECTADA M√ÉO DE OBRA:', componente.nome);
                
                // Usar o ID do produto de m√£o de obra do ultimoCalculo ou ID fixo conhecido
                const maoObraProduto = ultimoCalculo.mao_obra_produto_id || 1374;
                produtoComponenteId = maoObraProduto;
                console.log('‚úÖ Usando ID da m√£o de obra:', produtoComponenteId);
            
            // Para perfis I25, I32, I38
            } else if (componente.nome.includes('I25')) {
                produtoComponenteId = componente.nome.includes('Leve') ? 1331 : 1328;
            } else if (componente.nome.includes('I32')) {
                produtoComponenteId = 1329;
            } else if (componente.nome.includes('I38')) {
                produtoComponenteId = 1330;
            } else if (componente.nome.includes('Chaveta')) {
                produtoComponenteId = 1332; // ID fixo da chaveta
            } else if (componente.nome.includes('COLA ESTRUTURAL')) {
                produtoComponenteId = 1183; // ID fixo da cola estrutural 4500 A/B
            } else if (componente.nome.includes('TRAV')) {
                // Buscar perfil TRAV dinamicamente
                const produto = await buscarProdutoPorDescricao('trav');
                produtoComponenteId = produto.id;
            } else if (componente.nome.toLowerCase().includes('chapa') && componente.nome.toLowerCase().includes('lisa')) {
                // Buscar chapa lisa 2,5mm dinamicamente
                const produto = await buscarProdutoPorDescricao('chapa lisa');
                produtoComponenteId = produto.id;
            } else if (componente.nome.toLowerCase().includes('chapa') && componente.nome.toLowerCase().includes('2,5')) {
                // Buscar chapa 2,5mm dinamicamente
                const produto = await buscarProdutoPorDescricao('chapa 2,5');
                produtoComponenteId = produto.id;
            } else if (componente.nome.toLowerCase().includes('chapa') && componente.nome.toLowerCase().includes('ev')) {
                // Para Chapa EV com valor fixo, criar produto se n√£o existir
                produtoComponenteId = await buscarOuCriarChapaEV(csrftoken);
            } else if (componente.nome.toLowerCase().includes('u4')) {
                // Buscar perfil U4" dinamicamente
                const produto = await buscarProdutoPorDescricao('u4');
                produtoComponenteId = produto.id;
            } else if (componente.nome.toLowerCase().includes('al√ßa')) {
                // Buscar al√ßa dinamicamente
                const produto = await buscarProdutoPorDescricao('al√ßa');
                produtoComponenteId = produto.id;
            } else if (componente.nome.toLowerCase().includes('grade') && componente.nome.toLowerCase().includes('injetada')) {
                // Buscar grade injetada dinamicamente
                const produto = await buscarProdutoPorDescricao('grade injetada');
                produtoComponenteId = produto.id;
            }
            
            if (!produtoComponenteId) {
                console.error(`‚ùå N√£o foi poss√≠vel mapear o componente: ${componente.nome}`);
                throw new Error(`Componente n√£o mapeado: ${componente.nome}`);
            }
            
            // Verificar se j√° foi processado este produto componente (evitar duplicatas)
            if (componentesProcessados.has(produtoComponenteId)) {
                console.warn(`‚ö†Ô∏è Produto componente j√° processado, somando quantidades: ${componente.nome} (ID: ${produtoComponenteId})`);
                
                // Somar as quantidades se for o mesmo produto
                const componenteExistente = componentesProcessados.get(produtoComponenteId);
                componenteExistente.quantidade += Math.round(parseFloat(componente.quantidade.toFixed(3)) * 1000) / 1000;
                componenteExistente.custo_total += Math.round(componente.custo_total);
                
                console.log(`   Nova quantidade total: ${componenteExistente.quantidade}`);
                console.log(`   Novo custo total: ${componenteExistente.custo_total} centavos`);
                continue;
            }
            
            // Salvar custos calculados na observa√ß√£o como JSON
            const custosCalculados = {
                custo_unitario: Math.round(componente.custo_unitario),
                custo_total: Math.round(componente.custo_total),
                nome_componente: componente.nome,
                calculated_at: new Date().toISOString()
            };
            
            const componenteData = {
                produto_principal: produtoId,
                produto_componente: produtoComponenteId,
                quantidade: Math.round(parseFloat(componente.quantidade.toFixed(3)) * 1000) / 1000, // Garantir max 3 decimais
                observacao: JSON.stringify(custosCalculados)
            };
            
            // Adicionar ao mapa de componentes processados
            componentesProcessados.set(produtoComponenteId, {
                ...componenteData,
                nome: componente.nome,
                custo_total: Math.round(componente.custo_total)
            });
            
            console.log(`Preparando componente: ${componente.nome}`);
            console.log('Dados originais do componente:', {
                nome: componente.nome,
                quantidade: componente.quantidade,
                custo_unitario_original: componente.custo_unitario,
                custo_total_original: componente.custo_total
            });
            console.log('Dados processados:', componenteData);
        }
        
        // Agora salvar todos os componentes √∫nicos
        console.log(`\nüíæ Salvando ${componentesProcessados.size} componentes √∫nicos...`);
        
        for (const [produtoComponenteId, dadosComponente] of componentesProcessados) {
            try {
                console.log(`Salvando componente: ${dadosComponente.nome} (ID: ${produtoComponenteId})`);
                
                const response = await fetch('/api/componentes/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        produto_principal: dadosComponente.produto_principal,
                        produto_componente: produtoComponenteId,
                        quantidade: dadosComponente.quantidade,
                        observacao: dadosComponente.observacao
                    })
                });
                
                console.log(`Response status: ${response.status} para componente: ${dadosComponente.nome}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Erro detalhado para ${dadosComponente.nome}:`, errorText);
                    throw new Error(`Erro ao salvar componente ${dadosComponente.nome}: ${response.status} - ${errorText}`);
                }
                
                const componenteSalvo = await response.json();
                console.log(`‚úÖ Componente salvo:`, componenteSalvo);
                
            } catch (error) {
                console.error(`‚ùå Erro ao salvar componente ${dadosComponente.nome}:`, error);
                throw error;
            }
        }
        console.log('‚úÖ Todos os componentes foram salvos');
        
    } catch (error) {
        console.error('‚ùå Erro ao salvar componentes:', error);
        throw error;
    }
}

async function salvarDegrausParametrizado() {
    console.log('=== SALVANDO DEGRAUS PARAMETRIZADO ===');
    
    if (!ultimoCalculo) {
        alert('Realize o c√°lculo antes de salvar!');
        return;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    // Dados do produto principal
    const produtoData = {
        descricao: ultimoCalculo.nome,
        categoria: ultimoCalculo.categoria,
        tipo_produto: 'composto',
        custo_centavos: Math.round(ultimoCalculo.custo_total),
        preco_venda_centavos: Math.round(ultimoCalculo.custo_total * 1.3), // 30% de margem padr√£o
        peso_und: 0, // Ser√° calculado a partir dos componentes
        unidade: 'unid',
        observacoes: `Degrau calculado automaticamente - ${ultimoCalculo.parametros.tipo_perfil}`,
        referencia: gerarReferenciaDegrau(ultimoCalculo.nome),
        data_revisao: new Date().toISOString(),
        ativo: true
    };
    
    console.log('Dados do produto degrau:', produtoData);
    console.log('ultimoCalculo completo:', ultimoCalculo);
    
    // Validar dados antes de enviar
    if (!produtoData.descricao || produtoData.descricao.trim() === '') {
        alert('Nome do degrau √© obrigat√≥rio');
        return;
    }
    
    if (!produtoData.custo_centavos || produtoData.custo_centavos <= 0) {
        alert('Custo do degrau deve ser maior que zero');
        return;
    }
    
    // Salvar produto principal
    fetch('/api/produtos/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(produtoData)
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                console.error('Erro na resposta do servidor:', text);
                throw new Error(`Erro HTTP ${response.status}: ${response.statusText}. Detalhes: ${text}`);
            });
        }
        return response.json();
    })
    .then(produto => {
        console.log('‚úÖ Degrau principal salvo:', produto);
        
        // Salvar componentes do degrau
        return salvarComponentesDegrau(produto.id, csrftoken);
    })
    .then(() => {
        alert('Degrau salvo com sucesso na base de dados!');
        
        // Limpar formul√°rio
        document.getElementById('degraus_nome').value = '';
        document.getElementById('degraus_perfil').value = '';
        document.getElementById('degraus_largura').value = '';
        document.getElementById('degraus_comprimento').value = '';
        
        // Fechar modal
        closeProdutoParametrizadoModal();
        
        // Recarregar lista de produtos
        fetchProdutos();
        
        console.log('‚úÖ Degrau salvo e formul√°rio limpo');
    })
    .catch(error => {
        console.error('Erro ao salvar degrau:', error);
        alert('Erro ao salvar degrau: ' + error.message);
    });
}

function gerarReferenciaDegrau(nomeDegrau) {
    // Gerar refer√™ncia baseada no nome do degrau
    const palavras = nomeDegrau.split(' ').filter(p => p.length > 0);
    let referencia = 'DEGR-' + palavras.slice(0, 2).join('').substring(0, 8).toUpperCase();
    
    // Adicionar timestamp para unicidade
    const timestamp = Date.now().toString().slice(-4);
    referencia += timestamp;
    
    console.log(`Refer√™ncia gerada: ${referencia} para "${nomeDegrau}"`);
    return referencia;
}

function gerarReferenciaDegrauInjetado(nomeDegrau) {
    // Gerar refer√™ncia baseada no nome do degrau injetado
    const palavras = nomeDegrau.split(' ').filter(p => p.length > 0);
    let referencia = 'DEGI-' + palavras.slice(0, 2).join('').substring(0, 8).toUpperCase();
    
    // Adicionar timestamp para unicidade
    const timestamp = Date.now().toString().slice(-4);
    referencia += timestamp;
    
    console.log(`Refer√™ncia gerada: ${referencia} para "${nomeDegrau}"`);
    return referencia;
}

async function salvarComponentesDegrau(produtoId, csrftoken) {
    console.log('=== SALVANDO COMPONENTES DE DEGRAU ===');
    
    if (!ultimoCalculo || !ultimoCalculo.componentes) {
        throw new Error('Nenhum componente calculado encontrado');
    }
    
    console.log(`üíæ Salvando ${ultimoCalculo.componentes.length} componentes para produto ${produtoId}`);
    
    for (const componente of ultimoCalculo.componentes) {
        console.log(`\nüì¶ Processando: ${componente.nome}`);
        console.log(`   Quantidade: ${componente.quantidade}`);
        console.log(`   Custo total: R$ ${(componente.custo_total/100).toFixed(2)}`);
        
        // Identificar o produto componente
        let produtoComponenteId;
        
        // L√≥gica de identifica√ß√£o de produtos baseada no nome do componente
        if (componente.nome.toLowerCase().includes('processamento') || componente.nome.toLowerCase().includes('montagem')) {
            // M√£o de obra - usar ID fixo 1374
            produtoComponenteId = 1374;
        } else if (componente.nome.toLowerCase().includes('i25')) {
            // Perfil I25
            const produto = await buscarProdutoPorDescricao('I25mm');
            produtoComponenteId = produto.id;
        } else if (componente.nome.toLowerCase().includes('i38')) {
            // Perfil I38
            const produto = await buscarProdutoPorDescricao('I38mm');
            produtoComponenteId = produto.id;
        } else if (componente.nome.toLowerCase().includes('trav')) {
            // Travessa
            const produto = await buscarProdutoPorDescricao('TRAV');
            produtoComponenteId = produto.id;
        } else if (componente.nome.toLowerCase().includes('cola')) {
            // Cola estrutural
            produtoComponenteId = 1183; // ID fixo da cola estrutural
        } else if (componente.nome.toLowerCase().includes('perfil f')) {
            // Perfil F para refor√ßo
            const produto = await buscarProdutoPorDescricao('PERFIL F');
            produtoComponenteId = produto.id;
        } else if (componente.nome.toLowerCase().includes(' e ')) {
            // Perfil E para refor√ßo
            const produto = await buscarProdutoPorDescricao('E');
            produtoComponenteId = produto.id;
        } else if (componente.nome.toLowerCase().includes('tubo quadrado')) {
            // Tubo quadrado
            const produto = await buscarProdutoPorDescricao('Tubo Quadrado');
            produtoComponenteId = produto.id;
        } else if (componente.nome.toLowerCase().includes('paraf-sxt-m6x40')) {
            // Parafuso M6x40
            const produto = await buscarProdutoPorDescricao('PARAF-SXT-M6X40');
            produtoComponenteId = produto.id;
        } else if (componente.nome.toLowerCase().includes('paraf-sxt-m6x60')) {
            // Parafuso M6x60
            const produto = await buscarProdutoPorDescricao('PARAF-SXT-M6X60');
            produtoComponenteId = produto.id;
        } else if (componente.nome.toLowerCase().includes('por-sxt-m6')) {
            // Porca M6
            const produto = await buscarProdutoPorDescricao('POR-SXT-M6');
            produtoComponenteId = produto.id;
        } else {
            console.warn(`‚ö†Ô∏è Produto n√£o reconhecido: ${componente.nome}`);
            continue;
        }
        
        if (!produtoComponenteId) {
            console.error(`‚ùå Produto n√£o encontrado para: ${componente.nome}`);
            continue;
        }
        
        console.log(`   ‚úÖ Produto componente ID: ${produtoComponenteId}`);
        
        // Criar dados do componente
        const componenteData = {
            produto_principal: produtoId,
            produto_componente: produtoComponenteId,
            quantidade: Math.round(componente.quantidade * 1000) / 1000, // Arredondar para 3 casas decimais
            observacao: `Componente de degrau - ${componente.nome}`
        };
        
        console.log('   üìù Dados do componente:', componenteData);
        
        // Salvar componente
        const response = await fetch('/api/componentes/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(componenteData)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error(`‚ùå Erro ao salvar componente ${componente.nome}:`, errorText);
            throw new Error(`Erro ao salvar ${componente.nome}: ${response.status}`);
        }
        
        const componenteSalvo = await response.json();
        console.log(`   ‚úÖ Componente salvo: ID ${componenteSalvo.id}`);
    }
    
    console.log('‚úÖ Todos os componentes de degrau foram salvos com sucesso');
}

async function salvarDegrauInjetadoParametrizado() {
    console.log('=== SALVANDO DEGRAU INJETADO PARAMETRIZADO ===');
    
    if (!ultimoCalculo) {
        alert('Realize o c√°lculo antes de salvar!');
        return;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    // Dados do produto principal
    const produtoData = {
        descricao: ultimoCalculo.nome,
        categoria: ultimoCalculo.categoria,
        tipo_produto: 'composto',
        custo_centavos: Math.round(ultimoCalculo.custo_total),
        preco_venda_centavos: Math.round(ultimoCalculo.custo_total * 1.3), // 30% de margem padr√£o
        peso_und: 0, // Ser√° calculado a partir dos componentes
        unidade: 'unid',
        observacoes: `Degrau Injetado calculado automaticamente - Grade ID ${ultimoCalculo.parametros.grade_id}`,
        referencia: gerarReferenciaDegrauInjetado(ultimoCalculo.nome),
        data_revisao: new Date().toISOString(),
        ativo: true
    };
    
    console.log('Dados do produto degrau injetado:', produtoData);
    
    // Salvar produto principal
    fetch('/api/produtos/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(produtoData)
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`Erro ${response.status}: ${text}`);
            });
        }
        return response.json();
    })
    .then(produto => {
        console.log('‚úÖ Degrau injetado salvo:', produto);
        
        // Salvar componentes
        salvarComponentesDegrauInjetado(produto.id, csrftoken);
        
        alert('Degrau injetado salvo com sucesso na base de dados!');
        
        // Limpar formul√°rio e resultado
        document.getElementById('parametrosContainer').innerHTML = '<p class="text-muted">Selecione um template para come√ßar...</p>';
        document.getElementById('resultadoCalculado').style.display = 'none';
        document.getElementById('salvarProdutoBtn').disabled = true;
        ultimoCalculo = null;
        
        // Recarregar produtos
        fetchProdutos();
    })
    .catch(error => {
        console.error('‚ùå Erro ao salvar degrau injetado:', error);
        alert('Erro ao salvar degrau injetado: ' + (error.message || 'Erro desconhecido'));
    });
}

async function salvarComponentesDegrauInjetado(produtoId, csrftoken) {
    console.log('=== SALVANDO COMPONENTES DEGRAU INJETADO ===');
    
    try {
        for (const componente of ultimoCalculo.componentes) {
            // Encontrar o ID do produto componente baseado no nome
            let produtoComponenteId = null;
            
            // Verificar m√£o de obra
            if (componente.nome.toLowerCase().includes('processamento') || 
                componente.nome.toLowerCase().includes('montagem')) {
                produtoComponenteId = 1374; // ID fixo da m√£o de obra (mesmo usado em degraus normais)
            } 
            // Verificar grade injetada
            else if (componente.nome.toLowerCase().includes('grade injetada')) {
                produtoComponenteId = ultimoCalculo.parametros.grade_id;
            }
            // Verificar perfil refor√ßo E
            else if (componente.nome.toLowerCase().includes('e - 4')) {
                const produto = await buscarProdutoPorDescricao('E - 4\'x1.3/16\' #3/16\'');
                produtoComponenteId = produto.id;
            }
            // Verificar perfil refor√ßo F
            else if (componente.nome.toLowerCase().includes('f - 4')) {
                const produto = await buscarProdutoPorDescricao('F - 4\'x1.1/4\' #3/16\'');
                produtoComponenteId = produto.id;
            }
            // Verificar tubo quadrado
            else if (componente.nome.toLowerCase().includes('tubo quadrado')) {
                const produto = await buscarProdutoPorDescricao('Tubo Quadrado 25x38#3mm');
                produtoComponenteId = produto.id;
            }
            // Verificar parafusos e porcas
            else if (componente.nome.toLowerCase().includes('paraf-sxt-m6x40')) {
                const produto = await buscarProdutoPorDescricao('PARAF-SXT-M6X40');
                produtoComponenteId = produto.id;
            } else if (componente.nome.toLowerCase().includes('paraf-sxt-m6x60')) {
                const produto = await buscarProdutoPorDescricao('PARAF-SXT-M6X60');
                produtoComponenteId = produto.id;
            } else if (componente.nome.toLowerCase().includes('por-sxt-m6')) {
                const produto = await buscarProdutoPorDescricao('POR-SXT-M6');
                produtoComponenteId = produto.id;
            }
            
            if (!produtoComponenteId) {
                console.warn(`‚ùì Produto componente n√£o encontrado para: ${componente.nome}`);
                continue;
            }
            
            // Criar dados do componente
            const componenteData = {
                produto_principal: produtoId,
                produto_componente: produtoComponenteId,
                quantidade: Math.round(componente.quantidade * 1000) / 1000, // Arredondar para 3 casas decimais
                observacao: JSON.stringify({
                    nome_componente: componente.nome,
                    custo_unitario: componente.custo_unitario,
                    custo_total: componente.custo_total,
                    tipo_calculo: 'degrau_injetado',
                    unidade: componente.unidade || 'unid'
                })
            };
            
            console.log(`üíæ Salvando componente: ${componente.nome} (ID: ${produtoComponenteId})`);
            console.log('Dados do componente:', componenteData);
            
            // Salvar componente
            const response = await fetch('/api/componentes/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(componenteData)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Erro detalhado:', errorText);
                throw new Error(`Erro ao salvar componente ${componente.nome}: ${response.statusText}. Detalhes: ${errorText}`);
            }
            
            console.log(`‚úÖ Componente salvo: ${componente.nome}`);
        }
    } catch (error) {
        console.error('‚ùå Erro ao salvar componentes de degrau injetado:', error);
        throw error;
    }
    
    console.log('‚úÖ Todos os componentes de degrau injetado foram salvos com sucesso');
}

async function salvarGuardaCorpoHorizontalParametrizado() {
    console.log('=== SALVANDO GUARDA CORPO - HORIZONTAL PARAMETRIZADO ===');
    
    if (!ultimoCalculo) {
        alert('Realize o c√°lculo antes de salvar!');
        return;
    }
    
    const csrftoken = getCookie('csrftoken');
    
    // Dados do produto principal
    const produtoData = {
        descricao: ultimoCalculo.nome,
        categoria: ultimoCalculo.categoria,
        tipo_produto: 'composto',
        custo_centavos: Math.round(ultimoCalculo.custo_total),
        preco_venda_centavos: Math.round(ultimoCalculo.custo_total * 1.3), // 30% de margem padr√£o
        peso_und: 0, // Ser√° calculado a partir dos componentes
        unidade: 'unid',
        observacao: JSON.stringify({
            tipo_calculo: 'guarda_corpo_horizontal',
            parametros: ultimoCalculo.parametros,
            larg_modulo: ultimoCalculo.parametros.larg_modulo,
            altura: ultimoCalculo.parametros.altura,
            n_colunas: ultimoCalculo.parametros.n_colunas,
            n_br_intermediaria: ultimoCalculo.parametros.n_br_intermediaria,
            tipo_tubo_quad: ultimoCalculo.parametros.tipo_tubo_quad,
            tipo_omega: ultimoCalculo.parametros.tipo_omega,
            tipo_sapata: ultimoCalculo.parametros.tipo_sapata
        }),
        referencia: gerarReferenciaGuardaCorpo(ultimoCalculo.nome),
        data_revisao: new Date().toISOString(),
        ativo: true
    };
    
    console.log('Dados do produto guarda corpo horizontal:', produtoData);
    console.log('ultimoCalculo completo:', ultimoCalculo);
    
    // Validar dados antes de enviar
    if (!produtoData.descricao || produtoData.descricao.trim() === '') {
        alert('Nome do guarda corpo √© obrigat√≥rio');
        return;
    }
    
    if (!produtoData.custo_centavos || produtoData.custo_centavos <= 0) {
        alert('Custo do guarda corpo deve ser maior que zero');
        return;
    }
    
    // Salvar produto principal
    fetch('/api/produtos/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(produtoData)
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                console.error('Erro na resposta do servidor:', text);
                throw new Error(`Erro HTTP ${response.status}: ${response.statusText}. Detalhes: ${text}`);
            });
        }
        return response.json();
    })
    .then(async produto => {
        console.log('‚úÖ Guarda corpo horizontal salvo:', produto);
        
        // Salvar componentes (aguardar conclus√£o)
        await salvarComponentesGuardaCorpoHorizontal(produto.id, csrftoken);
        
        alert('Guarda corpo horizontal salvo com sucesso na base de dados!');
        
        // Limpar formul√°rio e resultado
        document.getElementById('parametrosContainer').innerHTML = '<p class="text-muted">Selecione um template para come√ßar...</p>';
        document.getElementById('resultadoCalculado').style.display = 'none';
        document.getElementById('salvarProdutoBtn').disabled = true;
        ultimoCalculo = null;
        
        // Recarregar produtos
        fetchProdutos();
    })
    .catch(error => {
        console.error('‚ùå Erro ao salvar guarda corpo horizontal:', error);
        alert('Erro ao salvar guarda corpo horizontal: ' + (error.message || 'Erro desconhecido'));
    });
}

async function salvarComponentesGuardaCorpoHorizontal(produtoId, csrftoken) {
    console.log('=== SALVANDO COMPONENTES GUARDA CORPO - HORIZONTAL ===');
    
    // Verificar se ultimoCalculo existe
    if (!ultimoCalculo || !ultimoCalculo.parametros || !ultimoCalculo.componentes) {
        console.error('‚ùå Erro: ultimoCalculo n√£o est√° dispon√≠vel ou est√° incompleto');
        console.error('ultimoCalculo atual:', ultimoCalculo);
        alert('Erro: √â necess√°rio fazer um c√°lculo antes de salvar os componentes.');
        return;
    }
    
    try {
        for (const componente of ultimoCalculo.componentes) {
            // Encontrar o ID do produto componente baseado no nome
            let produtoComponenteId = null;
            
            // Verificar m√£o de obra
            if (componente.nome.toLowerCase().includes('processamento') || 
                componente.nome.toLowerCase().includes('montagem')) {
                produtoComponenteId = 1374; // ID fixo da m√£o de obra
            } 
            // Verificar tubo quadrado
            else if (componente.nome.toLowerCase().includes('tubo quadrado')) {
                const produto = await buscarProdutoPorDescricao(ultimoCalculo.parametros.tipo_tubo_quad);
                produtoComponenteId = produto.id;
            }
            // Verificar perfil √¥mega
            else if (componente.nome.toLowerCase().includes('omega') || componente.nome.toLowerCase().includes('√¥mega')) {
                const produto = await buscarProdutoPorDescricao(ultimoCalculo.parametros.tipo_omega);
                produtoComponenteId = produto.id;
            }
            // Verificar sapata
            else if (componente.nome.toLowerCase().includes('sapata')) {
                const produto = await buscarProdutoPorDescricao(ultimoCalculo.parametros.tipo_sapata);
                produtoComponenteId = produto.id;
            }
            // Verificar corrim√£o
            else if (componente.nome.toLowerCase().includes('corrim√£o') || componente.nome.toLowerCase().includes('corrimao')) {
                produtoComponenteId = 1322; // ID fixo do corrim√£o
            }
            // Verificar rodap√©
            else if (componente.nome.toLowerCase().includes('rodap√©') || componente.nome.toLowerCase().includes('rodape')) {
                produtoComponenteId = 1323; // ID fixo do rodap√©
            }
            // Verificar parafusos e porcas
            else if (componente.nome.toLowerCase().includes('paraf-sxt-m6x40')) {
                const produto = await buscarProdutoPorDescricao('PARAF-SXT-M6X40-AI304');
                produtoComponenteId = produto.id;
            } else if (componente.nome.toLowerCase().includes('paraf-sxt-m6x60')) {
                const produto = await buscarProdutoPorDescricao('PARAF-SXT-M6X60-AI304');
                produtoComponenteId = produto.id;
            } else if (componente.nome.toLowerCase().includes('paraf-sxt-m6x70')) {
                const produto = await buscarProdutoPorDescricao('PARAF-SXT-M6X70-AI304');
                produtoComponenteId = produto.id;
            } else if (componente.nome.toLowerCase().includes('por-sxt-m6')) {
                const produto = await buscarProdutoPorDescricao('POR-SXT-M6-AI304');
                produtoComponenteId = produto.id;
            } else if (
                componente.nome.toLowerCase().includes('paraf-aa-pn-ph-4,8x19') ||
                componente.nome.toLowerCase().includes('paraf aa pn ph 4,8x19') ||
                componente.nome.toLowerCase().includes('paraf-aa-pn-ph')
            ) {
                const produto = await buscarProdutoPorDescricao('PARAF-AA-PN-PH-4,8X19-AI304');
                produtoComponenteId = produto.id;
            }
            
            if (!produtoComponenteId) {
                console.warn(`‚ùì Produto componente n√£o encontrado para: ${componente.nome}`);
                continue;
            }
            
            // Criar dados do componente
            const componenteData = {
                produto_principal: produtoId,
                produto_componente: produtoComponenteId,
                quantidade: Math.round(componente.quantidade * 1000) / 1000, // Arredondar para 3 casas decimais
                observacao: JSON.stringify({
                    nome_componente: componente.nome,
                    custo_unitario: componente.custo_unitario,
                    custo_total: componente.custo_total,
                    tipo_calculo: 'guarda_corpo_horizontal',
                    unidade: componente.unidade || 'unid'
                })
            };
            
            console.log(`üíæ Salvando componente: ${componente.nome} (ID: ${produtoComponenteId})`);
            console.log('Dados do componente:', componenteData);
            
            // Salvar componente
            const response = await fetch('/api/componentes/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(componenteData)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Erro detalhado:', errorText);
                throw new Error(`Erro ao salvar componente ${componente.nome}: ${response.statusText}. Detalhes: ${errorText}`);
            }
            
            console.log(`‚úÖ Componente salvo: ${componente.nome}`);
        }
    } catch (error) {
        console.error('‚ùå Erro ao salvar componentes de guarda corpo horizontal:', error);
        throw error;
    }
    
    console.log('‚úÖ Todos os componentes de guarda corpo horizontal foram salvos com sucesso');
}

function gerarReferenciaGuardaCorpo(nomeGuardaCorpo) {
    // Gerar refer√™ncia baseada no nome do guarda corpo
    const palavras = nomeGuardaCorpo.split(' ').filter(p => p.length > 0);
    let referencia = 'GC-HORIZ-' + palavras.slice(0, 2).join('').substring(0, 8).toUpperCase();
    
    // Adicionar timestamp para garantir unicidade
    const timestamp = Date.now().toString().slice(-4);
    referencia += '-' + timestamp;
    
    return referencia;
}

async function salvarComponentesTampaInjetada(produtoId, csrftoken) {
    console.log('=== SALVANDO COMPONENTES TAMPA INJETADA ===');
    
    try {
        for (const componente of ultimoCalculo.componentes) {
            // Encontrar o ID do produto componente baseado no nome
            let produtoComponenteId = null;
            
            // PRIMEIRO: Verificar m√£o de obra (deve vir antes de U4 e outras verifica√ß√µes)
            if (componente.nome.toLowerCase().includes('processamento') || 
                componente.nome.toLowerCase().includes('montagem') ||
                componente.nome.toLowerCase().includes('m√£o de obra')) {
                // Detectada m√£o de obra
                console.log('üîß DETECTADA M√ÉO DE OBRA TAMPA INJETADA:', componente.nome);
                
                // Usar o ID do produto de m√£o de obra do ultimoCalculo ou ID fixo conhecido
                const maoObraProduto = ultimoCalculo.mao_obra_produto_id || 1374;
                produtoComponenteId = maoObraProduto;
                console.log('‚úÖ Usando ID da m√£o de obra:', produtoComponenteId);
            
            } else if (componente.nome.toLowerCase().includes('grade') && componente.nome.toLowerCase().includes('injetada')) {
                // Buscar grade injetada dinamicamente
                const produto = await buscarProdutoPorDescricao('grade injetada');
                produtoComponenteId = produto.id;
            } else if (componente.nome.includes('COLA ESTRUTURAL')) {
                produtoComponenteId = 1183; // ID fixo da cola estrutural 4500 A/B
            } else if (componente.nome.toLowerCase().includes('chapa') && componente.nome.toLowerCase().includes('2,5')) {
                // Buscar chapa lisa 2,5mm dinamicamente
                const produto = await buscarProdutoPorDescricao('chapa lisa');
                produtoComponenteId = produto.id;
            } else if (componente.nome.toLowerCase().includes('chapa') && componente.nome.toLowerCase().includes('ev')) {
                // Para Chapa EV com valor fixo, criar produto se n√£o existir
                produtoComponenteId = await buscarOuCriarChapaEV(csrftoken);
            } else if (componente.nome.toLowerCase().includes('u4')) {
                // Buscar perfil U4" dinamicamente
                const produto = await buscarProdutoPorDescricao('u4');
                produtoComponenteId = produto.id;
            } else if (componente.nome.toLowerCase().includes('al√ßa')) {
                // Buscar al√ßa dinamicamente
                const produto = await buscarProdutoPorDescricao('al√ßa');
                produtoComponenteId = produto.id;
            }
            
            if (!produtoComponenteId) {
                console.error(`‚ùå N√£o foi poss√≠vel mapear o componente: ${componente.nome}`);
                throw new Error(`Componente n√£o mapeado: ${componente.nome}`);
            }
            
            // Salvar custos calculados na observa√ß√£o como JSON
            const custosCalculados = {
                custo_unitario: Math.round(componente.custo_unitario),
                custo_total: Math.round(componente.custo_total),
                nome_componente: componente.nome,
                calculated_at: new Date().toISOString()
            };
            
            const componenteData = {
                produto_principal: produtoId,
                produto_componente: produtoComponenteId,
                quantidade: Math.round(parseFloat(componente.quantidade.toFixed(3)) * 1000) / 1000,
                observacao: JSON.stringify(custosCalculados)
            };
            
            console.log(`Salvando componente tampa injetada: ${componente.nome}`);
            
            const response = await fetch('/api/componentes/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(componenteData)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Erro ao salvar componente ${componente.nome}: ${response.status} - ${errorText}`);
            }
            
            const componenteSalvo = await response.json();
            console.log(`‚úÖ Componente tampa injetada salvo:`, componenteSalvo);
        }
        
        console.log('‚úÖ Todos os componentes da tampa injetada foram salvos');
        
    } catch (error) {
        console.error('‚ùå Erro ao salvar componentes da tampa injetada:', error);
        throw error;
    }
}

async function buscarOuCriarChapaEV(csrftoken) {
    try {
        // Primeiro, tentar buscar chapa EV existente
        const response = await fetch('/api/produtos/');
        const produtos = await response.json();
        
        const chapaEV = produtos.find(p => 
            p.descricao && 
            p.descricao.toLowerCase().includes('chapa') &&
            p.descricao.toLowerCase().includes('ev')
        );
        
        if (chapaEV) {
            console.log(`‚úÖ Chapa EV encontrada: ID ${chapaEV.id} - ${chapaEV.descricao}`);
            return chapaEV.id;
        }
        
        // Se n√£o encontrar, criar produto para Chapa EV
        console.log('üîß Criando produto para Chapa EV...');
        const chapaEVData = {
            descricao: 'Chapa EV - Res. Poli√©ster',
            custo_centavos: 27750, // R$ 277,50 fixo
            peso_und: '2.500',
            unidade: 'm¬≤',
            referencia: 'CHAPA-EV',
            tipo_produto: 'simples',
            categoria: 'Chapa',
            subcategoria: 'EV'
        };
        
        const createResponse = await fetch('/api/produtos/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(chapaEVData)
        });
        
        if (createResponse.ok) {
            const novaChapaEV = await createResponse.json();
            console.log(`‚úÖ Chapa EV criada: ID ${novaChapaEV.id}`);
            return novaChapaEV.id;
        } else {
            throw new Error('Erro ao criar produto Chapa EV');
        }
        
    } catch (error) {
        console.error('‚ùå Erro ao buscar/criar Chapa EV:', error);
        throw error;
    }
}

async function salvarComponentesParametrizados(produtoId, csrftoken) {
    console.log('=== SALVANDO COMPONENTES PARAMETRIZADOS ===');
    console.log('Produto ID:', produtoId, 'Tipo:', typeof produtoId);
    
    // Validar produto ID
    if (!produtoId || produtoId === 'undefined' || produtoId === 'null') {
        console.error('‚ùå Produto ID inv√°lido:', produtoId);
        throw new Error('Produto ID inv√°lido');
    }
    
    // Obter dados do √∫ltimo c√°lculo
    if (!ultimoCalculo || !ultimoCalculo.componentes) {
        throw new Error('Dados do c√°lculo n√£o encontrados');
    }
    
    const componentes = ultimoCalculo.componentes;
    console.log('Componentes a salvar:', componentes.length);
    
    // Mapeamento dos componentes para IDs na tabela MP_Produtos
    const componentesMapeamento = {
        'Roving 4400': 1237,
        'Manta 300': 1238,
        'V√©u': 1239,
        'Resina Poli√©ster': 1269,
        'Resina Isoft√°lica': 1268,
        'Resina √âster Vin√≠lica': 1270,
        'Mon√¥mero de estireno': 1266,
        'Anti UV': 1243,
        'Anti OX': 1244,
        'BPO': 1245,
        'TBPB': 1246,
        'Desmoldante': 1247,
        'Antichama': 1248,
        'Carga mineral': 1249,
        'Pigmento': 1250,
        // Mapeamento especial para m√£o de obra
        'M√£o de Obra - Pultrus√£o': null  // Ser√° definido dinamicamente
    };
    
    let componentesSalvos = 0;
    let produtoFinal = null;
    
        // Primeiro, limpar componentes existentes deste produto para evitar conflitos
        console.log('üßπ Limpando componentes existentes do produto...');
        try {
            const componentesExistentesResponse = await fetch(`/api/componentes/?produto_principal=${produtoId}`);
            if (componentesExistentesResponse.ok) {
                const componentesExistentes = await componentesExistentesResponse.json();
                
                console.log(`   Encontrados ${componentesExistentes.length} componentes existentes`);
                
                for (const comp of componentesExistentes) {
                    const deleteResponse = await fetch(`/api/componentes/${comp.id}/`, {
                        method: 'DELETE',
                        headers: {
                            'X-CSRFToken': csrftoken
                        }
                    });
                    
                    if (deleteResponse.ok) {
                        console.log(`   ‚úÖ Removido componente ID ${comp.id}`);
                    } else {
                        console.warn(`   ‚ö†Ô∏è Erro ao remover componente ID ${comp.id}: ${deleteResponse.status}`);
                    }
                }
                
                console.log('‚úÖ Limpeza de componentes existentes conclu√≠da');
            } else {
                console.warn('‚ö†Ô∏è Erro ao buscar componentes existentes:', componentesExistentesResponse.status);
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Erro ao limpar componentes existentes:', error);
        }    // Primeiro, buscar todos os produtos para fazer mapeamento din√¢mico
    const produtosResponse = await fetch('/api/produtos/');
    const todosProdutos = await produtosResponse.json();
    
    // Verificar se existe produto para m√£o de obra, sen√£o criar
    let maoObraProductId = null;
    const maoObraProduto = todosProdutos.find(p => 
        p.descricao && p.descricao.toLowerCase().includes('m√£o de obra') && 
        p.descricao.toLowerCase().includes('pultrus√£o')
    );
    
    if (maoObraProduto) {
        maoObraProductId = maoObraProduto.id;
        console.log(`‚úÖ Produto m√£o de obra encontrado: ID ${maoObraProductId} - ${maoObraProduto.descricao}`);
    } else {
        // Criar produto para m√£o de obra se n√£o existir
        console.log('üîß Criando produto para m√£o de obra...');
        try {
            const maoObraData = {
                descricao: 'M√£o de Obra - Pultrus√£o',
                custo_centavos: 1, // Custo simb√≥lico, o valor real vem do c√°lculo
                peso_und: '0.000',
                unidade: 'H',
                referencia: 'MAO-OBRA-PULT',
                tipo_produto: 'simples',
                categoria: 'M√£o de Obra',
                subcategoria: 'Pultrus√£o'
            };
            
            const createResponse = await fetch('/api/produtos/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(maoObraData)
            });
            
            if (createResponse.ok) {
                const novoProdutoMaoObra = await createResponse.json();
                maoObraProductId = novoProdutoMaoObra.id;
                console.log(`‚úÖ Produto m√£o de obra criado: ID ${maoObraProductId}`);
                
                // Atualizar lista de produtos
                todosProdutos.push(novoProdutoMaoObra);
            } else {
                console.error('‚ùå Erro ao criar produto de m√£o de obra');
            }
        } catch (error) {
            console.error('‚ùå Erro ao criar produto de m√£o de obra:', error);
        }
    }
    
    // Atualizar mapeamento com ID da m√£o de obra
    if (maoObraProductId) {
        componentesMapeamento['M√£o de Obra - Pultrus√£o'] = maoObraProductId;
    }
    
    // Criar mapeamento por nome de produto
    const produtosPorNome = {};
    
    // Primeiro, mapear por nome exato
    todosProdutos.forEach(produto => {
        produtosPorNome[produto.descricao] = produto.id;
    });
    
    // Depois, criar mapeamentos espec√≠ficos por palavras-chave (sem sobrescrever)
    todosProdutos.forEach(produto => {
        const desc = produto.descricao.toLowerCase();
        
        // Mapeamento espec√≠fico - apenas se ainda n√£o foi mapeado
        if (desc.includes('roving') && !produtosPorNome['Roving 4400']) {
            produtosPorNome['Roving 4400'] = produto.id;
        }
        if (desc.includes('manta') && desc.includes('300') && !produtosPorNome['Manta 300']) {
            produtosPorNome['Manta 300'] = produto.id;
        }
        if ((desc.includes('v√©u') || desc.includes('veu')) && !produtosPorNome['V√©u']) {
            produtosPorNome['V√©u'] = produto.id;
        }
        if (desc.includes('resina') && desc.includes('poli√©ster') && !produtosPorNome['Resina Poli√©ster']) {
            produtosPorNome['Resina Poli√©ster'] = produto.id;
        }
        if (desc.includes('resina') && desc.includes('isoft√°lica') && !produtosPorNome['Resina Isoft√°lica']) {
            produtosPorNome['Resina Isoft√°lica'] = produto.id;
        }
        if (desc.includes('resina') && desc.includes('√©ster') && !produtosPorNome['Resina √âster Vin√≠lica']) {
            produtosPorNome['Resina √âster Vin√≠lica'] = produto.id;
        }
        if ((desc.includes('mon√¥mero') || desc.includes('estireno')) && !produtosPorNome['Mon√¥mero de estireno']) {
            produtosPorNome['Mon√¥mero de estireno'] = produto.id;
        }
        if (desc.includes('anti') && desc.includes('uv') && !produtosPorNome['Anti UV']) {
            produtosPorNome['Anti UV'] = produto.id;
        }
        if (desc.includes('anti') && desc.includes('ox') && !produtosPorNome['Anti OX']) {
            produtosPorNome['Anti OX'] = produto.id;
        }
        if (desc.includes('bpo') && !produtosPorNome['BPO']) {
            produtosPorNome['BPO'] = produto.id;
        }
        if (desc.includes('tbpb') && !produtosPorNome['TBPB']) {
            produtosPorNome['TBPB'] = produto.id;
        }
        if (desc.includes('desmoldante') && !produtosPorNome['Desmoldante']) {
            produtosPorNome['Desmoldante'] = produto.id;
        }
        if (desc.includes('antichama') && !produtosPorNome['Antichama']) {
            produtosPorNome['Antichama'] = produto.id;
        }
        if (desc.includes('carga') && desc.includes('mineral') && !produtosPorNome['Carga mineral']) {
            produtosPorNome['Carga mineral'] = produto.id;
        }
        if (desc.includes('pigmento') && !produtosPorNome['Pigmento']) {
            produtosPorNome['Pigmento'] = produto.id;
        }
    });
    
    console.log('Mapeamento de produtos por nome:', produtosPorNome);
    console.log('Total de produtos encontrados:', todosProdutos.length);
    console.log('Componentes a mapear:', componentes.map(c => c.nome));
    
    // Verificar mapeamentos espec√≠ficos
    console.log('=== VERIFICA√á√ÉO DE MAPEAMENTOS ===');
    componentes.forEach(comp => {
        const id = produtosPorNome[comp.nome];
        console.log(`${comp.nome} -> ID: ${id}`);
    });
    
    // Salvar cada componente individualmente
    for (const componente of componentes) {
        try {
            let produtoComponenteId = null;
            
            // Verificar se √© componente de m√£o de obra
            if (componente.nome === 'M√£o de Obra - Pultrus√£o') {
                produtoComponenteId = componentesMapeamento['M√£o de Obra - Pultrus√£o'];
                console.log(`üîß Processando m√£o de obra: ID ${produtoComponenteId}`);
                
                // CORRE√á√ÉO: Atualizar o custo do produto de m√£o de obra com o valor calculado
                if (produtoComponenteId && componente.custo_total > 0) {
                    console.log(`üîÑ Atualizando custo do produto m√£o de obra...`);
                    const updateData = {
                        custo_centavos: componente.custo_total
                    };
                    
                    try {
                        const updateResponse = await fetch(`/api/produtos/${produtoComponenteId}/`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrftoken
                            },
                            body: JSON.stringify(updateData)
                        });
                        
                        if (updateResponse.ok) {
                            console.log(`‚úÖ Custo do produto m√£o de obra atualizado para ${componente.custo_total} centavos`);
                        } else {
                            console.warn(`‚ö†Ô∏è Erro ao atualizar custo do produto m√£o de obra`);
                        }
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è Erro ao atualizar produto m√£o de obra:`, error);
                    }
                }
            } else {
                // Encontrar ID do produto componente usando mapeamento din√¢mico
                produtoComponenteId = produtosPorNome[componente.nome];
                console.log(`üîç Buscando componente: "${componente.nome}"`);
                console.log(`   - Mapeamento din√¢mico: ${produtoComponenteId}`);
                
                // Se n√£o encontrar, tentar mapeamento fixo
                if (!produtoComponenteId) {
                    produtoComponenteId = componentesMapeamento[componente.nome];
                    console.log(`   - Mapeamento fixo: ${produtoComponenteId}`);
                }
            }
            
            // Se ainda n√£o encontrar, tentar busca aproximada ou pular
            if (!produtoComponenteId) {
                console.warn(`‚ùå Componente n√£o encontrado: ${componente.nome}`);
                console.log('Produtos dispon√≠veis:', Object.keys(produtosPorNome));
                
                // Para m√£o de obra, n√£o pular - mostrar erro espec√≠fico
                if (componente.nome === 'M√£o de Obra - Pultrus√£o') {
                    console.error('‚ùå ERRO CR√çTICO: N√£o foi poss√≠vel mapear m√£o de obra!');
                }
                continue;
            }
            
            console.log(`‚úÖ Componente "${componente.nome}" mapeado para ID: ${produtoComponenteId}`);
            
            const componenteData = {
                produto_principal: produtoId,
                produto_componente: produtoComponenteId,
                quantidade: Math.round(parseFloat(componente.quantidade) * 1000) / 1000, // Arredondar para 3 casas decimais
                observacao: componente.nome === 'M√£o de Obra - Pultrus√£o' 
                    ? `M√£o de obra parametrizada: ${componente.produto}` 
                    : `Componente parametrizado calculado automaticamente`
            };
            
            console.log(`üíæ Salvando componente: ${componente.nome} (ID: ${produtoComponenteId}) - Quantidade: ${componenteData.quantidade}`);
            
            const response = await fetch('/api/componentes/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(componenteData)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`‚ùå Erro ao salvar componente ${componente.nome}:`, response.status);
                console.error(`   Detalhes do erro:`, errorText);
                
                // Tentar parsear como JSON para ver erro estruturado
                try {
                    const errorJson = JSON.parse(errorText);
                    console.error(`   Erro estruturado:`, errorJson);
                } catch (e) {
                    console.error(`   Erro como texto:`, errorText);
                }
                continue;
            }
            
            const componenteSalvo = await response.json();
            console.log(`‚úÖ Componente salvo: ${componente.nome} ${componente.nome === 'M√£o de Obra - Pultrus√£o' ? '(M√ÉO DE OBRA)' : ''}`);
            componentesSalvos++;
            
        } catch (error) {
            console.error(`‚ùå Erro ao processar componente ${componente.nome}:`, error);
        }
    }
    
    console.log(`=== SALVAMENTO CONCLU√çDO ===`);
    console.log(`Componentes salvos: ${componentesSalvos}/${componentes.length}`);
    
    // Buscar o produto atualizado para retornar
    const produtoResponse = await fetch(`/api/produtos/${produtoId}/`);
    produtoFinal = await produtoResponse.json();
    produtoFinal.num_componentes = componentesSalvos;
    
    return produtoFinal;
}

// Fun√ß√£o para recalcular um componente espec√≠fico baseado no novo fator
function recalcularComponente(componenteIndex) {
    if (!ultimoCalculo || !ultimoCalculo.componentes[componenteIndex]) {
        alert('Erro: Componente n√£o encontrado!');
        return;
    }
    
    const fatorInput = document.querySelector(`input[data-component-index="${componenteIndex}"]`);
    const novoFator = parseFloat(fatorInput.value);
    
    if (isNaN(novoFator) || novoFator < 0 || novoFator > 100) {
        alert('Fator deve ser um n√∫mero entre 0 e 100!');
        return;
    }
    
    const componente = ultimoCalculo.componentes[componenteIndex];
    const pesoResinaBase = ultimoCalculo.peso_resina_base;
    
    // Recalcular quantidade baseada no novo fator
    const novaQuantidade = pesoResinaBase * (novoFator / 100);
    const novoCustoTotal = novaQuantidade * componente.custo_unitario;
    
    // Atualizar o componente
    componente.quantidade = novaQuantidade;
    componente.custo_total = novoCustoTotal;
    
    // Atualizar a exibi√ß√£o na tabela
    const row = document.querySelector(`input[data-component-index="${componenteIndex}"]`).closest('tr');
    row.querySelector('.quantidade-display').textContent = novaQuantidade.toFixed(4);
    row.querySelector('.custo-total-display').textContent = `R$ ${novoCustoTotal.toFixed(2)}`;
    
    // Recalcular total geral
    atualizarTotalGeral();
    
    console.log(`Componente ${componente.nome} recalculado: Fator: ${novoFator}%, Qtd: ${novaQuantidade.toFixed(4)}, Custo: R$ ${novoCustoTotal.toFixed(2)}`);
}

// Fun√ß√£o para recalcular todos os componentes
function recalcularTodosComponentes() {
    if (!ultimoCalculo || !ultimoCalculo.componentes) {
        alert('Erro: Nenhum c√°lculo encontrado!');
        return;
    }
    
    console.log('=== RECALCULANDO TODOS OS COMPONENTES ===');
    
    const fatoresInputs = document.querySelectorAll('.fator-input');
    
    fatoresInputs.forEach(input => {
        const componenteIndex = parseInt(input.getAttribute('data-component-index'));
        const novoFator = parseFloat(input.value);
        
        if (!isNaN(novoFator) && novoFator >= 0 && novoFator <= 100) {
            const componente = ultimoCalculo.componentes[componenteIndex];
            const pesoResinaBase = ultimoCalculo.peso_resina_base;
            
            // Recalcular
            const novaQuantidade = pesoResinaBase * (novoFator / 100);
            const novoCustoTotal = novaQuantidade * componente.custo_unitario;
            
            // Atualizar componente
            componente.quantidade = novaQuantidade;
            componente.custo_total = novoCustoTotal;
            
            // Atualizar exibi√ß√£o
            const row = input.closest('tr');
            row.querySelector('.quantidade-display').textContent = novaQuantidade.toFixed(4);
            row.querySelector('.custo-total-display').textContent = `R$ ${novoCustoTotal.toFixed(2)}`;
            
            console.log(`Recalculado ${componente.nome}: ${novoFator}% = ${novaQuantidade.toFixed(4)} kg = R$ ${novoCustoTotal.toFixed(2)}`);
        }
    });
    
    // Atualizar total geral
    atualizarTotalGeral();
    
    alert('Todos os componentes foram recalculados com sucesso!');
}

// Fun√ß√£o para atualizar o total geral
function atualizarTotalGeral() {
    if (!ultimoCalculo || !ultimoCalculo.componentes) return;
    
    const custoTotalGeral = ultimoCalculo.componentes.reduce((total, comp) => total + comp.custo_total, 0);
    
    // Atualizar exibi√ß√£o na tabela
    const totalElement = document.getElementById('custo-total-geral');
    if (totalElement) {
        totalElement.textContent = `R$ ${custoTotalGeral.toFixed(2)}`;
    }
    
    // Atualizar no resumo tamb√©m
    ultimoCalculo.custo_total = Math.round(custoTotalGeral * 100);
    document.getElementById('custoTotalCalculado').textContent = `R$ ${custoTotalGeral.toFixed(2)}`;
    
    console.log(`Total geral atualizado: R$ ${custoTotalGeral.toFixed(2)}`);
}

// Fun√ß√£o auxiliar para buscar produto por descri√ß√£o
async function buscarProdutoPorDescricao(termo) {
    try {
        const response = await fetch('/api/produtos/');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const produtos = await response.json();
        
        const produto = produtos.find(p => 
            p.descricao && 
            p.descricao.toLowerCase().includes(termo.toLowerCase())
        );
        
        if (!produto) {
            throw new Error(`Produto com termo "${termo}" n√£o encontrado`);
        }
        
        console.log(`‚úÖ Produto encontrado para "${termo}": ID ${produto.id} - ${produto.descricao}`);
        return produto; // Retornar o produto completo em vez de apenas o ID
    } catch (error) {
        console.error(`‚ùå Erro ao buscar produto "${termo}":`, error);
        throw error;
    }
}

async function buscarProdutoPorId(id) {
    try {
        const response = await fetch('/api/produtos/');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const produtos = await response.json();
        
        // Converter ID para n√∫mero para garantir compara√ß√£o correta
        const idNumerico = parseInt(id, 10);
        const produto = produtos.find(p => p.id === idNumerico);
        
        if (!produto) {
            throw new Error(`Produto com ID "${id}" n√£o encontrado`);
        }
        
        console.log(`‚úÖ Produto encontrado por ID "${id}": ${produto.descricao}`);
        return produto;
    } catch (error) {
        console.error(`‚ùå Erro ao buscar produto por ID "${id}":`, error);
        throw error;
    }
}

window.onload = function() {
    fetchProdutos();
    // Adicionar um delay para garantir que os produtos foram carregados
    setTimeout(() => {
        inicializarProdutosComponente();
    }, 500);
};
</script>
</body>
</html>
