<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Or√ßamento - FIBERMEYER</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
            color: #fff;
        }
        .nav-pills .nav-link:hover {
            background-color: #e2e6ea;
            color: #0d6efd;
        }
        .orcamento-status {
            font-size: 1.1rem;
            font-weight: bold;
            color: #0d6efd;
        }
        
        /* Estilos da tabela de componentes (copiado do mp.html) */
        #componentesCalculadosTable th {
            background-color: #f8f9fa;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        #componentesCalculadosTable td {
            vertical-align: middle;
            font-size: 0.875rem;
        }
        
        .btn-sm i {
            font-size: 0.75rem;
        }
        
        /* Destaque para linha de total */
        #componentesCalculadosTable tr:last-child {
            background-color: #e3f2fd;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div class="d-flex">
  <nav class="flex-shrink-0 p-3 bg-light border-end" style="width: 220px; min-height: 100vh;">
    <h4 class="mb-4">FIBERMEYER</h4>
    <ul class="nav nav-pills flex-column mb-auto">
      <li class="nav-item">
        <a class="nav-link d-flex align-items-center" data-bs-toggle="collapse" href="#parametrosSubmenu" role="button" aria-expanded="false" aria-controls="parametrosSubmenu">
          <span>Par√¢metros</span>
          <span class="ms-auto caret-indicator" style="transition: transform 0.2s;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-caret-down" viewBox="0 0 16 16">
              <path d="M3.204 5h9.592L8 10.481 3.204 5z"/>
            </svg>
          </span>
        </a>
        <div class="collapse ms-3" id="parametrosSubmenu">
          <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link" href="/mp/">Produtos / MP</a></li>
            <li class="nav-item"><a class="nav-link" href="/impostos/">Impostos</a></li>
            <li class="nav-item"><a class="nav-link" href="/mao_de_obra/">M√£o de Obra</a></li>
          </ul>
        </div>
      </li>
      <li><a href="/" class="nav-link">Dashboard</a></li>
      <li><a href="/orcamento/" class="nav-link active">Or√ßamentos</a></li>
      <li><a href="/about/" class="nav-link">Sobre</a></li>
      <li><a href="/admin/" class="nav-link">Administra√ß√£o</a></li>
    </ul>
  </nav>
  <div class="container-fluid p-4">
    {% if orcamento.status == 'Enviado' %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      Or√ßamento enviado com sucesso!
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
    <h1 class="mb-4">Or√ßamento #{{ orcamento.numero_orcamento }}</h1>
    <div class="mb-3"><strong>Cliente:</strong> {{ orcamento.cliente }}</div>
    <div class="mb-3"><strong>Contato:</strong> {{ orcamento.contato }}</div>
    <div class="mb-3"><strong>Telefone:</strong> {{ orcamento.telefone }}</div>
    <div class="mb-3"><strong>Email:</strong> {{ orcamento.email }}</div>
    <div class="mb-3"><strong>UF:</strong> {{ orcamento.uf }}</div>
    <div class="mb-3"><strong>Status:</strong> <span class="badge bg-warning">{{ orcamento.status }}</span></div>

    <div class="row mb-3">
      <div class="col-md-4 d-flex gap-2">
        <div class="card shadow-sm" style="min-width: 170px; max-width: 180px;">
          <div class="card-body py-2 px-3">
            <div class="card-title mb-1" style="font-size: 1rem;">Total Or√ßamento</div>
            <div class="card-text fw-bold" style="font-size: 1.2rem;">R$ {{ total_liquido|floatformat:2 }}</div>
          </div>
        </div>
        <div class="card shadow-sm" style="min-width: 170px; max-width: 180px;">
          <div class="card-body py-2 px-3">
            <div class="card-title mb-1" style="font-size: 1rem;">Total Descontos</div>
            <div class="card-text fw-bold text-danger" style="font-size: 1.2rem;">R$ {{ total_desconto|floatformat:2 }}</div>
          </div>
        </div>
      </div>
      <div class="col-md-8 d-flex justify-content-end align-items-start">
        <a href="/orcamento_form/" class="btn btn-primary me-2">Editar Or√ßamento</a>
        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#addProdutoModal">Adicionar Produto</button>
        <button class="btn btn-warning me-2" onclick="openProdutoParametrizadoModal()">
          <i class="fas fa-calculator"></i> Produto Parametrizado
        </button>
        <form method="post" style="display:inline;">
          {% csrf_token %}
          <button type="submit" name="status_action" value="enviar" class="btn btn-primary">Enviar Or√ßamento</button>
        </form>
      </div>
    </div>

    <!-- Modal Adicionar Produto -->
    <div class="modal fade" id="addProdutoModal" tabindex="-1" aria-labelledby="addProdutoModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form method="post" action="">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title" id="addProdutoModalLabel">Adicionar Produto ao Or√ßamento</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="produto_id" class="form-label">Produto</label>
                <select class="form-select" id="produto_id" name="produto_id" required>
                  {% for produto in produtos %}
                  <option value="{{ produto.id }}">{{ produto.descricao }} ({{ produto.referencia }})</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label for="quantidade" class="form-label">Quantidade</label>
                <input type="number" class="form-control" id="quantidade" name="quantidade" min="1" value="1" required>
              </div>
              <div class="mb-3">
                <label for="desconto" class="form-label">Desconto (%)</label>
                <input type="number" class="form-control" id="desconto" name="desconto" min="0" max="100" value="0">
              </div>
              <div class="mb-3">
                <label for="imposto" class="form-label">Imposto (%)</label>
                <input type="number" class="form-control" id="imposto" name="imposto" min="0" max="100" value="0">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-success">Adicionar</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <table class="table table-bordered" id="tabelaOrcamento">
      <thead>
        <tr>
          <th>Descri√ß√£o</th>
          <th>Quantidade</th>
          <th>Valor Unit√°rio</th>
          <th>Desconto (%)</th>
          <th>Imposto (%)</th>
          <th>Valor Total</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="itensOrcamento">
        {% for item in itens %}
        <tr>
          <td>{{ item.descricao }}</td>
          <td>{{ item.quantidade }}</td>
          <td>R$ {{ item.valor_unitario|floatformat:2 }}</td>
          <td>{{ item.desconto_item|floatformat:2 }}</td>
          <td>{{ item.imposto_item|floatformat:2 }}</td>
          <td>R$ {{ item.valor_total|floatformat:2 }}</td>
          <td>
            {% if orcamento.status == 'Enviado' %}
              <form method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit" name="status_action" value="revisar" class="btn btn-sm btn-warning">Revisar</button>
              </form>
            {% else %}
              <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editItemModal" 
                data-id="{{ item.id }}" 
                data-descricao="{{ item.descricao }}" 
                data-quantidade="{{ item.quantidade }}" 
                data-valor_unitario="{{ item.valor_unitario }}" 
                data-desconto="{{ item.desconto_item }}" 
                data-imposto="{{ item.imposto_item }}">
                Editar
              </button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Total do Or√ßamento -->
    <div class="row mt-3">
      <div class="col-md-8"></div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Total do Or√ßamento</h5>
            <h3 class="text-success" id="totalOrcamento">R$ 0,00</h3>
            <small class="text-muted">Valores calculados dinamicamente</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Editar Item -->
    <div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form method="post">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title" id="editItemModalLabel">Editar Item do Or√ßamento</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" name="edit_item_id" id="edit_item_id">
              <div class="mb-3">
                <label for="edit_descricao" class="form-label">Descri√ß√£o</label>
                <input type="text" class="form-control" id="edit_descricao" name="descricao" readonly>
              </div>
              <div class="mb-3">
                <label for="edit_quantidade" class="form-label">Quantidade</label>
                <input type="number" class="form-control" id="edit_quantidade" name="quantidade" step="any" required>
              </div>
              <div class="mb-3">
                <label for="edit_valor_unitario" class="form-label">Valor Unit√°rio</label>
                <input type="number" class="form-control" id="edit_valor_unitario" name="valor_unitario" step="any" required>
              </div>
              <div class="mb-3">
                <label for="edit_desconto" class="form-label">Desconto (%)</label>
                <input type="number" class="form-control" id="edit_desconto" name="desconto" step="any" min="0" max="100">
              </div>
              <div class="mb-3">
                <label for="edit_imposto" class="form-label">Imposto (%)</label>
                <input type="number" class="form-control" id="edit_imposto" name="imposto" step="any" min="0" max="100">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              {% if orcamento.status == 'Enviado' %}
                <button type="button" class="btn btn-primary" disabled>Salvar Altera√ß√µes</button>
              {% else %}
                <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
              {% endif %}
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
    var editItemModal = document.getElementById('editItemModal');
    editItemModal.addEventListener('show.bs.modal', function (event) {
      var button = event.relatedTarget;
      document.getElementById('edit_item_id').value = button.getAttribute('data-id');
      document.getElementById('edit_descricao').value = button.getAttribute('data-descricao');
      document.getElementById('edit_quantidade').value = button.getAttribute('data-quantidade');
      document.getElementById('edit_valor_unitario').value = button.getAttribute('data-valor_unitario');
      document.getElementById('edit_desconto').value = button.getAttribute('data-desconto');
      document.getElementById('edit_imposto').value = button.getAttribute('data-imposto');
    });
    </script>
  </div>
</div>

<!-- Modal para Produto Parametrizado -->
<div class="modal fade" id="produtoParametrizadoModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Criar Produto Parametrizado</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- Sele√ß√£o de Template -->
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">1. Selecione o Tipo</h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <select class="form-select" id="templateSelect" onchange="carregarTemplate()">
                    <option value="">Escolha um template...</option>
                  </select>
                </div>
                <div id="templateDescription" class="text-muted small"></div>
              </div>
            </div>
          </div>
          
          <!-- Par√¢metros -->
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">2. Par√¢metros</h6>
              </div>
              <div class="card-body" id="parametrosContainer">
                <p class="text-muted">Selecione um template primeiro</p>
              </div>
            </div>
          </div>
          
          <!-- Resultado -->
          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">3. Resultado</h6>
              </div>
              <div class="card-body" id="resultadoContainer">
                <p class="text-muted">Configure os par√¢metros para ver o resultado</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Componentes calculados -->
        <div class="row mt-3">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">Componentes Calculados</h6>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead>
                      <tr>
                        <th>Material/Servi√ßo</th>
                        <th>Descri√ß√£o do Produto</th>
                        <th>Fator %</th>
                        <th>Quantidade</th>
                        <th>Custo Unit√°rio</th>
                        <th>Custo Total</th>
                        <th>A√ß√£o</th>
                      </tr>
                    </thead>
                    <tbody id="componentesCalculadosTable">
                      <tr>
                        <td colspan="7" class="text-center text-muted">Nenhum c√°lculo realizado</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" onclick="salvarProdutoParametrizadoNaBase()" disabled id="salvarProdutoBtn">
          <i class="fas fa-save"></i> Salvar na Base
        </button>
        <button type="button" class="btn btn-primary" onclick="adicionarProdutoParametrizadoAoOrcamento()" disabled id="adicionarProdutoBtn">
          <i class="fas fa-plus"></i> Adicionar ao Or√ßamento
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
// Vari√°veis globais para produto parametrizado
var produtoParametrizadoModal = null;
var templateAtual = null;
var ultimoCalculo = null;

// Fun√ß√£o global SIMPLIFICADA para abrir modal - DEFINIDA IMEDIATAMENTE
function openProdutoParametrizadoModal() {
    console.log('üöÄ Tentando abrir modal...');    // Verificar se o modal existe
    const modalElement = document.getElementById('produtoParametrizadoModal');
    if (!modalElement) {
        console.error('‚ùå Modal n√£o encontrado!');
        alert('Erro: Modal n√£o encontrado na p√°gina');
        return;
    }
    
    // Inicializar modal se necess√°rio
    if (!produtoParametrizadoModal) {
        produtoParametrizadoModal = new bootstrap.Modal(modalElement);
        console.log('‚úÖ Modal inicializado');
    }
    
    // Limpar estado
    templateAtual = null;
    ultimoCalculo = null;
    
    // Limpar formul√°rio
    const templateSelect = document.getElementById('templateSelect');
    if (templateSelect) {
        templateSelect.value = '';
    }
    
    // Carregar templates
    carregarTemplates();
    
    // Mostrar modal
    produtoParametrizadoModal.show();
    console.log('‚úÖ Modal aberto com sucesso');
}

// Disponibilizar globalmente
window.openProdutoParametrizadoModal = openProdutoParametrizadoModal;

// Teste de disponibilidade da fun√ß√£o
console.log('üîß Fun√ß√£o openProdutoParametrizadoModal dispon√≠vel:', typeof window.openProdutoParametrizadoModal);

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM carregado, inicializando modal...');
    const modalElement = document.getElementById('produtoParametrizadoModal');
    if (modalElement) {
        produtoParametrizadoModal = new bootstrap.Modal(modalElement);
        console.log('Modal inicializado com sucesso');
    } else {
        console.error('Elemento modal n√£o encontrado no DOM');
    }
    
    // Inicializar total do or√ßamento - ser√° carregado do backend
    // atualizarTotalOrcamento();
    console.log('Total do or√ßamento ser√° carregado do backend');
});

// APIs
const apiTemplates = '/api/templates/';
const apiCalcular = '/calcular-produto/';

function carregarTemplates() {
    console.log('Carregando templates...');
    fetch('/api/templates/')
        .then(res => {
            console.log('Resposta da API:', res.status);
            return res.json();
        })
        .then(templates => {
            console.log('Templates recebidos:', templates.length);
            const select = document.getElementById('templateSelect');
            if (!select) {
                console.error('Elemento templateSelect n√£o encontrado!');
                return;
            }
            
            select.innerHTML = '<option value="">Escolha um template...</option>';
            
            // Adicionar templates customizados do sistema FIBERMEYER
            const templateOptions = [
                { value: 'perfil_customizado', text: 'Novo Perfil', description: 'Criar novo perfil personalizado' },
                { value: 'grades_customizado', text: 'Grade Montada', description: 'Calcular estrutura de grade com perfis' },
                { value: 'tampa_montada_customizado', text: 'Tampa Montada', description: 'Calcular tampa montada com componentes espec√≠ficos' }
            ];
            
            templateOptions.forEach(template => {
                const option = document.createElement('option');
                option.value = template.value;
                option.textContent = template.text;
                option.setAttribute('data-description', template.description);
                select.appendChild(option);
            });
            
            // Adicionar templates da API (se houver)
            templates.forEach(template => {
                const option = document.createElement('option');
                option.value = `api_${template.id}`;
                const nome = template.produto_base && template.produto_base.descricao 
                    ? template.produto_base.descricao 
                    : `Template ${template.id}`;
                option.textContent = `API: ${nome}`;
                select.appendChild(option);
            });
            
            console.log('Templates carregados no select');
        })
        .catch(error => {
            console.error('Erro ao carregar templates:', error);
            alert('Erro ao carregar templates de produtos.');
        });
}

function carregarTemplate() {
    const templateId = document.getElementById('templateSelect').value;
    console.log('carregarTemplate chamada com templateId:', templateId);
    
    if (!templateId) {
        document.getElementById('templateDescription').innerHTML = '';
        document.getElementById('parametrosContainer').innerHTML = '<p class="text-muted">Selecione um template primeiro</p>';
        document.getElementById('resultadoContainer').innerHTML = '<p class="text-muted">Configure os par√¢metros para ver o resultado</p>';
        return;
    }
    
    // Templates customizados do sistema FIBERMEYER
    const templatesCustomizados = {
        'perfil_customizado': () => carregarInterfaceNovoPerfilOrcamento(),
        'grades_customizado': () => carregarInterfaceGradesOrcamento(),
        'tampa_montada_customizado': () => carregarInterfaceTampaMontadaOrcamento()
    };
    
    if (templatesCustomizados[templateId]) {
        console.log(`Carregando template customizado: ${templateId}`);
        console.log('Fun√ß√£o encontrada:', templatesCustomizados[templateId]);
        templatesCustomizados[templateId]();
        console.log('Fun√ß√£o executada com sucesso');
        return;
    }
    
    // Templates da API (come√ßam com "api_")
    if (templateId.startsWith('api_')) {
        const realTemplateId = templateId.replace('api_', '');
        fetch(`/api/templates/${realTemplateId}/`)
            .then(res => res.json())
            .then(template => {
                templateAtual = template;
                
                // Mostrar descri√ß√£o
                const nome = template.produto_base && template.produto_base.descricao 
                    ? template.produto_base.descricao 
                    : `Template ${template.id}`;
                const categoria = template.produto_base && template.produto_base.categoria 
                    ? template.produto_base.categoria 
                    : 'N/A';
                
                document.getElementById('templateDescription').innerHTML = `
                    <strong>${nome}</strong><br>
                    Template para cria√ß√£o de produtos parametrizados<br>
                    <small class="text-muted">Categoria: ${categoria}</small>
                `;
                
                // Criar campos de par√¢metros usando a nova estrutura
                criarCamposParametrosNovo(template);
            })
            .catch(error => {
                console.error('Erro ao carregar template:', error);
                alert('Erro ao carregar detalhes do template.');
            });
        return;
    }
    
    console.warn(`Template n√£o reconhecido: ${templateId}`);
}

function criarCamposParametrosNovo(template) {
    const container = document.getElementById('parametrosContainer');
    container.innerHTML = '';
    
    if (!template.parametros_obrigatorios && !template.parametros_opcionais) {
        container.innerHTML = '<p class="text-muted">Este template n√£o possui par√¢metros configurados</p>';
        return;
    }
    
    // Par√¢metros obrigat√≥rios (pode ser lista ou dicion√°rio)
    const temObrigatorios = template.parametros_obrigatorios && 
        ((Array.isArray(template.parametros_obrigatorios) && template.parametros_obrigatorios.length > 0) ||
         (typeof template.parametros_obrigatorios === 'object' && Object.keys(template.parametros_obrigatorios).length > 0));
    
    const temOpcionais = template.parametros_opcionais && Object.keys(template.parametros_opcionais).length > 0;
    
    if (temObrigatorios) {
        const obrigatoriosDiv = document.createElement('div');
        obrigatoriosDiv.innerHTML = '<h6 class="text-danger">Par√¢metros Obrigat√≥rios:</h6>';
        
        if (Array.isArray(template.parametros_obrigatorios)) {
            // Se for array, criar campos b√°sicos
            template.parametros_obrigatorios.forEach(param => {
                const div = document.createElement('div');
                div.className = 'mb-3';
                
                let label = param.charAt(0).toUpperCase() + param.slice(1);
                let placeholder = '';
                let step = '0.001';
                
                // Personalizar campos baseado no par√¢metro
                if (param === 'peso_roving') {
                    label = 'Peso Roving 4400 (kg)';
                    placeholder = 'Ex: 0.5';
                } else if (param === 'peso_veu') {
                    label = 'Peso V√©u (kg)';
                    placeholder = 'Ex: 0.2';
                } else if (param === 'peso_manta') {
                    label = 'Peso Manta 300 (kg)';
                    placeholder = 'Ex: 0.3';
                }
                
                div.innerHTML = `
                    <label for="param_${param}" class="form-label">${label}:</label>
                    <input type="number" class="form-control param-input" id="param_${param}" name="${param}" 
                           value="0" step="${step}" min="0" placeholder="${placeholder}" oninput="verificarParametrosOrcamento()">
                    <div class="form-text">Peso em quilogramas do material</div>
                `;
                obrigatoriosDiv.appendChild(div);
            });
        } else {
            // Se for objeto, usar chaves e valores
            Object.entries(template.parametros_obrigatorios).forEach(([param, defaultValue]) => {
                const div = document.createElement('div');
                div.className = 'mb-3';
                div.innerHTML = `
                    <label for="param_${param}" class="form-label">${param.charAt(0).toUpperCase() + param.slice(1)}:</label>
                    <input type="number" class="form-control param-input" id="param_${param}" name="${param}" 
                           value="${defaultValue}" step="0.001" oninput="verificarParametrosOrcamento()">
                `;
                obrigatoriosDiv.appendChild(div);
            });
        }
        
        container.appendChild(obrigatoriosDiv);
    }
    
    // Par√¢metros opcionais
    if (temOpcionais) {
        const opcionaisDiv = document.createElement('div');
        opcionaisDiv.innerHTML = '<h6 class="text-info mt-3">Par√¢metros Opcionais:</h6>';
        
        Object.entries(template.parametros_opcionais).forEach(([param, defaultValue]) => {
            const div = document.createElement('div');
            div.className = 'mb-3';
            
            let inputHTML = '';
            if (param === 'tipo_resina') {
                // Criar dropdown para sele√ß√£o de resina baseado nos IDs reais do template restaurado
                inputHTML = `
                    <label for="param_${param}" class="form-label">Tipo de Resina:</label>
                    <select class="form-control param-input" id="param_${param}" name="${param}" oninput="verificarParametrosOrcamento()">
                        <option value="poliester" ${defaultValue === 'poliester' ? 'selected' : ''}>Resina Poli√©ster</option>
                        <option value="isoftalica" ${defaultValue === 'isoftalica' ? 'selected' : ''}>Resina Isoft√°lica</option>
                        <option value="ester_vinilica" ${defaultValue === 'ester_vinilica' ? 'selected' : ''}>Resina √âster Vin√≠lica</option>
                    </select>
                `;
            } else if (param === 'velocidade_m_h') {
                // Campo espec√≠fico para velocidade
                inputHTML = `
                    <label for="param_${param}" class="form-label">Velocidade (m/h):</label>
                    <input type="number" class="form-control param-input" id="param_${param}" name="${param}" 
                           value="${defaultValue}" step="0.1" min="0.1" oninput="verificarParametrosOrcamento()">
                    <div class="form-text">Velocidade de produ√ß√£o em metros por hora</div>
                `;
            } else if (param === 'fator_resina') {
                inputHTML = `
                    <label for="param_${param}" class="form-label">Fator de Resina:</label>
                    <input type="number" class="form-control param-input" id="param_${param}" name="${param}" 
                           value="${defaultValue}" step="0.1" min="0.1" max="1.0" oninput="verificarParametrosOrcamento()">
                    <div class="form-text">Propor√ß√£o de resina em rela√ß√£o ao peso dos materiais (0.4 = 40%)</div>
                `;
            } else if (param === 'num_operadores') {
                inputHTML = `
                    <label for="param_${param}" class="form-label">N√∫mero de Operadores:</label>
                    <input type="number" class="form-control param-input" id="param_${param}" name="${param}" 
                           value="${defaultValue}" step="1" min="1" max="5" oninput="verificarParametrosOrcamento()">
                    <div class="form-text">Quantidade de operadores necess√°rios</div>
                `;
            } else if (param === 'tempo_cura_h') {
                inputHTML = `
                    <label for="param_${param}" class="form-label">Tempo de Cura (horas):</label>
                    <input type="number" class="form-control param-input" id="param_${param}" name="${param}" 
                           value="${defaultValue}" step="0.5" min="0.5" max="24" oninput="verificarParametrosOrcamento()">
                    <div class="form-text">Tempo de cura do produto em horas</div>
                `;
            } else if (param === 'tolerancia_peso') {
                inputHTML = `
                    <label for="param_${param}" class="form-label">Toler√¢ncia de Peso:</label>
                    <input type="number" class="form-control param-input" id="param_${param}" name="${param}" 
                           value="${defaultValue}" step="0.01" min="0.01" max="0.2" oninput="verificarParametrosOrcamento()">
                    <div class="form-text">Toler√¢ncia permitida no peso (0.05 = 5%)</div>
                `;
            } else if (param === 'adicionar_aditivos') {
                inputHTML = `
                    <label for="param_${param}" class="form-label">Adicionar Aditivos:</label>
                    <select class="form-control param-input" id="param_${param}" name="${param}" oninput="verificarParametrosOrcamento()">
                        <option value="true" ${defaultValue === true ? 'selected' : ''}>Sim</option>
                        <option value="false" ${defaultValue === false ? 'selected' : ''}>N√£o</option>
                    </select>
                    <div class="form-text">Incluir aditivos qu√≠micos no c√°lculo</div>
                `;
            } else if (param === 'acabamento_superficie') {
                inputHTML = `
                    <label for="param_${param}" class="form-label">Acabamento da Superf√≠cie:</label>
                    <select class="form-control param-input" id="param_${param}" name="${param}" oninput="verificarParametrosOrcamento()">
                        <option value="padrao" ${defaultValue === 'padrao' ? 'selected' : ''}>Padr√£o</option>
                        <option value="liso" ${defaultValue === 'liso' ? 'selected' : ''}>Liso</option>
                        <option value="rugoso" ${defaultValue === 'rugoso' ? 'selected' : ''}>Rugoso</option>
                        <option value="texturizado" ${defaultValue === 'texturizado' ? 'selected' : ''}>Texturizado</option>
                    </select>
                    <div class="form-text">Tipo de acabamento final do produto</div>
                `;
            } else {
                // Campo normal para outros par√¢metros
                inputHTML = `
                    <label for="param_${param}" class="form-label">${param.charAt(0).toUpperCase() + param.slice(1)}:</label>
                    <input type="text" class="form-control param-input" id="param_${param}" name="${param}" value="${defaultValue}" oninput="verificarParametrosOrcamento()">
                `;
            }
            
            div.innerHTML = inputHTML;
            opcionaisDiv.appendChild(div);
        });
        
        container.appendChild(opcionaisDiv);
    }
    
    // Adicionar bot√£o de calcular
    const calcularDiv = document.createElement('div');
    calcularDiv.className = 'mt-3 text-center';
    calcularDiv.innerHTML = `
        <button type="button" class="btn btn-primary" onclick="calcularProdutoParametrizadoOrcamento()" id="btnCalcular" disabled>
            <i class="fas fa-calculator"></i> Calcular Produto
        </button>
    `;
    container.appendChild(calcularDiv);
    
    // Verificar se deve habilitar o bot√£o
    verificarParametrosOrcamento();
}

function carregarProdutosParaParametro(nomeParametro) {
    const select = document.getElementById(`param_${nomeParametro}`);
    if (!select) return;
    
    fetch('/api/produtos/')
        .then(res => res.json())
        .then(produtos => {
            // Filtrar apenas produtos simples
            const produtosFiltrados = produtos.filter(produto => 
                !produto.is_composto && 
                (produto.unidade === 'M' || produto.unidade === 'KG' || produto.unidade === 'UN')
            );
            
            select.innerHTML = '<option value="">Selecione um produto...</option>';
            
            produtosFiltrados.forEach(produto => {
                const option = document.createElement('option');
                option.value = produto.id;
                option.textContent = `${produto.descricao} - R$ ${(produto.custo_centavos / 100).toFixed(2)}/${produto.unidade}`;
                select.appendChild(option);
            });
        });
}

function calcularProduto() {
    if (!templateAtual) return;
    
    // Coletar valores dos par√¢metros
    const parametros = {};
    let todosPreenchidos = true;
    
    templateAtual.parametros.forEach(param => {
        const input = document.getElementById(`param_${param.nome}`);
        if (input) {
            const valor = input.value;
            if (param.obrigatorio && !valor) {
                todosPreenchidos = false;
            }
            parametros[param.nome] = valor;
        }
    });
    
    if (!todosPreenchidos) {
        document.getElementById('resultadoContainer').innerHTML = '<p class="text-warning">Preencha todos os par√¢metros obrigat√≥rios</p>';
        return;
    }
    
    // Fazer chamada para calcular
    fetch(apiCalcular, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            template_id: templateAtual.id,
            parametros: parametros
        })
    })
    .then(res => res.json())
    .then(resultado => {
        if (resultado.erro) {
            document.getElementById('resultadoContainer').innerHTML = `<p class="text-danger">Erro: ${resultado.erro}</p>`;
            return;
        }
        
        ultimoCalculo = resultado;
        exibirResultadoCalculo(resultado);
        
        // Habilitar bot√µes
        document.getElementById('adicionarProdutoBtn').disabled = false;
        document.getElementById('salvarProdutoBtn').disabled = false;
    })
    .catch(error => {
        console.error('Erro no c√°lculo:', error);
        document.getElementById('resultadoContainer').innerHTML = '<p class="text-danger">Erro na comunica√ß√£o com o servidor</p>';
    });
}

function exibirResultadoCalculo(resultado) {
    // Mostrar resumo no painel de resultado
    document.getElementById('resultadoContainer').innerHTML = `
        <div class="alert alert-success">
            <h6><i class="fas fa-check-circle"></i> C√°lculo realizado!</h6>
            <p class="mb-1"><strong>Custo Total:</strong> R$ ${resultado.custo_total.toFixed(2)}</p>
            ${resultado.area_m2 ? `<p class="mb-1"><strong>√Årea:</strong> ${resultado.area_m2.toFixed(2)} m¬≤</p>` : ''}
            ${resultado.custo_por_m2 ? `<p class="mb-1"><strong>Custo por m¬≤:</strong> R$ ${resultado.custo_por_m2.toFixed(2)}</p>` : ''}
            <p class="mb-2"><small>${resultado.componentes.length} componente(s) calculado(s)</small></p>
        </div>
        
        <div class="mt-3">
            <label for="nomeProdutoParametrizado" class="form-label"><strong>Nome do Produto *</strong></label>
            <input type="text" class="form-control" id="nomeProdutoParametrizado" 
                   placeholder="Ex: Produto Personalizado 2000x1000mm" required>
            <div class="form-text">Digite um nome descritivo para este produto</div>
        </div>
    `;
    
    // Mostrar tabela de componentes na se√ß√£o correta
    const tbody = document.getElementById('componentesCalculadosTable');
    tbody.innerHTML = '';
    
    resultado.componentes.forEach(comp => {
        tbody.innerHTML += `
            <tr>
                <td>${comp.nome}</td>
                <td>${comp.produto}</td>
                <td>${comp.quantidade.toFixed(3)} ${comp.unidade || ''}</td>
                <td>R$ ${comp.custo_unitario.toFixed(2)}</td>
                <td>R$ ${comp.custo_total.toFixed(2)}</td>
            </tr>
        `;
    });
}

function adicionarProdutoParametrizadoAoOrcamento() {
    if (!ultimoCalculo) {
        alert('Realize o c√°lculo primeiro!');
        return;
    }
    
    // Verificar se nome foi preenchido - tentar diferentes IDs dependendo do template
    let nomePersonalizado = document.getElementById('nomeProdutoParametrizado');
    if (!nomePersonalizado) {
        nomePersonalizado = document.getElementById('perfil_nome'); // Para template Novo Perfil
    }
    
    if (!nomePersonalizado || !nomePersonalizado.value.trim()) {
        alert('Por favor, digite um nome para o produto!');
        return;
    }
    
    console.log('‚úÖ Nome do produto encontrado:', nomePersonalizado.value.trim());
    
    // Solicitar quantidade ao usu√°rio
    const quantidade = prompt('Digite a quantidade de metros lineares:', '1');
    if (!quantidade || isNaN(quantidade) || parseFloat(quantidade) <= 0) {
        alert('Quantidade inv√°lida!');
        return;
    }
    
    const qtd = parseFloat(quantidade);
    const nomeProduto = nomePersonalizado.value.trim();
    
    console.log('üîç DEBUG - Nome do produto a ser usado:', nomeProduto);
    console.log('üîç DEBUG - Input encontrado:', nomePersonalizado);
    console.log('üîç DEBUG - Valor do input:', nomePersonalizado.value);
    
    if (!nomeProduto) {
        alert('Nome do produto est√° vazio!');
        return;
    }
    
    // Calcular valores baseado no √∫ltimo c√°lculo
    let valorUnitario = 0;
    if (ultimoCalculo.custo_total) {
        // Converter centavos para reais se necess√°rio
        valorUnitario = ultimoCalculo.custo_total / 100; // custo_total est√° em centavos
    } else if (ultimoCalculo.componentes) {
        // Se precisar calcular pela soma dos componentes
        valorUnitario = ultimoCalculo.componentes.reduce((total, comp) => {
            const custo = comp.custo_total / 100; // Converter centavos para reais
            return total + custo;
        }, 0);
    }
    
    console.log('üîç DEBUG - Valor unit√°rio calculado:', valorUnitario);
    
    const valorTotal = qtd * valorUnitario;
    
    // Adicionar √† tabela de or√ßamento
    const tbody = document.getElementById('itensOrcamento');
    if (!tbody) {
        console.error('Tabela de or√ßamento n√£o encontrada');
        alert('Erro: Tabela de or√ßamento n√£o encontrada');
        return;
    }
    
    const novaLinha = tbody.insertRow();
    const itemId = Date.now(); // ID tempor√°rio √∫nico
    
    novaLinha.innerHTML = `
        <td>${nomeProduto}</td>
        <td>${qtd.toFixed(2)}</td>
        <td>R$ ${valorUnitario.toFixed(2)}</td>
        <td>0.00</td>
        <td>0.00</td>
        <td>R$ ${valorTotal.toFixed(2)}</td>
        <td>
            <button class="btn btn-sm btn-danger" onclick="removerItemOrcamento(this)" title="Remover">
                <i class="fas fa-trash"></i>
            </button>
            <button class="btn btn-sm btn-warning" onclick="editarItemOrcamento(this)" title="Editar">
                <i class="fas fa-edit"></i>
            </button>
        </td>
    `;
    
    // Adicionar dados do item para futuras refer√™ncias
    novaLinha.dataset.itemId = itemId;
    novaLinha.dataset.descricao = nomeProduto;
    novaLinha.dataset.valorUnitario = valorUnitario.toFixed(2);
    
    // Atualizar total do or√ßamento - ser√° feito no backend
    // atualizarTotalOrcamento();
    
    // Salvar no backend via POST
    salvarItemNoBackend(nomeProduto, qtd, valorUnitario, valorTotal);
    
    alert(`Produto "${nomeProduto}" adicionado ao or√ßamento!\nQuantidade: ${qtd} metros\nCusto unit√°rio: R$ ${valorUnitario.toFixed(2)}\nTotal: R$ ${valorTotal.toFixed(2)}`);
    
    // Remover foco do bot√£o antes de fechar o modal para evitar warning de acessibilidade
    const btnAdicionar = document.getElementById('adicionarProdutoBtn');
    if (btnAdicionar) {
        btnAdicionar.blur(); // Remove o foco
    }
    
    // Fechar modal
    setTimeout(() => {
        const modal = bootstrap.Modal.getInstance(document.getElementById('produtoParametrizadoModal'));
        if (modal) {
            modal.hide();
        }
    }, 50);
    
    console.log('‚úÖ Produto parametrizado adicionado ao or√ßamento:', {
        produto: nomeProduto,
        quantidade: qtd,
        valorUnitario: valorUnitario,
        valorTotal: valorTotal,
        componentesOriginais: ultimoCalculo.componentes?.length || 0
    });
}

function salvarItemNoBackend(descricao, quantidade, valorUnitario, valorTotal) {
    console.log('üíæ Salvando item no backend:', { descricao, quantidade, valorUnitario, valorTotal });
    console.log('üîç DEBUG - Descri√ß√£o recebida:', descricao);
    console.log('üîç DEBUG - Tipo da descri√ß√£o:', typeof descricao);
    console.log('üîç DEBUG - Descri√ß√£o √© vazia?', !descricao);
    
    // Preparar dados para envio como produto parametrizado
    const produtoParametrizadoData = {
        nome: descricao,
        preco_total: valorUnitario // O backend multiplica pela quantidade
    };
    
    console.log('üîç DEBUG - Dados do produto parametrizado:', produtoParametrizadoData);
    
    // Preparar dados para envio
    const formData = new FormData();
    formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
    formData.append('produto_parametrizado', JSON.stringify(produtoParametrizadoData));
    formData.append('quantidade', quantidade);
    formData.append('desconto', 0);
    formData.append('imposto', 0);
    
    // Enviar via POST para o mesmo endpoint que adiciona produtos normais
    fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log('üîç DEBUG - Status da resposta:', response.status);
        console.log('üîç DEBUG - Headers da resposta:', [...response.headers.entries()]);
        
        if (response.ok) {
            console.log('‚úÖ Item salvo no backend com sucesso');
            return response.text().then(text => {
                console.log('üîç DEBUG - Resposta do servidor:', text);
                alert('Item salvo com sucesso! Pressione OK para recarregar a p√°gina.');
                // Recarregar a p√°gina ap√≥s confirma√ß√£o
                window.location.reload();
            });
        } else {
            console.warn('‚ö†Ô∏è Erro ao salvar no backend:', response.status);
            return response.text().then(text => {
                console.log('‚ùå Resposta de erro:', text);
                alert('Erro ao salvar: ' + response.status + '\n' + text);
            });
        }
    })
    .catch(error => {
        console.error('‚ùå Erro na requisi√ß√£o:', error);
    });
}

function salvarProdutoParametrizadoNaBase() {
    if (!ultimoCalculo) {
        alert('Realize o c√°lculo primeiro!');
        return;
    }
    
    // Verificar se nome foi preenchido - tentar diferentes IDs dependendo do template
    let nomePersonalizado = document.getElementById('nomeProdutoParametrizado');
    if (!nomePersonalizado) {
        nomePersonalizado = document.getElementById('perfil_nome'); // Para template Novo Perfil
    }
    
    if (!nomePersonalizado || !nomePersonalizado.value.trim()) {
        alert('Por favor, digite um nome para o produto!');
        return;
    }
    
    console.log('‚úÖ Nome do produto para salvar encontrado:', nomePersonalizado.value.trim());
    
    // Coletar par√¢metros usados no c√°lculo
    const parametros = {};
    const allInputs = document.querySelectorAll('.param-input');
    allInputs.forEach(input => {
        parametros[input.name] = input.value;
    });
    
    // Criar refer√™ncia √∫nica
    const agora = new Date();
    const timestamp = agora.getTime();
    const referencia = `PARAM-${templateAtual.id}-${timestamp}`;
    
    // Preparar dados do produto para salvar na base como composto
    const produtoData = {
        descricao: nomePersonalizado.value.trim(),
        custo_centavos: ultimoCalculo.custo_total,
        peso_und: ultimoCalculo.peso_total?.toFixed(3) || '0.000',
        unidade: templateAtual.produto_base?.unidade || 'KG',
        referencia: referencia,
        tipo_produto: 'composto',  // Salvar como produto composto
        categoria: templateAtual.produto_base?.categoria || 'Parametrizado',
        subcategoria: 'Parametrizado'
    };
    
    console.log('Salvando produto parametrizado na base:', produtoData);
    
    // Salvar produto via API
    fetch('/api/produtos/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(produtoData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(produto => {
        console.log('Produto salvo:', produto);
        
        // Agora salvar todos os componentes calculados
        return salvarComponentesParametrizadosOrcamento(produto.id);
    })
    .then(produto => {
        console.log('Produto e componentes salvos com sucesso');
        alert(`Produto "${produto.descricao}" salvo na base como produto composto!\nID: ${produto.id}\nCusto: R$ ${(produto.custo_centavos / 100).toFixed(2)}\nComponentes: ${produto.num_componentes || 'N/A'}`);
        
        // Fechar modal
        produtoParametrizadoModal.hide();
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao salvar produto na base: ' + error.message);
    });
}

// Novas fun√ß√µes para o sistema baseado em MP
function verificarParametrosOrcamento() {
    if (!templateAtual) return;
    
    let todosPreenchidos = true;
    
    // Verificar par√¢metros obrigat√≥rios
    if (templateAtual.parametros_obrigatorios) {
        if (Array.isArray(templateAtual.parametros_obrigatorios)) {
            templateAtual.parametros_obrigatorios.forEach(param => {
                const input = document.getElementById(`param_${param}`);
                if (!input || !input.value || input.value.trim() === '') {
                    todosPreenchidos = false;
                }
            });
        } else {
            Object.keys(templateAtual.parametros_obrigatorios).forEach(param => {
                const input = document.getElementById(`param_${param}`);
                if (!input || !input.value || input.value.trim() === '') {
                    todosPreenchidos = false;
                }
            });
        }
    }
    
    const btnCalcular = document.getElementById('btnCalcular');
    if (btnCalcular) {
        btnCalcular.disabled = !todosPreenchidos;
    }
}

function calcularProdutoParametrizadoOrcamento() {
    if (!templateAtual) return;
    
    // Coletar par√¢metros usando a mesma l√≥gica que funciona no MP
    const parametros = {};
    const allInputs = document.querySelectorAll('.param-input');
    
    console.log('=== C√ÅLCULO PRODUTO PARAMETRIZADO OR√áAMENTO ===');
    console.log('Template ID:', templateAtual.id);
    console.log('Template:', templateAtual);
    console.log('Inputs encontrados:', allInputs.length);
    
    allInputs.forEach((input, index) => {
        console.log(`Input ${index + 1}: name="${input.name}", value="${input.value}"`);
        parametros[input.name] = input.value;
    });
    
    console.log('Par√¢metros coletados:', parametros);
    
    const requestBody = {
        template_id: templateAtual.id,
        parametros: parametros
    };
    
    console.log('Request body:', JSON.stringify(requestBody, null, 2));
    
    // Fazer chamada para API
    fetch('/api/calcular-produto-parametrizado/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(requestBody)
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('=== RESPOSTA DA API OR√áAMENTO ===');
        console.log('Data completa:', data);
        console.log('Success:', data.success);
        console.log('Componentes:', data.componentes);
        console.log('N√∫mero de componentes:', data.componentes ? data.componentes.length : 'undefined');
        
        if (data.success) {
            ultimoCalculo = data;
            mostrarResultadoCalculoOrcamento(data);
        } else {
            console.error('Erro no c√°lculo:', data.error);
            alert('Erro no c√°lculo: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erro na API:', error);
        alert('Erro ao calcular produto');
    });
}

function mostrarResultadoCalculoOrcamento(resultado) {
    const container = document.getElementById('resultadoContainer');
    
    // Preservar o nome j√° digitado pelo usu√°rio, se existir
    const nomeInputExistente = document.getElementById('nomeProdutoParametrizado');
    const nomeUsuario = nomeInputExistente ? nomeInputExistente.value.trim() : '';
    const nomeDisplay = nomeUsuario || resultado.nome_produto || 'Produto Calculado';
    
    const custoTotal = (resultado.custo_total / 100).toFixed(2);
    
    // Atualizar apenas o painel de resultado com resumo
    container.innerHTML = `
        <div class="alert alert-success">
            <h6><i class="fas fa-check-circle"></i> C√°lculo Realizado!</h6>
            <p><strong>Produto:</strong> ${nomeDisplay}</p>
            <p><strong>Custo Total:</strong> R$ ${custoTotal}</p>
            <p class="mb-2"><small>${resultado.componentes.length} componente(s) calculado(s)</small></p>
        </div>
        <div class="mt-3">
            <label for="nomeProdutoParametrizado" class="form-label"><strong>Nome do Produto *</strong></label>
            <input type="text" class="form-control" id="nomeProdutoParametrizado" 
                   value="${nomeDisplay}" placeholder="Ex: Produto Personalizado 2000x1000mm" required>
            <div class="form-text">Digite um nome descritivo para este produto</div>
        </div>
    `;
    
    // Atualizar a tabela de componentes calculados separadamente
    const tbody = document.getElementById('componentesCalculadosTable');
    tbody.innerHTML = '';
    
    if (!resultado.componentes || resultado.componentes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Nenhum componente calculado</td></tr>';
        return;
    }
    
    resultado.componentes.forEach((comp, index) => {
        const row = document.createElement('tr');
        const isComponenteResina = ['Resina PET', 'Mon√¥mero de estireno', 'Anti UV', 'Anti OX', 'BPO', 'TBPB', 'Desmoldante', 'Antichama', 'Carga mineral', 'Pigmento'].includes(comp.nome);
        
        let fatorCol = '', acaoCol = '';
        if (isComponenteResina && resultado.fatores_originais) {
            const fatorAtual = resultado.fatores_originais[comp.nome] || 0;
            fatorCol = `<input type="number" step="0.01" class="form-control form-control-sm fator-input" value="${fatorAtual.toFixed(2)}" data-component-index="${index}" style="width: 80px;" min="0" max="100">`;
            acaoCol = `<button class="btn btn-sm btn-success" onclick="recalcularComponenteOrcamento(${index})" title="Recalcular"><i class="fas fa-calculator"></i></button>`;
        } else {
            fatorCol = '<span class="text-muted">-</span>';
            acaoCol = '<span class="text-muted">-</span>';
        }
        
        row.innerHTML = `
            <td>${comp.nome}</td>
            <td>${comp.descricao_produto || comp.produto || 'N/A'}</td>
            <td>${fatorCol}</td>
            <td>${parseFloat(comp.quantidade).toFixed(3)}</td>
            <td>R$ ${(comp.custo_unitario / 100).toFixed(2)}</td>
            <td>R$ ${(comp.custo_total / 100).toFixed(2)}</td>
            <td>${acaoCol}</td>
        `;
        tbody.appendChild(row);
    });
    
    // Adicionar linha de total
    const custoTotalGeral = resultado.componentes.reduce((total, comp) => total + comp.custo_total, 0);
    const totalRow = document.createElement('tr');
    totalRow.innerHTML = `
        <td colspan="5"><strong>TOTAL GERAL</strong></td>
        <td><strong>R$ ${(custoTotalGeral/100).toFixed(2)}</strong></td>
        <td></td>
    `;
    totalRow.style.backgroundColor = '#f8f9fa';
    tbody.appendChild(totalRow);
    
    // Habilitar bot√µes de a√ß√£o
    document.getElementById('adicionarProdutoBtn').disabled = false;
    document.getElementById('salvarProdutoBtn').disabled = false;
}

async function salvarComponentesParametrizadosOrcamento(produtoId) {
    console.log('=== SALVANDO COMPONENTES PARAMETRIZADOS (OR√áAMENTO) ===');
    console.log('Produto ID:', produtoId);
    
    // Obter dados do √∫ltimo c√°lculo
    if (!ultimoCalculo || !ultimoCalculo.componentes) {
        throw new Error('Dados do c√°lculo n√£o encontrados');
    }
    
    const componentes = ultimoCalculo.componentes;
    console.log('Componentes a salvar:', componentes.length);
    
    // Mapeamento dos componentes para IDs na tabela MP_Produtos
    const componentesMapeamento = {
        'Roving 4400': 1237,
        'Manta 300': 1238,
        'V√©u': 1239,
        'Resina Poli√©ster': 1269,
        'Resina Isoft√°lica': 1268,
        'Resina √âster Vin√≠lica': 1270,
        'Mon√¥mero de estireno': 1266,
        'Anti UV': 1243,
        'Anti OX': 1244,
        'BPO': 1245,
        'TBPB': 1246,
        'Desmoldante': 1247,
        'Antichama': 1248,
        'Carga mineral': 1249,
        'Pigmento': 1250,
        // Mapeamento especial para m√£o de obra
        'M√£o de Obra - Pultrus√£o': null  // Ser√° definido dinamicamente
    };
    
    let componentesSalvos = 0;
    let produtoFinal = null;
    
    // Primeiro, limpar componentes existentes deste produto para evitar conflitos
    console.log('üßπ Limpando componentes existentes do produto (or√ßamento)...');
    try {
        const componentesExistentesResponse = await fetch(`/api/componentes/?produto_principal=${produtoId}`);
        const componentesExistentes = await componentesExistentesResponse.json();
        
        console.log(`   Encontrados ${componentesExistentes.length} componentes existentes`);
        
        for (const comp of componentesExistentes) {
            await fetch(`/api/componentes/${comp.id}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
        }
        
        console.log('‚úÖ Componentes existentes removidos (or√ßamento)');
    } catch (error) {
        console.warn('‚ö†Ô∏è Erro ao limpar componentes existentes (or√ßamento):', error);
    }
    
    // Primeiro, buscar todos os produtos para fazer mapeamento din√¢mico
    const produtosResponse = await fetch('/api/produtos/');
    const todosProdutos = await produtosResponse.json();
    
    // Verificar se existe produto para m√£o de obra, sen√£o criar
    let maoObraProductId = null;
    const maoObraProduto = todosProdutos.find(p => 
        p.descricao && p.descricao.toLowerCase().includes('m√£o de obra') && 
        p.descricao.toLowerCase().includes('pultrus√£o')
    );
    
    if (maoObraProduto) {
        maoObraProductId = maoObraProduto.id;
        console.log(`‚úÖ Produto m√£o de obra encontrado: ID ${maoObraProductId} - ${maoObraProduto.descricao}`);
    } else {
        // Criar produto para m√£o de obra se n√£o existir
        console.log('üîß Criando produto para m√£o de obra...');
        try {
            const maoObraData = {
                descricao: 'M√£o de Obra - Pultrus√£o',
                custo_centavos: 1, // Custo simb√≥lico, o valor real vem do c√°lculo
                peso_und: '0.000',
                unidade: 'H',
                referencia: 'MAO-OBRA-PULT',
                tipo_produto: 'simples',
                categoria: 'M√£o de Obra',
                subcategoria: 'Pultrus√£o'
            };
            
            const createResponse = await fetch('/api/produtos/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(maoObraData)
            });
            
            if (createResponse.ok) {
                const novoProdutoMaoObra = await createResponse.json();
                maoObraProductId = novoProdutoMaoObra.id;
                console.log(`‚úÖ Produto m√£o de obra criado: ID ${maoObraProductId}`);
                
                // Atualizar lista de produtos
                todosProdutos.push(novoProdutoMaoObra);
            } else {
                console.error('‚ùå Erro ao criar produto de m√£o de obra');
            }
        } catch (error) {
            console.error('‚ùå Erro ao criar produto de m√£o de obra:', error);
        }
    }
    
    // Atualizar mapeamento com ID da m√£o de obra
    if (maoObraProductId) {
        componentesMapeamento['M√£o de Obra - Pultrus√£o'] = maoObraProductId;
    }
    
    // Criar mapeamento por nome de produto
    const produtosPorNome = {};
    todosProdutos.forEach(produto => {
        // Mapeamento exato
        produtosPorNome[produto.descricao] = produto.id;
        
        // Mapeamento por palavras-chave
        if (produto.descricao.toLowerCase().includes('roving')) {
            produtosPorNome['Roving 4400'] = produto.id;
        }
        if (produto.descricao.toLowerCase().includes('manta')) {
            produtosPorNome['Manta 300'] = produto.id;
        }
        if (produto.descricao.toLowerCase().includes('v√©u') || produto.descricao.toLowerCase().includes('veu')) {
            produtosPorNome['V√©u'] = produto.id;
        }
        if (produto.descricao.toLowerCase().includes('resina') && produto.descricao.toLowerCase().includes('poli√©ster')) {
            produtosPorNome['Resina Poli√©ster'] = produto.id;
        }
        if (produto.descricao.toLowerCase().includes('resina') && produto.descricao.toLowerCase().includes('isoft√°lica')) {
            produtosPorNome['Resina Isoft√°lica'] = produto.id;
        }
        if (produto.descricao.toLowerCase().includes('resina') && produto.descricao.toLowerCase().includes('√©ster')) {
            produtosPorNome['Resina √âster Vin√≠lica'] = produto.id;
        }
        if (produto.descricao.toLowerCase().includes('mon√¥mero') || produto.descricao.toLowerCase().includes('estireno')) {
            produtosPorNome['Mon√¥mero de estireno'] = produto.id;
        }
        if (produto.descricao.toLowerCase().includes('anti') && produto.descricao.toLowerCase().includes('uv')) {
            produtosPorNome['Anti UV'] = produto.id;
        }
        if (produto.descricao.toLowerCase().includes('anti') && produto.descricao.toLowerCase().includes('ox')) {
            produtosPorNome['Anti OX'] = produto.id;
        }
        if (produto.descricao.toLowerCase().includes('bpo')) {
            produtosPorNome['BPO'] = produto.id;
        }
        if (produto.descricao.toLowerCase().includes('tbpb')) {
            produtosPorNome['TBPB'] = produto.id;
        }
        if (produto.descricao.toLowerCase().includes('desmoldante')) {
            produtosPorNome['Desmoldante'] = produto.id;
        }
        if (produto.descricao.toLowerCase().includes('antichama')) {
            produtosPorNome['Antichama'] = produto.id;
        }
        if (produto.descricao.toLowerCase().includes('carga') && produto.descricao.toLowerCase().includes('mineral')) {
            produtosPorNome['Carga mineral'] = produto.id;
        }
        if (produto.descricao.toLowerCase().includes('pigmento')) {
            produtosPorNome['Pigmento'] = produto.id;
        }
    });
    
    console.log('Mapeamento de produtos por nome (orcamento):', produtosPorNome);
    
    // Salvar cada componente individualmente
    for (const componente of componentes) {
        try {
            let produtoComponenteId = null;
            
            // Verificar se √© componente de m√£o de obra
            if (componente.nome === 'M√£o de Obra - Pultrus√£o') {
                produtoComponenteId = componentesMapeamento['M√£o de Obra - Pultrus√£o'];
                console.log(`üîß Processando m√£o de obra: ID ${produtoComponenteId}`);
                
                // CORRE√á√ÉO: Atualizar o custo do produto de m√£o de obra com o valor calculado
                if (produtoComponenteId && componente.custo_total > 0) {
                    console.log(`üîÑ Atualizando custo do produto m√£o de obra...`);
                    const updateData = {
                        custo_centavos: componente.custo_total
                    };
                    
                    try {
                        const updateResponse = await fetch(`/api/produtos/${produtoComponenteId}/`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify(updateData)
                        });
                        
                        if (updateResponse.ok) {
                            console.log(`‚úÖ Custo do produto m√£o de obra atualizado para ${componente.custo_total} centavos`);
                        } else {
                            console.warn(`‚ö†Ô∏è Erro ao atualizar custo do produto m√£o de obra`);
                        }
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è Erro ao atualizar produto m√£o de obra:`, error);
                    }
                }
            } else {
                // Encontrar ID do produto componente usando mapeamento din√¢mico
                produtoComponenteId = produtosPorNome[componente.nome];
                
                // Se n√£o encontrar, tentar mapeamento fixo
                if (!produtoComponenteId) {
                    produtoComponenteId = componentesMapeamento[componente.nome];
                }
            }
            
            // Se ainda n√£o encontrar, tentar busca aproximada ou pular
            if (!produtoComponenteId) {
                console.warn(`‚ùå Componente n√£o encontrado: ${componente.nome}`);
                console.log('Produtos dispon√≠veis:', Object.keys(produtosPorNome));
                
                // Para m√£o de obra, n√£o pular - mostrar erro espec√≠fico
                if (componente.nome === 'M√£o de Obra - Pultrus√£o') {
                    console.error('‚ùå ERRO CR√çTICO: N√£o foi poss√≠vel mapear m√£o de obra!');
                }
                continue;
            }
            
            const componenteData = {
                produto_principal: produtoId,
                produto_componente: produtoComponenteId,
                quantidade: Math.round(parseFloat(componente.quantidade) * 1000) / 1000, // Arredondar para 3 casas decimais
                observacao: componente.nome === 'M√£o de Obra - Pultrus√£o' 
                    ? `M√£o de obra parametrizada: ${componente.produto}` 
                    : `Componente parametrizado calculado automaticamente`
            };
            
            console.log(`üíæ Salvando componente: ${componente.nome} (ID: ${produtoComponenteId}) - Quantidade: ${componenteData.quantidade}`);
            
            const response = await fetch('/api/componentes/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(componenteData)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error(`‚ùå Erro ao salvar componente ${componente.nome}:`, response.status, errorText);
                continue;
            }
            
            const componenteSalvo = await response.json();
            console.log(`‚úÖ Componente salvo: ${componente.nome} ${componente.nome === 'M√£o de Obra - Pultrus√£o' ? '(M√ÉO DE OBRA)' : ''}`);
            componentesSalvos++;
            
        } catch (error) {
            console.error(`‚ùå Erro ao processar componente ${componente.nome}:`, error);
        }
    }
    
    console.log(`=== SALVAMENTO CONCLU√çDO ===`);
    console.log(`Componentes salvos: ${componentesSalvos}/${componentes.length}`);
    
    // Buscar o produto atualizado para retornar
    const produtoResponse = await fetch(`/api/produtos/${produtoId}/`);
    produtoFinal = await produtoResponse.json();
    produtoFinal.num_componentes = componentesSalvos;
    
    return produtoFinal;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function carregarInterfaceNovoPerfilOrcamento() {
    console.log('=== CARREGANDO INTERFACE NOVO PERFIL OR√áAMENTO ===');
    
    // Limpar estado anterior
    templateAtual = { id: 'perfil_customizado', tipo: 'perfil' };
    
    // Mostrar descri√ß√£o
    document.getElementById('templateDescription').innerHTML = `
        <strong>Novo Perfil</strong><br>
        Template para cria√ß√£o de perfis customizados<br>
        <small class="text-muted">Categoria: PRODUTO_FINAL</small>
    `;
    
    // Criar APENAS os 11 campos solicitados
    const parametrosContainer = document.getElementById('parametrosContainer');
    parametrosContainer.innerHTML = `
        <div class="mb-3">
            <label for="perfil_nome" class="form-label">Nome perfil *</label>
            <input type="text" class="form-control param-input" id="perfil_nome" name="nome_perfil" required>
        </div>
        
        <div class="mb-3">
            <label for="perfil_roving" class="form-label">Roving 4400 KG *</label>
            <input type="number" step="0.001" class="form-control param-input" id="perfil_roving" name="roving_4400_kg" required>
        </div>
        
        <div class="mb-3">
            <label for="perfil_manta" class="form-label">Manta 300 KG *</label>
            <input type="number" step="0.001" class="form-control param-input" id="perfil_manta" name="manta_300_kg" required>
        </div>
        
        <div class="mb-3">
            <label for="perfil_veu" class="form-label">V√©u KG *</label>
            <input type="number" step="0.001" class="form-control param-input" id="perfil_veu" name="veu_kg" required>
        </div>
        
        <div class="mb-3">
            <label for="perfil_peso_metro" class="form-label">Peso/m kg *</label>
            <input type="number" step="0.001" class="form-control param-input" id="perfil_peso_metro" name="peso_metro_kg" required>
        </div>
        
        <div class="mb-3">
            <label for="perfil_n_matrizes" class="form-label">N matrizes *</label>
            <input type="number" class="form-control param-input" id="perfil_n_matrizes" name="n_matrizes" required min="1">
        </div>
        
        <div class="mb-3">
            <label for="perfil_n_maquinas" class="form-label">N m√°quinas *</label>
            <input type="number" class="form-control param-input" id="perfil_n_maquinas" name="n_maquinas" required min="1">
        </div>
        
        <div class="mb-3">
            <label for="perfil_metros_h" class="form-label">Metro produzidos/h *</label>
            <input type="number" step="0.1" class="form-control param-input" id="perfil_metros_h" name="metros_produzidos_h" required>
        </div>
        
        <div class="mb-3">
            <label for="perfil_perda" class="form-label">% de perda *</label>
            <input type="number" step="0.1" class="form-control param-input" id="perfil_perda" name="percentual_perda" required min="0" max="100">
        </div>
        
        <div class="mb-3">
            <label for="perfil_tipo_resina" class="form-label">Tipo de Resina *</label>
            <select class="form-select param-input" id="perfil_tipo_resina" name="tipo_resina" required>
                <option value="">Carregando resinas...</option>
            </select>
        </div>
        
        <div class="mb-3">
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="perfil_pintura" name="tem_pintura" onchange="toggleAreaPinturaOrcamento()">
                <label for="perfil_pintura" class="form-check-label">Pintura?</label>
            </div>
        </div>
        
        <div class="mb-3" id="perfil_area_pintura_container" style="display: none;">
            <label for="perfil_area_pintura" class="form-label">√Årea pintura (m¬≤) *</label>
            <input type="number" step="0.01" class="form-control param-input" id="perfil_area_pintura" name="area_pintura_m2">
        </div>
        
        <div class="mt-3 text-center">
            <button type="button" class="btn btn-primary" onclick="calcularNovoPerfilOrcamento()">
                <i class="fas fa-calculator"></i> Calcular
            </button>
        </div>
    `;
    
    // Carregar tipos de resina dispon√≠veis
    carregarTiposResinaOrcamento();
    
    console.log('Interface Novo Perfil Or√ßamento carregada com 12 campos (incluindo tipo de resina)');
}

function carregarTiposResinaOrcamento() {
    console.log('=== CARREGANDO TIPOS DE RESINA OR√áAMENTO ===');
    
    const selectResina = document.getElementById('perfil_tipo_resina');
    if (!selectResina) {
        console.warn('Select de resina n√£o encontrado no or√ßamento');
        return;
    }
    
    // Buscar tipos de resina via API
    fetch('/api/tipos-resina/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.resinas) {
                console.log(`‚úÖ ${data.resinas.length} tipos de resina carregados (or√ßamento)`);
                
                // Limpar op√ß√µes atuais
                selectResina.innerHTML = '<option value="">Selecione uma resina...</option>';
                
                // Adicionar op√ß√µes das resinas
                data.resinas.forEach(resina => {
                    const option = document.createElement('option');
                    option.value = resina.id;
                    option.textContent = `${resina.descricao} - R$ ${resina.custo_reais.toFixed(2)}`;
                    selectResina.appendChild(option);
                    
                    console.log(`   ‚Ä¢ ${resina.descricao}: R$ ${resina.custo_reais.toFixed(2)}`);
                });
                
                // Selecionar Resina Poli√©ster como padr√£o (ID 1269)
                selectResina.value = '1269';
                
            } else {
                throw new Error(data.error || 'Erro desconhecido');
            }
        })
        .catch(error => {
            console.error('‚ùå Erro ao carregar tipos de resina (or√ßamento):', error);
            
            // Fallback: adicionar op√ß√µes b√°sicas
            selectResina.innerHTML = `
                <option value="">Erro ao carregar resinas</option>
                <option value="1269">Resina Poli√©ster (padr√£o)</option>
                <option value="1268">Resina Isoft√°lica</option>
                <option value="1270">Resina √âster Vin√≠lica</option>
            `;
            selectResina.value = '1269';
        });
}

function carregarInterfaceGradesOrcamento() {
    console.log('=== CARREGANDO INTERFACE GRADES OR√áAMENTO ===');
    
    // Limpar estado anterior
    templateAtual = { id: 'grades_customizado', tipo: 'grades' };
    ultimoCalculo = null;
    
    // Definir valor do select
    document.getElementById('templateSelect').value = 'grades_customizado';
    
    // Mostrar descri√ß√£o
    document.getElementById('templateDescription').innerHTML = `
        <h6 class="text-primary">Grade Montada</h6>
        <small class="text-muted">Categoria: ESTRUTURAS</small>
        <p class="mt-2 text-info small">
            <strong>F√≥rmula:</strong> (((comprimento/eixo i)*v√£o/1000)* peso do perfil)
        </p>
    `;
    
    // Criar campos espec√≠ficos para grades
    const parametrosContainer = document.getElementById('parametrosContainer');
    parametrosContainer.innerHTML = `
        <div class="mb-3">
            <label for="grade_nome" class="form-label">Nome da Grade *</label>
            <input type="text" class="form-control param-input" id="grade_nome" name="nome_grade" required>
        </div>
        
        <div class="mb-3">
            <label for="grade_vao" class="form-label">V√£o (mm) *</label>
            <input type="number" step="0.1" class="form-control param-input" id="grade_vao" name="vao" required min="0">
            <div class="form-text">Dist√¢ncia entre apoios em mil√≠metros</div>
        </div>
        
        <div class="mb-3">
            <label for="grade_comprimento" class="form-label">Comprimento (mm) *</label>
            <input type="number" step="0.1" class="form-control param-input" id="grade_comprimento" name="comprimento" required min="0">
            <div class="form-text">Comprimento total da grade em mil√≠metros</div>
        </div>
        
        <div class="mb-3">
            <label for="grade_eixo_i" class="form-label">Eixo I (mm) *</label>
            <input type="number" step="0.1" class="form-control param-input" id="grade_eixo_i" name="eixo_i" required min="0">
            <div class="form-text">Espa√ßamento entre perfis em mil√≠metros</div>
        </div>
        
        <div class="mb-3">
            <label for="grade_perfil" class="form-label">Selecione o Perfil *</label>
            <select class="form-select param-input" id="grade_perfil" name="perfil_id" required>
                <option value="">Carregando perfis...</option>
            </select>
            <div class="form-text">Perfil que ser√° utilizado na estrutura</div>
        </div>
        
        <div class="mb-3">
            <label for="grade_perda" class="form-label">Perda (%)</label>
            <input type="number" step="0.1" class="form-control param-input" id="grade_perda" name="perda" value="10" min="0" max="100">
            <div class="form-text">Percentual de perda do material (padr√£o: 10%)</div>
        </div>
        
        <!-- Se√ß√£o de M√£o de Obra -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-tools"></i> M√£o de Obra</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="grade_tempo_proc" class="form-label">Tempo PROC (h)</label>
                        <input type="number" step="0.1" class="form-control param-input" id="grade_tempo_proc" name="tempo_proc" value="0.7" min="0">
                        <div class="form-text">Tempo de processamento em horas</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="grade_tempo_mtg" class="form-label">Tempo MTG (h)</label>
                        <input type="number" step="0.1" class="form-control param-input" id="grade_tempo_mtg" name="tempo_mtg" value="0.3" min="0">
                        <div class="form-text">Tempo de montagem em horas</div>
                    </div>
                </div>
                <div class="alert alert-info">
                    <small><i class="fas fa-info-circle"></i> M√£o de Obra: Processamento/Montagem - R$ 65,79/hora</small>
                </div>
            </div>
        </div>
        
        <div class="mt-3 text-center">
            <button type="button" class="btn btn-primary" onclick="calcularGradeOrcamento()" id="calcularGradeBtn">
                <i class="fas fa-calculator"></i> Calcular Grade
            </button>
        </div>
    `;
    
    // Carregar perfis dispon√≠veis
    carregarPerfisGradeOrcamento();
    
    console.log('Interface Grades Or√ßamento carregada com sucesso');
}

function carregarPerfisGradeOrcamento() {
    console.log('=== CARREGANDO PERFIS PARA GRADE OR√áAMENTO ===');
    
    const selectPerfil = document.getElementById('grade_perfil');
    if (!selectPerfil) {
        console.warn('Select de perfil n√£o encontrado');
        return;
    }
    
    // Buscar perfis I25, I32, I38 via API
    fetch('/api/produtos/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(produtos => {
            console.log(`‚úÖ ${produtos.length} produtos carregados, filtrando perfis...`);
            
            // Filtrar perfis I25, I32, I38 (excluir grades injetadas)
            const perfisGrade = produtos.filter(produto => {
                const desc = produto.descricao.toLowerCase();
                const incluiPerfil = (desc.includes('i25') || desc.includes('i32') || desc.includes('i38')) && desc.includes('mm');
                const excluirGradeInjetada = desc.includes('grade') && desc.includes('injetada');
                return incluiPerfil && !excluirGradeInjetada;
            });
            
            console.log(`üìä ${perfisGrade.length} perfis de grade encontrados`);
            
            // Limpar op√ß√µes atuais
            selectPerfil.innerHTML = '<option value="">Selecione um perfil...</option>';
            
            // Ordenar perfis por descri√ß√£o
            perfisGrade.sort((a, b) => a.descricao.localeCompare(b.descricao));
            
            // Adicionar op√ß√µes dos perfis
            perfisGrade.forEach(perfil => {
                const option = document.createElement('option');
                option.value = perfil.id;
                option.textContent = `${perfil.descricao} - ${perfil.peso_und}kg - R$ ${(perfil.custo_centavos/100).toFixed(2)}`;
                selectPerfil.appendChild(option);
                
                console.log(`   ‚Ä¢ ${perfil.descricao}: ${perfil.peso_und}kg - R$ ${(perfil.custo_centavos/100).toFixed(2)}`);
            });
            
            console.log('‚úÖ Perfis carregados no select');
        })
        .catch(error => {
            console.error('‚ùå Erro ao carregar perfis:', error);
            selectPerfil.innerHTML = '<option value="">Erro ao carregar perfis</option>';
        });
}

function calcularNovoPerfilOrcamento() {
    console.log('=== CALCULANDO NOVO PERFIL OR√áAMENTO ===');
    
    // Verificar se todos os campos obrigat√≥rios est√£o preenchidos
    const camposObrigatorios = [
        'perfil_nome', 'perfil_roving', 'perfil_manta', 'perfil_veu', 
        'perfil_peso_metro', 'perfil_n_matrizes', 'perfil_n_maquinas', 
        'perfil_metros_h', 'perfil_perda', 'perfil_tipo_resina'
    ];
    
    let todosCamposPreenchidos = true;
    const dados = {};
    
    camposObrigatorios.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (!elemento || !elemento.value.trim()) {
            todosCamposPreenchidos = false;
            console.warn(`Campo ${campo} n√£o preenchido`);
            return;
        }
        
        const valor = elemento.value.trim();
        if (campo === 'perfil_nome') {
            dados[elemento.name] = valor;
        } else {
            dados[elemento.name] = parseFloat(valor) || 0;
        }
    });
    
    // Verificar pintura
    const temPintura = document.getElementById('perfil_pintura').checked;
    dados.tem_pintura = temPintura;
    
    if (temPintura) {
        const areaPintura = document.getElementById('perfil_area_pintura').value;
        if (!areaPintura || parseFloat(areaPintura) <= 0) {
            alert('√Årea de pintura deve ser preenchida quando pintura est√° marcada!');
            return;
        }
        dados.area_pintura_m2 = parseFloat(areaPintura);
    } else {
        dados.area_pintura_m2 = 0;
    }
    
    if (!todosCamposPreenchidos) {
        alert('Preencha todos os campos obrigat√≥rios!');
        return;
    }
    
    console.log('Dados coletados:', dados);
    
    // Buscar pre√ßos da base de dados antes de calcular
    console.log('üîç Buscando pre√ßos da base de dados...');
    
    fetch('/api/produtos/')
        .then(response => response.json())
        .then(produtos => {
            console.log('‚úÖ Produtos carregados da base:', produtos.length);
            
            // Criar mapeamento de produtos por nome/descri√ß√£o
            const precosProdutos = {};
            
            produtos.forEach(produto => {
                const desc = produto.descricao.toLowerCase();
                const precoReais = produto.custo_centavos / 100;
                
                // Mapear produtos espec√≠ficos
                if (desc.includes('roving') && desc.includes('4400')) {
                    precosProdutos['roving'] = precoReais;
                } else if (desc.includes('manta') && desc.includes('300')) {
                    precosProdutos['manta'] = precoReais;
                } else if (desc.includes('v√©u') || desc.includes('veu')) {
                    precosProdutos['veu'] = precoReais;
                } else if (desc.includes('resina') && (desc.includes('pet') || desc.includes('poli√©ster'))) {
                    precosProdutos['resina'] = precoReais;
                } else if (desc.includes('mon√¥mero') || desc.includes('estireno')) {
                    precosProdutos['monomero'] = precoReais;
                } else if (desc.includes('anti') && desc.includes('uv')) {
                    precosProdutos['antiUV'] = precoReais;
                } else if (desc.includes('anti') && desc.includes('ox')) {
                    precosProdutos['antiOX'] = precoReais;
                } else if (desc.includes('bpo')) {
                    precosProdutos['bpo'] = precoReais;
                } else if (desc.includes('tbpb')) {
                    precosProdutos['tbpb'] = precoReais;
                } else if (desc.includes('desmoldante')) {
                    precosProdutos['desmoldante'] = precoReais;
                } else if (desc.includes('antichama')) {
                    precosProdutos['antichama'] = precoReais;
                } else if (desc.includes('carga') && desc.includes('mineral')) {
                    precosProdutos['cargaMineral'] = precoReais;
                } else if (desc.includes('pigmento')) {
                    precosProdutos['pigmento'] = precoReais;
                } else if (desc.includes('pintura')) {
                    precosProdutos['pintura'] = precoReais;
                }
            });
            
            console.log('üí∞ Pre√ßos mapeados:', precosProdutos);
            
            // Definir pre√ßos padr√£o caso n√£o encontre na base
            const precosDefault = {
                roving: 8.50,
                manta: 12.00,
                veu: 25.00,
                resina: 12.96,
                monomero: 8.00,
                antiUV: 45.00,
                antiOX: 35.00,
                bpo: 28.00,
                tbpb: 42.00,
                desmoldante: 22.00,
                antichama: 18.50,
                cargaMineral: 3.20,
                pigmento: 15.80,
                pintura: 15.00
            };
            
            // Usar pre√ßo da base ou padr√£o se n√£o encontrar
            const precos = {};
            Object.keys(precosDefault).forEach(key => {
                precos[key] = precosProdutos[key] || precosDefault[key];
                if (!precosProdutos[key]) {
                    console.warn(`‚ö†Ô∏è Pre√ßo n√£o encontrado na base para ${key}, usando padr√£o: R$ ${precosDefault[key]}`);
                }
            });
            
            // BUSCAR PRE√áO ESPEC√çFICO DA RESINA SELECIONADA
            const tipoResinaId = dados.tipo_resina;
            console.log(`üéØ Tipo de resina selecionado: ID ${tipoResinaId}`);
            
            const resinaSelecionada = produtos.find(p => p.id == tipoResinaId);
            if (resinaSelecionada) {
                precos.resina = resinaSelecionada.custo_centavos / 100;
                console.log(`‚úÖ Pre√ßo da resina selecionada (${resinaSelecionada.descricao}): R$ ${precos.resina.toFixed(2)}`);
            } else {
                console.warn(`‚ö†Ô∏è Resina ID ${tipoResinaId} n√£o encontrada, usando pre√ßo padr√£o: R$ ${precos.resina}`);
            }
            
            // C√ÅLCULO CORRETO DOS COMPONENTES DA RESINA
            // Peso da resina base = peso do metro - (roving + manta + v√©u)
            const pesoResinaBase = dados.peso_metro_kg - (dados.roving_4400_kg + dados.manta_300_kg + dados.veu_kg);
            
            console.log('C√°lculo da resina:');
            console.log(`Peso do metro: ${dados.peso_metro_kg} kg`);
            console.log(`Peso fibras (roving + manta + v√©u): ${dados.roving_4400_kg + dados.manta_300_kg + dados.veu_kg} kg`);
            console.log(`Peso resina base: ${pesoResinaBase} kg`);
            
            // Fatores de multiplica√ß√£o conforme especificado
            const fatores = {
                resina: 0.6897,           // 68.97%
                monomero: 0.0213,         // 2.13%
                antiUV: 0.0028,           // 0.28%
                antiOX: 0.0011,           // 0.11%
                bpo: 0.0071,              // 0.71%
                tbpb: 0.0043,             // 0.43%
                desmoldante: 0.0071,      // 0.71%
                antichama: 0.1777,        // 17.77%
                cargaMineral: 0.0711,     // 7.11%
                pigmento: 0.0178          // 1.78%
            };
            
            // Calcular componentes da resina usando pre√ßos da base
            const componentes = [
                {
                    nome: 'Roving 4400 KG',
                    produto: 'Roving 4400 tex',
                    quantidade: dados.roving_4400_kg,
                    custo_unitario: precos.roving * 100, // converter para centavos
                    custo_total: dados.roving_4400_kg * precos.roving * 100
                },
                {
                    nome: 'Manta 300 KG',
                    produto: 'Manta 300 g/m¬≤',
                    quantidade: dados.manta_300_kg,
                    custo_unitario: precos.manta * 100,
                    custo_total: dados.manta_300_kg * precos.manta * 100
                },
                {
                    nome: 'V√©u KG',
                    produto: 'V√©u de Superf√≠cie',
                    quantidade: dados.veu_kg,
                    custo_unitario: precos.veu * 100,
                    custo_total: dados.veu_kg * precos.veu * 100
                },
                {
                    nome: 'Resina PET',
                    produto: resinaSelecionada ? resinaSelecionada.descricao : 'Resina Poli√©ster',
                    quantidade: pesoResinaBase * fatores.resina,
                    custo_unitario: precos.resina * 100,
                    custo_total: (pesoResinaBase * fatores.resina) * precos.resina * 100
                },
                {
                    nome: 'Mon√¥mero de estireno',
                    produto: 'Estireno',
                    quantidade: pesoResinaBase * fatores.monomero,
                    custo_unitario: precos.monomero * 100,
                    custo_total: (pesoResinaBase * fatores.monomero) * precos.monomero * 100
                },
                {
                    nome: 'Anti UV',
                    produto: 'Aditivo Anti UV',
                    quantidade: pesoResinaBase * fatores.antiUV,
                    custo_unitario: precos.antiUV * 100,
                    custo_total: (pesoResinaBase * fatores.antiUV) * precos.antiUV * 100
                },
                {
                    nome: 'Anti OX',
                    produto: 'Aditivo Anti Oxidante',
                    quantidade: pesoResinaBase * fatores.antiOX,
                    custo_unitario: precos.antiOX * 100,
                    custo_total: (pesoResinaBase * fatores.antiOX) * precos.antiOX * 100
                },
                {
                    nome: 'BPO',
                    produto: 'Per√≥xido de Benzo√≠la',
                    quantidade: pesoResinaBase * fatores.bpo,
                    custo_unitario: precos.bpo * 100,
                    custo_total: (pesoResinaBase * fatores.bpo) * precos.bpo * 100
                },
                {
                    nome: 'TBPB',
                    produto: 'Terc-Butil Perbenzoato',
                    quantidade: pesoResinaBase * fatores.tbpb,
                    custo_unitario: precos.tbpb * 100,
                    custo_total: (pesoResinaBase * fatores.tbpb) * precos.tbpb * 100
                },
                {
                    nome: 'Desmoldante',
                    produto: 'Desmoldante Industrial',
                    quantidade: pesoResinaBase * fatores.desmoldante,
                    custo_unitario: precos.desmoldante * 100,
                    custo_total: (pesoResinaBase * fatores.desmoldante) * precos.desmoldante * 100
                },
                {
                    nome: 'Antichama',
                    produto: 'Aditivo Antichama',
                    quantidade: pesoResinaBase * fatores.antichama,
                    custo_unitario: precos.antichama * 100,
                    custo_total: (pesoResinaBase * fatores.antichama) * precos.antichama * 100
                },
                {
                    nome: 'Carga mineral',
                    produto: 'Carbonato de C√°lcio',
                    quantidade: pesoResinaBase * fatores.cargaMineral,
                    custo_unitario: precos.cargaMineral * 100,
                    custo_total: (pesoResinaBase * fatores.cargaMineral) * precos.cargaMineral * 100
                },
                {
                    nome: 'Pigmento',
                    produto: 'Pigmento Colorante',
                    quantidade: pesoResinaBase * fatores.pigmento,
                    custo_unitario: precos.pigmento * 100,
                    custo_total: (pesoResinaBase * fatores.pigmento) * precos.pigmento * 100
                }
            ];
            
            // ADICIONAR M√ÉO DE OBRA - NOVA F√ìRMULA
            // ((mo_pultrusao / 3) * n¬∞ de m√°quinas) / (VELOCIDADE M/H * N¬∞ MATRIZES * 24 * 21 * 0,5)
            if (dados.metros_produzidos_h > 0 && dados.n_matrizes > 0) {
                const mo_pultrusao = 9976258; // Valor da tabela main_maoobra ID=1 em centavos
                const velocidade = dados.metros_produzidos_h;
                const matrizes = dados.n_matrizes;
                const maquinas = dados.n_maquinas;
                
                // Aplicar nova f√≥rmula
                const numerador = (mo_pultrusao / 3) * maquinas;
                const denominador = velocidade * matrizes * 24 * 21 * 0.5;
                const custo_raw = numerador / denominador;
                const custo_mao_obra_centavos = Math.max(1, Math.floor(custo_raw));
                
                console.log('=== C√ÅLCULO M√ÉO DE OBRA (NOVA F√ìRMULA) ===');
                console.log(`Par√¢metros: velocidade=${velocidade}, matrizes=${matrizes}, m√°quinas=${maquinas}`);
                console.log(`Numerador: (${mo_pultrusao} / 3) * ${maquinas} = ${numerador.toFixed(2)}`);
                console.log(`Denominador: ${velocidade} * ${matrizes} * 24 * 21 * 0.5 = ${denominador}`);
                console.log(`Resultado: ${numerador.toFixed(2)} / ${denominador} = ${custo_raw.toFixed(8)}`);
                console.log(`Custo final: ${custo_mao_obra_centavos} centavos = R$ ${(custo_mao_obra_centavos / 100).toFixed(2)}`);
                
                componentes.push({
                    nome: 'M√£o de Obra - Pultrus√£o',
                    produto: 'M√£o de Obra Industrial',
                    quantidade: 1.0,
                    custo_unitario: custo_mao_obra_centavos,
                    custo_total: custo_mao_obra_centavos
                });
            }
            
            // Adicionar pintura se selecionada
            if (temPintura && dados.area_pintura_m2 > 0) {
                componentes.push({
                    nome: '√Årea pintura (m¬≤)',
                    produto: 'Pintura Industrial',
                    quantidade: dados.area_pintura_m2,
                    custo_unitario: precos.pintura * 100,
                    custo_total: dados.area_pintura_m2 * precos.pintura * 100
                });
            }
            
            // Calcular custo total com 3% de perda nas mat√©rias-primas
            // Separar mat√©rias-primas de m√£o de obra
            const custoMateriasPrimas = componentes
                .filter(comp => comp.nome !== 'M√£o de Obra - Pultrus√£o')
                .reduce((total, comp) => total + comp.custo_total, 0);
            
            const custoMaoObra = componentes
                .filter(comp => comp.nome === 'M√£o de Obra - Pultrus√£o')
                .reduce((total, comp) => total + comp.custo_total, 0);
            
            // Aplicar perda apenas nas mat√©rias-primas
            const custoMateriasPrimasComPerda = custoMateriasPrimas * (1 + dados.perda_pct / 100);
            const custoTotalComPerda = custoMateriasPrimasComPerda + custoMaoObra;
            
            console.log('=== APLICA√á√ÉO DE PERDA ===');
            console.log(`Custo mat√©rias-primas: R$ ${(custoMateriasPrimas / 100).toFixed(2)}`);
            console.log(`Custo m√£o de obra: R$ ${(custoMaoObra / 100).toFixed(2)}`);
            console.log(`Perda aplicada: ${dados.perda_pct}%`);
            console.log(`Custo mat√©rias-primas c/ perda: R$ ${(custoMateriasPrimasComPerda / 100).toFixed(2)}`);
            console.log(`Custo total final: R$ ${(custoTotalComPerda / 100).toFixed(2)}`);
            
            // Adicionar componente de perda se h√° perda aplicada
            if (dados.perda_pct > 0) {
                const valorPerda = custoMateriasPrimasComPerda - custoMateriasPrimas;
                componentes.push({
                    nome: `Perda de material (${dados.perda_pct}%)`,
                    produto: 'Perda de Produ√ß√£o',
                    quantidade: 1,
                    custo_unitario: valorPerda,
                    custo_total: valorPerda
                });
            }
            
            // Criar resultado final
            ultimoCalculo = {
                success: true,
                nome_produto: dados.nome_perfil,
                custo_total: custoTotalComPerda,
                componentes: componentes,
                dados_originais: dados, // Para poder recalcular
                fatores_originais: { // Para exibir na tabela
                    'Resina PET': fatores.resina * 100,
                    'Mon√¥mero de estireno': fatores.monomero * 100,
                    'Anti UV': fatores.antiUV * 100,
                    'Anti OX': fatores.antiOX * 100,
                    'BPO': fatores.bpo * 100,
                    'TBPB': fatores.tbpb * 100,
                    'Desmoldante': fatores.desmoldante * 100,
                    'Antichama': fatores.antichama * 100,
                    'Carga mineral': fatores.cargaMineral * 100,
                    'Pigmento': fatores.pigmento * 100
                }
            };
            
            // Mostrar resultado
            mostrarResultadoCalculoOrcamento(ultimoCalculo);
            
            console.log('‚úÖ C√°lculo de novo perfil conclu√≠do');
        })
        .catch(error => {
            console.error('‚ùå Erro ao calcular perfil:', error);
            alert('Erro ao calcular perfil: ' + error.message);
        });
}

function calcularGradeOrcamento() {
    console.log('=== CALCULANDO GRADE OR√áAMENTO ===');
    
    // Verificar se todos os campos obrigat√≥rios est√£o preenchidos
    const nomeGradeElement = document.getElementById('nome_grade');
    const vaoElement = document.getElementById('vao');
    const comprimentoElement = document.getElementById('comprimento');
    const eixoIElement = document.getElementById('eixo_i');
    const perfilSelect = document.getElementById('perfil_grade');
    
    if (!nomeGradeElement || !nomeGradeElement.value.trim()) {
        alert('Por favor, preencha o nome da grade.');
        return;
    }
    
    if (!vaoElement || !vaoElement.value.trim()) {
        alert('Por favor, preencha o v√£o.');
        return;
    }
    
    if (!comprimentoElement || !comprimentoElement.value.trim()) {
        alert('Por favor, preencha o comprimento.');
        return;
    }
    
    if (!eixoIElement || !eixoIElement.value.trim()) {
        alert('Por favor, preencha o eixo i.');
        return;
    }
    
    if (!perfilSelect || !perfilSelect.value) {
        alert('Por favor, selecione um perfil.');
        return;
    }
    
    // Coletar dados dos campos
    const dados = {
        nome_grade: nomeGradeElement.value.trim(),
        vao: parseFloat(vaoElement.value) || 0,
        comprimento: parseFloat(comprimentoElement.value) || 0,
        eixo_i: parseFloat(eixoIElement.value) || 0,
        perfil_id: parseInt(perfilSelect.value) || 0
    };
    
    // Coletar dados opcionais de perda e m√£o de obra
    const perdaElement = document.getElementById('perda_grade');
    dados.perda = perdaElement ? (parseFloat(perdaElement.value) || 10) : 10;
    
    const tempoProcElement = document.getElementById('tempo_proc');
    dados.tempo_proc = tempoProcElement ? (parseFloat(tempoProcElement.value) || 0.7) : 0.7;
    
    const tempoMtgElement = document.getElementById('tempo_mtg');  
    dados.tempo_mtg = tempoMtgElement ? (parseFloat(tempoMtgElement.value) || 0.3) : 0.3;
    
    console.log('Dados coletados:', dados);
    
    // Buscar dados do perfil selecionado
    console.log('üîç Buscando dados do perfil selecionado...');
    
    fetch('/api/produtos/')
        .then(response => response.json())
        .then(produtos => {
            console.log('‚úÖ Produtos carregados da base');
            
            // Encontrar o perfil selecionado
            const perfilSelecionado = produtos.find(p => p.id == dados.perfil_id);
            if (!perfilSelecionado) {
                throw new Error(`Perfil ID ${dados.perfil_id} n√£o encontrado`);
            }
            
            // Encontrar a chaveta (ID fixo 1332)
            const chaveta = produtos.find(p => p.id == 1332);
            if (!chaveta) {
                throw new Error('Perfil Chaveta (ID 1332) n√£o encontrado no banco');
            }
            
            // Encontrar a cola (ID fixo 1183)
            const cola = produtos.find(p => p.id == 1183);
            if (!cola) {
                throw new Error('COLA ESTRUTURAL 4500 A/B (ID 1183) n√£o encontrada no banco');
            }
            
            console.log(`üìê Perfil selecionado: ${perfilSelecionado.descricao}`);
            console.log(`   ‚Ä¢ Peso: ${perfilSelecionado.peso_und} kg/m`);
            console.log(`   ‚Ä¢ Custo: R$ ${(perfilSelecionado.custo_centavos/100).toFixed(2)}/m`);
            
            console.log(`üîß Chaveta inclu√≠da: ${chaveta.descricao}`);
            console.log(`   ‚Ä¢ Peso: ${chaveta.peso_und} kg/m`);
            console.log(`   ‚Ä¢ Custo: R$ ${(chaveta.custo_centavos/100).toFixed(2)}/m`);
            
            console.log(`üß¥ Cola inclu√≠da: ${cola.descricao}`);
            console.log(`   ‚Ä¢ Peso: ${cola.peso_und} kg/unid`);
            console.log(`   ‚Ä¢ Custo: R$ ${(cola.custo_centavos/100).toFixed(2)}/unid`);
            
            // APLICAR F√ìRMULA: (((comprimento/eixo i)*v√£o/1000)* peso do perfil)
            const metrosLinearesPorM2 = (dados.comprimento / dados.eixo_i) * (dados.vao / 1000);
            
            // Calcular para o perfil
            const pesoPerfilKg = metrosLinearesPorM2 * perfilSelecionado.peso_und;
            const custoPerfilCentavos = metrosLinearesPorM2 * perfilSelecionado.custo_centavos;
            
            // Calcular para a chaveta - F√ìRMULA ESPEC√çFICA: v√£o / 150 * 2 * pre√ßo do perfil
            const quantidadeChaveta = (dados.vao / 150) * 2;
            const pesoChaveta = quantidadeChaveta * chaveta.peso_und;
            const custoChaveta = quantidadeChaveta * chaveta.custo_centavos;
            
            // Calcular para a cola - F√ìRMULA: quantidade fixa 0.06 unid/m¬≤
            const quantidadeCola = 0.06; // Quantidade fixa
            const pesoCola = quantidadeCola * cola.peso_und;
            const custoCola = quantidadeCola * cola.custo_centavos;
            
            // Aplicar perda APENAS aos custos dos materiais (individualmente)
            const fatorPerda = 1 + (dados.perda / 100);
            const custoPerfilComPerda = custoPerfilCentavos * fatorPerda;
            const custoChaveteComPerda = custoChaveta * fatorPerda;
            const custoColaComPerda = custoCola * fatorPerda;
            
            // Totais dos materiais (j√° com perda aplicada)
            let pesoTotalMateriaisKg = (pesoPerfilKg + pesoChaveta + pesoCola) * fatorPerda;
            let custoTotalMateriaisCentavos = custoPerfilComPerda + custoChaveteComPerda + custoColaComPerda;
            
            console.log(`üìä Subtotal MATERIAIS (sem perda): R$ ${((custoPerfilCentavos + custoChaveta + custoCola)/100).toFixed(2)}/m¬≤`);
            console.log(`üìä Subtotal MATERIAIS (com ${dados.perda}% perda): R$ ${(custoTotalMateriaisCentavos/100).toFixed(2)}/m¬≤`);
            
            // Calcular m√£o de obra - Processamento/Montagem R$ 65.79/hora
            const valorHoraMO = 65.79; // R$/hora
            const tempoTotal = dados.tempo_proc + dados.tempo_mtg;
            const custoMaoObraTotal = tempoTotal * valorHoraMO * 100; // converter para centavos
            const maoObraDescricao = `Processamento/Montagem (${tempoTotal}h)`;
            
            console.log(`üíº M√£o de Obra: ${maoObraDescricao} - R$ ${(custoMaoObraTotal/100).toFixed(2)}/m¬≤`);
            
            // CUSTO TOTAL = Materiais com perda + M√£o de obra (sem perda)
            let pesoTotalKg = pesoTotalMateriaisKg; // Peso s√≥ dos materiais (MO n√£o tem peso)
            let custoTotalCentavos = custoTotalMateriaisCentavos + custoMaoObraTotal;
            
            console.log(`üí∞ TOTAL FINAL: R$ ${(custoTotalCentavos/100).toFixed(2)}/m¬≤ | Peso: ${pesoTotalKg.toFixed(3)} kg/m¬≤`);
            
            // Criar componentes
            const componentes = [
                {
                    nome: `${perfilSelecionado.descricao} (com ${dados.perda}% perda)`,
                    produto: perfilSelecionado.descricao,
                    descricao_produto: perfilSelecionado.descricao,
                    quantidade: metrosLinearesPorM2,
                    custo_unitario: perfilSelecionado.custo_centavos,
                    custo_total: custoPerfilComPerda
                },
                {
                    nome: `${chaveta.descricao} (com ${dados.perda}% perda)`,
                    produto: chaveta.descricao,
                    descricao_produto: chaveta.descricao,
                    quantidade: quantidadeChaveta,
                    custo_unitario: chaveta.custo_centavos,
                    custo_total: custoChaveteComPerda
                },
                {
                    nome: `${cola.descricao} (com ${dados.perda}% perda)`,
                    produto: cola.descricao,
                    descricao_produto: cola.descricao,
                    quantidade: quantidadeCola,
                    custo_unitario: cola.custo_centavos,
                    custo_total: custoColaComPerda
                },
                {
                    nome: maoObraDescricao,
                    produto: 'M√£o de Obra Industrial',
                    descricao_produto: maoObraDescricao,
                    quantidade: tempoTotal,
                    custo_unitario: valorHoraMO * 100,
                    custo_total: custoMaoObraTotal
                }
            ];
            
            // Criar resultado final
            ultimoCalculo = {
                success: true,
                nome_produto: dados.nome_grade,
                custo_total: custoTotalCentavos,
                peso_total: pesoTotalKg,
                metros_lineares_por_m2: metrosLinearesPorM2,
                componentes: componentes,
                dados_originais: dados
            };
            
            // Mostrar resultado
            mostrarResultadoCalculoOrcamento(ultimoCalculo);
            
            console.log('‚úÖ C√°lculo de grade conclu√≠do');
        })
        .catch(error => {
            console.error('‚ùå Erro ao calcular grade:', error);
            alert('Erro ao calcular grade: ' + error.message);
        });
}

function carregarInterfaceTampaMontadaOrcamento() {
    console.log('=== CARREGANDO INTERFACE TAMPA MONTADA OR√áAMENTO ===');
    
    // Atualizar o contexto do template atual
    templateAtual = { id: 'tampa_montada_customizado', tipo: 'tampa_montada' };
    
    // Atualizar o select para mostrar a op√ß√£o correta
    document.getElementById('templateSelect').value = 'tampa_montada_customizado';
    
    // HTML da interface Tampa Montada
    const interfaceHTML = `
        <h6 class="text-primary">Tampa Montada</h6>
        
        <div class="mb-3">
            <label for="tampa_nome" class="form-label">Nome da Tampa *</label>
            <input type="text" class="form-control" id="tampa_nome" name="nome_tampa" placeholder="Ex: Tampa Montada 500x300" required>
        </div>
        
        <div class="mb-3">
            <label for="tampa_vao" class="form-label">V√£o (mm) *</label>
            <input type="number" class="form-control" id="tampa_vao" name="vao" placeholder="500" required>
        </div>
        
        <div class="mb-3">
            <label for="tampa_comprimento" class="form-label">Comprimento (mm) *</label>
            <input type="number" class="form-control" id="tampa_comprimento" name="comprimento" placeholder="300" required>
        </div>
        
        <div class="mb-3">
            <label for="tampa_eixo_i" class="form-label">Eixo i (mm) *</label>
            <input type="number" class="form-control" id="tampa_eixo_i" name="eixo_i" placeholder="150" required>
        </div>
        
        <div class="mb-3">
            <label for="tampa_perfil" class="form-label">Perfil *</label>
            <select class="form-select" id="tampa_perfil" name="perfil_id" required>
                <option value="">Carregando perfis...</option>
            </select>
        </div>
        
        <div class="mb-3">
            <label for="tampa_perda" class="form-label">Perda (%)</label>
            <input type="number" class="form-control" id="tampa_perda" name="perda" value="3" step="0.1" min="0">
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="tampa_tempo_proc" class="form-label">Tempo Proc. (h)</label>
                    <input type="number" class="form-control" id="tampa_tempo_proc" name="tempo_proc" value="1.5" step="0.1" min="0">
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="tampa_tempo_mtg" class="form-label">Tempo Mtg. (h)</label>
                    <input type="number" class="form-control" id="tampa_tempo_mtg" name="tempo_mtg" value="0.5" step="0.1" min="0">
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="tampa_quadro_u4" name="quadro_u4">
                <label class="form-check-label" for="tampa_quadro_u4">
                    Quadro U4"
                </label>
            </div>
        </div>
        
        <div class="mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="tampa_alca" name="alca">
                <label class="form-check-label" for="tampa_alca">
                    Al√ßa
                </label>
            </div>
        </div>
        
        <div class="mb-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="tampa_chapa_ev" name="chapa_ev">
                <label class="form-check-label" for="tampa_chapa_ev">
                    Chapa EV
                </label>
            </div>
        </div>
        
        <div class="d-flex justify-content-between align-items-center">
            <button type="button" class="btn btn-primary" onclick="calcularTampaMontadaOrcamento()" id="calcularTampaBtn">
                <i class="fas fa-calculator"></i> Calcular Tampa Montada
            </button>
        </div>
    `;
    
    // Atualizar a descri√ß√£o do template
    document.getElementById('templateDescription').innerHTML = 
        'C√°lculo de tampa montada com perfil, chaveta, cola, chapa e opcionais (quadro U4", al√ßa, chapa EV)';
    
    // Atualizar o container de par√¢metros
    document.getElementById('parametrosContainer').innerHTML = interfaceHTML;
    
    // Carregar perfis dispon√≠veis para tampa montada
    carregarPerfilsTampaMontadaOrcamento();
    
    console.log('Interface Tampa Montada carregada');
}

function carregarPerfilsTampaMontadaOrcamento() {
    console.log('=== CARREGANDO PERFIS PARA TAMPA MONTADA OR√áAMENTO ===');
    
    fetch('/api/produtos/')
        .then(response => response.json())
        .then(produtos => {
            console.log(`‚úÖ ${produtos.length} produtos carregados`);
            
            // Filtrar perfis I25, I32, I38 (excluir grades injetadas)
            const perfisDisponiveis = produtos.filter(produto => {
                if (!produto.descricao) return false;
                const desc = produto.descricao.toLowerCase();
                const incluiPerfil = desc.includes('perfil') && (desc.includes('i25') || desc.includes('i32') || desc.includes('i38'));
                const excluirGradeInjetada = desc.includes('grade') && desc.includes('injetada');
                return incluiPerfil && !excluirGradeInjetada;
            });
            
            console.log(`üîç ${perfisDisponiveis.length} perfis encontrados para tampa montada`);
            
            // Preencher o select
            const selectPerfil = document.getElementById('tampa_perfil');
            if (!selectPerfil) {
                console.error('‚ùå Elemento tampa_perfil n√£o encontrado');
                return;
            }
            
            selectPerfil.innerHTML = '<option value="">Selecione um perfil...</option>';
            
            perfisDisponiveis.forEach(perfil => {
                const option = document.createElement('option');
                option.value = perfil.id;
                option.textContent = `${perfil.descricao} - R$ ${(perfil.custo_centavos/100).toFixed(2)}/m`;
                selectPerfil.appendChild(option);
            });
            
            console.log('‚úÖ Perfis carregados no select');
        })
        .catch(error => {
            console.error('‚ùå Erro ao carregar perfis:', error);
            const selectPerfil = document.getElementById('tampa_perfil');
            if (selectPerfil) {
                selectPerfil.innerHTML = '<option value="">Erro ao carregar perfis</option>';
            }
        });
}

function calcularTampaMontadaOrcamento() {
    console.log('=== CALCULANDO TAMPA MONTADA OR√áAMENTO ===');
    
    // Verificar se todos os campos obrigat√≥rios est√£o preenchidos
    const nomeElement = document.getElementById('tampa_nome');
    const vaoElement = document.getElementById('tampa_vao');
    const comprimentoElement = document.getElementById('tampa_comprimento');
    const eixoIElement = document.getElementById('tampa_eixo_i');
    const perfilSelect = document.getElementById('tampa_perfil');
    
    if (!nomeElement || !nomeElement.value.trim()) {
        alert('Por favor, preencha o nome da tampa.');
        return;
    }
    
    if (!vaoElement || !vaoElement.value.trim()) {
        alert('Por favor, preencha o v√£o.');
        return;
    }
    
    if (!comprimentoElement || !comprimentoElement.value.trim()) {
        alert('Por favor, preencha o comprimento.');
        return;
    }
    
    if (!eixoIElement || !eixoIElement.value.trim()) {
        alert('Por favor, preencha o eixo i.');
        return;
    }
    
    if (!perfilSelect || !perfilSelect.value) {
        alert('Por favor, selecione um perfil.');
        return;
    }
    
    // Coletar dados dos campos
    const dados = {
        nome_tampa: nomeElement.value.trim(),
        vao: parseFloat(vaoElement.value) || 0,
        comprimento: parseFloat(comprimentoElement.value) || 0,
        eixo_i: parseFloat(eixoIElement.value) || 0,
        perfil_id: parseInt(perfilSelect.value) || 0
    };
    
    // Coletar dados opcionais
    const perdaElement = document.getElementById('tampa_perda');
    dados.perda = perdaElement ? (parseFloat(perdaElement.value) || 3) : 3;
    
    const tempoProcElement = document.getElementById('tampa_tempo_proc');
    dados.tempo_proc = tempoProcElement ? (parseFloat(tempoProcElement.value) || 1.5) : 1.5;
    
    const tempoMtgElement = document.getElementById('tampa_tempo_mtg');
    dados.tempo_mtg = tempoMtgElement ? (parseFloat(tempoMtgElement.value) || 0.5) : 0.5;
    
    dados.quadro_u4 = document.getElementById('tampa_quadro_u4')?.checked || false;
    dados.alca = document.getElementById('tampa_alca')?.checked || false;
    dados.chapa_ev = document.getElementById('tampa_chapa_ev')?.checked || false;
    
    console.log('Dados da tampa montada:', dados);
    
    // Buscar produtos necess√°rios
    fetch('/api/produtos/')
        .then(response => response.json())
        .then(produtos => {
            console.log(`‚úÖ ${produtos.length} produtos carregados da API`);
            
            // Encontrar perfil selecionado
            const perfilSelecionado = produtos.find(p => p.id === dados.perfil_id);
            if (!perfilSelecionado) {
                throw new Error(`Perfil com ID ${dados.perfil_id} n√£o encontrado`);
            }
            
            // Encontrar chaveta (sempre ID 1332)
            const chaveta = produtos.find(p => p.id === 1332);
            if (!chaveta) {
                throw new Error('Chaveta Perfil I (ID 1332) n√£o encontrada no banco');
            }
            
            // Encontrar cola estrutural (sempre ID 1183)
            const cola = produtos.find(p => p.id === 1183);
            if (!cola) {
                throw new Error('COLA ESTRUTURAL 4500 A/B (ID 1183) n√£o encontrada no banco');
            }
            
            // Encontrar chapa 2,5mm (buscar por descri√ß√£o)
            const chapa25 = produtos.find(p => 
                p.descricao && 
                p.descricao.toLowerCase().includes('chapa') && 
                p.descricao.toLowerCase().includes('2,5')
            );
            if (!chapa25) {
                throw new Error('Chapa 2,5mm n√£o encontrada no banco');
            }
            
            // Encontrar perfil U4" (se necess√°rio)
            let perfilU4 = null;
            if (dados.quadro_u4) {
                perfilU4 = produtos.find(p => 
                    p.descricao && 
                    p.descricao.toLowerCase().includes('u4')
                );
                if (!perfilU4) {
                    throw new Error('Perfil U4" n√£o encontrado no banco');
                }
            }
            
            // Encontrar al√ßa (se necess√°rio)
            let alca = null;
            if (dados.alca) {
                alca = produtos.find(p => 
                    p.descricao && 
                    p.descricao.toLowerCase().includes('al√ßa')
                );
                if (!alca) {
                    throw new Error('Al√ßa n√£o encontrada no banco');
                }
            }
            
            // Encontrar chapa EV (se necess√°rio)
            let chapaEV = null;
            if (dados.chapa_ev) {
                chapaEV = produtos.find(p => 
                    p.descricao && 
                    p.descricao.toLowerCase().includes('chapa') &&
                    p.descricao.toLowerCase().includes('ev')
                );
                if (!chapaEV) {
                    throw new Error('Chapa EV n√£o encontrada no banco');
                }
            }
            
            console.log(`üìê Perfil selecionado: ${perfilSelecionado.descricao}`);
            console.log(`üîß Chaveta inclu√≠da: ${chaveta.descricao}`);
            console.log(`üß¥ Cola inclu√≠da: ${cola.descricao}`);
            console.log(`üìã Chapa 2,5mm: ${chapa25.descricao}`);
            if (perfilU4) console.log(`üî≤ Perfil U4": ${perfilU4.descricao}`);
            if (alca) console.log(`üéØ Al√ßa: ${alca.descricao}`);
            if (chapaEV) console.log(`üìã Chapa EV: ${chapaEV.descricao}`);
            
            // APLICAR F√ìRMULAS DA TAMPA MONTADA
            const fatorPerda = 1 + (dados.perda / 100);
            
            // 1. Perfil (mesma l√≥gica da grade)
            const metrosLinearesPorM2 = (dados.comprimento / dados.eixo_i) * (dados.vao / 1000);
            const pesoPerfilKg = metrosLinearesPorM2 * perfilSelecionado.peso_und;
            let custoPerfilCentavos = metrosLinearesPorM2 * perfilSelecionado.custo_centavos;
            
            // 2. Chaveta (mesma l√≥gica da grade)
            const quantidadeChaveta = (dados.vao / 150) * 2;
            const pesoChaveta = quantidadeChaveta * chaveta.peso_und;
            let custoChaveta = quantidadeChaveta * chaveta.custo_centavos;
            
            // 3. Cola - 0,1 * custo da cola
            const quantidadeCola = 0.1;
            const pesoCola = quantidadeCola * cola.peso_und;
            let custoCola = quantidadeCola * cola.custo_centavos;
            
            // 4. Chapa 2,5mm ou EV
            const areaChapa = (dados.vao / 1000) * (dados.comprimento / 1000); // em m¬≤
            const pesoChapa25 = areaChapa * chapa25.peso_und;
            
            // CORRE√á√ÉO: Se Chapa EV marcada, usar nova f√≥rmula
            let custoChapa25;
            let nomeChapa, descricaoChapa;
            if (dados.chapa_ev) {
                // NOVA F√ìRMULA: (v√£o * comprimento * custo chapa EV) / 1000000
                custoChapa25 = (dados.vao * dados.comprimento * chapaEV.custo_centavos) / 1000000;
                nomeChapa = "Chapa EV - Res. Poli√©ster";
                descricaoChapa = "Chapa EV - Res. Poli√©ster";
                console.log(`üîß CHAPA EV MARCADA: Aplicando f√≥rmula (${dados.vao} * ${dados.comprimento} * ${chapaEV.custo_centavos/100}) / 1.000.000 = R$ ${(custoChapa25/100).toFixed(2)}`);
            } else {
                custoChapa25 = areaChapa * chapa25.custo_centavos; // C√°lculo normal
                nomeChapa = chapa25.descricao;
                descricaoChapa = chapa25.descricao;
            }
            
            // 5. Quadro U4" - se 'sim' custo perfil u4 * 2
            let pesoU4 = 0, custoU4 = 0;
            if (dados.quadro_u4 && perfilU4) {
                pesoU4 = 2 * perfilU4.peso_und;
                custoU4 = 2 * perfilU4.custo_centavos;
            }
            
            // 6. Al√ßa - se sim custo da al√ßa * 2
            let pesoAlca = 0, custoAlca = 0;
            if (dados.alca && alca) {
                pesoAlca = 2 * alca.peso_und;
                custoAlca = 2 * alca.custo_centavos;
            }
            
            // Aplicar perda aos materiais individuais (exceto m√£o de obra)
            custoPerfilCentavos = custoPerfilCentavos * fatorPerda;
            custoChaveta = custoChaveta * fatorPerda;
            custoCola = custoCola * fatorPerda;
            custoChapa25 = custoChapa25 * fatorPerda;
            custoU4 = custoU4 * fatorPerda;
            custoAlca = custoAlca * fatorPerda;
            
            // Total dos materiais com perda j√° aplicada
            const custoTotalMateriaisCentavos = custoPerfilCentavos + custoChaveta + custoCola + custoChapa25 + custoU4 + custoAlca;
            
            // Calcular m√£o de obra (sem perda) - L√ìGICA ESPECIAL PARA TAMPA MONTADA
            const valorHoraMO = 65.79; // R$/hora
            const custoMaoObraBase = (dados.tempo_proc + dados.tempo_mtg) * valorHoraMO * 100; // custo base em centavos
            
            // Aplicar multiplicador baseado nas op√ß√µes selecionadas
            let multiplicadorMO = 1.0; // padr√£o: nenhuma op√ß√£o selecionada
            let descricaoOpcoes = '';
            
            if (dados.quadro_u4 && dados.alca) {
                multiplicadorMO = 2.0;
                descricaoOpcoes = ' (com Quadro U4" + Al√ßa)';
            } else if (!dados.quadro_u4 && dados.alca) {
                multiplicadorMO = 1.9;
                descricaoOpcoes = ' (com Al√ßa)';
            } else if (dados.quadro_u4 && !dados.alca) {
                multiplicadorMO = 1.1;
                descricaoOpcoes = ' (com Quadro U4")';
            } else {
                multiplicadorMO = 1.0;
                descricaoOpcoes = ' (b√°sico)';
            }
            
            const custoMaoObraTotal = Math.round(custoMaoObraBase * multiplicadorMO);
            const maoObraDescricao = `M√ÉO DE OBRA Processamento/Montagem${descricaoOpcoes}`;
            
            console.log(`\nüîß C√ÅLCULO ESPECIAL M√ÉO DE OBRA TAMPA:`);
            console.log(`   ‚Ä¢ Custo base: R$ ${(custoMaoObraBase/100).toFixed(2)}`);
            console.log(`   ‚Ä¢ Multiplicador: ${multiplicadorMO}x ${descricaoOpcoes}`);
            console.log(`   ‚Ä¢ Custo final MO: R$ ${(custoMaoObraTotal/100).toFixed(2)}`);
            
            // Custo total
            const custoTotalCentavos = custoTotalMateriaisCentavos + custoMaoObraTotal;
            
            // Peso total
            const pesoTotalKg = (pesoPerfilKg + pesoChaveta + pesoCola + pesoChapa25 + pesoU4 + pesoAlca) * fatorPerda;
            
            // Criar componentes
            const componentes = [
                {
                    nome: `${perfilSelecionado.descricao} (com ${dados.perda}% perda)`,
                    produto: perfilSelecionado.descricao,
                    descricao_produto: perfilSelecionado.descricao,
                    quantidade: metrosLinearesPorM2,
                    custo_unitario: perfilSelecionado.custo_centavos,
                    custo_total: custoPerfilCentavos
                },
                {
                    nome: `${chaveta.descricao} (com ${dados.perda}% perda)`,
                    produto: chaveta.descricao,
                    descricao_produto: chaveta.descricao,
                    quantidade: quantidadeChaveta,
                    custo_unitario: chaveta.custo_centavos,
                    custo_total: custoChaveta
                },
                {
                    nome: `${cola.descricao} (com ${dados.perda}% perda)`,
                    produto: cola.descricao,
                    descricao_produto: cola.descricao,
                    quantidade: quantidadeCola,
                    custo_unitario: cola.custo_centavos,
                    custo_total: custoCola
                },
                {
                    nome: `${nomeChapa} (com ${dados.perda}% perda)`,
                    produto: descricaoChapa,
                    descricao_produto: descricaoChapa,
                    quantidade: dados.chapa_ev ? 1 : areaChapa,
                    custo_unitario: dados.chapa_ev ? (custoChapa25 / fatorPerda) : chapa25.custo_centavos,
                    custo_total: custoChapa25
                }
            ];
            
            // Adicionar componentes opcionais
            if (dados.quadro_u4 && perfilU4) {
                componentes.push({
                    nome: `${perfilU4.descricao} x2 (com ${dados.perda}% perda)`,
                    produto: perfilU4.descricao,
                    descricao_produto: perfilU4.descricao,
                    quantidade: 2,
                    custo_unitario: perfilU4.custo_centavos,
                    custo_total: custoU4
                });
            }
            
            if (dados.alca && alca) {
                componentes.push({
                    nome: `${alca.descricao} x2 (com ${dados.perda}% perda)`,
                    produto: alca.descricao,
                    descricao_produto: alca.descricao,
                    quantidade: 2,
                    custo_unitario: alca.custo_centavos,
                    custo_total: custoAlca
                });
            }
            
            // Adicionar m√£o de obra
            componentes.push({
                nome: maoObraDescricao,
                produto: 'M√£o de Obra Industrial',
                descricao_produto: maoObraDescricao,
                quantidade: dados.tempo_proc + dados.tempo_mtg,
                custo_unitario: valorHoraMO * 100,
                custo_total: custoMaoObraTotal
            });
            
            // Criar resultado final
            ultimoCalculo = {
                success: true,
                nome_produto: dados.nome_tampa,
                custo_total: custoTotalCentavos,
                peso_total: pesoTotalKg,
                metros_lineares_por_m2: metrosLinearesPorM2,
                componentes: componentes,
                dados_originais: dados
            };
            
            // Mostrar resultado
            mostrarResultadoCalculoOrcamento(ultimoCalculo);
            
            console.log('‚úÖ C√°lculo de tampa montada conclu√≠do');
        })
        .catch(error => {
            console.error('‚ùå Erro ao calcular tampa montada:', error);
            alert('Erro ao calcular tampa montada: ' + error.message);
        });
}

function calcularTampaMontadaOrcamento() {
    console.log('=== CALCULANDO TAMPA MONTADA OR√áAMENTO ===');
    
    // Verificar se todos os campos obrigat√≥rios est√£o preenchidos
    const nomeElement = document.getElementById('tampa_nome');
    const vaoElement = document.getElementById('tampa_vao');
    const comprimentoElement = document.getElementById('tampa_comprimento');
    const eixoIElement = document.getElementById('tampa_eixo_i');
    const perfilSelect = document.getElementById('tampa_perfil');
    
    if (!nomeElement || !nomeElement.value.trim()) {
        alert('Por favor, preencha o nome da tampa.');
        return;
    }
    
    if (!vaoElement || !vaoElement.value.trim()) {
        alert('Por favor, preencha o v√£o.');
        return;
    }
    
    if (!comprimentoElement || !comprimentoElement.value.trim()) {
        alert('Por favor, preencha o comprimento.');
        return;
    }
    
    if (!eixoIElement || !eixoIElement.value.trim()) {
        alert('Por favor, preencha o eixo i.');
        return;
    }
    
    if (!perfilSelect || !perfilSelect.value) {
        alert('Por favor, selecione um perfil.');
        return;
    }
    
    // Coletar dados dos campos
    const dados = {
        nome_tampa: nomeElement.value.trim(),
        vao: parseFloat(vaoElement.value) || 0,
        comprimento: parseFloat(comprimentoElement.value) || 0,
        eixo_i: parseFloat(eixoIElement.value) || 0,
        perfil_id: parseInt(perfilSelect.value) || 0
    };
    
    // Coletar dados opcionais
    const perdaElement = document.getElementById('tampa_perda');
    dados.perda = perdaElement ? (parseFloat(perdaElement.value) || 3) : 3;
    
    const tempoProcElement = document.getElementById('tampa_tempo_proc');
    dados.tempo_proc = tempoProcElement ? (parseFloat(tempoProcElement.value) || 1.5) : 1.5;
    
    const tempoMtgElement = document.getElementById('tampa_tempo_mtg');  
    dados.tempo_mtg = tempoMtgElement ? (parseFloat(tempoMtgElement.value) || 0.5) : 0.5;
    
    dados.quadro_u4 = document.getElementById('tampa_quadro_u4').checked;
    dados.alca = document.getElementById('tampa_alca').checked;
    dados.chapa_ev = document.getElementById('tampa_chapa_ev').checked;
    
    console.log('Dados coletados:', dados);
    
    // Buscar dados dos produtos necess√°rios
    console.log('üîç Buscando produtos para tampa montada...');
    
    fetch('/api/produtos/')
        .then(response => response.json())
        .then(produtos => {
            console.log('‚úÖ Produtos carregados da base');
            
            // Encontrar perfil selecionado
            const perfilSelecionado = produtos.find(p => p.id == dados.perfil_id);
            if (!perfilSelecionado) {
                throw new Error(`Perfil ID ${dados.perfil_id} n√£o encontrado`);
            }
            
            // Encontrar chaveta (ID fixo 1332)
            const chaveta = produtos.find(p => p.id == 1332);
            if (!chaveta) {
                throw new Error('Chaveta Perfil I (ID 1332) n√£o encontrada no banco');
            }
            
            // Encontrar cola estrutural (ID fixo 1183)
            const cola = produtos.find(p => p.id == 1183);
            if (!cola) {
                throw new Error('COLA ESTRUTURAL 4500 A/B (ID 1183) n√£o encontrada no banco');
            }
            
            // Encontrar chapa 2,5mm (buscar por descri√ß√£o)
            const chapa25 = produtos.find(p => 
                p.descricao && 
                p.descricao.toLowerCase().includes('chapa') && 
                p.descricao.toLowerCase().includes('2,5')
            );
            if (!chapa25) {
                throw new Error('Chapa 2,5mm n√£o encontrada no banco');
            }
            
            // Encontrar perfil U4" (se necess√°rio)
            let perfilU4 = null;
            if (dados.quadro_u4) {
                perfilU4 = produtos.find(p => 
                    p.descricao && 
                    p.descricao.toLowerCase().includes('u4')
                );
                if (!perfilU4) {
                    throw new Error('Perfil U4" n√£o encontrado no banco');
                }
            }
            
            // Encontrar al√ßa (se necess√°rio)
            let alca = null;
            if (dados.alca) {
                alca = produtos.find(p => 
                    p.descricao && 
                    p.descricao.toLowerCase().includes('al√ßa')
                );
                if (!alca) {
                    throw new Error('Al√ßa n√£o encontrada no banco');
                }
            }
            
            // Encontrar chapa EV (se necess√°rio) - ID fixo 1384
            let chapaEV = null;
            if (dados.chapa_ev) {
                chapaEV = produtos.find(p => p.id === 1384);
                if (!chapaEV) {
                    throw new Error('Chapa EV - Res. Poli√©ster (ID 1384) n√£o encontrada no banco');
                }
            }
            
            console.log(`üìê Perfil selecionado: ${perfilSelecionado.descricao}`);
            console.log(`üîß Chaveta inclu√≠da: ${chaveta.descricao}`);
            console.log(`üß¥ Cola inclu√≠da: ${cola.descricao}`);
            console.log(`üìã Chapa 2,5mm: ${chapa25.descricao}`);
            if (perfilU4) console.log(`üî≤ Perfil U4": ${perfilU4.descricao}`);
            if (alca) console.log(`üéØ Al√ßa: ${alca.descricao}`);
            if (chapaEV) console.log(`üìã Chapa EV: ${chapaEV.descricao}`);
            
            // APLICAR F√ìRMULAS DA TAMPA MONTADA
            const fatorPerda = 1 + (dados.perda / 100);
            
            // 1. Perfil (mesma l√≥gica da grade)
            const metrosLinearesPorM2 = (dados.comprimento / dados.eixo_i) * (dados.vao / 1000);
            const pesoPerfilKg = metrosLinearesPorM2 * perfilSelecionado.peso_und;
            let custoPerfilCentavos = metrosLinearesPorM2 * perfilSelecionado.custo_centavos;
            
            // 2. Chaveta (mesma l√≥gica da grade)
            const quantidadeChaveta = (dados.vao / 150) * 2;
            const pesoChaveta = quantidadeChaveta * chaveta.peso_und;
            let custoChaveta = quantidadeChaveta * chaveta.custo_centavos;
            
            // 3. Cola - 0,1 * custo da cola
            const quantidadeCola = 0.1;
            const pesoCola = quantidadeCola * cola.peso_und;
            let custoCola = quantidadeCola * cola.custo_centavos;
            
            // 4. Chapa 2,5mm ou Chapa EV
            const areaChapa = (dados.vao / 1000) * (dados.comprimento / 1000); // em m¬≤
            const pesoChapa25 = areaChapa * chapa25.peso_und;
            
            // APLICAR F√ìRMULA CORRIGIDA DA CHAPA EV
            let custoChapa25;
            let nomeChapa, descricaoChapa;
            if (dados.chapa_ev) {
                // NOVA F√ìRMULA: (v√£o * comprimento * custo chapa EV) / 1000000
                custoChapa25 = (dados.vao * dados.comprimento * chapaEV.custo_centavos) / 1000000;
                nomeChapa = "Chapa EV - Res. Poli√©ster";
                descricaoChapa = "Chapa EV - Res. Poli√©ster";
                console.log(`üîß CHAPA EV MARCADA: Aplicando f√≥rmula (${dados.vao} * ${dados.comprimento} * ${chapaEV.custo_centavos/100}) / 1.000.000 = R$ ${(custoChapa25/100).toFixed(2)}`);
            } else {
                custoChapa25 = areaChapa * chapa25.custo_centavos; // C√°lculo normal
                nomeChapa = chapa25.descricao;
                descricaoChapa = chapa25.descricao;
            }
            
            // 5. Quadro U4" - se 'sim' custo perfil u4 * 2
            let pesoU4 = 0, custoU4 = 0;
            if (dados.quadro_u4 && perfilU4) {
                pesoU4 = 2 * perfilU4.peso_und;
                custoU4 = 2 * perfilU4.custo_centavos;
            }
            
            // 6. Al√ßa - se sim custo da al√ßa * 2
            let pesoAlca = 0, custoAlca = 0;
            if (dados.alca && alca) {
                pesoAlca = 2 * alca.peso_und;
                custoAlca = 2 * alca.custo_centavos;
            }
            
            // Aplicar perda aos materiais individuais (exceto m√£o de obra)
            custoPerfilCentavos = custoPerfilCentavos * fatorPerda;
            custoChaveta = custoChaveta * fatorPerda;
            custoCola = custoCola * fatorPerda;
            custoChapa25 = custoChapa25 * fatorPerda;
            custoU4 = custoU4 * fatorPerda;
            custoAlca = custoAlca * fatorPerda;
            
            // Total dos materiais com perda j√° aplicada
            const custoTotalMateriaisCentavos = custoPerfilCentavos + custoChaveta + custoCola + custoChapa25 + custoU4 + custoAlca;
            
            // Calcular m√£o de obra (sem perda) - L√ìGICA ESPECIAL PARA TAMPA MONTADA
            const valorHoraMO = 65.79; // R$/hora
            const custoMaoObraBase = (dados.tempo_proc + dados.tempo_mtg) * valorHoraMO * 100; // custo base em centavos
            
            // Aplicar multiplicador baseado nas op√ß√µes selecionadas
            let multiplicadorMO = 1.0; // padr√£o: nenhuma op√ß√£o selecionada
            let descricaoOpcoes = '';
            
            if (dados.quadro_u4 && dados.alca) {
                multiplicadorMO = 2.0;
                descricaoOpcoes = ' (com Quadro U4" + Al√ßa)';
            } else if (!dados.quadro_u4 && dados.alca) {
                multiplicadorMO = 1.9;
                descricaoOpcoes = ' (com Al√ßa)';
            } else if (dados.quadro_u4 && !dados.alca) {
                multiplicadorMO = 1.1;
                descricaoOpcoes = ' (com Quadro U4")';
            } else {
                multiplicadorMO = 1.0;
                descricaoOpcoes = ' (b√°sico)';
            }
            
            const custoMaoObraTotal = Math.round(custoMaoObraBase * multiplicadorMO);
            const maoObraDescricao = `M√ÉO DE OBRA Processamento/Montagem${descricaoOpcoes}`;
            
            console.log(`\nüîß C√ÅLCULO ESPECIAL M√ÉO DE OBRA TAMPA:`);
            console.log(`   ‚Ä¢ Custo base: R$ ${(custoMaoObraBase/100).toFixed(2)}`);
            console.log(`   ‚Ä¢ Multiplicador: ${multiplicadorMO}x ${descricaoOpcoes}`);
            console.log(`   ‚Ä¢ Custo final MO: R$ ${(custoMaoObraTotal/100).toFixed(2)}`);
            
            // Custo total
            const custoTotalCentavos = custoTotalMateriaisCentavos + custoMaoObraTotal;
            
            // Peso total
            const pesoTotalKg = (pesoPerfilKg + pesoChaveta + pesoCola + pesoChapa25 + pesoU4 + pesoAlca) * fatorPerda;
            
            console.log(`üí∞ TOTAL FINAL: R$ ${(custoTotalCentavos/100).toFixed(2)}/m¬≤ | Peso: ${pesoTotalKg.toFixed(3)} kg/m¬≤`);
            
            // Criar componentes
            const componentes = [
                {
                    nome: `${perfilSelecionado.descricao} (com ${dados.perda}% perda)`,
                    produto: perfilSelecionado.descricao,
                    descricao_produto: perfilSelecionado.descricao,
                    quantidade: metrosLinearesPorM2,
                    custo_unitario: perfilSelecionado.custo_centavos,
                    custo_total: custoPerfilCentavos
                },
                {
                    nome: `${chaveta.descricao} (com ${dados.perda}% perda)`,
                    produto: chaveta.descricao,
                    descricao_produto: chaveta.descricao,
                    quantidade: quantidadeChaveta,
                    custo_unitario: chaveta.custo_centavos,
                    custo_total: custoChaveta
                },
                {
                    nome: `${cola.descricao} (com ${dados.perda}% perda)`,
                    produto: cola.descricao,
                    descricao_produto: cola.descricao,
                    quantidade: quantidadeCola,
                    custo_unitario: cola.custo_centavos,
                    custo_total: custoCola
                },
                {
                    nome: `${nomeChapa} (com ${dados.perda}% perda)`,
                    produto: descricaoChapa,
                    descricao_produto: descricaoChapa,
                    quantidade: dados.chapa_ev ? 1 : areaChapa,
                    custo_unitario: dados.chapa_ev ? custoChapa25 / fatorPerda : chapa25.custo_centavos,
                    custo_total: custoChapa25
                }
            ];
            
            // Adicionar componentes opcionais
            if (dados.quadro_u4 && perfilU4) {
                componentes.push({
                    nome: `${perfilU4.descricao} (2 unidades com ${dados.perda}% perda)`,
                    produto: perfilU4.descricao,
                    descricao_produto: perfilU4.descricao,
                    quantidade: 2,
                    custo_unitario: perfilU4.custo_centavos,
                    custo_total: custoU4
                });
            }
            
            if (dados.alca && alca) {
                componentes.push({
                    nome: `${alca.descricao} (2 unidades com ${dados.perda}% perda)`,
                    produto: alca.descricao,
                    descricao_produto: alca.descricao,
                    quantidade: 2,
                    custo_unitario: alca.custo_centavos,
                    custo_total: custoAlca
                });
            }
            
            // Adicionar m√£o de obra
            componentes.push({
                nome: maoObraDescricao,
                produto: 'M√£o de Obra Industrial',
                descricao_produto: maoObraDescricao,
                quantidade: dados.tempo_proc + dados.tempo_mtg,
                custo_unitario: valorHoraMO * 100 * multiplicadorMO,
                custo_total: custoMaoObraTotal
            });
            
            // Criar resultado final
            ultimoCalculo = {
                success: true,
                nome_produto: dados.nome_tampa,
                custo_total: custoTotalCentavos,
                peso_total: pesoTotalKg,
                metros_lineares_por_m2: metrosLinearesPorM2,
                componentes: componentes,
                dados_originais: dados
            };
            
            // Mostrar resultado
            mostrarResultadoCalculoOrcamento(ultimoCalculo);
            
            console.log('‚úÖ C√°lculo de tampa montada conclu√≠do');
        })
        .catch(error => {
            console.error('‚ùå Erro ao calcular tampa montada:', error);
            alert('Erro ao calcular tampa montada: ' + error.message);
        });
}

function recalcularComponenteOrcamento(index) {
    console.log('=== RECALCULAR COMPONENTE OR√áAMENTO ===');
    console.log('√çndice do componente:', index);
    
    if (!ultimoCalculo || !ultimoCalculo.componentes || !ultimoCalculo.componentes[index]) {
        console.error('Dados do √∫ltimo c√°lculo n√£o encontrados');
        alert('Erro: dados do c√°lculo n√£o encontrados');
        return;
    }
    
    const componente = ultimoCalculo.componentes[index];
    const componenteNome = componente.nome;
    
    // Verificar se √© um componente de resina que pode ser recalculado
    const componentesResina = ['Resina PET', 'Mon√¥mero de estireno', 'Anti UV', 'Anti OX', 'BPO', 'TBPB', 'Desmoldante', 'Antichama', 'Carga mineral', 'Pigmento'];
    if (!componentesResina.includes(componenteNome)) {
        console.warn('Componente n√£o √© recalcul√°vel:', componenteNome);
        return;
    }
    
    // Obter novo fator da input
    const fatorInput = document.querySelector(`input[data-component-index="${index}"]`);
    if (!fatorInput) {
        console.error('Input do fator n√£o encontrado');
        return;
    }
    
    const novoFatorPct = parseFloat(fatorInput.value);
    if (isNaN(novoFatorPct) || novoFatorPct < 0 || novoFatorPct > 100) {
        alert('Por favor, insira um fator v√°lido entre 0 e 100%');
        return;
    }
    
    console.log(`Recalculando ${componenteNome} com fator ${novoFatorPct}%`);
    
    // Obter dados originais do c√°lculo
    const dadosOriginais = ultimoCalculo.dados_originais;
    if (!dadosOriginais) {
        console.error('Dados originais n√£o encontrados');
        return;
    }
    
    // Recalcular peso base da resina (mesmo c√°lculo da fun√ß√£o original)
    const pesoTotalFibra = dadosOriginais.roving_4400_kg + dadosOriginais.manta_300_kg + dadosOriginais.veu_kg;
    const pesoResinaBase = pesoTotalFibra / 0.7; // 70% fibra, 30% resina
    
    // Converter fator de % para decimal
    const novoFator = novoFatorPct / 100;
    
    // Recalcular quantidade e custo
    const novaQuantidade = pesoResinaBase * novoFator;
    const custoUnitario = componente.custo_unitario; // Manter pre√ßo unit√°rio
    const novoCustoTotal = novaQuantidade * (custoUnitario / 100) * 100; // Convertendo centavos
    
    // Atualizar componente
    ultimoCalculo.componentes[index].quantidade = novaQuantidade;
    ultimoCalculo.componentes[index].custo_total = novoCustoTotal;
    
    // Atualizar fator original
    ultimoCalculo.fatores_originais[componenteNome] = novoFatorPct;
    
    // Recalcular custo total
    const novoCustoTotalGeral = ultimoCalculo.componentes.reduce((total, comp) => total + comp.custo_total, 0);
    ultimoCalculo.custo_total = novoCustoTotalGeral;
    
    // Atualizar interface
    mostrarResultadoCalculoOrcamento(ultimoCalculo);
    
    console.log('‚úÖ Componente recalculado com sucesso');
}









function verificarEHabilitarBotoes() {
    const adicionarBtn = document.getElementById('adicionarProdutoBtn');
    const salvarBtn = document.getElementById('salvarProdutoBtn');
    const nomeInput = document.getElementById('nomeProdutoParametrizado');
    
    if (ultimoCalculo && adicionarBtn && salvarBtn) {
        // Habilitar bot√µes se h√° c√°lculo
        adicionarBtn.disabled = false;
        salvarBtn.disabled = false;
        console.log('‚úÖ Bot√µes habilitados - c√°lculo dispon√≠vel');
        
        // Se h√° nome preenchido, garantir que os bot√µes est√£o habilitados
        if (nomeInput && nomeInput.value.trim()) {
            adicionarBtn.disabled = false;
            salvarBtn.disabled = false;
        }
    } else {
        console.log('‚ö†Ô∏è Aguardando c√°lculo para habilitar bot√µes');
    }
}

// Verificar bot√µes periodicamente (√∫til para debug)
setInterval(verificarEHabilitarBotoes, 2000);

// Fun√ß√£o stub para prevenir erros de fun√ß√£o n√£o definida
function toggleAreaPinturaOrcamento() {
    const checkbox = document.getElementById('perfil_pintura');
    const container = document.getElementById('perfil_area_pintura_container');
    
    if (checkbox && container) {
        if (checkbox.checked) {
            container.style.display = 'block';
        } else {
            container.style.display = 'none';
        }
    }
}

// Fun√ß√£o stub para remover item do or√ßamento
function removerItemOrcamento(button) {
    if (confirm('Tem certeza que deseja remover este item?')) {
        const row = button.closest('tr');
        if (row) {
            row.remove();
            // atualizarTotalOrcamento(); // Ser√° atualizado no backend
        }
    }
}

// Fun√ß√£o stub para editar item do or√ßamento
function editarItemOrcamento(button) {
    console.log('Editar item:', button);
    // Implementa√ß√£o futura se necess√°rio
}

// Verifica√ß√£o de integridade das fun√ß√µes principais
console.log('=== VERIFICA√á√ÉO DE INTEGRIDADE JAVASCRIPT ===');
console.log('‚úÖ openProdutoParametrizadoModal:', typeof openProdutoParametrizadoModal);
console.log('‚úÖ carregarTemplates:', typeof carregarTemplates);
// console.log('‚úÖ atualizarTotalOrcamento:', typeof atualizarTotalOrcamento); // Fun√ß√£o removida
console.log('‚úÖ toggleAreaPinturaOrcamento:', typeof toggleAreaPinturaOrcamento);
console.log('=== VERIFICA√á√ÉO CONCLU√çDA ===');

// Teste final para garantir que a fun√ß√£o est√° acess√≠vel
try {
    window.openProdutoParametrizadoModal = openProdutoParametrizadoModal;
    console.log('üéØ Fun√ß√£o openProdutoParametrizadoModal confirmada no objeto window');
} catch (error) {
    console.error('‚ùå Erro ao expor fun√ß√£o no window:', error);
}

</script>
</body>
</html>
