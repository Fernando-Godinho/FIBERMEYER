<!DOCTYPE html>
<html>
<head>
    <title>Teste Fun√ß√£o calcularGrade</title>
</head>
<body>
    <h1>Teste da Fun√ß√£o calcularGrade</h1>
    
    <!-- Campos de entrada -->
    <input type="text" id="grade_nome" name="nome_grade" value="GRADE TESTE 40x40">
    <input type="number" id="grade_vao" name="vao" value="400">
    <input type="number" id="grade_comprimento" name="comprimento" value="1000">
    <input type="number" id="grade_eixo_i" name="eixo_i" value="40">
    <select id="grade_perfil" name="perfil_id">
        <option value="1328">I25mm (s/ pintura) - Res. Poli√©ster</option>
    </select>
    <input type="number" id="grade_perda" value="3">
    <input type="number" id="grade_tempo_proc" value="1.5">
    <input type="number" id="grade_tempo_mtg" value="0.5">
    
    <!-- Elementos de resultado -->
    <div id="resultadoCalculado" style="display:none">
        <p>Nome: <span id="nomeProdutoCalculado"></span></p>
        <p>Custo: <span id="custoTotalCalculado"></span></p>
        <p>Peso: <span id="pesoTotalCalculado"></span></p>
    </div>
    
    <table id="componentesCalculadosTable"></table>
    <button id="salvarProdutoBtn" disabled>Salvar</button>
    
    <button onclick="testarCalculo()">Testar C√°lculo</button>
    
    <script>
        let ultimoCalculo = null;
        
        function testarCalculo() {
            console.log('=== TESTE DA FUN√á√ÉO calcularGrade ===');
            
            // Simular dados de produtos (mesmos do backend)
            const produtos = [
                {
                    id: 1328,
                    descricao: "I25mm (s/ pintura) - Res. Poli√©ster",
                    custo_centavos: 648,
                    peso_und: 0.497
                },
                {
                    id: 1332,
                    descricao: "Perfil Chaveta (s/ pintura) - Res. Poli√©ster",
                    custo_centavos: 212,
                    peso_und: 0.129
                },
                {
                    id: 1183,
                    descricao: "COLA ESTRUTURAL",
                    custo_centavos: 8685,
                    peso_und: 1.000
                }
            ];
            
            // Simular fetch substituindo por dados diretos
            window.fetch = function(url) {
                if (url === '/api/produtos/') {
                    return Promise.resolve({
                        json: () => Promise.resolve(produtos)
                    });
                }
                return Promise.reject('URL n√£o simulada');
            };
            
            // Chamar a fun√ß√£o
            calcularGrade();
        }
        
        function preencherTabelaComponentesGrade(resultado) {
            console.log('Preenchendo tabela com:', resultado);
        }
        
        // Copiar fun√ß√£o calcularGrade do mp.html
        function calcularGrade() {
            console.log('=== CALCULANDO GRADE ===');
            
            // Verificar se todos os campos obrigat√≥rios est√£o preenchidos
            const camposObrigatorios = [
                'grade_nome', 'grade_vao', 'grade_comprimento', 'grade_eixo_i', 'grade_perfil'
            ];
            
            let todosCamposPreenchidos = true;
            const dados = {};
            
            camposObrigatorios.forEach(campo => {
                const elemento = document.getElementById(campo);
                if (!elemento || !elemento.value.trim()) {
                    todosCamposPreenchidos = false;
                    console.warn(`Campo ${campo} n√£o preenchido`);
                    return;
                }
                
                const valor = elemento.value.trim();
                if (campo === 'grade_nome') {
                    dados[elemento.name] = valor;
                } else {
                    dados[elemento.name] = parseFloat(valor) || 0;
                }
            });
            
            if (!todosCamposPreenchidos) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }
            
            // Coletar dados opcionais
            const perdaElement = document.getElementById('grade_perda');
            dados.perda = perdaElement ? (parseFloat(perdaElement.value) || 3) : 3;
            
            const tempoProc = document.getElementById('grade_tempo_proc');
            dados.tempo_proc = tempoProc ? (parseFloat(tempoProc.value) || 1.5) : 1.5;
            
            const tempoMtg = document.getElementById('grade_tempo_mtg');  
            dados.tempo_mtg = tempoMtg ? (parseFloat(tempoMtg.value) || 0.5) : 0.5;
            
            console.log('Dados coletados:', dados);
            console.log('DEBUG - Campos dos dados:', Object.keys(dados));
            console.log('DEBUG - dados.perfil_id:', dados.perfil_id);
            console.log('DEBUG - dados.nome_grade:', dados.nome_grade);
            console.log('DEBUG - dados.vao:', dados.vao);
            console.log('DEBUG - dados.comprimento:', dados.comprimento);
            console.log('DEBUG - dados.eixo_i:', dados.eixo_i);
            
            // Buscar dados dos produtos
            fetch('/api/produtos/')
                .then(response => response.json())
                .then(produtos => {
                    console.log('‚úÖ Produtos carregados da base');
                    console.log('DEBUG - Total de produtos:', produtos.length);
                    
                    // Encontrar o perfil selecionado
                    console.log('DEBUG - Procurando perfil com ID:', dados.perfil_id);
                    const perfilSelecionado = produtos.find(p => p.id == dados.perfil_id);
                    console.log('DEBUG - Perfil encontrado:', perfilSelecionado);
                    if (!perfilSelecionado) {
                        throw new Error(`Perfil ID ${dados.perfil_id} n√£o encontrado`);
                    }
                    
                    // Encontrar a chaveta (ID fixo 1332)
                    const chaveta = produtos.find(p => p.id == 1332);
                    if (!chaveta) {
                        throw new Error('Perfil Chaveta (ID 1332) n√£o encontrado no banco');
                    }
                    
                    // Encontrar a cola (ID fixo 1183)
                    const cola = produtos.find(p => p.id == 1183);
                    if (!cola) {
                        throw new Error('COLA ESTRUTURAL 4500 A/B (ID 1183) n√£o encontrada no banco');
                    }
                    
                    console.log(`üìê Perfil selecionado: ${perfilSelecionado.descricao}`);
                    console.log(`   ‚Ä¢ Peso: ${perfilSelecionado.peso_und} kg/m`);
                    console.log(`   ‚Ä¢ Custo: R$ ${(perfilSelecionado.custo_centavos/100).toFixed(2)}/m`);
                    
                    // APLICAR F√ìRMULA: (((comprimento/eixo i)*v√£o/1000)* peso do perfil)
                    const metrosLinearesPorM2 = (dados.comprimento / dados.eixo_i) * (dados.vao / 1000);
                    
                    console.log(`F√≥rmula: (${dados.comprimento}/${dados.eixo_i}) * (${dados.vao}/1000) = ${metrosLinearesPorM2}`);
                    
                    // Calcular para o perfil
                    const pesoPerfilKg = metrosLinearesPorM2 * perfilSelecionado.peso_und;
                    const custoPerfilCentavos = metrosLinearesPorM2 * perfilSelecionado.custo_centavos;
                    
                    console.log(`Perfil - Peso: ${pesoPerfilKg.toFixed(3)} kg/m¬≤ | Custo: R$ ${(custoPerfilCentavos/100).toFixed(2)}/m¬≤`);
                    
                    alert(`Teste conclu√≠do! Metros lineares/m¬≤: ${metrosLinearesPorM2.toFixed(4)}`);
                })
                .catch(error => {
                    console.error('‚ùå Erro no c√°lculo:', error);
                    alert('Erro no c√°lculo: ' + error.message);
                });
        }
    </script>
</body>
</html>